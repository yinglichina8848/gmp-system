# File服务合并到EDMS服务方案

## 1. 背景与目标

根据系统重构需求，需要将独立的File服务合并到现有的EDMS（Electronic Document Management System）服务中，以简化系统架构，减少服务间调用，并实现文件管理功能的统一维护。

## 2. 当前系统分析

### 2.1 File服务现状
- File服务目录为空，可能是待实现或已被移除的服务
- 假设其预期功能是提供通用文件存储和管理功能

### 2.2 EDMS服务现状
- 已实现完整的文件存储功能，通过MinioFileStorageServiceImpl实现FileStorageService接口
- 使用Minio作为底层对象存储
- 已支持文档管理、版本控制和文件操作
- 提供了丰富的文件操作API，包括：
  - 文件上传、下载、删除
  - 预签名URL生成
  - 文件信息获取
  - 文件复制和移动
  - 目录列表和桶管理

## 3. 合并方案

### 3.1 功能整合策略

#### 3.1.1 文件存储功能扩展
1. 保留现有的MinioFileStorageServiceImpl作为底层实现
2. 扩展FileStorageService接口以支持更通用的文件操作需求
3. 实现多租户隔离机制，确保不同业务模块的文件存储隔离

#### 3.1.2 API整合方案
1. 为原File服务API创建兼容层，使用Spring MVC的控制器映射实现
2. 现有的EDMS文档相关API保持不变
3. 新增通用文件操作API，路径前缀为`/api/v1/files`

#### 3.1.3 存储结构设计
```
minio-bucket/
├── edms-documents/          # 现有文档存储区
│   └── versions/            # 文档版本存储
├── common-files/            # 通用文件存储区（新增）
│   ├── [module]/            # 模块标识
│   ├── [year]/[month]/[day] # 按日期组织
│   └── ...
└── temp/                    # 临时文件存储区（新增）
```

### 3.2 技术实现细节

#### 3.2.1 服务层扩展
1. 创建通用文件管理服务接口`CommonFileService`
2. 实现`CommonFileServiceImpl`，委托`FileStorageService`完成实际存储操作
3. 添加文件元数据管理，支持文件分类、标签和搜索

#### 3.2.2 控制器层实现
1. 创建`FileController`提供通用文件操作API
2. 实现原File服务的API兼容层，重定向到新的实现
3. 为所有文件操作添加权限控制和审计日志

#### 3.2.3 数据模型扩展
1. 创建`CommonFile`实体类存储文件元数据
2. 添加`FileModule`枚举标识文件所属模块
3. 设计文件索引结构支持快速检索

### 3.3 迁移策略

#### 3.3.1 数据迁移
1. 如果有现有File服务数据，创建迁移脚本将其导入新结构
2. 使用批处理方式迁移大量文件，最小化服务中断
3. 迁移后进行校验确保数据完整性

#### 3.3.2 服务部署
1. 更新EDMS服务配置，添加必要的Minio配置和文件路径设置
2. 部署更新后的EDMS服务
3. 更新API网关配置，将原File服务请求路由到EDMS服务

## 4. 兼容性保障

### 4.1 API兼容性
1. 实现API版本控制策略
2. 为原File服务API提供兼容层
3. 提供API文档和迁移指南

### 4.2 错误处理
1. 统一错误响应格式
2. 添加详细的错误日志
3. 实现重试机制和熔断保护

## 5. 实施计划

### 5.1 阶段一：准备工作
- 更新项目依赖和配置
- 创建开发分支
- 设计详细的API规范

### 5.2 阶段二：核心实现
- 扩展FileStorageService功能
- 实现CommonFileService
- 创建控制器层API

### 5.3 阶段三：测试与验证
- 编写单元测试和集成测试
- 性能测试和负载测试
- 安全审计

### 5.4 阶段四：部署与切换
- 数据迁移（如果需要）
- 更新服务配置
- 流量切换和监控

## 6. 风险评估

| 风险项 | 可能性 | 影响程度 | 缓解措施 |
|--------|--------|----------|----------|
| 存储性能下降 | 中 | 高 | 优化Minio配置，添加缓存层 |
| API兼容性问题 | 高 | 高 | 完整的API测试和兼容层实现 |
| 数据迁移失败 | 中 | 高 | 备份机制，回滚计划，分批次迁移 |
| 服务不可用时间 | 低 | 高 | 蓝绿部署，最小化切换窗口 |

## 7. 成功标准

1. EDMS服务能处理所有原File服务的请求
2. 服务性能满足或超过当前水平
3. API兼容性测试通过
4. 系统监控显示正常运行
5. 开发和测试团队确认功能完整性
