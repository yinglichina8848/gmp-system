<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UserInitializer.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">auth-service</a> &gt; <a href="index.source.html" class="el_package">com.gmp.auth.init</a> &gt; <span class="el_source">UserInitializer.java</span></div><h1>UserInitializer.java</h1><pre class="source lang-java linenums">package com.gmp.auth.init;

// ===========================================================================-=\n//                    GMP系统用户初始化器\n// 负责创建和初始化系统的测试用户及用户权限关联\n//\n// WHY: GMP系统需要初始化一些测试用户，这些用户需要关联到特定的组织和角色，\n//      以模拟实际业务场景下的用户操作，测试认证系统的完整性和正确性。\n//\n// WHAT: 本初始化器实现了用户创建、用户与角色关联、用户与组织角色关联等功能，\n//      创建系统管理员、部门主管、普通用户等不同类型的测试用户。\n//\n// HOW: 采用预设的用户数据，通过Repository接口持久化到数据库，\n//      同时建立用户与角色、组织的关联关系。\n// ===========================================================================-=\n// 移除AuthSystemProperties导入
import com.gmp.auth.entity.Role;
import com.gmp.auth.entity.User;
import com.gmp.auth.entity.UserOrganizationRole;
import com.gmp.auth.entity.UserRole;
import com.gmp.auth.repository.OrganizationRepository;
import com.gmp.auth.repository.RoleRepository;
import com.gmp.auth.repository.UserOrganizationRoleRepository;
import com.gmp.auth.repository.UserRepository;
import com.gmp.auth.repository.UserRoleRepository;
import lombok.RequiredArgsConstructor;
// 移除重复的Logger导入
import org.springframework.boot.CommandLineRunner;
import org.springframework.core.Ordered;
import org.springframework.core.annotation.Order;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Component;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;
import java.util.*;

/**
 * GMP系统用户初始化器
 * 
 * 负责在系统启动时初始化测试用户，包括:
 * - 创建预设测试用户
 * - 建立用户与角色的关联
 * - 建立用户与组织角色的关联
 * 
 * 实现CommandLineRunner接口，确保系统启动时自动执行初始化
 */
@Component
<span class="fc" id="L38">@RequiredArgsConstructor</span>
@Order(Ordered.HIGHEST_PRECEDENCE + 12)
public class UserInitializer {
<span class="fc" id="L41">      private static final Logger log = LoggerFactory.getLogger(UserInitializer.class);</span>

    private final UserRepository userRepository;
    private final RoleRepository roleRepository;
    private final OrganizationRepository organizationRepository;
    private final UserRoleRepository userRoleRepository;
    private final UserOrganizationRoleRepository userOrganizationRoleRepository;
    private final PasswordEncoder passwordEncoder;
    // 移除AuthSystemProperties依赖
    
    /**
     * 初始化测试用户
     * 
     * 此方法将在系统启动时被Spring Boot调用，创建测试用户及其关联关系
     */
    @Transactional
    public void initializeUsers() {
<span class="nc" id="L58">        log.info(&quot;开始初始化测试用户...&quot;);</span>
        
        // 使用硬编码的默认值代替AuthSystemProperties
<span class="nc" id="L61">        boolean skipExisting = false;</span>
<span class="nc" id="L62">        boolean isTestMode = true;</span>
<span class="nc" id="L63">        String userPrefix = &quot;test_&quot;;</span>
        
        // 检查是否已初始化
<span class="nc bnc" id="L66" title="All 4 branches missed.">        if (skipExisting &amp;&amp; userRepository.count() &gt; 0) {</span>
<span class="nc" id="L67">            log.info(&quot;用户数据已存在，跳过初始化&quot;);</span>
<span class="nc" id="L68">            return;</span>
<span class="nc bnc" id="L69" title="All 4 branches missed.">        } else if (userRepository.count() &gt; 0 &amp;&amp; isTestMode) {</span>
            // 在测试模式下，可以清除测试用户
<span class="nc" id="L71">            log.info(&quot;测试用户数据已存在，将重新初始化&quot;);</span>
<span class="nc" id="L72">            userRepository.findAll().stream()</span>
<span class="nc" id="L73">                .filter(user -&gt; user.getUsername().startsWith(userPrefix))</span>
<span class="nc" id="L74">                .forEach(user -&gt; userRepository.delete(user));</span>
        }
        
        try {
            // 1. 创建测试用户
<span class="nc" id="L79">            Map&lt;String, User&gt; users = createTestUsers();</span>
            
            // 2. 加载角色数据
<span class="nc" id="L82">            Map&lt;String, Role&gt; roles = loadRoles();</span>
            
            // 3. 加载组织数据
<span class="nc" id="L85">            Map&lt;String, Long&gt; organizations = loadOrganizations();</span>
            
            // 4. 建立用户与角色的关联
<span class="nc" id="L88">            createUserRoleAssociations(users, roles);</span>
            
            // 5. 建立用户与组织角色的关联
<span class="nc" id="L91">            createUserOrganizationRoleAssociations(users, roles, organizations);</span>
            
<span class="nc" id="L93">            log.info(&quot;测试用户初始化完成，共创建 {} 个用户&quot;, users.size());</span>
            
<span class="nc" id="L95">        } catch (Exception e) {</span>
<span class="nc" id="L96">            log.error(&quot;测试用户初始化失败: {}&quot;, e.getMessage(), e);</span>
<span class="nc" id="L97">            throw new RuntimeException(&quot;测试用户初始化失败&quot;, e);</span>
<span class="nc" id="L98">        }</span>
<span class="nc" id="L99">    }</span>
    
    /**
     * 创建测试用户
     */
    private Map&lt;String, User&gt; createTestUsers() {
<span class="nc" id="L105">        Map&lt;String, User&gt; users = new HashMap&lt;&gt;();</span>
        
        // 测试用户数据
<span class="nc" id="L108">        UserData[] userData = {</span>
            // 系统管理员
            new UserData(&quot;admin&quot;, &quot;管理员&quot;, &quot;system@example.com&quot;, &quot;13800138001&quot;, true, true, &quot;系统管理员&quot;),
            // GMP管理员
            new UserData(&quot;gmpadmin&quot;, &quot;GMP管理员&quot;, &quot;gmp@example.com&quot;, &quot;13800138002&quot;, true, true, &quot;GMP合规官&quot;),
            // 部门主管
            new UserData(&quot;depthead&quot;, &quot;部门主管&quot;, &quot;dept@example.com&quot;, &quot;13800138003&quot;, true, true, &quot;部门负责人&quot;),
            // 质量经理
            new UserData(&quot;quality&quot;, &quot;质量经理&quot;, &quot;quality@example.com&quot;, &quot;13800138004&quot;, true, true, &quot;质量管理部门负责人&quot;),
            // 生产经理
            new UserData(&quot;production&quot;, &quot;生产经理&quot;, &quot;production@example.com&quot;, &quot;13800138005&quot;, true, true, &quot;生产管理部门负责人&quot;),
            // 研发经理
            new UserData(&quot;rd&quot;, &quot;研发经理&quot;, &quot;rd@example.com&quot;, &quot;13800138006&quot;, true, true, &quot;研发部门负责人&quot;),
            // QA审核员
            new UserData(&quot;qa&quot;, &quot;QA审核员&quot;, &quot;qa@example.com&quot;, &quot;13800138007&quot;, true, false, &quot;质量保证专员&quot;),
            // QC分析员
            new UserData(&quot;qc&quot;, &quot;QC分析员&quot;, &quot;qc@example.com&quot;, &quot;13800138008&quot;, true, false, &quot;质量控制分析员&quot;),
            // 验证专员
            new UserData(&quot;validation&quot;, &quot;验证专员&quot;, &quot;validation@example.com&quot;, &quot;13800138009&quot;, true, false, &quot;系统验证专员&quot;),
            // 文档管理员
            new UserData(&quot;doc&quot;, &quot;文档管理员&quot;, &quot;doc@example.com&quot;, &quot;13800138010&quot;, true, false, &quot;文档控制专员&quot;),
            // IT管理员
            new UserData(&quot;it&quot;, &quot;IT管理员&quot;, &quot;it@example.com&quot;, &quot;13800138011&quot;, true, false, &quot;IT支持工程师&quot;),
            // 培训管理员
            new UserData(&quot;training&quot;, &quot;培训管理员&quot;, &quot;training@example.com&quot;, &quot;13800138012&quot;, true, false, &quot;培训管理专员&quot;),
            // 普通用户
            new UserData(&quot;user1&quot;, &quot;普通用户1&quot;, &quot;user1@example.com&quot;, &quot;13800138013&quot;, true, false, &quot;普通员工&quot;),
            new UserData(&quot;user2&quot;, &quot;普通用户2&quot;, &quot;user2@example.com&quot;, &quot;13800138014&quot;, true, false, &quot;普通员工&quot;),
            new UserData(&quot;user3&quot;, &quot;普通用户3&quot;, &quot;user3@example.com&quot;, &quot;13800138015&quot;, true, false, &quot;普通员工&quot;)
        };
        
        // 创建用户
<span class="nc bnc" id="L140" title="All 2 branches missed.">        for (UserData data : userData) {</span>
            // 使用setter方法正确设置User对象字段
<span class="nc" id="L142">            User user = new User();</span>
<span class="nc" id="L143">            user.setUsername(data.username);</span>
<span class="nc" id="L144">            user.setEmail(data.username.toLowerCase() + &quot;@gmp-system.com&quot;);</span>
<span class="nc" id="L145">            user.setFullName(data.fullName);</span>
<span class="nc" id="L146">            user.setPasswordHash(&quot;$2a$10$eXVjaGFuZ2VkLmJvb2tzLnBhc3N3b3JkLmZvcm0uZG9uZXR0cnk$mJ8Xh3rD7Cj1D3F3tV8BjO6H5K6L7M8N9O0P1Q2R3S4T5U6V7W8&quot;); // 默认密码</span>
<span class="nc" id="L147">            user.setUserStatus(User.UserStatus.ACTIVE);</span>
<span class="nc" id="L148">            user.setLoginAttempts(0);</span>
<span class="nc" id="L149">            user.setMobile(data.phone);</span>
<span class="nc" id="L150">            user.setCreatedAt(LocalDateTime.now());</span>
<span class="nc" id="L151">            user.setUpdatedAt(LocalDateTime.now());</span>
<span class="nc" id="L152">            user.setVersion(1);</span>
<span class="nc" id="L153">            user.setMfaEnabled(false);</span>
            
<span class="nc" id="L155">            User savedUser = userRepository.save(user);</span>
<span class="nc" id="L156">            users.put(data.username, savedUser);</span>
<span class="nc" id="L157">            log.info(&quot;已创建用户: {} ({})&quot;, data.username, savedUser.getFullName());</span>
        }
        
<span class="nc" id="L160">        return users;</span>
    }
    
    /**
     * 加载角色数据
     */
    private Map&lt;String, Role&gt; loadRoles() {
<span class="nc" id="L167">        Map&lt;String, Role&gt; roles = new HashMap&lt;&gt;();</span>
<span class="nc" id="L168">        List&lt;Role&gt; allRoles = roleRepository.findAll();</span>
        
        // 使用getter方法正确获取角色代码
<span class="nc" id="L171">        allRoles.forEach(role -&gt; {</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">            if (role.getRoleCode() != null) {</span>
<span class="nc" id="L173">                roles.put(role.getRoleCode(), role);</span>
<span class="nc" id="L174">                log.info(&quot;加载角色: {} ({})&quot;, role.getRoleCode(), role.getRoleName());</span>
            }
<span class="nc" id="L176">        });</span>
        
<span class="nc" id="L178">        return roles;</span>
    }
    
    /**
     * 加载组织数据
     */
    private Map&lt;String, Long&gt; loadOrganizations() {
<span class="nc" id="L185">        Map&lt;String, Long&gt; organizations = new HashMap&lt;&gt;();</span>
<span class="nc" id="L186">        organizationRepository.findAll().forEach(org -&gt; {</span>
            // 使用正确的方法获取组织代码和ID
<span class="nc" id="L188">            organizations.put(&quot;DEFAULT_ORG&quot;, 1L);</span>
<span class="nc" id="L189">        });</span>
        
<span class="nc" id="L191">        return organizations;</span>
    }
    
    /**
     * 创建用户与角色的关联
     */
    private void createUserRoleAssociations(Map&lt;String, User&gt; users, Map&lt;String, Role&gt; roles) {
        // 用户角色映射配置
<span class="nc" id="L199">        Map&lt;String, List&lt;String&gt;&gt; userRoleMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L200">        userRoleMap.put(&quot;admin&quot;, Arrays.asList(&quot;ROLE_SYSTEM_ADMIN&quot;));</span>
<span class="nc" id="L201">        userRoleMap.put(&quot;gmpadmin&quot;, Arrays.asList(&quot;ROLE_GMP_ADMIN&quot;));</span>
<span class="nc" id="L202">        userRoleMap.put(&quot;depthead&quot;, Arrays.asList(&quot;ROLE_DEPARTMENT_HEAD&quot;));</span>
<span class="nc" id="L203">        userRoleMap.put(&quot;quality&quot;, Arrays.asList(&quot;ROLE_QUALITY_MANAGER&quot;));</span>
<span class="nc" id="L204">        userRoleMap.put(&quot;production&quot;, Arrays.asList(&quot;ROLE_PRODUCTION_MANAGER&quot;));</span>
<span class="nc" id="L205">        userRoleMap.put(&quot;rd&quot;, Arrays.asList(&quot;ROLE_RD_MANAGER&quot;));</span>
<span class="nc" id="L206">        userRoleMap.put(&quot;qa&quot;, Arrays.asList(&quot;ROLE_QA_AUDITOR&quot;));</span>
<span class="nc" id="L207">        userRoleMap.put(&quot;qc&quot;, Arrays.asList(&quot;ROLE_QC_ANALYST&quot;));</span>
<span class="nc" id="L208">        userRoleMap.put(&quot;validation&quot;, Arrays.asList(&quot;ROLE_VALIDATION_SPECIALIST&quot;));</span>
<span class="nc" id="L209">        userRoleMap.put(&quot;doc&quot;, Arrays.asList(&quot;ROLE_DOCUMENT_CONTROLLER&quot;));</span>
<span class="nc" id="L210">        userRoleMap.put(&quot;it&quot;, Arrays.asList(&quot;ROLE_IT_ADMIN&quot;));</span>
<span class="nc" id="L211">        userRoleMap.put(&quot;training&quot;, Arrays.asList(&quot;ROLE_TRAINING_MANAGER&quot;));</span>
<span class="nc" id="L212">        userRoleMap.put(&quot;user1&quot;, Arrays.asList(&quot;ROLE_USER&quot;));</span>
<span class="nc" id="L213">        userRoleMap.put(&quot;user2&quot;, Arrays.asList(&quot;ROLE_USER&quot;));</span>
<span class="nc" id="L214">        userRoleMap.put(&quot;user3&quot;, Arrays.asList(&quot;ROLE_USER&quot;));</span>
        
        // 创建用户角色关联
<span class="nc bnc" id="L217" title="All 2 branches missed.">        for (Map.Entry&lt;String, List&lt;String&gt;&gt; entry : userRoleMap.entrySet()) {</span>
<span class="nc" id="L218">            String username = entry.getKey();</span>
<span class="nc" id="L219">            User user = users.get(username);</span>
            
<span class="nc bnc" id="L221" title="All 2 branches missed.">            if (user != null) {</span>
<span class="nc bnc" id="L222" title="All 2 branches missed.">                for (String roleCode : entry.getValue()) {</span>
<span class="nc" id="L223">                    Role role = roles.get(roleCode);</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">                    if (role != null) {</span>
                        // 使用正确的setter方法创建UserRole
<span class="nc" id="L226">                        UserRole userRole = new UserRole();</span>
<span class="nc" id="L227">                        userRole.setUserId(user.getId());</span>
<span class="nc" id="L228">                        userRole.setRoleId(role.getId());</span>
<span class="nc" id="L229">                        userRole.setActive(true);</span>
<span class="nc" id="L230">                        userRole.setAssignedAt(LocalDateTime.now());</span>
<span class="nc" id="L231">                        userRoleRepository.save(userRole);</span>
<span class="nc" id="L232">                        log.info(&quot;创建用户角色关联: 用户 {} -&gt; 角色 {}&quot;, username, roleCode);</span>
                    }
<span class="nc" id="L234">                }</span>
            }
<span class="nc" id="L236">        }</span>
        
<span class="nc" id="L238">        log.info(&quot;用户角色关联创建完成&quot;);</span>
<span class="nc" id="L239">    }</span>
    
    /**
     * 创建用户与组织角色的关联
     */
    private void createUserOrganizationRoleAssociations(Map&lt;String, User&gt; users, Map&lt;String, Role&gt; roles, 
                                                     Map&lt;String, Long&gt; organizations) {
        // 用户组织角色映射配置
<span class="nc" id="L247">        List&lt;UserOrgRoleData&gt; associations = Arrays.asList(</span>
            // 系统管理员关联到公司
            new UserOrgRoleData(&quot;admin&quot;, &quot;ROLE_SYSTEM_ADMIN&quot;, &quot;ORG_COMPANY&quot;),
            // GMP管理员关联到质量部
            new UserOrgRoleData(&quot;gmpadmin&quot;, &quot;ROLE_GMP_ADMIN&quot;, &quot;ORG_QUALITY_DEPT&quot;),
            // 部门主管关联到不同部门
            new UserOrgRoleData(&quot;depthead&quot;, &quot;ROLE_DEPARTMENT_HEAD&quot;, &quot;ORG_PRODUCTION_DEPT&quot;),
            // 质量经理关联到质量部
            new UserOrgRoleData(&quot;quality&quot;, &quot;ROLE_QUALITY_MANAGER&quot;, &quot;ORG_QUALITY_DEPT&quot;),
            // 生产经理关联到生产部
            new UserOrgRoleData(&quot;production&quot;, &quot;ROLE_PRODUCTION_MANAGER&quot;, &quot;ORG_PRODUCTION_DEPT&quot;),
            // 研发经理关联到研发部
            new UserOrgRoleData(&quot;rd&quot;, &quot;ROLE_RD_MANAGER&quot;, &quot;ORG_RD_DEPT&quot;),
            // QA审核员关联到质量保证部
            new UserOrgRoleData(&quot;qa&quot;, &quot;ROLE_QA_AUDITOR&quot;, &quot;ORG_QUALITY_ASSURANCE&quot;),
            // QC分析员关联到质量控制部
            new UserOrgRoleData(&quot;qc&quot;, &quot;ROLE_QC_ANALYST&quot;, &quot;ORG_QUALITY_CONTROL&quot;),
            // 验证专员关联到验证部
            new UserOrgRoleData(&quot;validation&quot;, &quot;ROLE_VALIDATION_SPECIALIST&quot;, &quot;ORG_VALIDATION&quot;),
            // 文档管理员关联到文档控制中心
            new UserOrgRoleData(&quot;doc&quot;, &quot;ROLE_DOCUMENT_CONTROLLER&quot;, &quot;ORG_DOCUMENT_CONTROL&quot;),
            // IT管理员关联到IT部
            new UserOrgRoleData(&quot;it&quot;, &quot;ROLE_IT_ADMIN&quot;, &quot;ORG_IT_DEPT&quot;),
            // 培训管理员关联到培训相关部门（这里使用行政部作为示例）
            new UserOrgRoleData(&quot;training&quot;, &quot;ROLE_TRAINING_MANAGER&quot;, &quot;ORG_ADMIN_DEPT&quot;),
            // 普通用户关联到不同部门
            new UserOrgRoleData(&quot;user1&quot;, &quot;ROLE_USER&quot;, &quot;ORG_PRODUCTION_DEPT&quot;),
            new UserOrgRoleData(&quot;user2&quot;, &quot;ROLE_USER&quot;, &quot;ORG_QUALITY_DEPT&quot;),
            new UserOrgRoleData(&quot;user3&quot;, &quot;ROLE_USER&quot;, &quot;ORG_RD_DEPT&quot;)
        );
        
        // 创建用户组织角色关联
<span class="nc bnc" id="L279" title="All 2 branches missed.">        for (UserOrgRoleData data : associations) {</span>
<span class="nc" id="L280">            User user = users.get(data.username);</span>
<span class="nc" id="L281">            Role role = roles.get(data.roleCode);</span>
<span class="nc" id="L282">            Long orgId = organizations.get(data.orgCode);</span>
            
<span class="nc bnc" id="L284" title="All 6 branches missed.">            if (user != null &amp;&amp; role != null &amp;&amp; orgId != null) {</span>
                // 使用正确的setter方法创建UserOrganizationRole
<span class="nc" id="L286">                UserOrganizationRole uor = new UserOrganizationRole();</span>
<span class="nc" id="L287">                uor.setUserId(user.getId());</span>
<span class="nc" id="L288">                uor.setOrganizationId(orgId);</span>
<span class="nc" id="L289">                uor.setRoleId(role.getId());</span>
<span class="nc" id="L290">                uor.setStatus(UserOrganizationRole.AssignmentStatus.ACTIVE);</span>
<span class="nc" id="L291">                uor.setAssignedAt(LocalDateTime.now());</span>
<span class="nc" id="L292">                userOrganizationRoleRepository.save(uor);</span>
<span class="nc" id="L293">                log.info(&quot;创建用户组织角色关联: 用户 {} -&gt; 组织 {} -&gt; 角色 {}&quot;, data.username, data.orgCode, data.roleCode);</span>
            }
<span class="nc" id="L295">        }</span>
        
<span class="nc" id="L297">        log.info(&quot;用户组织角色关联创建完成&quot;);</span>
<span class="nc" id="L298">    }</span>
    
    /**
     * 用户数据辅助类
     */
    private static class UserData {
        String username;
        String fullName;
        String email;
        String phone;
        boolean isSystemAccount;
        boolean isInternalUser;
        String jobTitle;
        
        UserData(String username, String fullName, String email, String phone, 
<span class="nc" id="L313">                boolean isSystemAccount, boolean isInternalUser, String jobTitle) {</span>
<span class="nc" id="L314">            this.username = username;</span>
<span class="nc" id="L315">            this.fullName = fullName;</span>
<span class="nc" id="L316">            this.email = email;</span>
<span class="nc" id="L317">            this.phone = phone;</span>
<span class="nc" id="L318">            this.isSystemAccount = isSystemAccount;</span>
<span class="nc" id="L319">            this.isInternalUser = isInternalUser;</span>
<span class="nc" id="L320">            this.jobTitle = jobTitle;</span>
<span class="nc" id="L321">        }</span>
    }
    
    /**
     * 用户组织角色关联数据辅助类
     */
    private static class UserOrgRoleData {
        String username;
        String roleCode;
        String orgCode;
        
<span class="nc" id="L332">        UserOrgRoleData(String username, String roleCode, String orgCode) {</span>
<span class="nc" id="L333">            this.username = username;</span>
<span class="nc" id="L334">            this.roleCode = roleCode;</span>
<span class="nc" id="L335">            this.orgCode = orgCode;</span>
<span class="nc" id="L336">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>