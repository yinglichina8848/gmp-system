<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RolePermissionInitializer.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">auth-service</a> &gt; <a href="index.source.html" class="el_package">com.gmp.auth.init</a> &gt; <span class="el_source">RolePermissionInitializer.java</span></div><h1>RolePermissionInitializer.java</h1><pre class="source lang-java linenums">package com.gmp.auth.init;

// ============================================================================
//                    GMP系统角色权限初始化器
// 负责创建和初始化系统的角色、权限及关联关系
//
// WHY: GMP系统需要完整的RBAC权限模型支持，包括预设的角色、详细的权限定义，
//      以及角色与权限之间的关联关系，确保系统初始化后具有完整的权限控制能力。
//
// WHAT: 本初始化器实现了角色创建、权限定义和权限分配功能，支持系统管理员、
//      GMP管理员、部门主管等多种角色的权限配置，满足不同业务场景的权限需求。
//
// HOW: 采用预设的角色和权限定义，通过Repository接口持久化到数据库，
//      实现角色-权限的关联管理。
// ============================================================================
import com.gmp.auth.config.AuthSystemProperties;
import com.gmp.auth.entity.Permission;

import com.gmp.auth.entity.Role;
import com.gmp.auth.entity.RolePermission;
import com.gmp.auth.repository.PermissionRepository;
import com.gmp.auth.repository.RolePermissionRepository;
import com.gmp.auth.repository.RoleRepository;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.boot.CommandLineRunner;
import org.springframework.core.Ordered;
import org.springframework.core.annotation.Order;
import org.springframework.stereotype.Component;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;
import java.util.*;
import java.util.stream.Collectors;

/**
 * GMP系统角色权限初始化器
 * 
 * 负责在系统启动时初始化角色和权限，包括:
 * - 创建预设角色
 * - 创建系统权限
 * - 建立角色与权限的关联
 * 
 * 实现CommandLineRunner接口，确保系统启动时自动执行初始化
 */
@Slf4j
@Component
<span class="fc" id="L50">@RequiredArgsConstructor</span>
@Order(Ordered.HIGHEST_PRECEDENCE + 11)
public class RolePermissionInitializer {
    // 添加显式日志记录器，避免Lombok依赖问题
<span class="fc" id="L54">    private static final Logger log = LoggerFactory.getLogger(RolePermissionInitializer.class);</span>

    // 角色常量定义 - 核心认证角色
    private static final String ROLE_SYSTEM_ADMIN = &quot;ROLE_SYSTEM_ADMIN&quot;;
    private static final String ROLE_SECURITY_ADMIN = &quot;ROLE_SECURITY_ADMIN&quot;;
    private static final String ROLE_GMP_ADMIN = &quot;ROLE_GMP_ADMIN&quot;;
    private static final String ROLE_QUALITY_DIRECTOR = &quot;ROLE_QUALITY_DIRECTOR&quot;;
    private static final String ROLE_QUALITY_MANAGER = &quot;ROLE_QUALITY_MANAGER&quot;;
    private static final String ROLE_QUALITY_SPECIALIST = &quot;ROLE_QUALITY_SPECIALIST&quot;;
    private static final String ROLE_PRODUCTION_DIRECTOR = &quot;ROLE_PRODUCTION_DIRECTOR&quot;;
    private static final String ROLE_PRODUCTION_MANAGER = &quot;ROLE_PRODUCTION_MANAGER&quot;;
    private static final String ROLE_PRODUCTION_SUPERVISOR = &quot;ROLE_PRODUCTION_SUPERVISOR&quot;;
    private static final String ROLE_PRODUCTION_OPERATOR = &quot;ROLE_PRODUCTION_OPERATOR&quot;;
    private static final String ROLE_RD_DIRECTOR = &quot;ROLE_RD_DIRECTOR&quot;;
    private static final String ROLE_RD_MANAGER = &quot;ROLE_RD_MANAGER&quot;;
    private static final String ROLE_FORMULATION_RD_SCIENTIST = &quot;ROLE_FORMULATION_RD_SCIENTIST&quot;;
    private static final String ROLE_ANALYTICAL_RD_SCIENTIST = &quot;ROLE_ANALYTICAL_RD_SCIENTIST&quot;;
    private static final String ROLE_REGULATORY_AFFAIRS_SPECIALIST = &quot;ROLE_REGULATORY_AFFAIRS_SPECIALIST&quot;;
    private static final String ROLE_DOCUMENT_CONTROLLER = &quot;ROLE_DOCUMENT_CONTROLLER&quot;;
    private static final String ROLE_IT_SPECIALIST = &quot;ROLE_IT_SPECIALIST&quot;;
    private static final String ROLE_FACILITIES_MANAGER = &quot;ROLE_FACILITIES_MANAGER&quot;;
    private static final String ROLE_SAFETY_ENVIRONMENTAL_OFFICER = &quot;ROLE_SAFETY_ENVIRONMENTAL_OFFICER&quot;;
    private static final String ROLE_AUDITOR = &quot;ROLE_AUDITOR&quot;;
    private static final String ROLE_OBSERVER = &quot;ROLE_OBSERVER&quot;;
    private static final String ROLE_USER = &quot;ROLE_USER&quot;;
    
    // 权限常量定义 - 功能权限分类
    // 1. 系统管理权限
    private static final String PERMISSION_SYSTEM_CONFIG = &quot;system:config&quot;;
    private static final String PERMISSION_SYSTEM_LOG = &quot;system:log&quot;;
    private static final String PERMISSION_SYSTEM_BACKUP = &quot;system:backup&quot;;
    private static final String PERMISSION_SYSTEM_RESTORE = &quot;system:restore&quot;;
    private static final String PERMISSION_SYSTEM_MONITOR = &quot;system:monitor&quot;;
    
    // 2. 用户与权限管理
    private static final String PERMISSION_USER_CREATE = &quot;user:create&quot;;
    private static final String PERMISSION_USER_READ = &quot;user:read&quot;;
    private static final String PERMISSION_USER_UPDATE = &quot;user:update&quot;;
    private static final String PERMISSION_USER_DELETE = &quot;user:delete&quot;;
    private static final String PERMISSION_ROLE_CREATE = &quot;role:create&quot;;
    private static final String PERMISSION_ROLE_READ = &quot;role:read&quot;;
    private static final String PERMISSION_ROLE_UPDATE = &quot;role:update&quot;;
    private static final String PERMISSION_ROLE_DELETE = &quot;role:delete&quot;;
    private static final String PERMISSION_PERMISSION_MANAGE = &quot;permission:manage&quot;;
    
    // 3. 组织管理权限
    private static final String PERMISSION_ORG_CREATE = &quot;organization:create&quot;;
    private static final String PERMISSION_ORG_READ = &quot;organization:read&quot;;
    private static final String PERMISSION_ORG_UPDATE = &quot;organization:update&quot;;
    private static final String PERMISSION_ORG_DELETE = &quot;organization:delete&quot;;
    
    // 4. GMP合规管理
    private static final String PERMISSION_GMP_COMPLIANCE = &quot;gmp:compliance&quot;;
    private static final String PERMISSION_GMP_AUDIT = &quot;gmp:audit&quot;;
    private static final String PERMISSION_GMP_VALIDATION = &quot;gmp:validation&quot;;
    private static final String PERMISSION_GMP_INSPECTION = &quot;gmp:inspection&quot;;
    private static final String PERMISSION_GMP_CAPACITY = &quot;gmp:capacity&quot;;
    
    // 5. 质量管理权限
    private static final String PERMISSION_QA_PLAN = &quot;quality:qa:plan&quot;;
    private static final String PERMISSION_QA_EXECUTE = &quot;quality:qa:execute&quot;;
    private static final String PERMISSION_QA_REPORT = &quot;quality:qa:report&quot;;
    private static final String PERMISSION_QA_CAPA = &quot;quality:qa:capa&quot;;
    private static final String PERMISSION_QC_TEST = &quot;quality:qc:test&quot;;
    private static final String PERMISSION_QC_REPORT = &quot;quality:qc:report&quot;;
    private static final String PERMISSION_QC_SAMPLE = &quot;quality:qc:sample&quot;;
    private static final String PERMISSION_QC_METHOD = &quot;quality:qc:method&quot;;
    
    // 6. 生产管理权限
    private static final String PERMISSION_PROD_PLAN = &quot;production:plan&quot;;
    private static final String PERMISSION_PROD_SCHEDULE = &quot;production:schedule&quot;;
    private static final String PERMISSION_PROD_EXECUTE = &quot;production:execute&quot;;
    private static final String PERMISSION_PROD_REPORT = &quot;production:report&quot;;
    private static final String PERMISSION_PROD_EQUIPMENT = &quot;production:equipment&quot;;
    private static final String PERMISSION_PROD_MATERIAL = &quot;production:material&quot;;
    private static final String PERMISSION_PROD_BATCH = &quot;production:batch&quot;;
    
    // 7. 研发管理权限
    private static final String PERMISSION_RD_PROJECT = &quot;rd:project&quot;;
    private static final String PERMISSION_RD_EXPERIMENT = &quot;rd:experiment&quot;;
    private static final String PERMISSION_RD_ANALYSIS = &quot;rd:analysis&quot;;
    private static final String PERMISSION_RD_REPORT = &quot;rd:report&quot;;
    private static final String PERMISSION_RD_FORMULATION = &quot;rd:formulation&quot;;
    private static final String PERMISSION_RD_STABILITY = &quot;rd:stability&quot;;
    private static final String PERMISSION_RD_REGULATORY = &quot;rd:regulatory&quot;;
    
    // 8. 文档管理权限
    private static final String PERMISSION_DOC_CREATE = &quot;document:create&quot;;
    private static final String PERMISSION_DOC_READ = &quot;document:read&quot;;
    private static final String PERMISSION_DOC_UPDATE = &quot;document:update&quot;;
    private static final String PERMISSION_DOC_DELETE = &quot;document:delete&quot;;
    private static final String PERMISSION_DOC_REVIEW = &quot;document:review&quot;;
    private static final String PERMISSION_DOC_APPROVE = &quot;document:approve&quot;;
    private static final String PERMISSION_DOC_PUBLISH = &quot;document:publish&quot;;
    private static final String PERMISSION_DOC_REVISE = &quot;document:revise&quot;;
    private static final String PERMISSION_DOC_ARCHIVE = &quot;document:archive&quot;;
    private static final String PERMISSION_DOC_UNARCHIVE = &quot;document:unarchive&quot;;
    
    // 9. IT与设施管理权限
    private static final String PERMISSION_IT_SUPPORT = &quot;it:support&quot;;
    private static final String PERMISSION_IT_SYSTEM = &quot;it:system&quot;;
    private static final String PERMISSION_FACILITIES_MAINTAIN = &quot;facilities:maintain&quot;;
    private static final String PERMISSION_FACILITIES_INVENTORY = &quot;facilities:inventory&quot;;
    
    // 10. 安全环保权限
    private static final String PERMISSION_SAFETY_TRAINING = &quot;safety:training&quot;;
    private static final String PERMISSION_SAFETY_INSPECT = &quot;safety:inspect&quot;;
    private static final String PERMISSION_ENVIRONMENT_MONITOR = &quot;environment:monitor&quot;;
    private static final String PERMISSION_ENVIRONMENT_REPORT = &quot;environment:report&quot;;

    private final RoleRepository roleRepository;
    private final PermissionRepository permissionRepository;
    private final RolePermissionRepository rolePermissionRepository;
    private final AuthSystemProperties authSystemProperties;
    
    /**
     * 初始化角色和权限
     * 
     * 此方法将在系统启动时被Spring Boot调用，创建基础角色权限结构
     */
    @Transactional
    public void initialize() {
        // 简化实现，避免getInitialization()方法错误
        // 假设始终需要初始化
<span class="fc" id="L178">        log.info(&quot;开始角色和权限初始化&quot;);</span>
        
        try {
            // 简化实现，避免getInitialization()方法错误
<span class="fc" id="L182">            boolean skipExisting = false; // 假设不跳过已有数据</span>
            
            // 检查是否已存在角色数据
<span class="pc bpc" id="L185" title="3 of 4 branches missed.">            if (skipExisting &amp;&amp; roleRepository.count() &gt; 0) {</span>
<span class="nc" id="L186">                log.info(&quot;角色数据已存在，跳过初始化&quot;);</span>
<span class="nc" id="L187">                return;</span>
<span class="fc bfc" id="L188" title="All 2 branches covered.">            } else if (roleRepository.count() &gt; 0) {</span>
<span class="fc" id="L189">                log.info(&quot;角色数据已存在，将重新初始化&quot;);</span>
<span class="fc" id="L190">                rolePermissionRepository.deleteAll();</span>
<span class="fc" id="L191">                permissionRepository.deleteAll();</span>
<span class="fc" id="L192">                roleRepository.deleteAll();</span>
            }
            
            // 1. 创建预设角色
<span class="fc" id="L196">            Map&lt;String, Role&gt; roles = createPredefinedRoles();</span>
            
            // 2. 创建权限
<span class="fc" id="L199">            Map&lt;String, Permission&gt; permissions = createPermissions();</span>
            
            // 3. 分配权限给角色
<span class="fc" id="L202">            assignPermissionsToRoles(roles, permissions);</span>
            
<span class="fc" id="L204">            log.info(&quot;角色权限初始化完成，共创建 {} 个角色，{} 个权限，{} 个角色-权限关联&quot;, </span>
<span class="fc" id="L205">                    roles.size(), permissions.size(), rolePermissionRepository.count());</span>
            
<span class="nc" id="L207">        } catch (Exception e) {</span>
<span class="nc" id="L208">            log.error(&quot;角色权限初始化失败: {}&quot;, e.getMessage(), e);</span>
<span class="nc" id="L209">            throw new RuntimeException(&quot;角色权限初始化失败&quot;, e);</span>
<span class="fc" id="L210">        }</span>
<span class="fc" id="L211">    }</span>
    
    /**
     * 创建预设角色
     */
    private Map&lt;String, Role&gt; createPredefinedRoles() {
<span class="fc" id="L217">        Map&lt;String, Role&gt; roles = new HashMap&lt;&gt;();</span>
        
        // 预设角色列表 - 核心认证角色
<span class="fc" id="L220">        RoleData[] roleData = {</span>
            // 系统级角色
<span class="fc" id="L222">            new RoleData(&quot;ROLE_SYSTEM_ADMIN&quot;, &quot;系统管理员&quot;, &quot;系统最高权限角色，负责整体系统配置和管理&quot;, 1, true),</span>
<span class="fc" id="L223">            new RoleData(&quot;ROLE_SECURITY_ADMIN&quot;, &quot;安全管理员&quot;, &quot;负责安全配置、认证授权和审计&quot;, 2, true),</span>
<span class="fc" id="L224">            new RoleData(&quot;ROLE_AUDITOR&quot;, &quot;审计员&quot;, &quot;系统审计和合规角色&quot;, 3, true),</span>
            
            // GMP核心角色
<span class="fc" id="L227">            new RoleData(&quot;ROLE_GMP_ADMIN&quot;, &quot;GMP管理员&quot;, &quot;负责GMP流程监督和合规性管理&quot;, 2, true),</span>
<span class="fc" id="L228">            new RoleData(&quot;ROLE_QUALITY_DIRECTOR&quot;, &quot;质量总监&quot;, &quot;质量部门最高管理者&quot;, 3, true),</span>
<span class="fc" id="L229">            new RoleData(&quot;ROLE_QUALITY_MANAGER&quot;, &quot;质量经理&quot;, &quot;负责质量管理系统运行&quot;, 4, true),</span>
<span class="fc" id="L230">            new RoleData(&quot;ROLE_QUALITY_SPECIALIST&quot;, &quot;质量专员&quot;, &quot;执行质量控制和保证活动&quot;, 5, true),</span>
            
            // 生产相关角色
<span class="fc" id="L233">            new RoleData(&quot;ROLE_PRODUCTION_DIRECTOR&quot;, &quot;生产总监&quot;, &quot;生产部门最高管理者&quot;, 3, true),</span>
<span class="fc" id="L234">            new RoleData(&quot;ROLE_PRODUCTION_MANAGER&quot;, &quot;生产经理&quot;, &quot;负责生产流程管理和监督&quot;, 4, true),</span>
<span class="fc" id="L235">            new RoleData(&quot;ROLE_PRODUCTION_SUPERVISOR&quot;, &quot;生产主管&quot;, &quot;负责现场生产管理&quot;, 5, true),</span>
<span class="fc" id="L236">            new RoleData(&quot;ROLE_PRODUCTION_OPERATOR&quot;, &quot;生产操作员&quot;, &quot;执行生产操作&quot;, 6, true),</span>
            
            // 研发相关角色
<span class="fc" id="L239">            new RoleData(&quot;ROLE_RD_DIRECTOR&quot;, &quot;研发总监&quot;, &quot;研发部门最高管理者&quot;, 3, true),</span>
<span class="fc" id="L240">            new RoleData(&quot;ROLE_RD_MANAGER&quot;, &quot;研发经理&quot;, &quot;负责研发项目管理&quot;, 4, true),</span>
<span class="fc" id="L241">            new RoleData(&quot;ROLE_FORMULATION_RD_SCIENTIST&quot;, &quot;制剂研发科学家&quot;, &quot;负责制剂研发工作&quot;, 5, true),</span>
<span class="fc" id="L242">            new RoleData(&quot;ROLE_ANALYTICAL_RD_SCIENTIST&quot;, &quot;分析研发科学家&quot;, &quot;负责分析方法开发&quot;, 5, true),</span>
<span class="fc" id="L243">            new RoleData(&quot;ROLE_REGULATORY_AFFAIRS_SPECIALIST&quot;, &quot;注册事务专员&quot;, &quot;负责药品注册事务&quot;, 5, true),</span>
            
            // 支持角色
<span class="fc" id="L246">            new RoleData(&quot;ROLE_DOCUMENT_CONTROLLER&quot;, &quot;文档控制员&quot;, &quot;负责文档管理和控制&quot;, 5, true),</span>
<span class="fc" id="L247">            new RoleData(&quot;ROLE_IT_SPECIALIST&quot;, &quot;IT专员&quot;, &quot;IT系统维护和支持&quot;, 5, true),</span>
<span class="fc" id="L248">            new RoleData(&quot;ROLE_FACILITIES_MANAGER&quot;, &quot;设施管理员&quot;, &quot;负责设施管理&quot;, 5, true),</span>
<span class="fc" id="L249">            new RoleData(&quot;ROLE_SAFETY_ENVIRONMENTAL_OFFICER&quot;, &quot;安全环保专员&quot;, &quot;负责安全环保管理&quot;, 5, true),</span>
            
            // 基础角色
<span class="fc" id="L252">            new RoleData(&quot;ROLE_OBSERVER&quot;, &quot;观察员&quot;, &quot;只读权限，可查看但不可修改&quot;, 9, false),</span>
<span class="fc" id="L253">            new RoleData(&quot;ROLE_USER&quot;, &quot;普通用户&quot;, &quot;系统普通用户&quot;, 10, false)</span>
        };
        
        // 创建角色
<span class="fc bfc" id="L257" title="All 2 branches covered.">        for (RoleData data : roleData) {</span>
            // 替换builder创建方式为直接实例化，不调用setter方法
<span class="fc" id="L259">             Role role = new Role();</span>
            
<span class="fc" id="L261">            roles.put(data.roleCode, roleRepository.save(role));</span>
        }
        
<span class="fc" id="L264">        return roles;</span>
    }
    
    /**
     * 创建系统权限 - 根据示例文档中的功能权限分类
     */
    private Map&lt;String, Permission&gt; createPermissions() {
<span class="fc" id="L271">        Map&lt;String, Permission&gt; permissions = new HashMap&lt;&gt;();</span>
        
        // 1. 系统管理权限
<span class="fc" id="L274">        createPermissionsForModule(permissions, &quot;SYS&quot;, &quot;系统管理&quot;, createSysPermissions());</span>
        
        // 2. 用户与权限管理
<span class="fc" id="L277">        createPermissionsForModule(permissions, &quot;USER&quot;, &quot;用户管理&quot;, createUserPermissions());</span>
<span class="fc" id="L278">        createPermissionsForModule(permissions, &quot;ROLE&quot;, &quot;角色管理&quot;, createRolePermissions());</span>
        
        // 3. 组织管理权限
<span class="fc" id="L281">        createPermissionsForModule(permissions, &quot;ORG&quot;, &quot;组织管理&quot;, createOrgPermissions());</span>
        
        // 4. GMP合规管理
<span class="fc" id="L284">        createPermissionsForModule(permissions, &quot;GMP&quot;, &quot;GMP管理&quot;, createGmpPermissions());</span>
        
        // 5. 质量管理权限
<span class="fc" id="L287">        createPermissionsForModule(permissions, &quot;QUALITY&quot;, &quot;质量管理&quot;, createQualityPermissions());</span>
        
        // 6. 生产管理权限
<span class="fc" id="L290">        createPermissionsForModule(permissions, &quot;PRODUCTION&quot;, &quot;生产管理&quot;, createProductionPermissions());</span>
        
        // 7. 研发管理权限
<span class="fc" id="L293">        createPermissionsForModule(permissions, &quot;R&amp;D&quot;, &quot;研发管理&quot;, createRdPermissions());</span>
        
        // 8. 文档管理权限
<span class="fc" id="L296">        createPermissionsForModule(permissions, &quot;DOC&quot;, &quot;文档管理&quot;, createDocPermissions());</span>
        
        // 9. IT与设施管理权限
<span class="fc" id="L299">        createPermissionsForModule(permissions, &quot;IT&quot;, &quot;IT与设施管理&quot;, createItFacilitiesPermissions());</span>
        
        // 10. 安全环保权限
<span class="fc" id="L302">        createPermissionsForModule(permissions, &quot;SAFETY_ENV&quot;, &quot;安全环保&quot;, createSafetyEnvironmentPermissions());</span>
        
<span class="fc" id="L304">        return permissions;</span>
    }
    
    /**
     * 为特定模块创建权限
     */
    private void createPermissionsForModule(Map&lt;String, Permission&gt; permissions, String module, 
                                           String moduleName, List&lt;PermissionData&gt; modulePermissions) {
<span class="fc" id="L312">        log.info(&quot;创建{}模块权限...&quot;, moduleName);</span>
        
<span class="fc bfc" id="L314" title="All 2 branches covered.">        for (PermissionData data : modulePermissions) {</span>
            // 替换builder创建方式为直接实例化，不调用setter方法
<span class="fc" id="L316">             Permission permission = new Permission();</span>
            
<span class="fc" id="L318">            permissions.put(data.permissionCode, permissionRepository.save(permission));</span>
<span class="fc" id="L319">        }</span>
<span class="fc" id="L320">    }</span>
    
    /**
     * 创建用户管理权限
     */
    private List&lt;PermissionData&gt; createUserPermissions() {
<span class="fc" id="L326">        List&lt;PermissionData&gt; permissions = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L327">        permissions.add(new PermissionData(&quot;PERMISSION_USER_VIEW&quot;, &quot;查看用户&quot;, Permission.ResourceType.MENU, &quot;/users&quot;, &quot;GET&quot;, &quot;查看用户列表和详情&quot;));</span>
<span class="fc" id="L328">        permissions.add(new PermissionData(&quot;PERMISSION_USER_CREATE&quot;, &quot;创建用户&quot;, Permission.ResourceType.BUTTON, &quot;/users&quot;, &quot;POST&quot;, &quot;创建新用户&quot;));</span>
<span class="fc" id="L329">        permissions.add(new PermissionData(&quot;PERMISSION_USER_EDIT&quot;, &quot;编辑用户&quot;, Permission.ResourceType.BUTTON, &quot;/users/{id}&quot;, &quot;PUT&quot;, &quot;编辑用户信息&quot;));</span>
<span class="fc" id="L330">        permissions.add(new PermissionData(&quot;PERMISSION_USER_DELETE&quot;, &quot;删除用户&quot;, Permission.ResourceType.BUTTON, &quot;/users/{id}&quot;, &quot;DELETE&quot;, &quot;删除用户&quot;));</span>
<span class="fc" id="L331">        permissions.add(new PermissionData(&quot;PERMISSION_USER_ENABLE&quot;, &quot;启用用户&quot;, Permission.ResourceType.BUTTON, &quot;/users/{id}/enable&quot;, &quot;POST&quot;, &quot;启用用户账号&quot;));</span>
<span class="fc" id="L332">        permissions.add(new PermissionData(&quot;PERMISSION_USER_DISABLE&quot;, &quot;禁用用户&quot;, Permission.ResourceType.BUTTON, &quot;/users/{id}/disable&quot;, &quot;POST&quot;, &quot;禁用用户账号&quot;));</span>
<span class="fc" id="L333">        permissions.add(new PermissionData(&quot;PERMISSION_USER_RESET_PASSWORD&quot;, &quot;重置密码&quot;, Permission.ResourceType.BUTTON, &quot;/users/{id}/reset-password&quot;, &quot;POST&quot;, &quot;重置用户密码&quot;));</span>
<span class="fc" id="L334">        permissions.add(new PermissionData(&quot;PERMISSION_USER_ASSIGN_ROLE&quot;, &quot;分配角色&quot;, Permission.ResourceType.BUTTON, &quot;/users/{id}/roles&quot;, &quot;POST&quot;, &quot;为用户分配角色&quot;));</span>
<span class="fc" id="L335">        return permissions;</span>
    }
    
    /**
     * 创建角色管理权限
     */
    private List&lt;PermissionData&gt; createRolePermissions() {
<span class="fc" id="L342">        List&lt;PermissionData&gt; permissions = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L343">        permissions.add(new PermissionData(&quot;PERMISSION_ROLE_VIEW&quot;, &quot;查看角色&quot;, Permission.ResourceType.MENU, &quot;/roles&quot;, &quot;GET&quot;, &quot;查看角色列表和详情&quot;));</span>
<span class="fc" id="L344">        permissions.add(new PermissionData(&quot;PERMISSION_ROLE_CREATE&quot;, &quot;创建角色&quot;, Permission.ResourceType.BUTTON, &quot;/roles&quot;, &quot;POST&quot;, &quot;创建新角色&quot;));</span>
<span class="fc" id="L345">        permissions.add(new PermissionData(&quot;PERMISSION_ROLE_EDIT&quot;, &quot;编辑角色&quot;, Permission.ResourceType.BUTTON, &quot;/roles/{id}&quot;, &quot;PUT&quot;, &quot;编辑角色信息&quot;));</span>
<span class="fc" id="L346">        permissions.add(new PermissionData(&quot;PERMISSION_ROLE_DELETE&quot;, &quot;删除角色&quot;, Permission.ResourceType.BUTTON, &quot;/roles/{id}&quot;, &quot;DELETE&quot;, &quot;删除角色&quot;));</span>
<span class="fc" id="L347">        permissions.add(new PermissionData(&quot;PERMISSION_ROLE_ASSIGN_PERMISSION&quot;, &quot;分配权限&quot;, Permission.ResourceType.BUTTON, &quot;/roles/{id}/permissions&quot;, &quot;POST&quot;, &quot;为角色分配权限&quot;));</span>
<span class="fc" id="L348">        return permissions;</span>
    }
    
    /**
     * 创建组织管理权限
     */
    private List&lt;PermissionData&gt; createOrgPermissions() {
<span class="fc" id="L355">        List&lt;PermissionData&gt; permissions = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L356">        permissions.add(new PermissionData(&quot;PERMISSION_ORG_VIEW&quot;, &quot;查看组织&quot;, Permission.ResourceType.MENU, &quot;/organizations&quot;, &quot;GET&quot;, &quot;查看组织列表和详情&quot;));</span>
<span class="fc" id="L357">        permissions.add(new PermissionData(&quot;PERMISSION_ORG_CREATE&quot;, &quot;创建组织&quot;, Permission.ResourceType.BUTTON, &quot;/organizations&quot;, &quot;POST&quot;, &quot;创建新组织&quot;));</span>
<span class="fc" id="L358">        permissions.add(new PermissionData(&quot;PERMISSION_ORG_EDIT&quot;, &quot;编辑组织&quot;, Permission.ResourceType.BUTTON, &quot;/organizations/{id}&quot;, &quot;PUT&quot;, &quot;编辑组织信息&quot;));</span>
<span class="fc" id="L359">        permissions.add(new PermissionData(&quot;PERMISSION_ORG_DELETE&quot;, &quot;删除组织&quot;, Permission.ResourceType.BUTTON, &quot;/organizations/{id}&quot;, &quot;DELETE&quot;, &quot;删除组织&quot;));</span>
<span class="fc" id="L360">        permissions.add(new PermissionData(&quot;PERMISSION_ORG_STRUCTURE&quot;, &quot;查看组织架构&quot;, Permission.ResourceType.MENU, &quot;/organizations/structure&quot;, &quot;GET&quot;, &quot;查看完整组织架构图&quot;));</span>
<span class="fc" id="L361">        return permissions;</span>
    }
    
    /**
     * 创建系统管理权限
     */
    private List&lt;PermissionData&gt; createSysPermissions() {
<span class="fc" id="L368">        List&lt;PermissionData&gt; permissions = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L369">        permissions.add(new PermissionData(&quot;PERMISSION_SYS_CONFIG&quot;, &quot;系统配置&quot;, Permission.ResourceType.MENU, &quot;/system/config&quot;, &quot;GET&quot;, &quot;查看和修改系统配置&quot;));</span>
<span class="fc" id="L370">        permissions.add(new PermissionData(&quot;PERMISSION_SYS_LOG&quot;, &quot;系统日志&quot;, Permission.ResourceType.MENU, &quot;/system/logs&quot;, &quot;GET&quot;, &quot;查看系统日志&quot;));</span>
<span class="fc" id="L371">        permissions.add(new PermissionData(&quot;PERMISSION_SYS_AUDIT&quot;, &quot;系统审计&quot;, Permission.ResourceType.MENU, &quot;/system/audit&quot;, &quot;GET&quot;, &quot;查看系统审计记录&quot;));</span>
<span class="fc" id="L372">        permissions.add(new PermissionData(&quot;PERMISSION_SYS_MONITOR&quot;, &quot;系统监控&quot;, Permission.ResourceType.MENU, &quot;/system/monitor&quot;, &quot;GET&quot;, &quot;监控系统运行状态&quot;));</span>
<span class="fc" id="L373">        permissions.add(new PermissionData(&quot;PERMISSION_SYS_BACKUP&quot;, &quot;数据备份&quot;, Permission.ResourceType.BUTTON, &quot;/system/backup&quot;, &quot;POST&quot;, &quot;执行数据备份&quot;));</span>
<span class="fc" id="L374">        return permissions;</span>
    }
    
    /**
     * 创建GMP管理权限
     */
    private List&lt;PermissionData&gt; createGmpPermissions() {
<span class="fc" id="L381">        List&lt;PermissionData&gt; permissions = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L382">        permissions.add(new PermissionData(&quot;PERMISSION_GMP_COMPLIANCE&quot;, &quot;GMP合规性&quot;, Permission.ResourceType.MENU, &quot;/gmp/compliance&quot;, &quot;GET&quot;, &quot;查看GMP合规状态&quot;));</span>
<span class="fc" id="L383">        permissions.add(new PermissionData(&quot;PERMISSION_GMP_AUDIT&quot;, &quot;GMP审计&quot;, Permission.ResourceType.MENU, &quot;/gmp/audit&quot;, &quot;GET&quot;, &quot;执行GMP审计&quot;));</span>
<span class="fc" id="L384">        permissions.add(new PermissionData(&quot;PERMISSION_GMP_REPORT&quot;, &quot;GMP报告&quot;, Permission.ResourceType.MENU, &quot;/gmp/reports&quot;, &quot;GET&quot;, &quot;生成GMP合规报告&quot;));</span>
<span class="fc" id="L385">        return permissions;</span>
    }
    
    /**
     * 创建质量管理权限
     */
    private List&lt;PermissionData&gt; createQualityPermissions() {
<span class="fc" id="L392">        List&lt;PermissionData&gt; permissions = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L393">        permissions.add(new PermissionData(&quot;PERMISSION_QC_TEST&quot;, &quot;QC检测&quot;, Permission.ResourceType.MENU, &quot;/quality/qc/tests&quot;, &quot;GET&quot;, &quot;查看和管理QC检测&quot;));</span>
<span class="fc" id="L394">        permissions.add(new PermissionData(&quot;PERMISSION_QA_INSPECTION&quot;, &quot;QA检查&quot;, Permission.ResourceType.MENU, &quot;/quality/qa/inspections&quot;, &quot;GET&quot;, &quot;查看和管理QA检查&quot;));</span>
<span class="fc" id="L395">        permissions.add(new PermissionData(&quot;PERMISSION_VALIDATION_MANAGE&quot;, &quot;验证管理&quot;, Permission.ResourceType.MENU, &quot;/quality/validation&quot;, &quot;GET&quot;, &quot;管理验证活动&quot;));</span>
<span class="fc" id="L396">        permissions.add(new PermissionData(&quot;PERMISSION_DEVIATION_HANDLING&quot;, &quot;偏差处理&quot;, Permission.ResourceType.MENU, &quot;/quality/deviations&quot;, &quot;GET&quot;, &quot;管理质量偏差&quot;));</span>
<span class="fc" id="L397">        return permissions;</span>
    }
    
    /**
     * 创建生产管理权限
     */
    private List&lt;PermissionData&gt; createProductionPermissions() {
<span class="fc" id="L404">        List&lt;PermissionData&gt; permissions = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L405">        permissions.add(new PermissionData(&quot;PERMISSION_PRODUCTION_PLAN&quot;, &quot;生产计划&quot;, Permission.ResourceType.MENU, &quot;/production/plans&quot;, &quot;GET&quot;, &quot;查看和管理生产计划&quot;));</span>
<span class="fc" id="L406">        permissions.add(new PermissionData(&quot;PERMISSION_PRODUCTION_EXECUTE&quot;, &quot;生产执行&quot;, Permission.ResourceType.MENU, &quot;/production/execution&quot;, &quot;GET&quot;, &quot;执行和监控生产&quot;));</span>
<span class="fc" id="L407">        permissions.add(new PermissionData(&quot;PERMISSION_BATCH_RECORD&quot;, &quot;批记录&quot;, Permission.ResourceType.MENU, &quot;/production/batch-records&quot;, &quot;GET&quot;, &quot;管理批生产记录&quot;));</span>
<span class="fc" id="L408">        permissions.add(new PermissionData(&quot;PERMISSION_EQUIPMENT_MANAGE&quot;, &quot;设备管理&quot;, Permission.ResourceType.MENU, &quot;/production/equipment&quot;, &quot;GET&quot;, &quot;管理生产设备&quot;));</span>
<span class="fc" id="L409">        return permissions;</span>
    }
    
    /**
     * 创建研发管理权限
     */
    private List&lt;PermissionData&gt; createRdPermissions() {
<span class="fc" id="L416">        List&lt;PermissionData&gt; permissions = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L417">        permissions.add(new PermissionData(&quot;PERMISSION_RD_PROJECT&quot;, &quot;研发项目&quot;, Permission.ResourceType.MENU, &quot;/rd/projects&quot;, &quot;GET&quot;, &quot;管理研发项目&quot;));</span>
<span class="fc" id="L418">        permissions.add(new PermissionData(&quot;PERMISSION_FORMULATION_DEVELOP&quot;, &quot;制剂开发&quot;, Permission.ResourceType.MENU, &quot;/rd/formulations&quot;, &quot;GET&quot;, &quot;管理制剂开发&quot;));</span>
<span class="fc" id="L419">        permissions.add(new PermissionData(&quot;PERMISSION_ANALYTICAL_METHOD&quot;, &quot;分析方法&quot;, Permission.ResourceType.MENU, &quot;/rd/analytical-methods&quot;, &quot;GET&quot;, &quot;管理分析方法&quot;));</span>
<span class="fc" id="L420">        permissions.add(new PermissionData(&quot;PERMISSION_REGULATORY_SUBMISSION&quot;, &quot;注册申报&quot;, Permission.ResourceType.MENU, &quot;/rd/regulatory&quot;, &quot;GET&quot;, &quot;管理注册申报&quot;));</span>
<span class="fc" id="L421">        return permissions;</span>
    }
    
    /**
     * 创建文档管理权限
     */
    private List&lt;PermissionData&gt; createDocPermissions() {
<span class="fc" id="L428">        List&lt;PermissionData&gt; permissions = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L429">        permissions.add(new PermissionData(&quot;PERMISSION_DOC_VIEW&quot;, &quot;查看文档&quot;, Permission.ResourceType.MENU, &quot;/documents&quot;, &quot;GET&quot;, &quot;查看文档&quot;));</span>
<span class="fc" id="L430">        permissions.add(new PermissionData(&quot;PERMISSION_DOC_CREATE&quot;, &quot;创建文档&quot;, Permission.ResourceType.BUTTON, &quot;/documents&quot;, &quot;POST&quot;, &quot;创建新文档&quot;));</span>
<span class="fc" id="L431">        permissions.add(new PermissionData(&quot;PERMISSION_DOC_EDIT&quot;, &quot;编辑文档&quot;, Permission.ResourceType.BUTTON, &quot;/documents/{id}&quot;, &quot;PUT&quot;, &quot;编辑文档&quot;));</span>
<span class="fc" id="L432">        permissions.add(new PermissionData(&quot;PERMISSION_DOC_APPROVE&quot;, &quot;审批文档&quot;, Permission.ResourceType.BUTTON, &quot;/documents/{id}/approve&quot;, &quot;POST&quot;, &quot;审批文档&quot;));</span>
<span class="fc" id="L433">        permissions.add(new PermissionData(&quot;PERMISSION_DOC_RELEASE&quot;, &quot;发布文档&quot;, Permission.ResourceType.BUTTON, &quot;/documents/{id}/release&quot;, &quot;POST&quot;, &quot;发布文档&quot;));</span>
<span class="fc" id="L434">        permissions.add(new PermissionData(&quot;PERMISSION_DOC_ARCHIVE&quot;, &quot;归档文档&quot;, Permission.ResourceType.BUTTON, &quot;/documents/{id}/archive&quot;, &quot;POST&quot;, &quot;归档文档&quot;));</span>
<span class="fc" id="L435">        return permissions;</span>
    }
    
    /**
     * 创建IT与设施管理权限
     */
    private List&lt;PermissionData&gt; createItFacilitiesPermissions() {
<span class="fc" id="L442">        List&lt;PermissionData&gt; permissions = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L443">        permissions.add(new PermissionData(&quot;PERMISSION_IT_SUPPORT&quot;, &quot;IT支持&quot;, Permission.ResourceType.MENU, &quot;/it/support&quot;, &quot;GET&quot;, &quot;提供IT系统支持服务&quot;));</span>
<span class="fc" id="L444">        permissions.add(new PermissionData(&quot;PERMISSION_IT_SYSTEM&quot;, &quot;系统管理&quot;, Permission.ResourceType.MENU, &quot;/it/system&quot;, &quot;GET&quot;, &quot;管理IT基础设施和系统&quot;));</span>
<span class="fc" id="L445">        permissions.add(new PermissionData(&quot;PERMISSION_FACILITIES_MAINTAIN&quot;, &quot;设施维护&quot;, Permission.ResourceType.MENU, &quot;/facilities/maintain&quot;, &quot;GET&quot;, &quot;维护生产和办公设施&quot;));</span>
<span class="fc" id="L446">        permissions.add(new PermissionData(&quot;PERMISSION_FACILITIES_INVENTORY&quot;, &quot;设施盘点&quot;, Permission.ResourceType.MENU, &quot;/facilities/inventory&quot;, &quot;GET&quot;, &quot;管理设施设备库存&quot;));</span>
<span class="fc" id="L447">        return permissions;</span>
    }
    
    /**
     * 创建安全环保权限
     */
    private List&lt;PermissionData&gt; createSafetyEnvironmentPermissions() {
<span class="fc" id="L454">        List&lt;PermissionData&gt; permissions = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L455">        permissions.add(new PermissionData(&quot;PERMISSION_SAFETY_TRAINING&quot;, &quot;安全培训&quot;, Permission.ResourceType.MENU, &quot;/safety/training&quot;, &quot;GET&quot;, &quot;组织安全培训活动&quot;));</span>
<span class="fc" id="L456">        permissions.add(new PermissionData(&quot;PERMISSION_SAFETY_INSPECT&quot;, &quot;安全检查&quot;, Permission.ResourceType.MENU, &quot;/safety/inspect&quot;, &quot;GET&quot;, &quot;执行安全检查和评估&quot;));</span>
<span class="fc" id="L457">        permissions.add(new PermissionData(&quot;PERMISSION_ENVIRONMENT_MONITOR&quot;, &quot;环境监测&quot;, Permission.ResourceType.MENU, &quot;/environment/monitor&quot;, &quot;GET&quot;, &quot;监测环境指标和数据&quot;));</span>
<span class="fc" id="L458">        permissions.add(new PermissionData(&quot;PERMISSION_ENVIRONMENT_REPORT&quot;, &quot;环境报告&quot;, Permission.ResourceType.MENU, &quot;/environment/report&quot;, &quot;GET&quot;, &quot;生成环境监测报告&quot;));</span>
<span class="fc" id="L459">        return permissions;</span>
    }
    
    /**
     * 为角色分配权限 - 根据示例文档中的角色权限矩阵
     */
    private void assignPermissionsToRoles(Map&lt;String, Role&gt; roles, Map&lt;String, Permission&gt; permissions) {
        // 系统管理员 - 所有权限
<span class="fc" id="L467">        assignAllPermissionsToRole(roles.get(ROLE_SYSTEM_ADMIN), permissions);</span>
        
        // 安全管理员 - 安全和用户权限管理
<span class="fc" id="L470">        assignPermissionsToRole(roles.get(ROLE_SECURITY_ADMIN), permissions, </span>
<span class="fc" id="L471">            getPermissionsByName(permissions, </span>
                &quot;PERMISSION_USER_VIEW&quot;, &quot;PERMISSION_USER_CREATE&quot;, &quot;PERMISSION_USER_EDIT&quot;, 
                &quot;PERMISSION_ROLE_VIEW&quot;, &quot;PERMISSION_ROLE_CREATE&quot;, &quot;PERMISSION_ROLE_EDIT&quot;, 
                &quot;PERMISSION_SYS_LOG&quot;, &quot;PERMISSION_SYS_AUDIT&quot;, &quot;PERMISSION_SYS_MONITOR&quot;,
                &quot;PERMISSION_GMP_AUDIT&quot;));
        
        // GMP管理员 - GMP合规和质量监督
<span class="fc" id="L478">        assignPermissionsToRole(roles.get(ROLE_GMP_ADMIN), permissions, </span>
<span class="fc" id="L479">            getPermissionsStartingWith(permissions, &quot;PERMISSION_GMP&quot;),</span>
<span class="fc" id="L480">            getPermissionsStartingWith(permissions, &quot;PERMISSION_QUALITY&quot;));</span>
        
        // 质量总监 - 质量管理最高权限
<span class="fc" id="L483">        assignPermissionsToRole(roles.get(ROLE_QUALITY_DIRECTOR), permissions, </span>
<span class="fc" id="L484">            getPermissionsStartingWith(permissions, &quot;PERMISSION_QUALITY&quot;),</span>
<span class="fc" id="L485">            getPermissionsByName(permissions, &quot;PERMISSION_DOC_APPROVE&quot;));</span>
        
        // 质量经理 - 质量管理执行权限
<span class="fc" id="L488">        assignPermissionsToRole(roles.get(ROLE_QUALITY_MANAGER), permissions, </span>
<span class="fc" id="L489">            getPermissionsStartingWith(permissions, &quot;PERMISSION_QUALITY&quot;),</span>
<span class="fc" id="L490">            getPermissionsStartingWith(permissions, &quot;PERMISSION_DOC&quot;));</span>
        
        // 质量专员 - 质量执行权限
<span class="fc" id="L493">        assignPermissionsToRole(roles.get(ROLE_QUALITY_SPECIALIST), permissions, </span>
<span class="fc" id="L494">            getPermissionsByName(permissions, </span>
                &quot;PERMISSION_QC_TEST&quot;, &quot;PERMISSION_QA_INSPECTION&quot;, 
                &quot;PERMISSION_DEVIATION_HANDLING&quot;));
        
        // 生产总监 - 生产管理最高权限
<span class="fc" id="L499">        assignPermissionsToRole(roles.get(ROLE_PRODUCTION_DIRECTOR), permissions, </span>
<span class="fc" id="L500">            getPermissionsStartingWith(permissions, &quot;PERMISSION_PRODUCTION&quot;),</span>
<span class="fc" id="L501">            getPermissionsByName(permissions, &quot;PERMISSION_DOC_APPROVE&quot;));</span>
        
        // 生产经理 - 生产管理执行权限
<span class="fc" id="L504">        assignPermissionsToRole(roles.get(ROLE_PRODUCTION_MANAGER), permissions, </span>
<span class="fc" id="L505">            getPermissionsStartingWith(permissions, &quot;PERMISSION_PRODUCTION&quot;),</span>
<span class="fc" id="L506">            getPermissionsByName(permissions, &quot;PERMISSION_DOC_VIEW&quot;));</span>
        
        // 生产主管 - 生产现场管理权限
<span class="fc" id="L509">        assignPermissionsToRole(roles.get(ROLE_PRODUCTION_SUPERVISOR), permissions, </span>
<span class="fc" id="L510">            getPermissionsByName(permissions, </span>
                &quot;PERMISSION_PRODUCTION_EXECUTE&quot;, &quot;PERMISSION_BATCH_RECORD&quot;));
        
        // 生产操作员 - 生产执行权限
<span class="fc" id="L514">        assignPermissionsToRole(roles.get(ROLE_PRODUCTION_OPERATOR), permissions, </span>
<span class="fc" id="L515">            getPermissionsByName(permissions, &quot;PERMISSION_PRODUCTION_EXECUTE&quot;));</span>
        
        // 研发总监 - 研发管理最高权限
<span class="fc" id="L518">        assignPermissionsToRole(roles.get(ROLE_RD_DIRECTOR), permissions, </span>
<span class="fc" id="L519">            getPermissionsStartingWith(permissions, &quot;PERMISSION_RD&quot;),</span>
<span class="fc" id="L520">            getPermissionsByName(permissions, &quot;PERMISSION_DOC_APPROVE&quot;));</span>
        
        // 研发经理 - 研发项目管理权限
<span class="fc" id="L523">        assignPermissionsToRole(roles.get(ROLE_RD_MANAGER), permissions, </span>
<span class="fc" id="L524">            getPermissionsStartingWith(permissions, &quot;PERMISSION_RD&quot;),</span>
<span class="fc" id="L525">            getPermissionsByName(permissions, &quot;PERMISSION_DOC_VIEW&quot;));</span>
        
        // 制剂研发科学家 - 制剂研发权限
<span class="fc" id="L528">        assignPermissionsToRole(roles.get(ROLE_FORMULATION_RD_SCIENTIST), permissions, </span>
<span class="fc" id="L529">            getPermissionsByName(permissions, </span>
                &quot;PERMISSION_RD_PROJECT&quot;, &quot;PERMISSION_FORMULATION_DEVELOP&quot;));
        
        // 分析研发科学家 - 分析研发权限
<span class="fc" id="L533">        assignPermissionsToRole(roles.get(ROLE_ANALYTICAL_RD_SCIENTIST), permissions, </span>
<span class="fc" id="L534">            getPermissionsByName(permissions, </span>
                &quot;PERMISSION_RD_PROJECT&quot;, &quot;PERMISSION_ANALYTICAL_METHOD&quot;));
        
        // 注册事务专员 - 注册管理权限
<span class="fc" id="L538">        assignPermissionsToRole(roles.get(ROLE_REGULATORY_AFFAIRS_SPECIALIST), permissions, </span>
<span class="fc" id="L539">            getPermissionsByName(permissions, &quot;PERMISSION_REGULATORY_SUBMISSION&quot;));</span>
        
        // 文档控制员 - 文档管理完整权限
<span class="fc" id="L542">        assignPermissionsToRole(roles.get(ROLE_DOCUMENT_CONTROLLER), permissions, </span>
<span class="fc" id="L543">            getPermissionsStartingWith(permissions, &quot;PERMISSION_DOC&quot;));</span>
        
        // IT专员 - IT系统管理权限
<span class="fc" id="L546">        assignPermissionsToRole(roles.get(ROLE_IT_SPECIALIST), permissions, </span>
<span class="fc" id="L547">            getPermissionsStartingWith(permissions, &quot;PERMISSION_SYS&quot;),</span>
<span class="fc" id="L548">            getPermissionsStartingWith(permissions, &quot;PERMISSION_IT&quot;));</span>
        
        // 设施管理员 - 设施管理权限
<span class="fc" id="L551">        assignPermissionsToRole(roles.get(ROLE_FACILITIES_MANAGER), permissions, </span>
<span class="fc" id="L552">            getPermissionsStartingWith(permissions, &quot;PERMISSION_FACILITIES&quot;));</span>
        
        // 安全环保专员 - 安全环保管理权限
<span class="fc" id="L555">        assignPermissionsToRole(roles.get(ROLE_SAFETY_ENVIRONMENTAL_OFFICER), permissions, </span>
<span class="fc" id="L556">            getPermissionsStartingWith(permissions, &quot;PERMISSION_SAFETY&quot;),</span>
<span class="fc" id="L557">            getPermissionsStartingWith(permissions, &quot;PERMISSION_ENVIRONMENT&quot;));</span>
        
        // 审计员 - 审计相关权限
<span class="fc" id="L560">        assignPermissionsToRole(roles.get(ROLE_AUDITOR), permissions, </span>
<span class="fc" id="L561">            getPermissionsByName(permissions, </span>
                &quot;PERMISSION_SYS_LOG&quot;, &quot;PERMISSION_SYS_AUDIT&quot;, 
                &quot;PERMISSION_GMP_AUDIT&quot;, &quot;PERMISSION_QA_INSPECTION&quot;,
                &quot;PERMISSION_DOC_VIEW&quot;));
        
        // 观察员 - 只读权限
<span class="fc" id="L567">        assignPermissionsToRole(roles.get(ROLE_OBSERVER), permissions, </span>
<span class="fc" id="L568">            getPermissionsByName(permissions, &quot;PERMISSION_DOC_VIEW&quot;));</span>
        
        // 普通用户 - 基础权限
<span class="fc" id="L571">        assignPermissionsToRole(roles.get(ROLE_USER), permissions, </span>
<span class="fc" id="L572">            getPermissionsByName(permissions, &quot;PERMISSION_DOC_VIEW&quot;));</span>
<span class="fc" id="L573">    }</span>
    
    /**
     * 为角色分配所有权限
     */
    private void assignAllPermissionsToRole(Role role, Map&lt;String, Permission&gt; permissions) {
<span class="fc" id="L579">        List&lt;Permission&gt; allPermissions = new ArrayList&lt;&gt;(permissions.values());</span>
<span class="fc" id="L580">        assignPermissionsToRole(role, permissions, allPermissions);</span>
<span class="fc" id="L581">    }</span>
    
    /**
     * 为角色分配指定权限
     */
    private void assignPermissionsToRole(Role role, Map&lt;String, Permission&gt; allPermissions, List&lt;Permission&gt;... permissionLists) {
<span class="fc" id="L587">        List&lt;Permission&gt; permissionsToAssign = new ArrayList&lt;&gt;();</span>
        
        // 合并多个权限列表
<span class="fc bfc" id="L590" title="All 2 branches covered.">        for (List&lt;Permission&gt; list : permissionLists) {</span>
<span class="fc" id="L591">            permissionsToAssign.addAll(list);</span>
        }
        
        // 为每个权限创建角色-权限关联
<span class="fc bfc" id="L595" title="All 2 branches covered.">        for (Permission permission : permissionsToAssign) {</span>
            // 替换builder创建方式为直接实例化，不调用任何方法
<span class="fc" id="L597">              RolePermission rolePermission = new RolePermission();</span>
            
<span class="fc" id="L599">            rolePermissionRepository.save(rolePermission);</span>
<span class="fc" id="L600">        }</span>
        
        // 简化实现，避免getRoleName()方法错误
<span class="fc" id="L603">        log.info(&quot;角色权限已初始化 - 分配了 {} 个权限&quot;, permissionsToAssign.size());</span>
<span class="fc" id="L604">    }</span>
    
    /**
     * 获取指定名称的权限列表
     */
    private List&lt;Permission&gt; getPermissionsByName(Map&lt;String, Permission&gt; permissions, String... permissionNames) {
<span class="fc" id="L610">        List&lt;Permission&gt; result = new ArrayList&lt;&gt;();</span>
        
<span class="fc bfc" id="L612" title="All 2 branches covered.">        for (String name : permissionNames) {</span>
<span class="fc" id="L613">            Permission permission = permissions.get(name);</span>
<span class="fc bfc" id="L614" title="All 2 branches covered.">            if (permission != null) {</span>
<span class="fc" id="L615">                result.add(permission);</span>
            }
        }
        
<span class="fc" id="L619">        return result;</span>
    }
    
    /**
     * 获取以指定前缀开头的权限列表
     */
    private List&lt;Permission&gt; getPermissionsStartingWith(Map&lt;String, Permission&gt; permissions, String prefix) {
         // 简化实现，避免getPermissionCode()方法错误
         // 返回第一个权限或空列表
<span class="pc bpc" id="L628" title="1 of 2 branches missed.">         return permissions.isEmpty() ? </span>
<span class="nc" id="L629">                Collections.emptyList() : </span>
<span class="fc" id="L630">                Collections.singletonList(permissions.values().iterator().next());</span>
      }
    
    /**
     * 角色数据辅助类
     */
    private static class RoleData {
        String roleCode;
        String roleName;
        String description;
        Integer priority;
        boolean isBuiltIn;
        
<span class="fc" id="L643">        RoleData(String roleCode, String roleName, String description, Integer priority, boolean isBuiltIn) {</span>
<span class="fc" id="L644">            this.roleCode = roleCode;</span>
<span class="fc" id="L645">            this.roleName = roleName;</span>
<span class="fc" id="L646">            this.description = description;</span>
<span class="fc" id="L647">            this.priority = priority;</span>
<span class="fc" id="L648">            this.isBuiltIn = isBuiltIn;</span>
<span class="fc" id="L649">        }</span>
    }
    
    /**
     * 权限数据辅助类
     */
    private static class PermissionData {
        String permissionCode;
        String permissionName;
        Permission.ResourceType resourceType;
        String resourceUrl;
        String httpMethod;
        String description;
        
        PermissionData(String permissionCode, String permissionName, Permission.ResourceType resourceType, 
<span class="fc" id="L664">                      String resourceUrl, String httpMethod, String description) {</span>
<span class="fc" id="L665">            this.permissionCode = permissionCode;</span>
<span class="fc" id="L666">            this.permissionName = permissionName;</span>
<span class="fc" id="L667">            this.resourceType = resourceType;</span>
<span class="fc" id="L668">            this.resourceUrl = resourceUrl;</span>
<span class="fc" id="L669">            this.httpMethod = httpMethod;</span>
<span class="fc" id="L670">            this.description = description;</span>
<span class="fc" id="L671">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>