# 认证子系统测试改进计划

## 1. 测试现状分析
- **测试总数**：280个
- **失败测试**：26个
- **错误测试**：65个
- **通过率**：约69%
- **主要问题**：
  - ApplicationContext加载失败
  - Mock配置错误（MissingMethodInvocation）
  - 不必要的Stubbing
  - 空值/无效参数处理
  - 运行时异常

## 2. 改进目标
- **测试通过率**：≥80%
- **代码覆盖率**：≥90%
- **测试质量**：修复现有测试问题，增加边缘情况测试

## 3. 改进步骤

### 3.1 修复单元测试中的Mock配置问题
- **MfaServiceTest**：修复TotpUtils mock配置
- **UserRoleServiceImplTest**：修复参数匹配器使用错误
- **TokenBlacklistServiceTest**：移除不必要的Stubbing

### 3.2 优化集成测试的Spring上下文配置
- **AuthServiceTest**：优化@SpringBootTest配置，减少上下文加载失败
- **其他集成测试**：检查并修复Spring上下文配置

### 3.3 修复运行时异常
- **TotpUtilsTest**：修复空密钥和无效密钥的异常处理
- **AuthServiceImplTest**：修复空值构造函数调用
- **MfaServiceTest**：修复MFA验证失败问题

### 3.4 增加测试覆盖率
- **核心服务**：AuthService、MfaService、TokenBlacklistService
- **工具类**：TotpUtils、PasswordUtils等
- **边缘情况**：空值、无效参数、异常场景

### 3.5 生成测试报告和改进文档
- 运行测试并生成覆盖率报告
- 分析覆盖率数据，识别未测试代码
- 编写改进文档，放入docs/auth-sys/测试目录

## 4. 实施计划

### 4.1 第一阶段：修复现有测试问题（预计2天）
- 修复Mock配置问题
- 修复运行时异常
- 优化Spring上下文配置

### 4.2 第二阶段：提高测试覆盖率（预计3天）
- 为核心组件编写缺失的测试用例
- 增加边缘情况测试
- 确保覆盖率达到90%

### 4.3 第三阶段：生成报告和文档（预计1天）
- 运行测试并生成覆盖率报告
- 编写测试改进文档
- 验证测试通过率达到80%

## 5. 预期成果
- 测试通过率提升至80%以上
- 代码覆盖率提升至90%以上
- 修复所有现有测试问题
- 生成详细的测试改进文档
- 建立可持续的测试维护机制

## 6. 风险和应对措施
- **Spring上下文问题**：使用@MockBean替代@Mock，确保Spring容器正确管理Bean
- **Mock配置错误**：仔细检查mock对象的方法签名和参数匹配器
- **覆盖率提升困难**：优先测试核心业务逻辑，使用测试覆盖工具识别重点区域

## 7. 工具和技术栈
- **测试框架**：JUnit 5、Mockito
- **覆盖率工具**：JaCoCo
- **构建工具**：Maven
- **报告生成**：Maven Surefire Plugin、JaCoCo Maven Plugin