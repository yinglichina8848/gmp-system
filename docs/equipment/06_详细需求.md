# 设备管理系统详细需求分析

## 1. 设备基础管理模块 (Equipment Master Data)

### 1.1 功能需求

#### 1.1.1 设备台账管理
- **设备信息录入**：
  - 设备编号 (EQ-YYYY-MMDD-001)
  - 设备名称和型号规格
  - 制造商和供应商信息
  - 采购日期、安装日期
  - 设备位置和负责人

#### 1.1.2 设备分类管理
- **设备类型**：生产设备、检测设备、动力设备、辅助设备
- **设备状态**：在用、停用、维修中、报废、闲置
- **设备等级**：关键设备、一般设备、低值设备

### 1.2 数据模型

#### 1.2.1 设备主表 (equipment)
```sql
CREATE TABLE equipment (
    id BIGSERIAL PRIMARY KEY,
    equipment_code VARCHAR(50) UNIQUE NOT NULL,
    equipment_name VARCHAR(200) NOT NULL,
    equipment_type VARCHAR(50),
    model VARCHAR(100),
    serial_number VARCHAR(100),
    manufacturer VARCHAR(100),
    supplier VARCHAR(100),
    purchase_date DATE,
    installation_date DATE,
    location VARCHAR(200),
    department VARCHAR(100),
    status VARCHAR(20) DEFAULT 'IDLE',
    criticality VARCHAR(20) DEFAULT 'NORMAL', -- CRITICAL, HIGH, NORMAL, LOW
    description TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## 2. 设备维护管理模块 (Maintenance Management)

### 2.1 功能需求

#### 2.1.1 预防性维护计划
- **维护周期设置**：按时间/使用时数设定维护周期
- **维护标准制定**：维护项目、步骤、标准、耗材
- **自动提醒**：到期前7天开始提醒
- **维护工单生成**：自动生成维护任务

#### 2.1.2 故障维修管理
- **故障报告**：设备故障分类分级记录
- **维修流程**：维修申请→审批→分配→执行→验证→关闭
- **备件管理**：维修中备件领用记录
- **费用统计**：维修成本跟踪分析

### 2.2 数据模型

#### 2.2.1 维护计划表 (maintenance_plan)
```sql
CREATE TABLE maintenance_plan (
    id BIGSERIAL PRIMARY KEY,
    equipment_id BIGINT REFERENCES equipment(id),
    plan_name VARCHAR(200) NOT NULL,
    maintenance_type VARCHAR(50) NOT NULL, -- PREVENTIVE, CORRECTIVE, PREDICTIVE
    frequency_type VARCHAR(20), -- TIME, USAGE_HOURS, PRODUCTION_BATCHES
    frequency_value INTEGER,
    last_maintenance TIMESTAMP,
    next_maintenance TIMESTAMP,
    technician VARCHAR(100),
    estimated_duration INTEGER, -- minutes
    instructions TEXT,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 2.2.2 维护记录表 (maintenance_records)
```sql
CREATE TABLE maintenance_records (
    id BIGSERIAL PRIMARY KEY,
    equipment_id BIGINT REFERENCES equipment(id),
    maintenance_plan_id BIGINT REFERENCES maintenance_plan(id),
    technician VARCHAR(100) NOT NULL,
    start_time TIMESTAMP,
    end_time TIMESTAMP,
    findings TEXT,
    work_performed TEXT,
    parts_used JSONB,
    costs DECIMAL(10,2),
    status VARCHAR(20) DEFAULT 'COMPLETED',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## 3. API接口设计

### 3.1 设备管理接口

#### 3.1.1 创建设备
```
POST /api/equipment
{
    "equipmentCode": "EQ-2024-0101-001",
    "equipmentName": "混合制药反应釜",
    "equipmentType": "REACTOR",
    "model": "RP-500L",
    "manufacturer": "ABC Pharma Equipment Co.",
    "location": "提取车间A线",
    "criticality": "CRITICAL"
}
```

#### 3.1.2 查询设备列表
```
GET /api/equipment?page=0&size=20&status=ACTIVE&type=REACTOR&location=提取车间
```

## 4. 认证与安全管理模块 (Authentication & Security Management)

### 4.1 功能需求

#### 4.1.1 认证子系统集成
- **单点登录(SSO)集成**：与认证子系统集成，实现一次认证多系统访问
- **会话管理**：管理用户会话状态，支持会话超时自动注销
- **权限验证**：根据用户角色和权限控制对系统功能的访问
- **访问令牌管理**：使用JWT或OAuth2.0令牌进行API访问控制

#### 4.1.2 电子签名管理
- **电子签名捕获**：记录用户身份、时间戳和操作意图
- **签名级别**：支持单人签名和双人复核签名模式
- **签名验证**：确保签名的完整性和不可篡改性
- **签名审计**：所有签名操作必须记录完整的审计信息

#### 4.1.3 审计日志管理
- **操作日志记录**：记录所有关键操作的详细信息
- **日志查询**：支持多条件组合查询审计日志
- **日志导出**：支持导出为PDF、Excel等格式
- **日志保留**：符合GMP要求的日志保留策略（至少保存5年）

#### 4.1.4 合规性管理
- **21 CFR Part 11合规**：确保系统符合FDA电子记录和电子签名法规
- **GMP合规**：满足药品生产质量管理规范的要求
- **权限矩阵管理**：定义和维护详细的用户-角色-权限关系

### 4.2 数据模型

#### 4.2.1 审计日志表 (audit_logs)
```sql
CREATE TABLE audit_logs (
    id BIGSERIAL PRIMARY KEY,
    user_id VARCHAR(100) NOT NULL,
    username VARCHAR(100) NOT NULL,
    operation_type VARCHAR(50) NOT NULL, -- CREATE, UPDATE, DELETE, VIEW, LOGIN, LOGOUT
    entity_type VARCHAR(100),
    entity_id VARCHAR(100),
    action_details JSONB,
    ip_address VARCHAR(50),
    user_agent TEXT,
    timestamp TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    status VARCHAR(20) DEFAULT 'SUCCESS',
    error_message TEXT,
    signature_id BIGINT REFERENCES electronic_signatures(id) -- 关联电子签名
);
```

#### 4.2.2 电子签名表 (electronic_signatures)
```sql
CREATE TABLE electronic_signatures (
    id BIGSERIAL PRIMARY KEY,
    user_id VARCHAR(100) NOT NULL,
    username VARCHAR(100) NOT NULL,
    password_verified BOOLEAN NOT NULL,
    signature_intent TEXT NOT NULL,
    signature_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    verification_level VARCHAR(20) DEFAULT 'SINGLE', -- SINGLE, DOUBLE_VERIFICATION
    verifying_user_id VARCHAR(100),
    verifying_username VARCHAR(100),
    signature_metadata JSONB
);
```

## 5. API接口设计补充

### 5.1 认证相关接口

#### 5.1.1 获取认证令牌
```
POST /api/auth/login
{
    "username": "technician01",
    "password": "password123",
    "clientId": "equipment-management-system"
}
```

#### 5.1.2 刷新认证令牌
```
POST /api/auth/refresh
{
    "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

### 5.2 电子签名接口

#### 5.2.1 创建电子签名
```
POST /api/signatures
{
    "username": "technician01",
    "password": "password123",
    "intent": "确认完成设备维护操作",
    "operationId": "MAINT-2024-0101-001"
}
```

#### 5.2.2 验证电子签名
```
POST /api/signatures/verify
{
    "signatureId": 123,
    "verifyingUsername": "supervisor01",
    "verifyingPassword": "password123"
}
```

### 5.3 审计日志接口

#### 5.3.1 查询审计日志
```
GET /api/audit-logs?page=0&size=20&username=technician01&operationType=UPDATE&startDate=2024-01-01&endDate=2024-01-31
```

#### 5.3.2 导出审计日志
```
GET /api/audit-logs/export?format=pdf&username=technician01&operationType=SIGNATURE&startDate=2024-01-01&endDate=2024-01-31
```

### 5.4 安全要求补充

所有API接口必须满足以下安全要求：
- 所有接口调用必须包含有效的认证令牌（Bearer Token）
- 敏感操作必须验证用户权限
- 关键数据修改操作必须要求电子签名确认
- 所有接口调用必须记录审计日志
- 使用HTTPS加密传输所有数据
- 实施API访问频率限制，防止暴力攻击

---

**文档信息：**
- 版本：v1.1
- 编制人员：详细需求分析团队
- 状态：Updated
- 更新内容：新增认证与安全管理模块详细需求
