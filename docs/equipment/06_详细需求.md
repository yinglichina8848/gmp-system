# 设备管理系统详细需求分析

## 1. 设备基础管理模块 (Equipment Master Data)

### 1.1 功能需求

#### 1.1.1 设备台账管理
- **设备信息录入**：
  - 设备编号 (EQ-YYYY-MMDD-001)
  - 设备名称和型号规格
  - 制造商和供应商信息
  - 采购日期、安装日期
  - 设备位置和负责人
  - 中药专用设备特有属性（如适用于中药材炮制、提取等）

#### 1.1.2 设备分类管理
- **设备类型**：生产设备、检测设备、动力设备、辅助设备
- **设备状态**：在用、停用、维修中、报废、闲置
- **设备等级**：关键设备、一般设备、低值设备
- **中药专用设备分类**：中药材炮制设备、中药提取设备、中药干燥设备、中药检验设备

### 1.2 数据模型

#### 1.2.1 设备主表 (equipment)
```sql
CREATE TABLE equipment (
    id BIGSERIAL PRIMARY KEY,
    equipment_code VARCHAR(50) UNIQUE NOT NULL,
    equipment_name VARCHAR(200) NOT NULL,
    equipment_type VARCHAR(50),
    model VARCHAR(100),
    serial_number VARCHAR(100),
    manufacturer VARCHAR(100),
    supplier VARCHAR(100),
    purchase_date DATE,
    installation_date DATE,
    location VARCHAR(200),
    department VARCHAR(100),
    status VARCHAR(20) DEFAULT 'IDLE',
    criticality VARCHAR(20) DEFAULT 'NORMAL', -- CRITICAL, HIGH, NORMAL, LOW
    description TEXT,
    is_tcm_equipment BOOLEAN DEFAULT FALSE, -- 是否为中药专用设备
    tcm_equipment_type VARCHAR(50), -- 中药设备类型：HERB_CLEANING, HERB_CUTTING, HERB_DRYING, HERB_EXTRACTING, HERB_GRINDING
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## 2. 设备维护管理模块 (Maintenance Management)

### 2.1 功能需求

#### 2.1.1 预防性维护计划
- **维护周期设置**：按时间/使用时数设定维护周期
- **维护标准制定**：维护项目、步骤、标准、耗材
- **自动提醒**：到期前7天开始提醒
- **维护工单生成**：自动生成维护任务
- **中药设备专项维护**：针对中药专用设备的特殊维护要求

#### 2.1.2 故障维修管理
- **故障报告**：设备故障分类分级记录
- **维修流程**：维修申请→审批→分配→执行→验证→关闭
- **备件管理**：维修中备件领用记录
- **费用统计**：维修成本跟踪分析
- **中药设备维修**：中药专用设备的特殊维修要求和记录

### 2.2 数据模型

#### 2.2.1 维护计划表 (maintenance_plan)
```sql
CREATE TABLE maintenance_plan (
    id BIGSERIAL PRIMARY KEY,
    equipment_id BIGINT REFERENCES equipment(id),
    plan_name VARCHAR(200) NOT NULL,
    maintenance_type VARCHAR(50) NOT NULL, -- PREVENTIVE, CORRECTIVE, PREDICTIVE
    frequency_type VARCHAR(20), -- TIME, USAGE_HOURS, PRODUCTION_BATCHES
    frequency_value INTEGER,
    last_maintenance TIMESTAMP,
    next_maintenance TIMESTAMP,
    technician VARCHAR(100),
    estimated_duration INTEGER, -- minutes
    instructions TEXT,
    is_tcm_maintenance BOOLEAN DEFAULT FALSE, -- 是否为中药设备专项维护
    tcm_maintenance_requirements TEXT, -- 中药设备维护特殊要求
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 2.2.2 维护记录表 (maintenance_records)
```sql
CREATE TABLE maintenance_records (
    id BIGSERIAL PRIMARY KEY,
    equipment_id BIGINT REFERENCES equipment(id),
    maintenance_plan_id BIGINT REFERENCES maintenance_plan(id),
    technician VARCHAR(100) NOT NULL,
    start_time TIMESTAMP,
    end_time TIMESTAMP,
    findings TEXT,
    work_performed TEXT,
    parts_used JSONB,
    costs DECIMAL(10,2),
    status VARCHAR(20) DEFAULT 'COMPLETED',
    tcm_maintenance_details JSONB, -- 中药设备维护详情
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## 3. API接口设计

### 3.1 设备管理接口

#### 3.1.1 创建设备
```
POST /api/equipment
{
    "equipmentCode": "EQ-2024-0101-001",
    "equipmentName": "混合制药反应釜",
    "equipmentType": "REACTOR",
    "model": "RP-500L",
    "manufacturer": "ABC Pharma Equipment Co.",
    "location": "提取车间A线",
    "criticality": "CRITICAL",
    "isTcmEquipment": true,
    "tcmEquipmentType": "HERB_EXTRACTING"
}
```

#### 3.1.2 查询设备列表
```
GET /api/equipment?page=0&size=20&status=ACTIVE&type=REACTOR&location=提取车间&tcmEquipment=true
```

## 4. 认证与安全管理模块 (Authentication & Security Management)

### 4.1 功能需求

#### 4.1.1 认证子系统集成
- **单点登录(SSO)集成**：与认证子系统集成，实现一次认证多系统访问
- **会话管理**：管理用户会话状态，支持会话超时自动注销
- **权限验证**：根据用户角色和权限控制对系统功能的访问
- **访问令牌管理**：使用JWT或OAuth2.0令牌进行API访问控制

#### 4.1.2 电子签名管理
- **电子签名捕获**：记录用户身份、时间戳和操作意图
- **签名级别**：支持单人签名和双人复核签名模式
- **签名验证**：确保签名的完整性和不可篡改性
- **签名审计**：所有签名操作必须记录完整的审计信息

#### 4.1.3 审计日志管理
- **操作日志记录**：记录所有关键操作的详细信息
- **日志查询**：支持多条件组合查询审计日志
- **日志导出**：支持导出为PDF、Excel等格式
- **日志保留**：符合GMP要求的日志保留策略（至少保存5年）

#### 4.1.4 合规性管理
- **21 CFR Part 11合规**：确保系统符合FDA电子记录和电子签名法规
- **GMP合规**：满足药品生产质量管理规范的要求
- **权限矩阵管理**：定义和维护详细的用户-角色-权限关系
- **中药设备管理合规**：满足中药设备管理的特殊合规要求

### 4.2 数据模型

#### 4.2.1 审计日志表 (audit_logs)
```sql
CREATE TABLE audit_logs (
    id BIGSERIAL PRIMARY KEY,
    user_id VARCHAR(100) NOT NULL,
    username VARCHAR(100) NOT NULL,
    operation_type VARCHAR(50) NOT NULL, -- CREATE, UPDATE, DELETE, VIEW, LOGIN, LOGOUT
    entity_type VARCHAR(100),
    entity_id VARCHAR(100),
    action_details JSONB,
    ip_address VARCHAR(50),
    user_agent TEXT,
    timestamp TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    status VARCHAR(20) DEFAULT 'SUCCESS',
    error_message TEXT,
    signature_id BIGINT REFERENCES electronic_signatures(id) -- 关联电子签名
);
```

#### 4.2.2 电子签名表 (electronic_signatures)
```sql
CREATE TABLE electronic_signatures (
    id BIGSERIAL PRIMARY KEY,
    user_id VARCHAR(100) NOT NULL,
    username VARCHAR(100) NOT NULL,
    password_verified BOOLEAN NOT NULL,
    signature_intent TEXT NOT NULL,
    signature_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    verification_level VARCHAR(20) DEFAULT 'SINGLE', -- SINGLE, DOUBLE_VERIFICATION
    verifying_user_id VARCHAR(100),
    verifying_username VARCHAR(100),
    signature_metadata JSONB
);
```

## 5. 中药专用设备管理模块 (TCM Equipment Management)

### 5.1 功能需求

#### 5.1.1 中药炮制设备管理
- **设备类型管理**：
  - 清洗设备：用于中药材清洗去杂
  - 切制设备：用于中药材切片、切段、切块
  - 炒制设备：用于中药材炒黄、炒焦、炒炭
  - 炙制设备：用于中药材酒炙、醋炙、盐炙、蜜炙
  - 蒸制设备：用于中药材蒸制、炖制
  - 煅制设备：用于中药材明煅、煅淬

- **工艺参数管理**：
  - 温度控制参数
  - 时间控制参数
  - 火力控制参数
  - 辅料添加参数

#### 5.1.2 中药提取设备管理
- **设备类型管理**：
  - 煎煮设备：多功能提取罐、动态提取罐
  - 回流设备：回流提取器
  - 渗漉设备：渗漉器
  - 超声波提取设备
  - 微波提取设备

- **工艺参数管理**：
  - 提取温度控制
  - 提取时间控制
  - 溶剂比控制
  - 压力控制参数

#### 5.1.3 中药干燥设备管理
- **设备类型管理**：
  - 晒干设备：自然晾晒场
  - 阴干设备：通风干燥室
  - 烘干设备：热风循环烘箱、带式干燥机
  - 冷冻干燥设备

- **工艺参数管理**：
  - 干燥温度控制
  - 干燥时间控制
  - 湿度控制参数
  - 风速控制参数

### 5.2 数据模型

#### 5.2.1 中药设备工艺参数表 (tcm_equipment_parameters)
```sql
CREATE TABLE tcm_equipment_parameters (
    id BIGSERIAL PRIMARY KEY,
    equipment_id BIGINT REFERENCES equipment(id),
    parameter_name VARCHAR(100) NOT NULL,
    parameter_type VARCHAR(50) NOT NULL, -- TEMPERATURE, TIME, PRESSURE, HUMIDITY
    min_value DECIMAL(10,2),
    max_value DECIMAL(10,2),
    optimal_value DECIMAL(10,2),
    unit VARCHAR(20),
    description TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 5.2.2 中药设备验证记录表 (tcm_equipment_validation)
```sql
CREATE TABLE tcm_equipment_validation (
    id BIGSERIAL PRIMARY KEY,
    equipment_id BIGINT REFERENCES equipment(id),
    validation_type VARCHAR(50) NOT NULL, -- IQ, OQ, PQ
    validation_date DATE NOT NULL,
    validator VARCHAR(100),
    validation_results JSONB,
    next_validation_date DATE,
    status VARCHAR(20) DEFAULT 'PENDING', -- PENDING, PASSED, FAILED
    remarks TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## 6. API接口设计补充

### 6.1 中药设备管理接口

#### 6.1.1 创建中药设备
```
POST /api/equipment/tcm
{
    "equipmentCode": "TCM-EQ-2024-0101-001",
    "equipmentName": "中药材炒制机",
    "equipmentType": "PROCESSING_EQUIPMENT",
    "model": "TCM-CZ-500",
    "manufacturer": "中药设备制造有限公司",
    "location": "炮制车间A线",
    "criticality": "HIGH",
    "isTcmEquipment": true,
    "tcmEquipmentType": "HERB_ROASTING",
    "tcmParameters": [
        {
            "parameterName": "炒制温度",
            "parameterType": "TEMPERATURE",
            "minValue": 100,
            "maxValue": 300,
            "optimalValue": 200,
            "unit": "℃"
        },
        {
            "parameterName": "炒制时间",
            "parameterType": "TIME",
            "minValue": 5,
            "maxValue": 60,
            "optimalValue": 20,
            "unit": "分钟"
        }
    ]
}
```

#### 6.1.2 查询中药设备列表
```
GET /api/equipment?tcmEquipment=true&equipmentType=PROCESSING_EQUIPMENT
```

## 7. 附录

### 7.1 参考文档
- GMP法规（2010版）
- 《中国药典》（2020年版）
- 中药材生产质量管理规范（GAP）
- 设备管理子系统总体需求文档
- 中药材检验子系统需求文档

### 7.2 版本历史
| 版本 | 修改日期 | 修改内容 | 修改人 |
|------|---------|---------|--------|
| v1.0.0 | 2024-01-15 | 初始版本 | 设备管理系统团队 |
| v1.1.0 | 2025-11-27 | 增加中药专用设备管理功能 | 系统分析师 |