# GMP信息管理系统架构设计文档

## 1. 总体架构设计

### 1.1 架构原则
- **微服务架构**：各业务模块独立部署，便于维护和扩展
- **前后端分离**：前端Vue.js + 后端Spring Boot微服务
- **容器化部署**：使用Docker实现环境一致性
- **API网关**：统一入口，实现认证、限流、路由
- **数据一致性**：通过事件驱动保证最终一致性

### 1.2 技术栈选型

| 层级 | 技术选型 | 说明 |
|------|----------|------|
| **前端** | Vue.js 3 + Element Plus | 响应式UI框架，支持移动端 |
| **网关** | Spring Cloud Gateway | API网关，统一认证和路由 |
| **后端** | Spring Boot 3.x + Java 17 | 微服务框架，现代化Java |
| **数据库** | PostgreSQL + Redis | 主数据库 + 缓存 |
| **消息队列** | RabbitMQ | 异步通信，解耦服务 |
| **文件存储** | MinIO | 对象存储，支持大文件 |
| **监控** | Prometheus + Grafana | 系统监控和告警 |
| **部署** | Docker + Docker Compose | 容器化部署 |

## 2. 微服务架构设计

### 2.1 服务划分

```
┌─────────────────────────────────────────────────────────┐
│                   前端应用层 (Vue.js)                    │
├─────────────────────────────────────────────────────────┤
│    桌面应用      │     移动应用     │    管理控制台     │
└─────────────────────────────────────────────────────────┘
                                ▼
┌─────────────────────────────────────────────────────────┐
│                   API网关层 (Gateway)                    │
└─────────────────────────────────────────────────────────┘
                                ▼
┌─────────────┬─────────────┬─────────────┬─────────────┐
│   QMS服务   │   MES服务   │  LIMS服务   │   EDMS服务  │
│   (8081)    │   (8082)    │   (8083)    │   (8084)    │
└─────────────┴─────────────┴─────────────┴─────────────┘
                                ▼
┌─────────────┬─────────────┬─────────────┬─────────────┐
│  认证服务   │  配置服务   │  消息服务   │  文件服务   │
│   (8085)    │   (8086)    │   (8087)    │   (8088)    │
└─────────────┴─────────────┴─────────────┴─────────────┘
                                ▼
┌─────────────┬─────────────┬─────────────┬─────────────┐
│  CRM服务    │ 移动应用服务 │ 仓库管理服务 │  AI服务     │
│   (8089)    │   (8090)    │   (8091)    │   (8092)    │
└─────────────┴─────────────┴─────────────┴─────────────┘
                                ▼
┌─────────────────────────────────────────────────────────┐
│                   基础设施层                             │
│   PostgreSQL + Redis + RabbitMQ + MinIO + AI模型服务    │
└─────────────────────────────────────────────────────────┘
```

### 2.2 服务详细说明

#### 2.2.1 QMS服务 (质量管理系统)
- **端口**：8081
- **主要功能**：偏差管理、CAPA、变更控制、审计管理
- **数据库**：qms_db
- **API示例**：
  - POST /api/qms/deviations - 创建偏差
  - GET /api/qms/capas - 查询CAPA列表
  - PUT /api/qms/changes/{id} - 更新变更

#### 2.2.2 MES服务 (生产执行系统)
- **端口**：8082
- **主要功能**：生产订单、批次记录、设备管理、物料追踪
- **数据库**：mes_db
- **API示例**：
  - POST /api/mes/batches - 创建生产批次
  - GET /api/mes/orders - 查询生产订单
  - PUT /api/mes/equipment/{id}/status - 更新设备状态

#### 2.2.3 LIMS服务 (实验室管理系统)
- **端口**：8083
- **主要功能**：样品管理、检验计划、检验结果、仪器管理
- **数据库**：lims_db
- **API示例**：
  - POST /api/lims/samples - 创建样品
  - GET /api/lims/tests - 查询检验任务
  - PUT /api/lims/results/{id} - 录入检验结果

#### 2.2.4 EDMS服务 (电子文档管理系统)
- **端口**：8084
- **主要功能**：文档管理、版本控制、审批流程、电子签名
- **数据库**：edms_db
- **API示例**：
  - POST /api/edms/documents - 上传文档
  - GET /api/edms/versions/{docId} - 查询文档版本
  - POST /api/edms/approvals - 发起审批

#### 2.2.5 认证服务 (Auth)
- **端口**：8085
- **主要功能**：用户认证、授权管理、JWT token生成、角色权限管理
- **数据库**：auth_db
- **API示例**：
  - POST /api/auth/login - 用户登录
  - POST /api/auth/logout - 用户登出
  - GET /api/auth/roles - 查询角色列表

#### 2.2.6 配置服务 (Config)
- **端口**：8086
- **主要功能**：集中配置管理、动态配置刷新、配置版本控制、环境隔离
- **数据库**：config_db
- **API示例**：
  - GET /api/config/{serviceId} - 获取服务配置
  - POST /api/config - 新增配置
  - PUT /api/config/{id} - 更新配置

#### 2.2.7 消息服务 (Message)
- **端口**：8087
- **主要功能**：消息队列管理、实时消息推送、消息模板管理、消息日志记录
- **数据库**：message_db
- **API示例**：
  - POST /api/message/send - 发送消息
  - GET /api/message/templates - 查询消息模板
  - GET /api/message/logs - 查询消息发送记录

#### 2.2.8 文件服务 (File)
- **端口**：8088
- **主要功能**：文件上传下载、文件存储管理、文件权限控制、文件版本管理
- **数据库**：file_db (文件元数据) + MinIO (文件内容)
- **API示例**：
  - POST /api/file/upload - 上传文件
  - GET /api/file/download/{fileId} - 下载文件
  - GET /api/file/metadata/{fileId} - 获取文件元数据

#### 2.2.9 CRM销售服务 (CRM)
- **端口**：8089
- **主要功能**：客户管理、销售订单、销售预测、客户服务、销售报表
- **数据库**：crm_db
- **API示例**：
  - POST /api/crm/customers - 创建客户
  - GET /api/crm/orders - 查询销售订单
  - POST /api/crm/forecasts - 生成销售预测

#### 2.2.10 移动应用服务 (Mobile)
- **端口**：8090
- **主要功能**：移动认证、数据同步、离线操作、推送通知、设备管理
- **数据库**：mobile_db
- **API示例**：
  - POST /api/mobile/auth - 移动设备认证
  - GET /api/mobile/sync - 获取同步数据
  - POST /api/mobile/offline/save - 保存离线数据

#### 2.2.11 仓库管理服务 (WMS)
- **端口**：8091
- **主要功能**：物料管理、库位管理、库存管理、出入库管理、盘点管理
- **数据库**：wms_db
- **API示例**：
  - POST /api/wms/receipts - 创建入库单
  - GET /api/wms/inventory - 查询库存
  - POST /api/wms/issuances - 创建出库单

#### 2.2.12 AI智能分析服务 (AI)
- **端口**：8092
- **主要功能**：预测模型、异常检测、数据分析、报表生成、模型管理
- **数据库**：ai_db (模型元数据) + PostgreSQL (分析结果)
- **API示例**：
  - POST /api/ai/predict - 执行预测
  - GET /api/ai/anomalies - 查询异常检测结果
  - POST /api/ai/models/train - 训练模型

## 3. 数据库设计

### 3.1 核心数据模型

#### 3.1.1 质量管理模块 (QMS)
```sql
-- 偏差管理表
CREATE TABLE deviations (
    id BIGSERIAL PRIMARY KEY,
    deviation_number VARCHAR(50) UNIQUE NOT NULL,
    title VARCHAR(200) NOT NULL,
    description TEXT,
    severity VARCHAR(20) CHECK (severity IN ('LOW', 'MEDIUM', 'HIGH', 'CRITICAL')),
    status VARCHAR(20) DEFAULT 'OPEN',
    reported_by VARCHAR(100) NOT NULL,
    reported_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    due_date TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- CAPA表
CREATE TABLE capas (
    id BIGSERIAL PRIMARY KEY,
    capa_number VARCHAR(50) UNIQUE NOT NULL,
    deviation_id BIGINT REFERENCES deviations(id),
    description TEXT,
    root_cause_analysis TEXT,
    corrective_action TEXT,
    preventive_action TEXT,
    status VARCHAR(20) DEFAULT 'OPEN',
    due_date TIMESTAMP,
    completed_date TIMESTAMP,
    effectiveness_check TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 3.1.2 生产管理模块 (MES)
```sql
-- 生产批次表
CREATE TABLE production_batches (
    id BIGSERIAL PRIMARY KEY,
    batch_number VARCHAR(50) UNIQUE NOT NULL,
    product_id BIGINT NOT NULL,
    product_name VARCHAR(200) NOT NULL,
    planned_quantity DECIMAL(10,3),
    actual_quantity DECIMAL(10,3),
    status VARCHAR(20) DEFAULT 'PLANNED',
    start_time TIMESTAMP,
    end_time TIMESTAMP,
    equipment_id BIGINT,
    operator_id BIGINT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 批次记录表
CREATE TABLE batch_records (
    id BIGSERIAL PRIMARY KEY,
    batch_id BIGINT REFERENCES production_batches(id),
    step_number INTEGER NOT NULL,
    step_name VARCHAR(200) NOT NULL,
    parameter_name VARCHAR(100),
    parameter_value DECIMAL(10,3),
    unit VARCHAR(20),
    min_value DECIMAL(10,3),
    max_value DECIMAL(10,3),
    actual_value DECIMAL(10,3),
    operator_id BIGINT,
    recorded_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    remarks TEXT
);
```

#### 3.1.3 实验室管理模块 (LIMS)
```sql
-- 样品表
CREATE TABLE samples (
    id BIGSERIAL PRIMARY KEY,
    sample_number VARCHAR(50) UNIQUE NOT NULL,
    batch_id BIGINT,
    sample_type VARCHAR(100) NOT NULL,
    received_date TIMESTAMP,
    test_plan TEXT,
    status VARCHAR(20) DEFAULT 'RECEIVED',
    assigned_to VARCHAR(100),
    due_date TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 检验结果表
CREATE TABLE test_results (
    id BIGSERIAL PRIMARY KEY,
    sample_id BIGINT REFERENCES samples(id),
    test_item VARCHAR(200) NOT NULL,
    specification TEXT,
    result_value DECIMAL(10,6),
    result_unit VARCHAR(20),
    result_status VARCHAR(20) CHECK (result_status IN ('PASS', 'FAIL', 'PENDING')),
    tested_by VARCHAR(100),
    tested_date TIMESTAMP,
    instrument_id BIGINT,
    remarks TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## 4. API接口设计

### 4.1 统一响应格式
```json
{
    "success": true,
    "code": 200,
    "message": "操作成功",
    "data": {},
    "timestamp": "2024-01-01T00:00:00Z"
}
```

### 4.2 认证接口
```java
// 登录接口
POST /api/auth/login
{
    "username": "user001",
    "password": "encrypted_password"
}

// 响应
{
    "success": true,
    "data": {
        "token": "jwt_token",
        "userInfo": {
            "userId": 1,
            "username": "user001",
            "roles": ["QUALITY_MANAGER", "OPERATOR"]
        }
    }
}
```

### 4.3 质量管理接口示例
```java
// 创建偏差
POST /api/qms/deviations
{
    "title": "生产过程中温度超标",
    "description": "提取工序温度超过设定值5℃",
    "severity": "MEDIUM",
    "reportedBy": "operator001",
    "dueDate": "2024-01-10T00:00:00Z"
}

// 查询偏差列表
GET /api/qms/deviations?page=0&size=20&status=OPEN

// 更新偏差状态
PUT /api/qms/deviations/{id}/status
{
    "status": "IN_PROGRESS",
    "remarks": "已指派质量工程师处理"
}
```

## 5. 安全设计

### 5.1 认证授权
- **JWT Token**：无状态认证
- **RBAC模型**：基于角色的访问控制
- **Session管理**：Redis存储会话信息
- **密码策略**：BCrypt加密，定期更换

### 5.2 数据安全
- **数据加密**：敏感数据AES加密存储
- **传输安全**：HTTPS加密传输
- **审计日志**：所有操作记录审计日志
- **数据备份**：定期备份，异地存储

### 5.3 GMP合规安全
- **电子签名**：符合FDA 21 CFR Part 11要求
- **审计追踪**：所有数据变更记录
- **版本控制**：文档和记录版本管理
- **访问控制**：严格的权限管理

## 6. 性能设计

### 6.1 缓存策略
- **Redis缓存**：热点数据缓存
- **本地缓存**：配置信息缓存
- **CDN加速**：静态资源加速
- **数据库优化**：索引优化，查询优化

### 6.2 负载均衡
- **服务发现**：Consul或Eureka
- **负载均衡**：Nginx负载均衡
- **弹性伸缩**：根据负载自动扩缩容
- **故障转移**：主备切换机制

## 7. 监控设计

### 7.1 应用监控
- **健康检查**：服务健康状态监控
- **性能指标**：响应时间、吞吐量监控
- **错误监控**：异常和错误监控
- **业务指标**：关键业务指标监控

### 7.2 基础设施监控
- **服务器监控**：CPU、内存、磁盘监控
- **网络监控**：网络延迟、带宽监控
- **数据库监控**：连接数、慢查询监控
- **日志监控**：日志分析和告警

## 8. 部署架构

### 8.1 开发环境
```yaml
# docker-compose-dev.yml
version: '3.8'
services:
  postgres:
    image: postgres:13
    environment:
      POSTGRES_DB: gmp_dev
      POSTGRES_USER: dev_user
      POSTGRES_PASSWORD: dev_pass
    ports:
      - "5432:5432"
    
  redis:
    image: redis:6-alpine
    ports:
      - "6379:6379"
    
  qms-service:
    build: ./qms-service
    ports:
      - "8081:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=dev
    depends_on:
      - postgres
      - redis
```

### 8.2 生产环境
```yaml
# docker-compose-prod.yml
version: '3.8'
services:
  # 数据库集群
  postgres-master:
    image: postgres:13
    environment:
      POSTGRES_DB: gmp_prod
      POSTGRES_USER: prod_user
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    deploy:
      replicas: 1
    
  postgres-slave:
    image: postgres:13
    environment:
      POSTGRES_DB: gmp_prod
      POSTGRES_USER: prod_user
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    deploy:
      replicas: 1
    
  # 微服务集群
  qms-service:
    build: ./qms-service
    deploy:
      replicas: 2
    environment:
      - SPRING_PROFILES_ACTIVE=prod
```

## 9. 容灾设计

### 9.1 数据备份
- **实时备份**：数据库主从复制
- **定期备份**：全量备份 + 增量备份
- **异地备份**：跨机房数据备份
- **恢复测试**：定期恢复演练

### 9.2 服务容灾
- **多副本部署**：关键服务多副本
- **自动故障转移**：服务自动切换
- **降级策略**：非核心功能降级
- **限流保护**：防止雪崩效应

---

**文档版本**：v1.0
**更新日期**：2024年
**编制人员**：架构设计团队