# EDMS子系统（电子文档管理系统）详细需求分析

## 1. 文档管理模块 (Document Management)

### 1.1 功能需求

#### 1.1.1 文档创建与编辑
- **文档模板选择**：系统提供预定义的文档模板（SOP、规范、记录等）
- **所见即所得编辑**：支持富文本编辑，包括表格、图片、列表等
- **草稿保存**：自动保存草稿功能，防止数据丢失
- **版本控制**：新版本创建时自动备份上一版本
- **元数据管理**：自动提取或手动录入文档属性（标题、作者、部门、文件类型等）

#### 1.1.2 文档存储与组织
- **层级分类**：支持多级文档分类体系
- **标签管理**：支持标签标记，便于快速检索
- **全文索引**：对文档内容进行全文索引，支持关键词搜索
- **权限控制**：基于角色和部门的文档访问权限

### 1.2 数据模型

#### 1.2.1 文档表 (documents)
```sql
CREATE TABLE documents (
    id BIGSERIAL PRIMARY KEY,
    document_number VARCHAR(50) UNIQUE NOT NULL, -- DOC-YYYY-MMDD-001
    title VARCHAR(200) NOT NULL,
    document_type VARCHAR(50) NOT NULL, -- SOP, SPECIFICATION, RECORD, MANUAL
    category VARCHAR(100), -- 分类路径，用/分隔
    status VARCHAR(20) DEFAULT 'DRAFT', -- DRAFT, IN_REVIEW, APPROVED, EFFECTIVE, WITHDRAWN
    current_version VARCHAR(20) DEFAULT '1.0',
    template_id BIGINT, -- 关联的模板ID
    owner_department VARCHAR(100),
    author VARCHAR(100) NOT NULL,
    approver VARCHAR(100),
    effective_date TIMESTAMP,
    expiry_date TIMESTAMP,
    retention_period INTEGER, -- 保留期(月)
    confidentiality_level VARCHAR(20) DEFAULT 'NORMAL', -- NORMAL, CONFIDENTIAL, RESTRICTED
    file_path VARCHAR(500), -- 存储路径
    file_size BIGINT,
    content_type VARCHAR(100), -- MIME类型
    checksum VARCHAR(128), -- SHA256校验和
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 1.2.2 文档版本表 (document_versions)
```sql
CREATE TABLE document_versions (
    id BIGSERIAL PRIMARY KEY,
    document_id BIGINT REFERENCES documents(id) ON DELETE CASCADE,
    version_number VARCHAR(20) NOT NULL,
    version_type VARCHAR(20) DEFAULT 'REVISION', -- REVISION, MAJOR, MINOR
    change_reason TEXT, -- 变更原因说明
    change_summary TEXT, -- 变更内容摘要
    author VARCHAR(100) NOT NULL,
    reviewer VARCHAR(100),
    approver VARCHAR(100),
    approval_date TIMESTAMP,
    file_path VARCHAR(500),
    file_size BIGINT,
    checksum VARCHAR(128),
    is_current BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## 2. 审批工作流模块 (Approval Workflow)

### 2.1 功能需求

#### 2.1.1 流程配置
- **可视化流程设计**：拖拽式流程设计器
- **节点类型**：支持串行审批、并行审批、条件分支
- **角色绑定**：将审批节点绑定到具体角色或人员
- **时间管控**：设置审批时限和自动提醒

#### 2.1.2 审批处理
- **任务分派**：系统自动根据流程规则分派审批任务
- **审批意见**：支持填写审批意见和修改建议
- **电子签名**：审批时自动附加电子签名
- **超时处理**：超期自动升级或转发

### 2.2 数据模型

#### 2.2.1 审批流程表 (approval_workflows)
```sql
CREATE TABLE approval_workflows (
    id BIGSERIAL PRIMARY KEY,
    workflow_code VARCHAR(50) UNIQUE NOT NULL,
    workflow_name VARCHAR(200) NOT NULL,
    document_type VARCHAR(50), -- 适用的文档类型
    workflow_definition TEXT, -- JSON格式的工作流定义
    version VARCHAR(20) DEFAULT '1.0',
    is_active BOOLEAN DEFAULT TRUE,
    created_by VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 2.2.2 审批实例表 (approval_instances)
```sql
CREATE TABLE approval_instances (
    id BIGSERIAL PRIMARY KEY,
    workflow_id BIGINT REFERENCES approval_workflows(id),
    document_id BIGINT REFERENCES documents(id),
    initiator VARCHAR(100) NOT NULL, -- 发起人
    current_step VARCHAR(50), -- 当前步骤名称
    status VARCHAR(20) DEFAULT 'IN_PROGRESS', -- IN_PROGRESS, APPROVED, REJECTED, WITHDRAWN
    priority VARCHAR(20) DEFAULT 'NORMAL',
    started_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMP,
    deadline TIMESTAMP, -- 完成截止时间
    comments TEXT, -- 整体审批意见
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## 3. 检索与访问模块 (Search & Access)

### 3.1 功能需求

#### 3.1.1 多维度检索
- **基础检索**：按标题、编号、作者、日期等字段检索
- **内容检索**：全文内容搜索，支持关键词高亮
- **高级检索**：组合多个检索条件，支持布尔逻辑
- **分类浏览**：按分类体系进行浏览导航

#### 3.1.2 访问控制
- **权限验证**：访问时动态验证用户权限
- **审计记录**：记录所有访问行为和操作痕迹
- **离线访问**：重要文档支持离线下载和查看（权限控制）
- **过期提醒**：文档过期或即将过期时提前提醒

### 3.2 数据模型

#### 3.2.1 文档访问记录表 (document_access_logs)
```sql
CREATE TABLE document_access_logs (
    id BIGSERIAL PRIMARY KEY,
    document_id BIGINT REFERENCES documents(id),
    document_version_id BIGINT REFERENCES document_versions(id),
    user_id VARCHAR(100) NOT NULL,
    user_name VARCHAR(200),
    user_department VARCHAR(100),
    access_type VARCHAR(20) NOT NULL, -- VIEW, DOWNLOAD, PRINT, EDIT, DELETE
    access_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    session_id VARCHAR(50), -- 会话标识
    ip_address VARCHAR(45), -- IPv4/IPv6地址
    user_agent TEXT, -- 浏览器信息
    success BOOLEAN DEFAULT TRUE, -- 是否成功
    error_message VARCHAR(500) -- 错误信息
);
```

## 4. 版本控制与合规模块 (Version Control & Compliance)

### 4.1 功能需求

#### 4.1.1 版本管控
- **自动版本号**：新增版本自动计算版本号（major.minor.revision）
- **版本比较**：可视化显示版本差异
- **版本冻结**：重要文档版本可以冻结防止意外修改
- **历史追溯**：可查看任意历史版本的完整信息

#### 4.1.2 合规性保障
- **审计追踪**：所有文档操作都有完整的审计日志
- **电子签名**：关键操作要求电子签名验证身份
- **数据完整性**：防止文档内容被篡改，数字签名保护
- **生命周期管理**：文档从创建到销毁的完整生命周期追踪

### 3.2 数据模型

#### 3.2.1 电子签名记录表 (electronic_signatures)
```sql
CREATE TABLE electronic_signatures (
    id BIGSERIAL PRIMARY KEY,
    document_id BIGINT REFERENCES documents(id),
    document_version_id BIGINT REFERENCES document_versions(id),
    signer_id VARCHAR(100) NOT NULL, -- 签署人ID
    signer_name VARCHAR(200),
    signer_role VARCHAR(100),
    signature_type VARCHAR(20) NOT NULL, -- APPROVE, REVIEW, CREATE, WITHDRAW
    signature_data TEXT, -- 签名数据（JSON格式）
    signature_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    ip_address VARCHAR(45),
    certificate_info TEXT, -- 证书信息JSON
    validity_status VARCHAR(20) DEFAULT 'VALID', -- VALID, INVALID, EXPIRED
    verification_result BOOLEAN DEFAULT TRUE
);
```

#### 3.2.2 文档合规记录表 (document_compliance_logs)
```sql
CREATE TABLE document_compliance_logs (
    id BIGSERIAL PRIMARY KEY,
    document_id BIGINT REFERENCES documents(id),
    compliance_type VARCHAR(50) NOT NULL, -- GMP_REQUIREMENT, COMPANY_POLICY, REGULATORY
    compliance_standard VARCHAR(200),
    check_result VARCHAR(20) NOT NULL, -- COMPLIANT, NON_COMPLIANT, NOT_APPLICABLE
    checked_by VARCHAR(100),
    checked_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    notes TEXT,
    corrective_action TEXT, -- 纠正措施
    follow_up_date TIMESTAMP -- 后续跟进日期
);
```

## 5. REST API接口设计

### 5.1 文档管理接口

#### 5.1.1 创建文档
```
POST /api/edms/documents
Content-Type: multipart/form-data

{
    title: "新的SOP文档",
    documentType: "SOP",
    category: "生产管理/质量控制",
    content: "<富文本内容>",
    attachments: [file1, file2]
}
```

#### 5.1.2 文档检索
```
GET /api/edms/documents/search?query=质量控制&page=0&size=20&sort=updatedAt,desc
```

### 5.2 审批流程接口

#### 5.2.1 提交审批
```
POST /api/edms/documents/{id}/submit-approval
{
    "workflowCode": "SOP_APPROVAL",
    "priority": "NORMAL",
    "comments": "请审批新的质量控制SOP"
}
```

#### 5.2.2 执行审批
```
POST /api/edms/approvals/{instanceId}/step/{stepId}/action
{
    "action": "APPROVE",
    "comments": "内容完整，同意发布",
    "signature": "数字签名数据"
}
```

### 5.3 数据验证规则

#### 5.3.1 文档验证
- 文件大小限制（最大100MB）
- 文件类型支持（PDF, DOC, DOCX, XLS, XLSX等）
- 必填字段校验（标题、文档类型、作者等）
- 权限验证（创建者必须有对应权限）
- 唯一性校验（文档编号全局唯一）

#### 5.3.2 审批验证
- 用户权限校验（必须是审批流程中的节点负责人）
- 操作时效校验（在有效时间内操作）
- 重复操作防护（防止重复审批）

## 6. 数据库设计要点

### 6.1 索引优化
- 文档状态和类型联合索引
- 全文搜索索引（使用PostgreSQL的全文搜索功能）
- 时间范围查询索引（创建时间、审批时间等）
- 用户权限索引（基于用户和文档的访问控制）

### 6.2 数据完整性
- 外键约束：确保文档版本、审批实例等关联关系正确
- 枚举约束：状态、类型等字段使用预定义枚举值
- 数据级联：重要数据的级联删除和更新策略

### 6.3 性能优化
- **缓存策略**：热点文档内容缓存，权限信息缓存
- **异步处理**：大文件上传、复杂的全文索引建立使用异步处理
- **读写分离**：可能的话实现数据库读写分离

---

**文档信息：**
- 版本：v1.0
- 更新日期：2024年
- 编制人员：详细需求分析团队
- 状态：Draft
