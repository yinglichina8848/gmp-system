# 文档变更控制与版本管理详细设计文档

## 1. 概述

### 1.1 文档目的
本文档详细描述EDMS（电子文档管理系统）中的文档变更控制与版本管理功能设计，包括版本控制机制、变更审批流程、差异比较、历史追溯等核心功能，确保在GMP环境下文档变更符合合规要求，保证文档的完整性、可追溯性和有效性。

### 1.2 适用范围
适用于EDMS系统中所有受控文档的变更控制、版本管理、历史记录维护和合规审计支持。

### 1.3 术语定义
- **文档**：指在EDMS系统中管理的各类文件，包括SOP、质量标准、批记录等
- **版本**：文档在生命周期中的不同修订状态
- **主版本**：重大变更导致的版本号升级（如从1.0到2.0）
- **次版本**：小幅修改导致的版本号升级（如从1.1到1.2）
- **基线版本**：经过正式审批并生效的文档版本
- **变更请求**：对现有文档提出的修改申请
- **变更控制**：管理和控制文档从申请修改到最终发布的整个过程
- **差异比较**：对比不同版本文档内容的变化

## 2. 设计原则

### 2.1 合规性原则
- 符合GMP（21 CFR Part 11、EU GMP Annex 11等）关于电子记录和电子签名的要求
- 确保所有文档变更可追溯、可审计
- 支持电子签名验证和授权管理

### 2.2 完整性原则
- 完整保存文档的所有历史版本
- 记录所有变更操作的详细日志
- 确保版本切换的一致性和可靠性

### 2.3 用户友好原则
- 提供直观的版本比较功能
- 简化变更申请和审批流程
- 清晰展示文档的版本历史和当前状态

### 2.4 安全性原则
- 严格的权限控制，确保只有授权用户可进行变更操作
- 变更内容的完整性保护，防止未授权修改
- 版本数据的安全存储和备份

## 3. 系统架构

### 3.1 整体架构
![版本管理架构图]

版本管理模块作为EDMS核心组件，与工作流引擎、用户权限管理、电子签名和审计追踪模块紧密集成，共同构成完整的文档变更控制体系。

### 3.2 核心组件
- **版本管理器**：负责文档版本的创建、存储、检索和比较
- **变更控制器**：管理变更请求的生命周期
- **差异比较引擎**：分析和展示不同版本间的内容差异
- **版本状态管理器**：跟踪和维护文档版本的状态流转
- **集成接口**：与工作流、电子签名和审计模块的交互接口

## 4. 数据模型设计

### 4.1 核心数据实体

#### 4.1.1 文档主表(Document)
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| document_id | UUID | 主键 | 文档唯一标识 |
| document_title | VARCHAR(255) | NOT NULL | 文档标题 |
| document_type | VARCHAR(50) | NOT NULL | 文档类型 |
| current_version | VARCHAR(20) | NOT NULL | 当前版本号 |
| status | VARCHAR(50) | NOT NULL | 文档状态 |
| department_id | UUID | NOT NULL | 所属部门 |
| created_by | UUID | NOT NULL | 创建人 |
| created_at | TIMESTAMP | NOT NULL | 创建时间 |
| last_updated_at | TIMESTAMP | NOT NULL | 最后更新时间 |

#### 4.1.2 文档版本表(Document_Version)
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| version_id | UUID | 主键 | 版本唯一标识 |
| document_id | UUID | 外键 | 关联文档ID |
| version_number | VARCHAR(20) | NOT NULL | 版本号 |
| version_type | VARCHAR(20) | NOT NULL | 版本类型(主版本/次版本) |
| file_path | VARCHAR(500) | NOT NULL | 文件存储路径 |
| file_size | BIGINT | NOT NULL | 文件大小 |
| file_hash | VARCHAR(255) | NOT NULL | 文件校验和 |
| created_by | UUID | NOT NULL | 创建人 |
| created_at | TIMESTAMP | NOT NULL | 创建时间 |
| approved_by | UUID | NULL | 审批人 |
| approved_at | TIMESTAMP | NULL | 审批时间 |
| effective_date | DATE | NULL | 生效日期 |
| expiry_date | DATE | NULL | 过期日期 |
| change_summary | TEXT | NULL | 变更摘要 |

#### 4.1.3 变更请求表(Change_Request)
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| request_id | UUID | 主键 | 请求唯一标识 |
| document_id | UUID | 外键 | 关联文档ID |
| request_type | VARCHAR(50) | NOT NULL | 变更类型 |
| request_reason | TEXT | NOT NULL | 变更原因 |
| requested_by | UUID | NOT NULL | 申请人 |
| requested_at | TIMESTAMP | NOT NULL | 申请时间 |
| request_status | VARCHAR(50) | NOT NULL | 请求状态 |
| implementation_notes | TEXT | NULL | 实施说明 |
| approval_comments | TEXT | NULL | 审批意见 |

#### 4.1.4 版本差异表(Version_Diff)
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| diff_id | UUID | 主键 | 差异记录ID |
| from_version_id | UUID | 外键 | 源版本ID |
| to_version_id | UUID | 外键 | 目标版本ID |
| diff_content | JSONB | NOT NULL | 差异内容 |
| created_at | TIMESTAMP | NOT NULL | 创建时间 |

### 4.2 数据关系
- 文档主表与文档版本表：一对多关系
- 文档主表与变更请求表：一对多关系
- 文档版本表与版本差异表：多对多关系（通过from_version_id和to_version_id）
- 文档版本表与电子签名表：一对多关系
- 文档版本表与审计记录表：一对多关系

## 5. 功能设计

### 5.1 文档版本控制

#### 5.1.1 版本创建
- **自动版本编号**：根据版本类型自动生成版本号（主版本：X.0，次版本：X.Y）
- **版本初始化**：新文档默认创建1.0版本
- **版本升级**：支持手动选择主版本升级或次版本升级
- **版本继承**：新版本继承前一版本的基本属性和元数据

#### 5.1.2 版本存储
- **完整存储**：每个版本保存完整的文档内容
- **增量存储**：对大型文档实现增量存储优化
- **文件格式**：支持多种文档格式（PDF、Word、Excel、图片等）
- **压缩存储**：对历史版本进行压缩存储，优化存储空间

#### 5.1.3 版本检索与访问
- **版本列表**：显示文档的所有历史版本
- **版本预览**：支持在线预览任意历史版本
- **版本下载**：支持下载指定版本的文档
- **版本比较**：支持选择任意两个版本进行差异比较

### 5.2 变更控制流程

#### 5.2.1 变更申请
- **变更请求表单**：提供标准的变更请求表单
- **变更类型选择**：支持选择不同类型的变更（内容修改、格式调整、政策更新等）
- **变更原因说明**：要求提供详细的变更理由
- **预期效果说明**：要求说明变更的预期效果和影响范围

#### 5.2.2 变更审批
- **多级审批流程**：支持配置多级审批流程
- **审批路线配置**：可根据文档类型、变更类型等配置不同的审批路线
- **并行审批**：支持多个审批人并行审批
- **审批意见收集**：记录审批人的详细意见
- **审批通知**：自动发送审批通知给相关人员

#### 5.2.3 变更实施
- **文档编辑**：在隔离环境中进行文档编辑
- **变更跟踪**：记录编辑过程中的所有修改
- **变更摘要生成**：自动生成变更摘要
- **电子签名**：实施完成后需要执行人电子签名确认

#### 5.2.4 变更发布
- **发布审批**：最终发布前的审批确认
- **版本生效**：设置新版本的生效日期
- **旧版本处理**：自动将旧版本标记为历史版本
- **发布通知**：自动通知相关人员文档已更新

### 5.3 差异比较功能

#### 5.3.1 文本差异比较
- **行级比较**：显示行级别的增加、删除和修改
- **字符级比较**：显示字符级别的具体变化
- **颜色标记**：使用不同颜色标记增加、删除和修改内容
- **导航功能**：支持快速定位到变更位置

#### 5.3.2 表格差异比较
- **单元格级别比较**：显示表格中每个单元格的变化
- **行列增删显示**：清晰显示新增或删除的行和列
- **数据变化统计**：统计表格数据的变更数量

#### 5.3.3 图像差异比较
- **图像对比视图**：并排显示图像变化
- **变化高亮**：高亮显示图像中变化的区域
- **放大功能**：支持放大查看细节变化

### 5.4 历史记录与审计

#### 5.4.1 操作日志记录
- **版本操作记录**：记录所有版本相关操作
- **变更操作记录**：记录变更流程中的每一步操作
- **访问记录**：记录文档版本的访问历史
- **操作详情**：记录操作人、时间、IP地址等详细信息

#### 5.4.2 审计报告生成
- **版本审计报告**：生成文档版本变更的审计报告
- **变更流程报告**：生成变更控制流程的审计报告
- **合规性检查**：验证变更流程是否符合预定义的合规要求
- **报告导出**：支持多种格式导出审计报告

## 6. 工作流设计

### 6.1 文档版本变更流程

#### 6.1.1 标准变更流程
1. **变更申请**：文档所有者提交变更请求
2. **初步审核**：文档管理员进行初步审核
3. **技术审核**：技术专家审核变更内容
4. **质量审核**：质量部门审核合规性
5. **最终批准**：授权人员最终批准
6. **实施变更**：更新文档内容
7. **发布新版本**：发布并生效新版本
8. **通知相关方**：通知所有相关人员

#### 6.1.2 紧急变更流程
1. **紧急申请**：提交紧急变更请求
2. **快速审核**：简化的审核流程
3. **临时批准**：临时批准实施
4. **实施变更**：立即更新文档
5. **事后追认**：正式流程事后补全
6. **合规审核**：验证紧急流程的合规性

### 6.2 版本状态流转

#### 6.2.1 版本状态定义
- **草稿**：版本创建后尚未提交审批
- **审核中**：版本已提交等待审批
- **已批准**：版本已获得批准但未生效
- **已生效**：版本正式生效使用
- **已过期**：版本已超过有效期
- **已废止**：版本被正式废止

#### 6.2.2 状态流转图
```
草稿 → 审核中 → 已批准 → 已生效 → 已过期
        ↓          ↓          ↓
       拒绝      撤回       废止
```

## 7. 接口设计

### 7.1 内部接口

#### 7.1.1 版本管理接口
- **创建版本**
  - URL: /api/version/create
  - 方法: POST
  - 参数: documentId, versionType, changeSummary
  - 返回: versionId, versionNumber

- **获取版本列表**
  - URL: /api/version/list/{documentId}
  - 方法: GET
  - 返回: 版本列表信息

- **获取版本详情**
  - URL: /api/version/{versionId}
  - 方法: GET
  - 返回: 版本详细信息

- **比较版本差异**
  - URL: /api/version/compare
  - 方法: POST
  - 参数: fromVersionId, toVersionId
  - 返回: 差异内容

#### 7.1.2 变更控制接口
- **创建变更请求**
  - URL: /api/change-request/create
  - 方法: POST
  - 参数: documentId, requestType, requestReason
  - 返回: requestId

- **提交审批**
  - URL: /api/change-request/submit/{requestId}
  - 方法: POST
  - 参数: comment, signature
  - 返回: 提交结果

- **审批变更请求**
  - URL: /api/change-request/approve/{requestId}
  - 方法: POST
  - 参数: action, comment, signature
  - 返回: 审批结果

- **执行变更**
  - URL: /api/change-request/execute/{requestId}
  - 方法: POST
  - 参数: documentContent, signature
  - 返回: 执行结果

### 7.2 外部接口

#### 7.2.1 与工作流引擎接口
- **启动审批流程**
  - 方法: 调用工作流引擎API
  - 参数: workflowType, documentInfo, approvers
  - 返回: workflowInstanceId

- **更新流程状态**
  - 方法: 调用工作流引擎API
  - 参数: workflowInstanceId, status, action
  - 返回: 更新结果

#### 7.2.2 与电子签名接口
- **验证签名**
  - 方法: 调用电子签名API
  - 参数: userId, signature, timestamp
  - 返回: 验证结果

- **记录签名**
  - 方法: 调用电子签名API
  - 参数: documentId, versionId, userId, signature
  - 返回: 记录结果

#### 7.2.3 与审计追踪接口
- **记录审计日志**
  - 方法: 调用审计追踪API
  - 参数: action, resource, userId, details
  - 返回: 记录结果

## 8. 安全设计

### 8.1 访问控制
- **基于角色的访问控制**：不同角色拥有不同的版本管理权限
- **操作权限分离**：创建、审批、发布权限分离
- **版本特定权限**：可针对特定版本设置访问权限
- **时间限制访问**：可设置临时访问权限

### 8.2 数据保护
- **传输加密**：所有版本操作通过HTTPS加密传输
- **存储加密**：版本文件存储时进行加密
- **完整性校验**：使用文件哈希确保版本完整性
- **防篡改机制**：一旦版本发布，禁止未授权修改

### 8.3 合规性控制
- **电子签名要求**：关键操作必须进行电子签名
- **审计跟踪**：所有操作都有详细的审计日志
- **权限审批链**：严格的多级审批链确保合规
- **合规检查点**：在流程关键节点设置合规检查

## 9. 性能优化

### 9.1 版本存储优化
- **增量存储**：对大型文档实施增量存储
- **压缩存储**：历史版本数据压缩存储
- **分层存储**：热数据和冷数据分离存储
- **缓存机制**：频繁访问的版本缓存处理

### 9.2 检索性能优化
- **索引优化**：优化版本检索的数据库索引
- **搜索引擎集成**：集成全文搜索引擎
- **预加载机制**：常用版本预加载到内存
- **分页加载**：大量版本数据分页加载

### 9.3 差异比较优化
- **异步比较**：大文件差异比较异步处理
- **比较算法优化**：优化差异比较算法
- **增量比较**：利用增量比较减少计算量
- **结果缓存**：缓存常用的版本比较结果

## 10. 测试策略

### 10.1 功能测试
- **版本控制测试**：测试版本创建、检索、比较功能
- **变更流程测试**：测试变更申请、审批、实施流程
- **权限测试**：测试不同角色的权限控制
- **集成测试**：测试与其他模块的集成功能

### 10.2 性能测试
- **版本创建性能**：测试大量版本创建的性能
- **检索响应时间**：测试版本检索的响应时间
- **差异比较性能**：测试大文件差异比较的性能
- **并发操作测试**：测试多用户并发操作的性能

### 10.3 合规性测试
- **审计跟踪测试**：验证审计日志的完整性
- **电子签名测试**：测试电子签名的有效性
- **权限控制测试**：验证权限控制的严格性
- **流程合规测试**：验证变更流程的合规性

## 11. 部署与实施

### 11.1 部署要求
- **硬件要求**：根据文档数量和访问量确定服务器配置
- **存储要求**：足够的存储空间用于版本文件存储
- **数据库要求**：高性能数据库支持版本数据存储
- **备份要求**：定期备份版本数据

### 11.2 实施计划
- **准备阶段**：系统配置和环境准备
- **试点实施**：选择部分文档进行试点
- **全面推广**：全系统文档的版本管理实施
- **培训支持**：用户培训和技术支持

## 12. 维护与支持

### 12.1 日常维护
- **版本清理**：定期清理不必要的临时版本
- **存储管理**：监控存储使用情况
- **性能监控**：监控系统性能指标
- **日志管理**：定期归档审计日志

### 12.2 故障处理
- **版本恢复**：版本数据损坏时的恢复流程
- **权限修复**：权限配置错误的修复方法
- **性能优化**：性能问题的诊断和优化
- **集成问题**：与其他系统集成问题的解决

### 12.3 升级管理
- **版本管理模块升级**：模块升级的流程和注意事项
- **数据迁移**：升级时的历史版本数据迁移
- **兼容性管理**：确保向后兼容性
- **升级测试**：升级前的全面测试

## 13. 附录

### 13.1 相关文档
- EDMS系统整体架构设计文档
- EDMS工作流引擎设计文档
- EDMS电子签名系统设计文档
- EDMS审计追踪功能设计文档

### 13.2 版本历史
| 版本号 | 修改日期 | 修改人 | 修改内容 |
|-------|---------|--------|----------|
| 1.0 | 2023-04-15 | 系统架构师 | 初始版本 |
| 1.1 | 2023-05-20 | 系统架构师 | 优化数据模型和接口设计 |
| 1.2 | 2023-06-10 | 质量经理 | 更新合规性要求和审计设计 |

### 13.3 审批记录
| 审批阶段 | 审批人 | 审批日期 | 审批意见 |
|---------|-------|---------|----------|
| 技术审核 | 技术总监 | 2023-04-20 | 同意 |
| 质量审核 | 质量总监 | 2023-04-25 | 同意 |
| 最终批准 | IT总监 | 2023-04-30 | 批准实施 |