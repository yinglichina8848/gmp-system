# 文档生命周期管理设计文档

## 1. 概述

### 1.1 文档目的
本文档详细描述EDMS（电子文档管理系统）中的文档生命周期管理（Document Lifecycle Management）功能设计，涵盖文档从创建、审核、发布、使用、变更、归档到销毁的完整生命周期过程，确保在GMP环境下文档管理的规范性、合规性和可追溯性。

### 1.2 适用范围
适用于EDMS系统中所有受控文档的全生命周期管理，包括但不限于标准操作程序(SOP)、质量标准、操作规程、批记录模板、验证文件等GMP相关文档。

### 1.3 术语定义
- **文档生命周期**：文档从创建到最终归档或销毁的完整过程
- **受控文档**：需要严格管理和控制的正式文档
- **生命周期阶段**：文档在生命周期中经历的不同状态（如草稿、审核中、已发布等）
- **状态转换**：文档从一个生命周期阶段转变到另一个阶段的过程
- **触发条件**：导致文档状态发生变化的事件或条件
- **保留期限**：文档需要保留的最小时间长度
- **归档**：将不再活跃使用但需要长期保存的文档移至归档存储
- **销毁**：安全地删除超过保留期限且无需继续保存的文档
- **有效性控制**：确保只有最新有效版本的文档被使用的机制

## 2. 设计原则

### 2.1 合规性原则
- 符合GMP、21 CFR Part 11、EU GMP Annex 11等法规要求
- 确保文档全过程可追溯、可审计
- 支持电子签名和审批流程
- 保证文档的真实性、完整性和可靠性

### 2.2 全生命周期管理原则
- 覆盖文档从创建到销毁的完整过程
- 明确定义每个生命周期阶段的特性和要求
- 规范状态转换的规则和权限
- 提供全程自动化管理和控制

### 2.3 版本控制原则
- 严格的版本控制机制
- 明确区分主版本和次版本
- 保证新版本发布时旧版本的正确处理
- 提供完整的版本历史记录和查询

### 2.4 安全性原则
- 基于角色的访问控制
- 文档操作的权限分离
- 敏感操作的多级授权
- 全面的操作审计记录

## 3. 文档生命周期模型

### 3.1 生命周期阶段定义

#### 3.1.1 阶段划分
文档生命周期划分为以下核心阶段：

1. **创建阶段（Creation）**
   - 文档起草和初步编写
   - 文档基本属性定义
   - 初始版本创建

2. **审核阶段（Review）**
   - 多级审核流程
   - 内容和格式检查
   - 技术和合规性审核

3. **批准阶段（Approval）**
   - 最终审批
   - 电子签名确认
   - 批准记录生成

4. **发布阶段（Publication）**
   - 文档正式发布
   - 通知相关人员
   - 生效日期设置

5. **使用阶段（Active Use）**
   - 文档日常使用
   - 访问和检索
   - 定期评审

6. **变更阶段（Change）**
   - 变更申请
   - 变更评估
   - 修改和重新审批

7. **归档阶段（Archival）**
   - 文档归档处理
   - 长期存储
   - 历史查询支持

8. **销毁阶段（Destruction）**
   - 销毁申请和审批
   - 安全删除
   - 销毁记录生成

### 3.2 状态转换模型

#### 3.2.1 状态转换图
```
创建 → 审核 → 批准 → 发布 → 使用 → 变更 → 审核 → 批准 → 发布 → 使用 → 归档 → 销毁
  ↓       ↓       ↓       ↓       ↓
 废弃    退回    退回    撤回    废止
```

#### 3.2.2 主要转换路径
- **正常流程**：创建 → 审核 → 批准 → 发布 → 使用 → 归档 → 销毁
- **变更流程**：使用 → 变更 → 审核 → 批准 → 发布 → 使用
- **异常流程**：各阶段均可进入废弃/退回/撤回/废止状态

### 3.3 生命周期规则

#### 3.3.1 阶段规则配置
每个生命周期阶段配置以下规则：
- **时间规则**：阶段停留时长限制，超时提醒
- **权限规则**：阶段允许的操作和授权用户
- **审核规则**：审核人数、审核方式和通过条件
- **通知规则**：阶段转换时的通知对象和方式
- **合规规则**：满足的法规要求和合规检查点

#### 3.3.2 文档类型差异化配置
根据文档类型配置不同的生命周期规则：
- **SOP文档**：完整的多级审核流程，长期保留
- **批记录**：严格的完整性控制，长期归档
- **质量标准**：正式的批准流程，定期评审
- **临时文档**：简化流程，短期保留

## 4. 功能设计

### 4.1 文档创建管理

#### 4.1.1 文档模板管理
- **模板创建与管理**：创建和维护标准化文档模板
- **模板权限控制**：设置模板的使用权限
- **模板版本管理**：模板本身的版本控制
- **模板使用统计**：跟踪模板使用情况

#### 4.1.2 文档初始化
- **基于模板创建**：从模板快速创建新文档
- **属性定义**：设置文档标题、类型、部门、作者等属性
- **保留期设置**：定义文档的保留期限
- **分类与标签**：设置文档分类和搜索标签

### 4.2 审核与批准流程

#### 4.2.1 审核工作流
- **多级审核配置**：支持设置多级审核流程
- **审核人分配**：自动或手动分配审核人
- **并行/串行审核**：支持并行或串行审核模式
- **审核意见收集**：记录详细的审核意见
- **审核跟踪**：实时跟踪审核进度

#### 4.2.2 批准管理
- **最终审批流程**：正式的最终审批环节
- **电子签名验证**：强制电子签名确认
- **批准记录生成**：生成正式的批准记录
- **紧急批准机制**：特殊情况下的紧急批准流程

### 4.3 发布与分发

#### 4.3.1 文档发布
- **正式发布处理**：文档正式发布流程
- **版本生效控制**：设置生效日期和时间
- **发布通知**：自动通知相关人员
- **发布记录生成**：记录发布详情

#### 4.3.2 文档分发
- **分发范围定义**：设置文档分发的用户或部门
- **分发方式配置**：配置分发渠道（系统内通知、邮件等）
- **阅读确认**：要求接收者确认阅读
- **分发状态跟踪**：监控分发状态和阅读情况

### 4.4 使用与维护

#### 4.4.1 文档访问控制
- **基于角色的访问**：根据用户角色控制文档访问
- **基于属性的访问**：根据文档属性和用户属性动态控制
- **时间限制访问**：临时访问权限设置
- **访问日志记录**：记录所有访问操作

#### 4.4.2 文档使用监控
- **使用频率分析**：跟踪文档使用情况
- **异常使用检测**：识别异常访问模式
- **使用效果评估**：评估文档的实用性和有效性
- **使用统计报告**：生成使用情况统计报告

### 4.5 变更控制

#### 4.5.1 变更申请
- **变更请求表单**：标准化的变更申请表单
- **变更原因分析**：要求提供详细的变更理由
- **变更影响评估**：评估变更可能的影响范围
- **变更请求审批**：变更请求的初步审批

#### 4.5.2 变更实施
- **变更文档编辑**：在隔离环境中进行文档修改
- **变更内容审核**：审核变更的具体内容
- **变更验证**：验证变更的正确性和有效性
- **变更历史记录**：完整记录变更历史

### 4.6 归档管理

#### 4.6.1 归档触发机制
- **自动归档**：基于规则自动触发归档
- **手动归档**：手动发起归档请求
- **归档审批**：归档操作的审批流程
- **归档前检查**：归档前的完整性和合规性检查

#### 4.6.2 归档存储管理
- **归档存储策略**：归档数据的存储策略
- **存储介质选择**：适合长期存储的介质选择
- **归档索引管理**：维护归档文档的索引
- **归档检索支持**：提供归档文档的检索功能

### 4.7 销毁管理

#### 4.7.1 销毁流程
- **销毁申请**：提交文档销毁申请
- **保留期验证**：验证文档是否超过保留期限
- **销毁审批**：多级销毁审批流程
- **销毁执行**：安全执行文档销毁

#### 4.7.2 销毁验证与记录
- **销毁验证**：验证文档是否完全销毁
- **销毁记录生成**：生成正式的销毁记录
- **销毁证明**：提供销毁证明文件
- **合规性确认**：确认销毁符合法规要求

## 5. 数据模型设计

### 5.1 核心数据实体

#### 5.1.1 文档主表(Document)
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| document_id | UUID | 主键 | 文档唯一标识 |
| title | VARCHAR(255) | NOT NULL | 文档标题 |
| document_type | VARCHAR(50) | NOT NULL | 文档类型 |
| current_version | VARCHAR(20) | NOT NULL | 当前版本号 |
| lifecycle_stage | VARCHAR(50) | NOT NULL | 当前生命周期阶段 |
| status | VARCHAR(50) | NOT NULL | 文档状态 |
| department_id | UUID | NOT NULL | 所属部门ID |
| author_id | UUID | NOT NULL | 创建人ID |
| retention_period | INT | NOT NULL | 保留期限(月) |
| created_at | TIMESTAMP | NOT NULL | 创建时间 |
| last_modified_at | TIMESTAMP | NOT NULL | 最后修改时间 |
| effective_date | DATE | NULL | 生效日期 |
| expiry_date | DATE | NULL | 过期日期 |
| archival_date | DATE | NULL | 归档日期 |
| destruction_date | DATE | NULL | 销毁日期 |

#### 5.1.2 文档版本表(Document_Version)
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| version_id | UUID | 主键 | 版本唯一标识 |
| document_id | UUID | 外键 | 关联文档ID |
| version_number | VARCHAR(20) | NOT NULL | 版本号 |
| file_path | VARCHAR(500) | NOT NULL | 文件存储路径 |
| created_by | UUID | NOT NULL | 创建人ID |
| created_at | TIMESTAMP | NOT NULL | 创建时间 |
| approved_by | UUID | NULL | 批准人ID |
| approved_at | TIMESTAMP | NULL | 批准时间 |
| published_at | TIMESTAMP | NULL | 发布时间 |
| change_summary | TEXT | NULL | 变更摘要 |
| lifecycle_stage | VARCHAR(50) | NOT NULL | 版本当前生命周期阶段 |

#### 5.1.3 生命周期事件表(Lifecycle_Event)
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| event_id | UUID | 主键 | 事件唯一标识 |
| document_id | UUID | 外键 | 关联文档ID |
| version_id | UUID | 外键 | 关联版本ID |
| event_type | VARCHAR(50) | NOT NULL | 事件类型 |
| from_stage | VARCHAR(50) | NULL | 源阶段 |
| to_stage | VARCHAR(50) | NULL | 目标阶段 |
| performed_by | UUID | NOT NULL | 执行人员ID |
| performed_at | TIMESTAMP | NOT NULL | 执行时间 |
| comments | TEXT | NULL | 备注说明 |
| signature_id | UUID | NULL | 关联电子签名ID |

#### 5.1.4 生命周期规则表(Lifecycle_Rule)
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| rule_id | UUID | 主键 | 规则唯一标识 |
| document_type | VARCHAR(50) | NOT NULL | 适用文档类型 |
| stage_name | VARCHAR(50) | NOT NULL | 阶段名称 |
| rule_type | VARCHAR(50) | NOT NULL | 规则类型 |
| rule_config | JSONB | NOT NULL | 规则配置参数 |
| created_at | TIMESTAMP | NOT NULL | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL | 更新时间 |

### 5.2 数据关系
- 文档主表与文档版本表：一对多关系
- 文档主表与生命周期事件表：一对多关系
- 文档版本表与生命周期事件表：一对多关系
- 生命周期规则表与文档主表：一对多关系（通过document_type）
- 生命周期事件表与电子签名表：一对一关系

## 6. 工作流设计

### 6.1 主要工作流定义

#### 6.1.1 文档创建与发布工作流
1. **起草文档**：文档创建人起草文档
2. **提交审核**：提交文档进行审核
3. **技术审核**：技术专家审核内容准确性
4. **质量审核**：质量部门审核合规性
5. **最终批准**：授权人员最终批准
6. **发布文档**：文档正式发布并生效
7. **通知分发**：通知相关人员并分发文档

#### 6.1.2 文档变更工作流
1. **发起变更请求**：提交文档变更申请
2. **变更评估**：评估变更的必要性和影响
3. **变更审批**：批准变更请求
4. **文档修改**：基于现有版本进行修改
5. **变更审核**：审核变更内容
6. **再次批准**：对变更进行最终批准
7. **发布新版本**：发布文档新版本
8. **历史版本归档**：将旧版本归档

#### 6.1.3 文档归档与销毁工作流
1. **归档/销毁评估**：评估文档是否需要归档或销毁
2. **提交申请**：提交归档或销毁申请
3. **合规检查**：检查是否符合归档或销毁条件
4. **审批流程**：多级审批
5. **执行操作**：执行归档或销毁
6. **验证确认**：验证操作结果
7. **记录生成**：生成归档或销毁记录

### 6.2 工作流引擎集成

#### 6.2.1 工作流定义
- **流程定义语言**：使用BPMN 2.0标准定义工作流
- **可视化设计器**：提供工作流可视化设计工具
- **动态流程配置**：支持动态调整工作流配置
- **流程模板库**：维护常用工作流模板

#### 6.2.2 工作流执行
- **流程实例管理**：创建和管理工作流实例
- **任务分配与通知**：智能分配任务并通知相关人员
- **执行状态监控**：实时监控工作流执行状态
- **异常处理机制**：处理工作流执行异常情况

## 7. 接口设计

### 7.1 内部接口

#### 7.1.1 生命周期管理接口
- **获取文档生命周期状态**
  - URL: /api/lifecycle/status/{documentId}
  - 方法: GET
  - 返回: 文档当前生命周期状态

- **执行生命周期转换**
  - URL: /api/lifecycle/transition
  - 方法: POST
  - 参数: documentId, targetStage, comments, signature
  - 返回: 转换结果

- **获取生命周期历史**
  - URL: /api/lifecycle/history/{documentId}
  - 方法: GET
  - 返回: 生命周期事件历史记录

- **配置生命周期规则**
  - URL: /api/lifecycle/rules/configure
  - 方法: POST
  - 参数: documentType, rulesConfig
  - 返回: 配置结果

#### 7.1.2 文档状态管理接口
- **获取文档状态**
  - URL: /api/document/status/{documentId}
  - 方法: GET
  - 返回: 文档详细状态信息

- **更新文档状态**
  - URL: /api/document/status/update
  - 方法: PUT
  - 参数: documentId, status, reason
  - 返回: 更新结果

- **查询状态统计**
  - URL: /api/document/status/stats
  - 方法: GET
  - 参数: filters
  - 返回: 状态统计信息

### 7.2 外部接口

#### 7.2.1 工作流集成接口
- **启动工作流**
  - 方法: 调用工作流引擎API
  - 参数: workflowType, documentInfo, participants
  - 返回: workflowInstanceId

- **更新工作流状态**
  - 方法: 调用工作流引擎API
  - 参数: workflowInstanceId, status, action
  - 返回: 更新结果

#### 7.2.2 电子签名接口
- **验证签名**
  - 方法: 调用电子签名API
  - 参数: userId, signature, timestamp
  - 返回: 验证结果

- **记录签名**
  - 方法: 调用电子签名API
  - 参数: documentId, versionId, userId, signature, action
  - 返回: 记录结果

#### 7.2.3 审计接口
- **记录审计事件**
  - 方法: 调用审计系统API
  - 参数: eventType, resourceId, userId, details
  - 返回: 记录结果

## 8. 安全设计

### 8.1 访问控制

#### 8.1.1 角色与权限
- **生命周期角色定义**：定义文档生命周期中的各类角色
- **操作权限矩阵**：详细的角色-操作权限矩阵
- **条件权限控制**：基于条件的动态权限控制
- **临时权限管理**：临时权限授予和撤销机制

#### 8.1.2 敏感操作保护
- **双人控制原则**：关键操作需要双人授权
- **权限分离**：确保不相容职责分离
- **操作验证**：敏感操作前的二次验证
- **异常操作监控**：监控和告警异常操作

### 8.2 数据保护

#### 8.2.1 传输安全
- **TLS加密**：所有数据传输使用TLS加密
- **安全会话管理**：安全的会话创建和管理
- **防重放攻击**：防止请求重放攻击

#### 8.2.2 存储安全
- **数据加密**：文档内容和元数据加密存储
- **完整性校验**：使用哈希值确保数据完整性
- **备份与恢复**：完善的数据备份和恢复机制
- **归档数据保护**：归档数据的特殊保护措施

## 9. 监控与报告

### 9.1 生命周期监控

#### 9.1.1 监控指标
- **状态分布统计**：各生命周期阶段的文档数量统计
- **处理时间监控**：各阶段平均处理时间监控
- **异常状态监控**：异常状态文档的监控和告警
- **即将到期提醒**：即将到期或需要评审的文档提醒

#### 9.1.2 预警机制
- **超时预警**：处理超时的自动预警
- **合规风险预警**：潜在合规风险的识别和预警
- **容量预警**：存储容量和系统负载预警
- **异常行为预警**：可疑操作行为的预警

### 9.2 报告生成

#### 9.2.1 标准报告
- **文档状态报告**：文档状态分布和统计
- **生命周期活动报告**：生命周期事件活动统计
- **合规性报告**：合规性检查结果报告
- **性能报告**：系统性能和处理效率报告

#### 9.2.2 自定义报告
- **报告生成器**：灵活的自定义报告生成工具
- **报表模板**：预设常用报表模板
- **导出功能**：支持多种格式导出
- **定时生成**：定期自动生成和分发报告

## 10. 测试策略

### 10.1 功能测试

#### 10.1.1 生命周期阶段测试
- **阶段转换测试**：验证各阶段之间的正确转换
- **权限控制测试**：验证不同角色的权限控制
- **规则验证测试**：验证生命周期规则的正确执行
- **异常处理测试**：测试异常情况下的系统行为

#### 10.1.2 工作流测试
- **工作流执行测试**：测试完整工作流的执行
- **分支路径测试**：测试工作流的不同分支路径
- **并发测试**：测试多个工作流并发执行
- **错误恢复测试**：测试工作流错误恢复机制

### 10.2 合规性测试

#### 10.2.1 法规符合性测试
- **GMP合规性测试**：验证符合GMP要求
- **电子记录测试**：测试电子记录的完整性和可靠性
- **电子签名测试**：测试电子签名的有效性
- **审计跟踪测试**：验证审计跟踪的完整性

#### 10.2.2 安全测试
- **访问控制测试**：测试访问控制的有效性
- **数据保护测试**：测试数据保护措施
- **安全渗透测试**：测试系统安全防护能力
- **权限分离测试**：验证权限分离原则

## 11. 部署与实施

### 11.1 部署架构

#### 11.1.1 系统组件部署
- **应用服务器部署**：生命周期管理服务部署
- **数据存储部署**：数据库和文件存储配置
- **工作流引擎部署**：工作流引擎配置和部署
- **集成服务部署**：与其他系统的集成服务

#### 11.1.2 高可用设计
- **服务冗余**：关键服务的冗余部署
- **故障转移**：自动故障检测和转移
- **负载均衡**：服务请求的负载均衡
- **灾难恢复**：灾难恢复方案和定期演练

### 11.2 实施计划

#### 11.2.1 分阶段实施
- **试点阶段**：选择部分文档类型进行试点
- **扩展阶段**：逐步扩展到所有文档类型
- **全面部署**：系统全面上线和切换
- **持续优化**：基于使用反馈持续优化

#### 11.2.2 用户培训
- **培训计划制定**：制定详细的培训计划
- **培训材料开发**：开发培训教材和操作手册
- **关键用户培训**：培训核心用户和管理员
- **全员培训**：系统用户的全面培训

## 12. 维护与支持

### 12.1 日常维护

#### 12.1.1 系统维护
- **定期检查**：系统健康状态定期检查
- **性能监控**：持续监控系统性能
- **数据备份**：定期数据备份和验证
- **日志管理**：日志收集、分析和归档

#### 12.1.2 规则维护
- **规则审核**：定期审核生命周期规则
- **规则更新**：根据业务需求更新规则
- **规则测试**：新规则或更新规则的测试
- **规则文档维护**：规则文档的更新和维护

### 12.2 故障处理

#### 12.2.1 常见问题排查
- **状态异常排查**：文档状态异常的排查和修复
- **工作流故障排查**：工作流执行故障的排查
- **性能问题排查**：系统性能问题的诊断和解决
- **集成问题排查**：与其他系统集成问题的处理

#### 12.2.2 升级与迁移
- **系统升级**：系统版本升级的计划和执行
- **数据迁移**：系统迁移时的数据迁移
- **规则迁移**：规则配置的迁移和验证
- **兼容性管理**：确保升级后的系统兼容性

## 13. 附录

### 13.1 相关文档
- EDMS系统整体架构设计文档
- EDMS工作流引擎设计文档
- EDMS电子签名系统设计文档
- EDMS审计追踪功能设计文档

### 13.2 生命周期阶段详细定义
| 阶段名称 | 描述 | 主要活动 | 状态标志 |
|---------|------|---------|----------|
| 创建 | 文档起草和初步编写 | 文档创建、内容编辑、属性设置 | DRAFT |
| 审核 | 文档内容和格式审查 | 多级审核、意见收集、内容修改 | IN_REVIEW |
| 批准 | 文档的正式批准 | 最终审批、电子签名、批准记录 | APPROVED |
| 发布 | 文档正式生效和分发 | 文档发布、通知分发、生效控制 | PUBLISHED |
| 使用 | 文档正常使用阶段 | 文档访问、定期评审、使用监控 | ACTIVE |
| 变更 | 文档内容或属性变更 | 变更申请、修改、重新审批 | UNDER_CHANGE |
| 归档 | 文档的长期保存 | 归档处理、长期存储、历史查询 | ARCHIVED |
| 销毁 | 文档的最终处置 | 销毁申请、审批、安全删除 | DESTROYED |
| 废弃 | 文档提前终止 | 废弃申请、审批、状态变更 | ABANDONED |
| 撤回 | 已发布文档的撤销 | 撤回申请、审批、状态变更 | WITHDRAWN |

### 13.3 版本历史
| 版本号 | 修改日期 | 修改人 | 修改内容 |
|-------|---------|--------|----------|
| 1.0 | 2023-04-25 | 系统架构师 | 初始版本 |
| 1.1 | 2023-05-20 | 质量专家 | 更新合规性要求和流程设计 |
| 1.2 | 2023-06-15 | 文档管理员 | 完善生命周期阶段定义和规则配置 |

### 13.4 审批记录
| 审批阶段 | 审批人 | 审批日期 | 审批意见 |
|---------|-------|---------|----------|
| 技术审核 | 技术总监 | 2023-04-30 | 同意 |
| 质量审核 | 质量总监 | 2023-05-10 | 同意，建议加强合规检查点 |
| 最终批准 | IT总监 | 2023-05-15 | 批准实施 |