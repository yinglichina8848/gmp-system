# EDMS子系统（电子文档管理系统）架构设计

## 1. 概述

EDMS子系统基于微服务架构设计，实现企业级文档生命周期全管理，通过工作流驱动的审批机制、智能检索和严格的版本控制，确保文档管理的合规性和高效性。

> **重要更新**: 原独立的File服务已集成到EDMS服务中，通过MinIO实现文件存储功能，同时保留了兼容层接口确保系统平滑过渡。

## 2. 系统架构

### 2.1 分层架构设计 (已更新文件存储集成)

```
┌────────────────────────────────────────────────────┐
│            表现层 (Presentation Layer)             │
│   ┌─────────────────────────────────────────────┐   │
│   │        REST控制器 (Controllers)            │   │
│   │ - DocumentController                       │   │
│   │ - ApprovalController                       │   │
│   │ - SearchController                         │   │
│   │ - VersionController                        │   │
│   │ - FileController (新增文件管理API)          │   │
│   │ - FileServiceCompatibilityController (兼容层) │   │
│   └─────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────┘
                                ▼
┌────────────────────────────────────────────────────┐
│           业务逻辑层 (Business Layer)               │
│   ┌─────────────────────────────────────────────┐   │
│   │       业务服务 (Services)                    │   │
│   │ - DocumentService                           │   │
│   │ - ApprovalWorkflowService                   │   │
│   │ - SearchService                            │   │
│   │ - VersionControlService                     │   │
│   │ - CommonFileService (通用文件服务)          │   │
│   │ - FileStorageService (文件存储服务)         │   │
│   │                                             │   │
│   │ - 工作流引擎                               │   │
│   │ - 全文检索引擎                             │   │
│   │ - 审计追踪引擎                             │   │
│   │ - 文件处理引擎 (MinIO集成)                 │   │
│   │                                             │   │
│   │ **重要更新**: 原File服务已完全集成到EDMS服务中 │   │
│   └─────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────┘
                                ▼
┌────────────────────────────────────────────────────┐
│           数据访问层 (Data Access Layer)            │
│   ┌─────────────────────────────────────────────┐   │
│   │       数据仓库 (Repositories)               │   │
│   │ - DocumentRepository                        │   │
│   │ - DocumentVersionRepository                 │   │
│   │ - ApprovalRepository                        │   │
│   │ - AccessLogRepository                       │   │
│   │ - CommonFileRepository (通用文件库)         │   │
│   └─────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────┘
                                ▼
┌────────────────────────────────────────────────────┐
│           数据存储层 (Data Storage)                │
│   ┌─────────────────────────────────────────────┐   │
│   │ 对象存储：MinIO (分布式文件存储)              │   │
│   │ 关系数据库：PostgreSQL                      │   │
│   │ 全文检索：Elasticsearch                     │   │
│   │ 缓存系统：Redis                             │   │
│   └─────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────┘
```

### 2.2 微服务架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    EDMS微服务 (edms-service:8084)           │
│                                                             │
│  ┌─────────────┬─────────────┬─────────────┬─────────────┐   │
│  │ 文档管理    │ 工作流审批  │ 智能检索    │ 版本控制    │   │
│  │ Document    │ Workflow    │ Search      │ Version     │   │
│  │ Management  │ Approval    │ Engine      │ Control     │   │
│  └─────────────┴─────────────┴─────────────┴─────────────┘   │
│                                                             │
│  ┌─────────────┬─────────────┬─────────────┬─────────────┐   │
│  │ 模板管理    │ 全文索引    │ 缓存管理    │ 文件存储    │   │
│  │ Template    │ Indexing    │ Cache       │ File        │   │
│  │ Engine      │ Engine      │ Management  │ Storage     │   │
│  └─────────────┴─────────────┴─────────────┴─────────────┘   │
│                                                             │
│  **更新说明**: 原独立的File服务已集成到此微服务中          │
└─────────────────────────────────────────────────────────────┘
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                    数据存储与外部集成                       │
│                                                             │
│  PostgreSQL edms_db   Elasticsearch      Redis Cache    │
│  - documents                                             │
│  - document_versions                                     │
│  - approval_instances                                    │
│  - access_logs           全文搜索索引                      │
│                                                             │
│  外部系统集成：用户认证系统、权限系统、审计系统              │
└─────────────────────────────────────────────────────────────┘
```

## 3. 服务设计

### 3.1 微服务边界

EDMS微服务主要包含四个核心业务领域：

```
文档管理 (Document Management)
├── 文档创建与编辑 (@Post /api/edms/documents)
├── 文档分类管理 (@Put /api/edms/documents/{id}/category)
├── 文档元数据更新 (@Patch /api/edms/documents/{id}/metadata)
├── 文档状态变更 (@Patch /api/edms/documents/{id}/status)
└── 文档模板应用 (@Post /api/edms/documents/{id}/apply-template)

工作流审批 (Workflow Approval)
├── 审批流程启动 (@Post /api/edms/approvals)
├── 审批任务分配 (@Post /api/edms/approvals/{id}/assign)
├── 审批意见录入 (@Post /api/edms/approvals/{id}/comments)
├── 审批决策执行 (@Put /api/edms/approvals/{id}/decide)
└── 审批流程监控 (@Get /api/edms/approvals/{id}/progress)

智能检索 (Intelligent Search)
├── 全文内容搜索 (@Get /api/edms/search/fulltext)
├── 结构化数据查询 (@Get /api/edms/search/structured)
├── 高级组合检索 (@Post /api/edms/search/advanced)
├── 搜索结果排序 (@Get /api/edms/search/sort)
└── 搜索历史管理 (@Get /api/edms/search/history)

版本控制 (Version Control)
├── 版本创建 (@Post /api/edms/documents/{id}/versions)
├── 版本比较 (@Get /api/edms/versions/{id1}/compare/{id2})
├── 版本切换 (@Patch /api/edms/documents/{id}/switch-version)
├── 版本历史查询 (@Get /api/edms/documents/{id}/version-history)
└── 版本冻结 (@Patch /api/edms/versions/{id}/freeze)
```

## 4. 数据架构设计

### 4.1 核心数据表关系

```
edms_db
├── documents (文档主表)
│   ├── id (主键)
│   ├── document_number (文档编号)
│   ├── title (标题)
│   ├── document_type (文档类型)
│   ├── status (状态)
│   ├── current_version (当前版本)
│   └── file_path (存储路径)
│
├── document_versions (文档版本表)
│   ├── id (主键)
│   ├── document_id (文档ID - 外键)
│   ├── version_number (版本号)
│   ├── change_reason (变更原因)
│   ├── author (作者)
│   └── file_path (版本文件路径)
│
├── approval_workflows (审批流程模板)
│   ├── id (主键)
│   ├── workflow_code (流程编码)
│   ├── workflow_definition (流程定义JSON)
│   └── document_type (适用的文档类型)
│
├── approval_instances (审批实例)
│   ├── id (主键)
│   ├── workflow_id (流程模板ID - 外键)
│   ├── document_id (文档ID - 外键)
│   ├── status (审批状态)
│   └── current_step (当前步骤)
│
└── document_access_logs (访问日志表)
    ├── id (主键)
    ├── document_id (文档ID - 外键)
    ├── user_id (用户ID)
    ├── access_type (访问类型)
    └── access_time (访问时间)
```

### 4.2 核心数据模型

#### 4.2.1 文档实体类
```java
@Entity
@Table(name = "documents")
@Data
@Audited
public class Document {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(unique = true, nullable = false)
    private String documentNumber;

    @Column(nullable = false, length = 200)
    private String title;

    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    private DocumentType documentType;

    @Enumerated(EnumType.STRING)
    private DocumentStatus status = DocumentStatus.DRAFT;

    @Column(nullable = false)
    private String author;

    private String ownerDepartment;
    private String category;
    private LocalDateTime effectiveDate;
    private LocalDateTime expiryDate;

    @Enumerated(EnumType.STRING)
    private ConfidentialityLevel confidentialityLevel = ConfidentialityLevel.NORMAL;

    private String currentVersion = "1.0";
    private String filePath;
    private Long fileSize;
    private String contentType;
    private String checksum;

    @OneToMany(mappedBy = "document", cascade = CascadeType.ALL, fetch = FetchType.LAZY)
    private List<DocumentVersion> versions = new ArrayList<>();

    @OneToMany(mappedBy = "document", cascade = CascadeType.ALL, fetch = FetchType.LAZY)
    private List<ApprovalInstance> approvalInstances = new ArrayList<>();

    // 审计字段
    @CreatedDate
    private LocalDateTime createdAt;

    @LastModifiedDate
    private LocalDateTime updatedAt;
}
```

## 5. 工作流引擎设计

### 5.1 审批工作流引擎

```java
@Service
public class ApprovalWorkflowEngine {

    // 启动审批流程
    public ApprovalInstance startApprovalProcess(Document document, String workflowCode) {
        // 1. 查找适用的审批流程模板
        ApprovalWorkflow workflow = findWorkflowByCodeAndType(workflowCode, document.getDocumentType());

        // 2. 创建审批实例
        ApprovalInstance instance = createApprovalInstance(document, workflow);

        // 3. 初始化第一个审批步骤
        initializeFirstStep(instance);

        // 4. 发送审批任务通知
        notifyApprovers(instance);

        return instance;
    }

    // 执行审批决策
    public boolean executeApprovalStep(Long instanceId, String userId, ApprovalDecision decision) {
        // 1. 验证用户权限
        validateApproverPermission(instanceId, userId);

        // 2. 记录审批决策
        recordApprovalDecision(instanceId, userId, decision);

        // 3. 计算下一步骤
        ApprovalStep nextStep = calculateNextStep(instanceId);

        if (nextStep != null) {
            // 还有后续步骤
            assignNextStep(instanceId, nextStep);
        } else {
            // 流程结束
            finalizeApprovalProcess(instanceId);
        }

        return true;
    }
}
```

## 6. 全文检索架构

### 6.1 Elasticsearch集成设计

```java
@Component
public class DocumentSearchService {

    @Autowired
    private RestHighLevelClient elasticsearchClient;

    // 索引文档内容
    public void indexDocument(Document document) {
        IndexRequest request = new IndexRequest("documents");

        Map<String, Object> documentMap = new HashMap<>();
        documentMap.put("id", document.getId());
        documentMap.put("title", document.getTitle());
        documentMap.put("content", extractContent(document)); // 提取文档内容
        documentMap.put("author", document.getAuthor());
        documentMap.put("documentType", document.getDocumentType().toString());
        documentMap.put("status", document.getStatus().toString());
        documentMap.put("effectiveDate", document.getEffectiveDate());
        documentMap.put("tags", extractTags(document));

        request.source(documentMap, XContentType.JSON);
        elasticsearchClient.index(request, RequestOptions.DEFAULT);
    }

    // 全文搜索
    public SearchResponse searchDocuments(String query, Map<String, Object> filters) {
        BoolQueryBuilder boolQuery = QueryBuilders.boolQuery()
            .must(QueryBuilders.multiMatchQuery(query, "title", "content", "author"))
            .filter(buildFilters(filters));

        SearchRequest searchRequest = new SearchRequest("documents");
        searchRequest.source().query(boolQuery);

        return elasticsearchClient.search(searchRequest, RequestOptions.DEFAULT);
    }
}
```

## 7. 缓存设计

### 7.1 Redis缓存策略

#### 7.1.1 多级缓存架构
```java
@Configuration
public class CacheConfiguration {

    @Bean
    public RedisCacheManager cacheManager(RedisConnectionFactory connectionFactory) {
        return RedisCacheManager.builder(connectionFactory)
            .cacheDefaults(
                RedisCacheConfiguration.defaultCacheConfig()
                    .entryTtl(Duration.ofHours(1)) // 默认1小时过期
                    .serializeKeysWith(
                        SerializationPair.fromSerializer(new StringRedisSerializer()))
                    .serializeValuesWith(
                        SerializationPair.fromSerializer(
                            new Jackson2JsonRedisSerializer<>(Object.class)))
            )
            .withCacheConfiguration("documentMetadata",
                RedisCacheConfiguration.defaultCacheConfig().entryTtl(Duration.ofMinutes(30)))
            .withCacheConfiguration("userPermissions",
                RedisCacheConfiguration.defaultCacheConfig().entryTtl(Duration.ofHours(2)))
            .withCacheConfiguration("searchResults",
                RedisCacheConfiguration.defaultCacheConfig().entryTtl(Duration.ofMinutes(10)))
            .build();
    }
}
```

## 8. 消息队列设计

### 8.1 事件驱动架构

```java
@Service
public class DocumentEventPublisher {

    @Autowired
    private RabbitTemplate rabbitTemplate;

    // 发布文档状态变更事件
    public void publishDocumentStatusChangedEvent(Document document) {
        DocumentStatusChangedEvent event = new DocumentStatusChangedEvent(document);
        rabbitTemplate.convertAndSend("edms.exchange", "document.status.changed", event);
    }

    // 发布审批任务分配事件
    public void publishApprovalTaskAssignedEvent(ApprovalInstance instance) {
        ApprovalTaskAssignedEvent event = new ApprovalTaskAssignedEvent(instance);
        rabbitTemplate.convertAndSend("edms.exchange", "approval.task.assigned", event);
    }

    // 发布文档访问审计事件
    public void publishDocumentAccessEvent(DocumentAccessLog accessLog) {
        DocumentAccessEvent event = new DocumentAccessEvent(accessLog);
        rabbitTemplate.convertAndSend("edms.exchange", "document.access.logged", event);
    }
}
```

## 9. 安全性设计

### 9.1 权限控制架构

```java
@Service
public class DocumentPermissionService {

    // 文档访问权限检查
    public boolean hasPermission(String userId, Long documentId, PermissionType permission) {
        // 1. 获取用户角色
        Set<String> userRoles = getUserRoles(userId);

        // 2. 获取文档权限策略
        Document document = getDocument(documentId);
        List<PermissionPolicy> policies = getDocumentPolicies(document);

        // 3. 权限计算：角色 + 策略 + 上下文
        return evaluatePermissions(userRoles, policies, permission, getContext(userId, document));
    }

    // 动态权限评估
    private boolean evaluatePermissions(Set<String> roles, List<PermissionPolicy> policies,
                                      PermissionType required, PermissionContext context) {
        // 支持复杂的权限规则：
        // - 基于角色的访问控制
        // - 基于属性的访问控制
        // - 时间窗口限制
        // - 地理位置限制
        return policies.stream()
            .anyMatch(policy -> policy.evaluate(roles, required, context));
    }
}
```

---

**文档信息：**
- 版本：v1.0
- 更新日期：2024年
- 编制人员：架构设计团队
- 状态：Draft
