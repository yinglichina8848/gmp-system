# 实验室信息管理系统数据流和接口定义

## 1. 概述

本文档详细描述实验室信息管理系统（LIMS）的数据流动过程和系统间的接口定义，包括数据流图、数据字典、接口规范等，为系统集成和数据交换提供明确的指导。

## 2. 数据流分析

### 2.1 整体数据流图

LIMS系统的数据流动主要包括以下几个核心环节：

1. **数据输入**：样品信息、检验计划、检验数据等
2. **数据处理**：数据计算、统计分析、结果判定等
3. **数据输出**：检验报告、统计报表、异常通知等
4. **数据存储**：样品数据、检验数据、系统配置等
5. **数据交换**：与其他系统的数据接口通信

### 2.2 主要数据流描述

#### 2.2.1 样品数据流

**来源**：外部用户、生产管理系统
**处理**：样品登记、分类、分配
**存储**：样品数据库
**输出**：样品信息查询、样品流转记录
**流向**：
- 样品登记信息 → 样品管理模块 → 样品数据库
- 样品分配信息 → 检验任务模块 → 检验任务列表

#### 2.2.2 检验数据流

**来源**：检验员录入、仪器自动采集
**处理**：数据验证、计算、判定、审核
**存储**：检验数据库
**输出**：检验结果、趋势分析、异常报告
**流向**：
- 检验原始数据 → 数据处理模块 → 检验结果
- 检验结果 → 审核模块 → 报告生成模块

#### 2.2.3 报告数据流

**来源**：检验结果、报告模板
**处理**：报告生成、审核、签发
**存储**：报告数据库
**输出**：电子报告、纸质报告
**流向**：
- 检验结果 → 报告生成模块 → 报告草稿
- 报告草稿 → 报告审核模块 → 正式报告
- 正式报告 → 报告分发模块 → 用户

## 3. 数据字典

### 3.1 核心数据实体

#### 3.1.1 样品（Sample）

| 字段名 | 数据类型 | 描述 | 约束 |
|-------|---------|------|------|
| sample_id | String | 样品编号 | 主键，唯一性 |
| sample_name | String | 样品名称 | 必填 |
| batch_number | String | 批次号 | 必填 |
| specification | String | 规格 | 必填 |
| quantity | Number | 数量 | 必填，大于0 |
| unit | String | 单位 | 必填 |
| source | String | 样品来源 | 必填 |
| test_type | String | 检验类型 | 必填 |
| receive_date | DateTime | 接收日期 | 必填 |
| received_by | String | 接收人 | 必填 |
| current_status | String | 当前状态 | 必填 |
| storage_location | String | 存储位置 | 可选 |
| expiry_date | Date | 有效期 | 可选 |
| remark | String | 备注 | 可选 |

#### 3.1.2 检验任务（TestTask）

| 字段名 | 数据类型 | 描述 | 约束 |
|-------|---------|------|------|
| task_id | String | 任务编号 | 主键，唯一性 |
| sample_id | String | 关联样品ID | 外键，必填 |
| task_name | String | 任务名称 | 必填 |
| priority | String | 优先级 | 必填 |
| assigned_to | String | 分配人员 | 必填 |
| assigned_by | String | 分配人 | 必填 |
| assign_date | DateTime | 分配日期 | 必填 |
| due_date | DateTime | 截止日期 | 必填 |
| current_status | String | 当前状态 | 必填 |
| test_standard | String | 检验标准 | 必填 |
| test_method_id | String | 检验方法ID | 外键，必填 |
| department_id | String | 检验部门ID | 外键，必填 |
| remark | String | 备注 | 可选 |

#### 3.1.3 检验数据（TestData）

| 字段名 | 数据类型 | 描述 | 约束 |
|-------|---------|------|------|
| data_id | String | 数据ID | 主键，唯一性 |
| task_id | String | 关联任务ID | 外键，必填 |
| test_item_id | String | 检验项目ID | 外键，必填 |
| value | Number | 检验值 | 必填 |
| unit | String | 单位 | 必填 |
| test_date | DateTime | 检验日期 | 必填 |
| tested_by | String | 检验员 | 必填 |
| instrument_id | String | 使用仪器ID | 外键，可选 |
| raw_data_file | String | 原始数据文件路径 | 可选 |
| result_status | String | 结果状态（合格/不合格/异常） | 必填 |
| remark | String | 备注 | 可选 |

#### 3.1.4 检验报告（TestReport）

| 字段名 | 数据类型 | 描述 | 约束 |
|-------|---------|------|------|
| report_id | String | 报告编号 | 主键，唯一性 |
| task_id | String | 关联任务ID | 外键，必填 |
| sample_id | String | 关联样品ID | 外键，必填 |
| report_title | String | 报告标题 | 必填 |
| report_type | String | 报告类型 | 必填 |
| generated_date | DateTime | 生成日期 | 必填 |
| generated_by | String | 生成人 | 必填 |
| reviewed_date | DateTime | 审核日期 | 可选 |
| reviewed_by | String | 审核人 | 可选 |
| approved_date | DateTime | 批准日期 | 可选 |
| approved_by | String | 批准人 | 可选 |
| report_status | String | 报告状态 | 必填 |
| report_content | Text | 报告内容 | 必填 |
| report_file_path | String | 报告文件路径 | 可选 |
| remark | String | 备注 | 可选 |

## 4. 接口定义

### 4.1 内部接口

#### 4.1.1 样品管理接口

**1. 创建样品**

- **接口URL**: `/api/samples`
- **方法**: POST
- **请求参数**:
  ```json
  {
    "sample_name": "",
    "batch_number": "",
    "specification": "",
    "quantity": 0,
    "unit": "",
    "source": "",
    "test_type": ""
  }
  ```
- **返回结果**:
  ```json
  {
    "success": true,
    "data": {
      "sample_id": "",
      "sample_name": "",
      "batch_number": "",
      "current_status": "待接收"
    }
  }
  ```

**2. 查询样品列表**

- **接口URL**: `/api/samples`
- **方法**: GET
- **请求参数**: 查询参数（可选）
  - page: 页码
  - size: 每页数量
  - sample_name: 样品名称
  - batch_number: 批次号
  - status: 状态
- **返回结果**:
  ```json
  {
    "success": true,
    "data": {
      "list": [],
      "total": 0,
      "page": 0,
      "size": 0
    }
  }
  ```

#### 4.1.2 检验任务接口

**1. 创建检验任务**

- **接口URL**: `/api/test-tasks`
- **方法**: POST
- **请求参数**:
  ```json
  {
    "sample_id": "",
    "task_name": "",
    "priority": "",
    "assigned_to": "",
    "due_date": "",
    "test_standard": "",
    "test_method_id": "",
    "department_id": ""
  }
  ```
- **返回结果**:
  ```json
  {
    "success": true,
    "data": {
      "task_id": "",
      "task_name": "",
      "current_status": "待执行"
    }
  }
  ```

**2. 提交检验数据**

- **接口URL**: `/api/test-data`
- **方法**: POST
- **请求参数**:
  ```json
  {
    "task_id": "",
    "test_item_id": "",
    "value": 0,
    "unit": "",
    "instrument_id": "",
    "raw_data_file": ""
  }
  ```
- **返回结果**:
  ```json
  {
    "success": true,
    "data": {
      "data_id": "",
      "result_status": "合格"
    }
  }
  ```

#### 4.1.3 报告管理接口

**1. 生成报告**

- **接口URL**: `/api/reports/generate`
- **方法**: POST
- **请求参数**:
  ```json
  {
    "task_id": "",
    "report_type": ""
  }
  ```
- **返回结果**:
  ```json
  {
    "success": true,
    "data": {
      "report_id": "",
      "report_title": "",
      "report_status": "草稿"
    }
  }
  ```

**2. 审核报告**

- **接口URL**: `/api/reports/{reportId}/review`
- **方法**: PUT
- **请求参数**:
  ```json
  {
    "review_comment": "",
    "review_result": "通过"
  }
  ```
- **返回结果**:
  ```json
  {
    "success": true,
    "data": {
      "report_id": "",
      "report_status": "已审核"
    }
  }
  ```

### 4.2 外部接口

#### 4.2.1 与认证子系统接口

**1. 用户认证**

- **接口URL**: `/auth/login`
- **方法**: POST
- **请求参数**:
  ```json
  {
    "username": "",
    "password": ""
  }
  ```
- **返回结果**:
  ```json
  {
    "success": true,
    "data": {
      "token": "",
      "user_info": {
        "user_id": "",
        "username": "",
        "roles": []
      }
    }
  }
  ```

**2. 权限验证**

- **接口URL**: `/auth/check-permission`
- **方法**: POST
- **请求参数**:
  ```json
  {
    "user_id": "",
    "resource": "",
    "action": ""
  }
  ```
- **返回结果**:
  ```json
  {
    "success": true,
    "data": {
      "has_permission": true
    }
  }
  ```

#### 4.2.2 与生产管理系统接口

**1. 接收样品信息**

- **接口URL**: `/api/integration/production/sample-info`
- **方法**: POST
- **请求参数**:
  ```json
  {
    "production_order_id": "",
    "product_code": "",
    "batch_number": "",
    "quantity": 0,
    "production_date": "",
    "requested_test_items": []
  }
  ```
- **返回结果**:
  ```json
  {
    "success": true,
    "data": {
      "sample_id": "",
      "received": true,
      "message": "样品信息已接收"
    }
  }
  ```

**2. 反馈检验结果**

- **接口URL**: `/api/integration/production/test-result`
- **方法**: POST
- **请求参数**:
  ```json
  {
    "production_order_id": "",
    "batch_number": "",
    "sample_id": "",
    "overall_result": "合格",
    "test_details": [],
    "report_id": ""
  }
  ```
- **返回结果**:
  ```json
  {
    "success": true,
    "data": {
      "message": "检验结果已接收"
    }
  }
  ```

#### 4.2.3 与设备管理系统接口

**1. 查询设备状态**

- **接口URL**: `/api/integration/equipment/status`
- **方法**: GET
- **请求参数**:
  - equipment_id: 设备ID
- **返回结果**:
  ```json
  {
    "success": true,
    "data": {
      "equipment_id": "",
      "status": "可用",
      "last_calibration": "",
      "next_calibration": "",
      "is_valid": true
    }
  }
  ```

**2. 记录设备使用**

- **接口URL**: `/api/integration/equipment/usage`
- **方法**: POST
- **请求参数**:
  ```json
  {
    "equipment_id": "",
    "start_time": "",
    "end_time": "",
    "used_by": "",
    "purpose": "",
    "sample_id": ""
  }
  ```
- **返回结果**:
  ```json
  {
    "success": true,
    "data": {
      "message": "设备使用记录已保存"
    }
  }
  ```

## 5. 数据交换规范

### 5.1 数据格式标准

- 所有接口采用RESTful API设计风格
- 请求和响应数据格式为JSON
- 日期时间格式采用ISO 8601标准：YYYY-MM-DDTHH:mm:ss.SSSZ
- 文件传输采用Base64编码或通过文件URL引用

### 5.2 安全规范

- 所有接口调用需进行身份验证（JWT Token）
- 敏感数据传输采用HTTPS加密
- API访问需记录详细的操作日志
- 实施接口调用频率限制
- 错误信息不包含系统内部敏感信息

### 5.3 错误处理规范

- 统一的错误码体系
- 标准的错误响应格式：
  ```json
  {
    "success": false,
    "code": "ERROR_CODE",
    "message": "错误描述",
    "details": {}
  }
  ```
- 关键错误需记录详细日志
- 业务逻辑错误需明确提示用户

## 6. 文档维护

- **文档版本**：v1.0
- **编制日期**：2023年10月25日
- **编制人**：技术部
- **审核人**：系统架构师
- **批准人**：技术总监

---

本文档将随着系统设计和接口需求的变化而定期更新，确保文档与实际实现保持一致。