# LIMS子系统（实验室管理系统）架构设计

## 1. 概述

LIMS子系统基于微服务架构设计，实现实验室信息管理的一体化解决方案，通过标准化实验流程、电子化数据管理，确保实验室操作符合GMP规范。

## 2. 系统架构

### 2.1 分层架构设计

```
┌────────────────────────────────────────────────────┐
│            表现层 (Presentation Layer)             │
│   ┌─────────────────────────────────────────────┐   │
│   │        REST控制器 (Controllers)            │   │
│   │ - SampleController                         │   │
│   │ - TestTaskController                       │   │
│   │ - TestResultController                     │   │
│   │ - InstrumentController                     │   │
│   └─────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────┘
                                ▼
┌────────────────────────────────────────────────────┐
│           业务逻辑层 (Business Layer)               │
│   ┌─────────────────────────────────────────────┐   │
│   │       业务服务 (Services)                    │   │
│   │ - SampleManagementService                   │   │
│   │ - TestExecutionService                      │   │
│   │ - QualityControlService                     │   │
│   │ - InstrumentManagementService               │   │
│   │                                             │   │
│   │ - 实验室工作流引擎                          │   │
│   │ - 质量规则引擎                              │   │
│   │ - 数据验证引擎                              │   │
│   └─────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────┘
                                ▼
┌────────────────────────────────────────────────────┐
│           数据访问层 (Data Access Layer)            │
│   ┌─────────────────────────────────────────────┐   │
│   │       数据仓库 (Repositories)               │   │
│   │ - SampleRepository                          │   │
│   │ - TestTaskRepository                        │   │
│   │ - TestResultRepository                      │   │
│   │ - InstrumentRepository                      │   │
│   └─────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────┘
                                ▼
┌────────────────────────────────────────────────────┐
│           数据存储层 (Data Storage)                │
└────────────────────────────────────────────────────┘
```

### 2.2 微服务架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    LIMS微服务 (lims-service:8083)           │
│                                                             │
│  ┌─────────────┬─────────────┬─────────────┬─────────────┐   │
│  │ 样品管理    │ 测试任务管  │ 测试结果管  │ 仪器管理    │   │
│  │ Sample Mgmt │ Test Task   │ Test Result │ Instrument  │   │
│  │             │ Management  │ Management  │ Management  │   │
│  └─────────────┴─────────────┴─────────────┴─────────────┘   │
│                                                             │
│  ┌─────────────┬─────────────┬─────────────┬─────────────┐   │
│  │ 工作流管理  │ 质量控制    │ 数据验证    │ 报告生成    │   │
│  │ Workflow    │ Quality Ctrl│ Data        │ Report Gen  │   │
│  │ Management  │             │ Validation  │             │   │
│  └─────────────┴─────────────┴─────────────┴─────────────┘   │
└─────────────────────────────────────────────────────────────┘
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                    数据存储与集成                          │
│                                                             │
│  PostgreSQL lims_db      Redis Cache     RabbitMQ      │
│  - samples                                               │
│  - test_tasks                                            │
│  - test_results                                          │
│  - instruments                    仪器接口集成             │
│                                                             │
│  外部系统集成：仪器系统、MES、QMS、文档系统                │
└─────────────────────────────────────────────────────────────┘
```

## 3. 服务设计

### 3.1 微服务边界

LIMS微服务主要包含四个核心业务领域：

```
样品管理 (Sample Management)
├── 样品接收与登记 (@Post /api/lims/samples)
├── 样品信息查询 (@Get /api/lims/samples)
├── 样品状态更新 (@Patch /api/lims/samples/{id}/status)
├── 样品存储分配 (@Post /api/lims/samples/{id}/storage)
└── 样品追溯查询 (@Get /api/lims/samples/{id}/trace)

测试任务管理 (Test Task Management)
├── 测试任务创建 (@Post /api/lims/test-tasks)
├── 任务状态查询 (@Get /api/lims/test-tasks)
├── 任务分配 (@Patch /api/lims/test-tasks/{id}/assign)
├── 任务更新 (@Put /api/lims/test-tasks/{id})
└── 任务完成确认 (@Patch /api/lims/test-tasks/{id}/complete)

测试结果管理 (Test Result Management)
├── 结果录入 (@Post /api/lims/test-results)
├── 结果查询 (@Get /api/lims/test-results)
├── 结果审核 (@Patch /api/lims/test-results/{id}/review)
├── 结果批准 (@Patch /api/lims/test-results/{id}/approve)
└── 结果统计 (@Get /api/lims/test-results/statistics)

仪器管理 (Instrument Management)
├── 仪器注册 (@Post /api/lims/instruments)
├── 仪器查询 (@Get /api/lims/instruments)
├── 校准管理 (@Post /api/lims/instruments/{id}/calibrations)
├── 维护记录 (@Post /api/lims/instruments/{id}/maintenance)
└── 使用统计 (@Get /api/lims/instruments/{id}/usage)
```

## 4. 数据架构设计

### 4.1 核心数据表关系

```
lims_db
├── samples (样品表)
│   ├── id (主键)
│   ├── sample_number (样品编号)
│   ├── sample_type (样品类型)
│   ├── source_type (来源类型)
│   ├── status (状态)
│   ├── received_date (接收日期)
│   └── storage_condition (保存条件)
│
├── test_tasks (测试任务表)
│   ├── id (主键)
│   ├── task_number (任务编号)
│   ├── sample_id (样品ID - 外键)
│   ├── test_category (测试类别)
│   ├── status (状态)
│   └── assigned_technician (分配技术员)
│
├── test_results (测试结果表)
│   ├── id (主键)
│   ├── test_task_id (测试任务ID - 外键)
│   ├── sample_id (样品ID - 外键)
│   ├── test_item (测试项目)
│   ├── result_status (结果状态)
│   ├── tested_by (测试人员)
│   └── reviewed_by (审核人员)
│
└── instruments (仪器设备表)
    ├── id (主键)
    ├── instrument_code (仪器代码)
    ├── instrument_name (仪器名称)
    ├── status (状态)
    ├── calibration_date (上次校准日期)
    └── next_calibration_date (下次校准日期)
```

### 4.2 核心数据模型

#### 4.2.1 样品实体类
```java
@Entity
@Table(name = "samples")
@Data
@Audited
public class Sample {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(unique = true, nullable = false)
    private String sampleNumber;

    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    private SampleType sampleType;

    @Enumerated(EnumType.STRING)
    private SampleSourceType sourceType;

    @Column(nullable = false)
    private LocalDateTime receivedDate;

    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    private SampleStatus status = SampleStatus.RECEIVED;

    @Enumerated(EnumType.STRING)
    private StorageCondition storageCondition;

    private String storageLocation;
    private LocalDateTime expiryDate;

    @Column(nullable = false)
    private String samplingPersonnel;

    private String inspectionResult;
    private LocalDateTime inspectionDate;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "qa_inspector_id")
    private User qaInspector;

    // 审计字段
    @CreatedDate
    private LocalDateTime createdAt;

    @LastModifiedDate
    private LocalDateTime updatedAt;
}
```

#### 4.2.2 测试结果实体类
```java
@Entity
@Table(name = "test_results")
@Data
public class TestResult {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "test_task_id", nullable = false)
    private TestTask testTask;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "sample_id", nullable = false)
    private Sample sample;

    @Column(nullable = false)
    private String testItem;

    private String testMethod;
    private String specification;

    private BigDecimal testValueNumeric;
    private String testValueText;
    private String unit;

    private BigDecimal lowerLimit;
    private BigDecimal upperLimit;

    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    private TestResultStatus resultStatus;

    @Column(nullable = false)
    private String testedBy;

    @Column(nullable = false)
    private LocalDateTime testedDate;

    private String reviewedBy;
    private LocalDateTime reviewedDate;

    private String approvedBy;
    private LocalDateTime approvedDate;

    @Column(columnDefinition = "TEXT")
    private String remarks;
}
```

## 5. 业务规则引擎

### 5.1 质量控制引擎

```java
@Service
public class QualityControlEngine {

    // 自动结果判定逻辑
    public TestResultStatus evaluateTestResult(BigDecimal measuredValue,
                                               BigDecimal lowerLimit,
                                               BigDecimal upperLimit) {
        if (measuredValue == null) {
            return TestResultStatus.INVALID;
        }

        if (lowerLimit != null && measuredValue.compareTo(lowerLimit) < 0) {
            return TestResultStatus.FAIL;
        }

        if (upperLimit != null && measuredValue.compareTo(upperLimit) > 0) {
            return TestResultStatus.FAIL;
        }

        return TestResultStatus.PASS;
    }

    // 测试任务优先级计算
    public TestPriority calculateTaskPriority(Sample sample, TestCategory category) {
        // 根据样品类型、测试类别和紧急程度计算优先级
        if (sample.getSampleType() == SampleType.FINAL_PRODUCT) {
            return category == TestCategory.CHEMICAL ? TestPriority.HIGH : TestPriority.NORMAL;
        }
        // 其他规则...
    }
}
```

## 6. 仪器集成设计

### 6.1 仪器接口架构

```java
@Component
public class InstrumentIntegrationManager {

    private final Map<String, InstrumentAdapter> instrumentAdapters = new ConcurrentHashMap<>();

    // 注册仪器适配器
    public void registerAdapter(String instrumentType, InstrumentAdapter adapter) {
        instrumentAdapters.put(instrumentType, adapter);
    }

    // 发送测试命令到仪器
    public TestCommandResult sendCommand(String instrumentCode, InstrumentCommand command) {
        InstrumentAdapter adapter = findAdapterByInstrumentCode(instrumentCode);
        if (adapter != null) {
            return adapter.executeCommand(command);
        }
        throw new InstrumentNotFoundException("Instrument adapter not found: " + instrumentCode);
    }

    // 接收仪器数据回调
    public void handleInstrumentCallback(String instrumentCode, String data) {
        // 解析仪器返回的数据
        // 更新测试结果
        // 触发后续业务流程
    }
}
```

## 7. 数据完整性保护

### 7.1 数据不可修改策略

```java
@Repository
public interface TestResultRepository extends JpaRepository<TestResult, Long> {

    // 标准查询方法
    List<TestResult> findBySampleId(Long sampleId);

    // 审核通过后的数据不可修改
    @Modifying
    @Query("UPDATE TestResult t SET t.reviewedBy = :reviewer, t.reviewedDate = :date " +
           "WHERE t.id = :id AND t.reviewedBy IS NULL")
    int approveResult(@Param("id") Long id, @Param("reviewer") String reviewer,
                      @Param("date") LocalDateTime date);

    // 修正记录管理（追加而非修改）
    @Query("SELECT t FROM TestResult t WHERE t.sampleId = :sampleId AND " +
           "t.status <> 'SUPERSEDED'")
    List<TestResult> findActiveResultsBySample(@Param("sampleId") Long sampleId);
}
```

## 8. 电子签名与审计

### 8.1 电子签名实现

```java
@Service
public class ElectronicSignatureService {

    @Autowired
    private JwtTokenProvider tokenProvider;

    // 生成电子签名
    public String generateSignature(String userId, String action, String dataHash) {
        Map<String, Object> signatureData = new HashMap<>();
        signatureData.put("userId", userId);
        signatureData.put("action", action);
        signatureData.put("timestamp", LocalDateTime.now());
        signatureData.put("dataHash", dataHash);

        // 使用用户私钥签名
        return tokenProvider.sign(signatureData);
    }

    // 验证电子签名
    public boolean verifySignature(String signature, String userId, String action) {
        try {
            Map<String, Object> signatureData = tokenProvider.verifyAndGetClaims(signature);

            // 验证签名时间窗口（24小时内有效）
            LocalDateTime signTime = (LocalDateTime) signatureData.get("timestamp");
            if (Duration.between(signTime, LocalDateTime.now()).toHours() > 24) {
                return false;
            }

            // 验证用户身份
            return userId.equals(signatureData.get("userId")) &&
                   action.equals(signatureData.get("action"));

        } catch (Exception e) {
            return false;
        }
    }
}
```

---

**文档信息：**
- 版本：v1.0
- 更新日期：2024年
- 编制人员：架构设计团队
- 状态：Draft
