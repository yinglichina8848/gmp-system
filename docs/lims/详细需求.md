# LIMS子系统（实验室管理系统）详细需求分析

## 1. 样品管理模块 (Sample Management)

### 1.1 功能需求

#### 1.1.1 样品登记与信息管理
- **样品基本信息**：
  - 样品编号 (自动生成规则：SAMPLE-YYYY-MMDD-001)
  - 样品类型 (成品、中间体、原料、包装材料等)
  - 样品来源 (生产批次、供应商批次等)
  - 接收日期和时间
  - 保存条件 (常温、冷藏、冷冻等)
  - 采样人员和位置
  - 样品状态跟踪 (接收中、已接收、分配中、已分配、测试中、已完成)

- **样品状态管理**：
  - 状态转换流程严格控制
  - 状态变更记录完整审计日志
  - 支持样品驳回和退样处理

#### 1.1.2 样品存储与追溯
- **存储位置管理**：冷藏柜位置、冰箱层级、二维码定位
- **存储条件监控**：温度、湿度监控，超限报警
- **过期预警**：样品保存有效期管理，提前预警
- **样品追溯**：从测试结果反向追溯到原始样品信息

### 1.2 数据模型

#### 1.2.1 样品表 (samples)
```sql
CREATE TABLE samples (
    id BIGSERIAL PRIMARY KEY,
    sample_number VARCHAR(50) UNIQUE NOT NULL, -- SAMPLE-2024-0101-001
    sample_type VARCHAR(20) NOT NULL, -- FINAL_PRODUCT, INTERMEDIATE, RAW_MATERIAL, PACKAGING
    source_type VARCHAR(20), -- PRODUCTION_BATCH, SUPPLIER_BATCH, PROCESS_SAMPLE
    source_batch_number VARCHAR(50),
    received_date TIMESTAMP NOT NULL,
    sampling_personnel VARCHAR(100),
    sampling_location VARCHAR(200),
    storage_condition VARCHAR(50), -- ROOM_TEMPERATURE, REFRIGERATED, FROZEN
    storage_location VARCHAR(200),
    expiry_date TIMESTAMP,
    status VARCHAR(20) DEFAULT 'RECEIVED',
    qa_inspector VARCHAR(100),
    inspection_date TIMESTAMP,
    inspection_result VARCHAR(20), -- PASS, FAIL, CONDITIONAL
    remarks TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 1.2.2 测试任务表 (test_tasks)
```sql
CREATE TABLE test_tasks (
    id BIGSERIAL PRIMARY KEY,
    task_number VARCHAR(50) UNIQUE NOT NULL, -- TASK-2024-0101-001
    sample_id BIGINT REFERENCES samples(id),
    test_category VARCHAR(50) NOT NULL, -- CHEMICAL, PHYSICAL, MICROBIOLOGICAL, STABILITY
    test_method VARCHAR(100) NOT NULL,
    test_standard VARCHAR(200),
    priority VARCHAR(20) DEFAULT 'NORMAL', -- URGENT, HIGH, NORMAL, LOW
    planned_start_date TIMESTAMP,
    planned_completion_date TIMESTAMP,
    assigned_technician VARCHAR(100),
    assigned_supervisor VARCHAR(100),
    status VARCHAR(20) DEFAULT 'ASSIGNED',
    equipment_required VARCHAR(500), -- JSON格式存储仪器需求
    reagents_required TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## 2. 测试执行模块 (Test Execution)

### 2.1 功能需求

#### 2.1.1 测试过程管理
- **测试准备**：环境条件确认，仪器校准状态验证
- **数据采集**：手动录入和仪器自动采集相结合
- **过程监控**：测试进度跟踪，超时预警
- **异常处理**：测试失败原因记录，重新测试流程

#### 2.1.2 质量把关
- **数据审核**：技术员自检，主管审核
- **结果判定**：基于标准自动判定，支持人工干预
- **电子签名**：测试执行和审核的电子签名
- **签名验证**：签名有效性和权限验证

### 2.2 数据模型

#### 2.2.1 测试结果表 (test_results)
```sql
CREATE TABLE test_results (
    id BIGSERIAL PRIMARY KEY,
    test_task_id BIGINT REFERENCES test_tasks(id),
    sample_id BIGINT REFERENCES samples(id),
    test_item VARCHAR(100) NOT NULL,
    test_method VARCHAR(200),
    specification TEXT, -- 测试标准规范
    test_value_numeric DECIMAL(15,6),
    test_value_text TEXT,
    unit VARCHAR(50),
    lower_limit DECIMAL(15,6),
    upper_limit DECIMAL(15,6),
    result_status VARCHAR(20) NOT NULL, -- PASS, FAIL, CONDITIONAL, INVALID
    testing_conditions TEXT, -- 测试环境条件JSON
    instrument_used VARCHAR(200),
    instrument_serial VARCHAR(50),
    calibration_status VARCHAR(20), -- VALID, EXPIRED, DUE
    tested_by VARCHAR(100) NOT NULL,
    tested_date TIMESTAMP NOT NULL,
    reviewed_by VARCHAR(100),
    reviewed_date TIMESTAMP,
    approved_by VARCHAR(100),
    approved_date TIMESTAMP,
    remarks TEXT,
    electronic_signature TEXT, -- JSON格式存储签名信息
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 2.2.2 测试原始数据表 (test_raw_data)
```sql
CREATE TABLE test_raw_data (
    id BIGSERIAL PRIMARY KEY,
    test_result_id BIGINT REFERENCES test_results(id),
    data_sequence INTEGER NOT NULL, -- 数据序列号
    measurement_time TIMESTAMP,
    raw_value DECIMAL(15,6),
    processed_value DECIMAL(15,6),
    data_quality_indicator VARCHAR(20), -- GOOD, QUESTIONABLE, BAD
    data_source VARCHAR(20), -- MANUAL, INSTRUMENT, CALCULATION
    operator_notes TEXT,
    recorded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## 3. 仪器管理模块 (Instrument Management)

### 3.1 功能需求

#### 3.1.1 仪器信息管理
- **仪器台账**：仪器基本信息、供应商、安装日期
- **状态管理**：使用中、维修中、停用等状态
- **资产管理**：设备价值、折旧计算、使用率统计

#### 3.1.2 校准维护管理
- **校准计划**：定期校准提醒，校准历史记录
- **维护记录**：预防性维护，故障维修记录
- **证书管理**：校准证书有效期管理

### 3.2 数据模型

#### 3.2.1 仪器设备表 (instruments)
```sql
CREATE TABLE instruments (
    id BIGSERIAL PRIMARY KEY,
    instrument_code VARCHAR(50) UNIQUE NOT NULL,
    instrument_name VARCHAR(200) NOT NULL,
    manufacturer VARCHAR(100),
    model VARCHAR(50),
    serial_number VARCHAR(50),
    purchase_date DATE,
    installation_date DATE,
    location VARCHAR(200),
    status VARCHAR(20) DEFAULT 'ACTIVE', -- ACTIVE, MAINTENANCE, DECOMMISSIONED
    instrument_type VARCHAR(50),
    measurement_range TEXT, -- JSON格式存储量程信息
    accuracy_specification TEXT,
    purchase_cost DECIMAL(12,2),
    department_owner VARCHAR(100),
    responsible_person VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 3.2.2 校准记录表 (calibrations)
```sql
CREATE TABLE calibrations (
    id BIGSERIAL PRIMARY KEY,
    instrument_id BIGINT REFERENCES instruments(id),
    calibration_number VARCHAR(50) UNIQUE NOT NULL,
    calibration_date DATE NOT NULL,
    next_due_date DATE,
    calibration_method VARCHAR(200),
    calibration_standard VARCHAR(200),
    calibration_result VARCHAR(20) NOT NULL, -- PASS, FAIL, CONDITIONAL
    calibrated_by VARCHAR(100) NOT NULL,
    reviewed_by VARCHAR(100),
    certificate_number VARCHAR(50),
    certificate_issuer VARCHAR(100),
    certificate_expiry DATE,
    calibration_cost DECIMAL(10,2),
    remarks TEXT,
    attachments TEXT, -- 校准证书等附件文件路径JSON
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## 4. REST API接口设计

### 4.1 样品管理接口

#### 4.1.1 样品登记
```
POST /api/lims/samples
Content-Type: application/json

{
    "sampleNumber": "SAMPLE-2024-0101-001",
    "sampleType": "FINAL_PRODUCT",
    "sourceType": "PRODUCTION_BATCH",
    "sourceBatchNumber": "BATCH-2024-0101-001",
    "receivedDate": "2024-01-01T10:00:00Z",
    "storageCondition": "REFRIGERATED",
    "expiryDate": "2024-07-01T00:00:00Z"
}
```

#### 4.1.2 样品查询
```
GET /api/lims/samples?page=0&size=20&status=RECEIVED&sampleType=FINAL_PRODUCT
```

### 4.2 测试结果接口

#### 4.2.1 提交测试结果
```
POST /api/lims/test-results
{
    "testTaskId": 1,
    "sampleId": 1,
    "testItem": "含量测定",
    "testMethod": "HPLC测定法",
    "specification": "98.0-102.0%",
    "testValueNumeric": 99.5,
    "unit": "%",
    "resultStatus": "PASS",
    "testedBy": "technician001",
    "testedDate": "2024-01-01T15:00:00Z"
}
```

## 5. 数据库设计要点

### 5.1 索引优化
- 样品状态和类型索引
- 测试任务状态和优先级索引
- 时间范围查询索引
- 外键约束索引

### 5.2 数据完整性
- 级联删除保护重要数据
- 数据状态约束
- 必填字段验证
- 唯一性约束

### 5.3 审计要求
- 所有测试数据不可修改，只能追加更正记录
- 完整的修改历史追踪
- 电子签名时间戳记录

---

**文档信息：**
- 版本：v1.0
- 更新日期：2024年
- 编制人员：详细需求分析团队
- 状态：Draft
