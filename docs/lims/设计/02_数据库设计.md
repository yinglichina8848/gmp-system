# LIMS子系统（实验室管理系统）数据库设计

## 1. 数据库设计概述

### 1.1 设计原则

- **中药特色原则**：数据库设计充分考虑中药材质量检测的特殊需求
- **规范化与性能平衡**：在确保数据一致性的同时兼顾查询性能
- **可扩展性**：支持未来业务增长和新功能扩展
- **数据安全**：符合GMP要求的安全设计
- **数据完整性**：通过约束和事务确保数据的准确性和完整性

### 1.2 数据库技术选型

- **关系型数据库**：PostgreSQL 14.x
  - 用于存储结构化业务数据，确保事务一致性
  - 优势：强大的数据完整性约束、丰富的数据类型支持、良好的并发性能
- **文档型数据库**：MongoDB 5.x
  - 用于存储非结构化数据，如指纹图谱、传统鉴别数据等
  - 优势：灵活的文档结构、良好的扩展性、适合处理复杂数据

## 2. 核心数据模型设计

### 2.1 关系型数据库（PostgreSQL）

#### 2.1.1 样品管理模块

##### **样品信息表 (samples)**
| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| sample_id | UUID | PRIMARY KEY | 样品唯一标识 |
| sample_code | VARCHAR(50) | UNIQUE NOT NULL | 样品编号 |
| sample_name | VARCHAR(100) | NOT NULL | 样品名称 |
| scientific_name | VARCHAR(150) | | 学名（拉丁文名称） |
| variety | VARCHAR(50) | | 品种/规格 |
| origin | VARCHAR(100) | | 产地 |
| origin_standard | VARCHAR(50) | | 道地性标准 |
| supplier_id | UUID | REFERENCES suppliers(supplier_id) | 供应商ID |
| batch_number | VARCHAR(50) | NOT NULL | 批次号 |
| production_date | DATE | | 生产日期 |
| expiry_date | DATE | | 有效期 |
| quantity | DECIMAL(10,4) | NOT NULL | 数量 |
| unit | VARCHAR(20) | NOT NULL | 单位 |
| storage_condition | VARCHAR(100) | | 存储条件 |
| current_location | VARCHAR(200) | | 当前位置 |
| sample_status | VARCHAR(30) | NOT NULL | 样品状态 |
| receive_date | TIMESTAMP | NOT NULL | 接收日期 |
| received_by | UUID | REFERENCES users(user_id) | 接收人 |
| quality_level | VARCHAR(30) | | 质量等级 |
| initial_check_result | TEXT | | 初检结果描述 |
| created_at | TIMESTAMP | NOT NULL | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL | 更新时间 |

##### **供应商信息表 (suppliers)**
| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| supplier_id | UUID | PRIMARY KEY | 供应商ID |
| supplier_name | VARCHAR(100) | NOT NULL | 供应商名称 |
| contact_person | VARCHAR(50) | | 联系人 |
| contact_phone | VARCHAR(20) | | 联系电话 |
| address | TEXT | | 地址 |
| supplier_type | VARCHAR(30) | | 供应商类型 |
| qualification_status | VARCHAR(30) | | 资质状态 |
| created_at | TIMESTAMP | NOT NULL | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL | 更新时间 |

#### 2.1.2 检测任务管理模块

##### **检测任务表 (test_tasks)**
| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| task_id | UUID | PRIMARY KEY | 任务ID |
| task_code | VARCHAR(50) | UNIQUE NOT NULL | 任务编号 |
| sample_id | UUID | REFERENCES samples(sample_id) | 样品ID |
| test_type | VARCHAR(50) | NOT NULL | 检测类型 |
| priority | VARCHAR(20) | NOT NULL | 优先级 |
| assigned_to | UUID | REFERENCES users(user_id) | 任务执行人 |
| task_status | VARCHAR(30) | NOT NULL | 任务状态 |
| start_date | TIMESTAMP | | 开始日期 |
| due_date | TIMESTAMP | | 截止日期 |
| completion_date | TIMESTAMP | | 完成日期 |
| created_by | UUID | REFERENCES users(user_id) | 创建人 |
| created_at | TIMESTAMP | NOT NULL | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL | 更新时间 |

##### **检测项目表 (test_items)**
| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| item_id | UUID | PRIMARY KEY | 项目ID |
| task_id | UUID | REFERENCES test_tasks(task_id) | 所属任务ID |
| method_id | UUID | REFERENCES test_methods(method_id) | 检测方法ID |
| item_status | VARCHAR(30) | NOT NULL | 项目状态 |
| specification | VARCHAR(200) | | 检验标准 |
| unit | VARCHAR(20) | | 单位 |
| lower_limit | DECIMAL(15,6) | | 下限值 |
| upper_limit | DECIMAL(15,6) | | 上限值 |
| expected_value | DECIMAL(15,6) | | 期望值 |
| created_at | TIMESTAMP | NOT NULL | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL | 更新时间 |

##### **检测方法表 (test_methods)**
| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| method_id | UUID | PRIMARY KEY | 方法ID |
| method_code | VARCHAR(50) | UNIQUE NOT NULL | 方法编号 |
| method_name | VARCHAR(100) | NOT NULL | 方法名称 |
| method_type | VARCHAR(50) | NOT NULL | 方法类型 |
| category | VARCHAR(50) | NOT NULL | 方法类别 |
| standard_reference | VARCHAR(200) | | 标准参考 |
| instrument_requirements | TEXT | | 仪器要求 |
| reagent_requirements | TEXT | | 试剂要求 |
| procedure_description | TEXT | | 操作步骤描述 |
| calculation_formula | TEXT | | 计算公式 |
| version | VARCHAR(20) | NOT NULL | 版本号 |
| status | VARCHAR(30) | NOT NULL | 状态 |
| created_at | TIMESTAMP | NOT NULL | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL | 更新时间 |

#### 2.1.3 检测结果管理模块

##### **检测结果表 (test_results)**
| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| result_id | UUID | PRIMARY KEY | 结果ID |
| item_id | UUID | REFERENCES test_items(item_id) | 检测项目ID |
| actual_value | DECIMAL(15,6) | | 实测值 |
| qualitative_result | VARCHAR(100) | | 定性结果 |
| measurement_unit | VARCHAR(20) | | 计量单位 |
| is_qualified | BOOLEAN | | 是否合格 |
| test_date | TIMESTAMP | | 检测日期 |
| tested_by | UUID | REFERENCES users(user_id) | 检测人 |
| instrument_id | UUID | REFERENCES instruments(instrument_id) | 使用仪器 |
| remark | TEXT | | 备注 |
| created_at | TIMESTAMP | NOT NULL | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL | 更新时间 |

##### **审核记录表 (audit_records)**
| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| audit_id | UUID | PRIMARY KEY | 审核记录ID |
| result_id | UUID | REFERENCES test_results(result_id) | 结果ID |
| audit_status | VARCHAR(30) | NOT NULL | 审核状态 |
| audit_comment | TEXT | | 审核意见 |
| audited_by | UUID | REFERENCES users(user_id) | 审核人 |
| audit_date | TIMESTAMP | | 审核日期 |
| created_at | TIMESTAMP | NOT NULL | 创建时间 |

#### 2.1.4 质量管理模块

##### **质量标准表 (quality_standards)**
| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| standard_id | UUID | PRIMARY KEY | 标准ID |
| standard_code | VARCHAR(50) | UNIQUE NOT NULL | 标准编号 |
| standard_name | VARCHAR(100) | NOT NULL | 标准名称 |
| standard_type | VARCHAR(50) | NOT NULL | 标准类型 |
| version | VARCHAR(20) | NOT NULL | 版本号 |
| effective_date | DATE | NOT NULL | 生效日期 |
| expiry_date | DATE | | 失效日期 |
| status | VARCHAR(30) | NOT NULL | 状态 |
| standard_content | TEXT | | 标准内容 |
| created_at | TIMESTAMP | NOT NULL | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL | 更新时间 |

##### **异常处理记录表 (exception_records)**
| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| exception_id | UUID | PRIMARY KEY | 异常记录ID |
| related_entity_type | VARCHAR(50) | NOT NULL | 相关实体类型 |
| related_entity_id | UUID | NOT NULL | 相关实体ID |
| exception_type | VARCHAR(50) | NOT NULL | 异常类型 |
| exception_description | TEXT | NOT NULL | 异常描述 |
| severity_level | VARCHAR(20) | NOT NULL | 严重程度 |
| handling_status | VARCHAR(30) | NOT NULL | 处理状态 |
| handler_id | UUID | REFERENCES users(user_id) | 处理人 |
| handling_date | TIMESTAMP | | 处理日期 |
| handling_result | TEXT | | 处理结果 |
| created_at | TIMESTAMP | NOT NULL | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL | 更新时间 |

#### 2.1.5 系统管理模块

##### **用户信息表 (users)**
| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| user_id | UUID | PRIMARY KEY | 用户ID |
| username | VARCHAR(50) | UNIQUE NOT NULL | 用户名 |
| password_hash | VARCHAR(255) | NOT NULL | 密码哈希 |
| real_name | VARCHAR(50) | NOT NULL | 真实姓名 |
| email | VARCHAR(100) | | 邮箱 |
| phone | VARCHAR(20) | | 电话 |
| department_id | UUID | REFERENCES departments(department_id) | 部门ID |
| position | VARCHAR(50) | | 职位 |
| role_id | UUID | REFERENCES roles(role_id) | 角色ID |
| status | VARCHAR(30) | NOT NULL | 用户状态 |
| last_login_at | TIMESTAMP | | 最后登录时间 |
| created_at | TIMESTAMP | NOT NULL | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL | 更新时间 |

##### **角色权限表 (roles)**
| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| role_id | UUID | PRIMARY KEY | 角色ID |
| role_name | VARCHAR(50) | UNIQUE NOT NULL | 角色名称 |
| description | TEXT | | 角色描述 |
| created_at | TIMESTAMP | NOT NULL | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL | 更新时间 |

##### **操作日志表 (operation_logs)**
| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| log_id | UUID | PRIMARY KEY | 日志ID |
| user_id | UUID | REFERENCES users(user_id) | 操作用户ID |
| operation_type | VARCHAR(50) | NOT NULL | 操作类型 |
| entity_type | VARCHAR(50) | NOT NULL | 操作实体类型 |
| entity_id | UUID | | 操作实体ID |
| operation_detail | TEXT | NOT NULL | 操作详情 |
| operation_ip | VARCHAR(50) | | 操作IP |
| created_at | TIMESTAMP | NOT NULL | 操作时间 |

### 2.2 文档型数据库（MongoDB）

#### 2.2.1 中药特色数据模型

##### **指纹图谱数据**
```javascript
{
  "fingerprint_id": "UUID",
  "sample_id": "UUID",
  "method_id": "UUID",
  "analysis_date": "Date",
  "analyst_id": "UUID",
  "instrument_id": "UUID",
  "chromatogram_data": {
    "retention_times": [1.2, 1.5, 2.3, ...], // 保留时间数组
    "peak_areas": [1234, 5678, 9012, ...],    // 峰面积数组
    "peak_heights": [123, 456, 789, ...],    // 峰高数组
    "resolution": 1.5,                       // 分辨率
    "chromatogram_image": "BASE64_ENCODED_STRING" // 色谱图图像
  },
  "fingerprint_analysis": {
    "similarity_score": 0.95,                // 相似度评分
    "compared_standard": "UUID",            // 比对标准图谱ID
    "characteristic_peaks": [                // 特征峰信息
      {
        "peak_number": 1,
        "retention_time": 1.2,
        "relative_area": 0.23,
        "assigned_component": "XXX成分"
      },
      // ...更多特征峰
    ],
    "differential_peaks": []                 // 差异峰信息
  },
  "metadata": {
    "instrument_settings": {},
    "mobile_phase": "",
    "column_type": "",
    "flow_rate": 1.0
  },
  "created_at": "Date",
  "updated_at": "Date"
}
```

##### **传统鉴别数据**
```javascript
{
  "authentication_id": "UUID",
  "sample_id": "UUID",
  "authentication_type": "性状鉴别", // 性状鉴别、显微鉴别、理化鉴别
  "authentication_date": "Date",
  "authenticated_by": "UUID",
  "characteristics": {
    "external_features": {
      "color": "棕色",
      "texture": "粗糙",
      "shape": "圆柱形",
      "size": "直径1-2cm",
      "odor": "特异",
      "taste": "苦"
    },
    "microscopic_features": {
      "cell_types": ["纤维细胞", "导管细胞"],
      "crystal_types": ["草酸钙簇晶"],
      "starch_grains": true,
      "microscopic_images": ["BASE64_ENCODED_STRING_1", "BASE64_ENCODED_STRING_2"]
    },
    "physicochemical_features": {
      "solubility": "",
      "reaction_results": [],
      "fluorescence_test": "蓝色荧光"
    }
  },
  "conclusion": "符合规定",
  "reference": "中国药典2020版一部",
  "notes": "",
  "attachments": [
    {
      "file_name": "照片1.jpg",
      "file_type": "image/jpeg",
      "file_size": 1024000,
      "file_path": "attachments/xxx/photo1.jpg",
      "upload_date": "Date"
    }
  ],
  "created_at": "Date",
  "updated_at": "Date"
}
```

##### **道地性评估数据**
```javascript
{
  "geo_assessment_id": "UUID",
  "sample_id": "UUID",
  "assessment_date": "Date",
  "assessor_id": "UUID",
  "origin_info": {
    "declared_origin": "浙江省磐安县",
    "actual_origin": "浙江省磐安县",
    "growing_environment": {
      "elevation": 800,
      "climate_type": "亚热带季风气候",
      "soil_type": "红壤"
    }
  },
  "characteristic_components": [
    {
      "component_name": "有效成分A",
      "content": 1.2,
      "unit": "%",
      "reference_range": "1.0-1.5%",
      "similarity_score": 0.98
    },
    // ...更多特征成分
  ],
  "trace_elements_fingerprint": {
    "element_ratios": {
      "Cu/Zn": 0.5,
      "Fe/Mn": 2.3
      // ...更多元素比例
    },
    "fingerprint_similarity": 0.92
  },
  "traditional_quality_features": {
    "color_similarity": 0.95,
    "odor_similarity": 0.90,
    "taste_similarity": 0.88
  },
  "overall_assessment": {
    "geo_authenticity_score": 0.94, // 道地性评分(0-1)
    "assessment_conclusion": "符合道地药材特征",
    "confidence_level": "高"
  },
  "assessment_notes": "",
  "created_at": "Date",
  "updated_at": "Date"
}
```

## 3. 索引设计

### 3.1 PostgreSQL 索引

```sql
-- 样品表索引
CREATE INDEX idx_samples_sample_code ON samples(sample_code);
CREATE INDEX idx_samples_sample_name ON samples(sample_name);
CREATE INDEX idx_samples_batch_number ON samples(batch_number);
CREATE INDEX idx_samples_sample_status ON samples(sample_status);
CREATE INDEX idx_samples_receive_date ON samples(receive_date);
CREATE INDEX idx_samples_origin ON samples(origin); -- 按产地查询优化

-- 检测任务表索引
CREATE INDEX idx_test_tasks_sample_id ON test_tasks(sample_id);
CREATE INDEX idx_test_tasks_task_status ON test_tasks(task_status);
CREATE INDEX idx_test_tasks_assigned_to ON test_tasks(assigned_to);
CREATE INDEX idx_test_tasks_due_date ON test_tasks(due_date);

-- 检测项目表索引
CREATE INDEX idx_test_items_task_id ON test_items(task_id);
CREATE INDEX idx_test_items_method_id ON test_items(method_id);

-- 检测结果表索引
CREATE INDEX idx_test_results_item_id ON test_results(item_id);
CREATE INDEX idx_test_results_tested_by ON test_results(tested_by);
CREATE INDEX idx_test_results_test_date ON test_results(test_date);

-- 复合索引
CREATE INDEX idx_samples_name_origin ON samples(sample_name, origin); -- 按名称和产地联合查询
CREATE INDEX idx_tasks_sample_status_date ON test_tasks(sample_id, task_status, due_date); -- 按样品和状态查询
```

### 3.2 MongoDB 索引

```javascript
// 指纹图谱集合索引
db.fingerprints.createIndex({ sample_id: 1 });
db.fingerprints.createIndex({ analysis_date: 1 });
db.fingerprints.createIndex({ "fingerprint_analysis.similarity_score": 1 });

// 传统鉴别集合索引
db.authentications.createIndex({ sample_id: 1 });
db.authentications.createIndex({ authentication_type: 1 });
db.authentications.createIndex({ authentication_date: 1 });

// 道地性评估集合索引
db.geo_assessments.createIndex({ sample_id: 1 });
db.geo_assessments.createIndex({ "origin_info.declared_origin": 1 });
db.geo_assessments.createIndex({ "overall_assessment.geo_authenticity_score": 1 });
```

## 4. 数据完整性与约束

### 4.1 关系完整性

- **主键约束**：所有表都有唯一主键
- **外键约束**：确保引用关系的完整性
- **非空约束**：必填字段设置NOT NULL约束
- **唯一约束**：确保关键业务字段的唯一性

### 4.2 业务规则约束

- **CHECK约束**：实现业务规则验证
  ```sql
  -- 示例：有效期必须大于生产日期
  ALTER TABLE samples ADD CONSTRAINT chk_expiry_after_production 
  CHECK (expiry_date IS NULL OR expiry_date > production_date);
  
  -- 示例：道地性评分范围约束
  ALTER TABLE geo_assessment_scores ADD CONSTRAINT chk_score_range 
  CHECK (score >= 0 AND score <= 1);
  ```

### 4.3 数据校验与触发器

- **触发器**：在关键业务操作时执行额外的数据校验和操作
  ```sql
  -- 示例：更新样品状态时记录操作日志的触发器
  CREATE OR REPLACE FUNCTION log_sample_status_change()
  RETURNS TRIGGER AS $$
  BEGIN
    IF NEW.sample_status <> OLD.sample_status THEN
      INSERT INTO operation_logs(log_id, user_id, operation_type, entity_type, entity_id, operation_detail)
      VALUES (uuid_generate_v4(), current_user_id(), 'STATUS_CHANGE', 'SAMPLE', NEW.sample_id,
              '样品状态从 ' || OLD.sample_status || ' 变更为 ' || NEW.sample_status);
    END IF;
    RETURN NEW;
  END;
  $$ LANGUAGE plpgsql;
  
  CREATE TRIGGER trg_sample_status_change
  AFTER UPDATE OF sample_status ON samples
  FOR EACH ROW
  EXECUTE FUNCTION log_sample_status_change();
  ```

## 5. 数据安全设计

### 5.1 访问控制

- **行级安全策略**：基于用户权限限制数据访问范围
  ```sql
  -- 示例：创建行级安全策略
  CREATE POLICY user_department_policy ON samples
  FOR ALL TO authenticated_users
  USING (department_id IN (SELECT department_id FROM users WHERE user_id = current_user_id()));
  ```

### 5.2 数据加密

- **敏感字段加密**：对敏感数据进行加密存储
  ```sql
  -- 示例：供应商联系信息加密存储
  ALTER TABLE suppliers ADD COLUMN contact_phone_encrypted BYTEA;
  ```

### 5.3 审计追踪

- **审计表**：记录关键数据的变更历史
- **操作日志**：详细记录用户的系统操作

## 6. 数据备份与恢复策略

### 6.1 备份策略

- **全量备份**：每日执行一次全量备份
- **增量备份**：每小时执行一次增量备份
- **事务日志备份**：实时备份事务日志
- **异地备份**：备份数据存储到异地，确保灾难恢复能力

### 6.2 恢复策略

- **时间点恢复**：支持恢复到任意时间点
- **故障演练**：定期进行恢复演练，确保备份可用性
- **RTO/RPO目标**：设定合理的恢复时间目标和恢复点目标

## 7. 性能优化设计

### 7.1 查询优化

- **索引优化**：根据查询模式创建适当的索引
- **查询语句优化**：优化SQL查询语句，避免全表扫描
- **分区表**：对大表按时间或业务维度进行分区

### 7.2 数据分区

```sql
-- 示例：按时间分区的操作日志表
CREATE TABLE operation_logs_partitioned (
  -- 字段定义与operation_logs相同
) PARTITION BY RANGE (created_at);

-- 创建按月分区
CREATE TABLE operation_logs_y2023m01 PARTITION OF operation_logs_partitioned
  FOR VALUES FROM ('2023-01-01') TO ('2023-02-01');

CREATE TABLE operation_logs_y2023m02 PARTITION OF operation_logs_partitioned
  FOR VALUES FROM ('2023-02-01') TO ('2023-03-01');

-- ...更多分区
```

### 7.3 读写分离

- **主从复制**：配置PostgreSQL主从复制
- **读写分离**：写操作走主库，读操作走从库
- **负载均衡**：多个从库之间实现负载均衡

## 8. 数据迁移与同步

### 8.1 历史数据迁移

- **迁移策略**：制定详细的数据迁移计划
- **数据验证**：迁移后进行数据完整性验证
- **分批迁移**：大批量数据采用分批迁移策略

### 8.2 数据同步机制

- **实时同步**：关键数据实时同步
- **定时同步**：非关键数据定时同步
- **冲突解决**：制定数据冲突解决策略