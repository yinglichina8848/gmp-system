# 实验室信息管理系统数据库设计需求

## 1. 概述

本文档详细描述实验室信息管理系统（LIMS）的数据库设计需求，包括数据模型、表结构、关系设计、数据存储策略、性能优化等方面，为系统数据库设计提供指导和规范。

## 2. 数据库设计原则

### 2.1 数据完整性原则

- **实体完整性**：主键约束确保记录唯一性
- **参照完整性**：外键约束维护表间关系
- **域完整性**：数据类型、约束条件确保数据有效性
- **业务完整性**：通过业务规则和触发器维护业务数据一致性

### 2.2 性能优化原则

- **查询效率**：合理设计索引，优化查询性能
- **写入效率**：减少不必要的约束和索引，优化写入性能
- **存储效率**：数据类型优化，存储过程优化
- **并发控制**：事务隔离级别设置，锁策略优化

### 2.3 可扩展性原则

- **分库分表**：支持未来数据量增长的分库分表策略
- **读写分离**：支持读写分离架构
- **数据分区**：支持按时间、业务维度的数据分区
- **扩展性字段**：预留扩展性字段，减少结构变更

### 2.4 安全性原则

- **数据加密**：敏感数据加密存储
- **访问控制**：基于角色的数据库访问控制
- **审计追踪**：关键操作日志记录
- **备份恢复**：完善的备份恢复策略

### 2.5 中药检验特色原则

- **检验数据时序存储**：支持检验数据的时序存储和查询
- **图谱数据存储**：支持中药检验图谱的高效存储和检索
- **标准数据版本化**：支持检验标准的版本管理
- **批间数据比较**：支持多批次数据的高效比较

## 3. 数据库技术选型

### 3.1 主要数据库

- **关系型数据库**：MySQL 8.0+
  - 用于存储核心业务数据、配置数据、用户数据等结构化数据
  - 支持事务处理、复杂查询和数据完整性约束

### 3.2 辅助数据库

- **时序数据库**：InfluxDB
  - 用于存储检验原始数据、历史趋势数据
  - 支持高效的时间序列数据存储和查询
  - 适合进行检验数据的趋势分析和统计

- **缓存数据库**：Redis 6.0+
  - 用于缓存热点数据、会话数据
  - 提高系统响应速度，减轻数据库压力
  - 支持分布式锁和消息队列功能

- **文档数据库**：MongoDB（可选）
  - 用于存储非结构化数据、报告模板、检验方法文档等
  - 支持灵活的数据结构和快速查询

## 4. 数据模型设计

### 4.1 核心实体关系

系统核心实体包括：用户、角色、权限、样品、检验任务、检验数据、检验项目、检验标准、检验报告、仪器设备、供应商、客户等。

主要关系图：
- 用户 - 角色：多对多关系
- 角色 - 权限：多对多关系
- 样品 - 检验任务：一对多关系
- 检验任务 - 检验数据：一对多关系
- 检验项目 - 检验标准：一对多关系
- 检验数据 - 检验项目：多对一关系
- 检验任务 - 检验报告：一对多关系
- 检验任务 - 仪器设备：多对多关系

### 4.2 数据模型详细设计

#### 4.2.1 用户管理模块

- **用户表(user)**
  - user_id (PK)
  - username
  - password_hash
  - real_name
  - email
  - phone
  - department_id (FK)
  - position
  - status
  - create_time
  - update_time
  - last_login_time

- **角色表(role)**
  - role_id (PK)
  - role_name
  - role_desc
  - create_time
  - update_time

- **权限表(permission)**
  - permission_id (PK)
  - permission_code
  - permission_name
  - resource_type
  - resource_id
  - action_type
  - create_time
  - update_time

- **用户角色关联表(user_role)**
  - user_id (PK, FK)
  - role_id (PK, FK)

- **角色权限关联表(role_permission)**
  - role_id (PK, FK)
  - permission_id (PK, FK)

#### 4.2.2 样品管理模块

- **样品表(sample)**
  - sample_id (PK)
  - sample_code
  - sample_name
  - batch_number
  - specification
  - quantity
  - unit
  - source
  - sample_type
  - test_type
  - receive_date
  - received_by (FK)
  - current_status
  - storage_location
  - expiry_date
  - remark
  - create_time
  - update_time

- **样品来源表(sample_source)**
  - source_id (PK)
  - source_name
  - contact_person
  - contact_phone
  - address
  - remark

- **样品流转记录表(sample_flow_record)**
  - record_id (PK)
  - sample_id (FK)
  - from_location
  - to_location
  - operator_id (FK)
  - operate_time
  - status_before
  - status_after
  - remark

#### 4.2.3 检验任务模块

- **检验任务表(test_task)**
  - task_id (PK)
  - task_code
  - sample_id (FK)
  - task_name
  - priority
  - assigned_to (FK)
  - assigned_by (FK)
  - assign_date
  - due_date
  - start_date
  - complete_date
  - current_status
  - test_standard_id (FK)
  - test_method_id (FK)
  - department_id (FK)
  - remark
  - create_time
  - update_time

- **检验项目表(test_item)**
  - item_id (PK)
  - item_code
  - item_name
  - item_type
  - unit
  - standard_min_value
  - standard_max_value
  - standard_value
  - test_method_id (FK)
  - precision_requirement
  - remark
  - create_time
  - update_time

- **任务项目关联表(task_item)**
  - task_id (PK, FK)
  - item_id (PK, FK)
  - is_required
  - test_sequence

#### 4.2.4 检验数据模块

- **检验数据表(test_data)**
  - data_id (PK)
  - task_id (FK)
  - item_id (FK)
  - test_value
  - unit
  - test_date
  - tested_by (FK)
  - instrument_id (FK)
  - raw_data_file_path
  - result_status (合格/不合格/异常)
  - deviation_reason
  - review_status
  - reviewed_by (FK)
  - reviewed_date
  - review_comment
  - remark
  - create_time
  - update_time

- **检验图谱表(test_chart)**
  - chart_id (PK)
  - data_id (FK)
  - chart_name
  - chart_type
  - chart_data (JSON或文件路径)
  - create_time
  - update_time

#### 4.2.5 检验报告模块

- **检验报告表(test_report)**
  - report_id (PK)
  - report_code
  - task_id (FK)
  - sample_id (FK)
  - report_title
  - report_type
  - generated_date
  - generated_by (FK)
  - reviewed_date
  - reviewed_by (FK)
  - approved_date
  - approved_by (FK)
  - report_status
  - report_content (JSON或HTML)
  - report_file_path
  - overall_result
  - remark
  - create_time
  - update_time

- **报告模板表(report_template)**
  - template_id (PK)
  - template_name
  - template_type
  - template_content
  - created_by (FK)
  - create_time
  - update_time

#### 4.2.6 质量管理模块

- **检验标准表(test_standard)**
  - standard_id (PK)
  - standard_code
  - standard_name
  - standard_type
  - version
  - effective_date
  - expiry_date
  - standard_content
  - issuer
  - status
  - create_time
  - update_time

- **检验方法表(test_method)**
  - method_id (PK)
  - method_code
  - method_name
  - method_type
  - description
  - procedure
  - equipment_required
  - reagent_required
  - detection_limit
  - quantitation_limit
  - precision_requirement
  - recovery_requirement
  - status
  - create_time
  - update_time

- **质量异常记录表(quality_exception)**
  - exception_id (PK)
  - exception_code
  - related_type (样品/任务/数据/报告)
  - related_id
  - exception_type
  - exception_desc
  - occurred_time
  - reported_by (FK)
  - handler_id (FK)
  - handling_result
  - closed_time
  - status
  - remark
  - create_time
  - update_time

## 5. 数据库索引设计

### 5.1 主键索引

- 所有表的主键字段设置主键索引
- 优先使用自增整数类型作为主键，提高插入性能

### 5.2 唯一索引

- 样品编号(sample_code)
- 批次号(batch_number)
- 任务编号(task_code)
- 报告编号(report_code)
- 用户名(username)
- 检验标准编号(standard_code)
- 检验方法编号(method_code)

### 5.3 普通索引

#### 5.3.1 样品管理
- sample表：sample_name, source, current_status, receive_date, expiry_date
- sample_flow_record表：sample_id, operate_time

#### 5.3.2 检验任务
- test_task表：sample_id, assigned_to, current_status, assign_date, due_date, complete_date
- task_item表：task_id, item_id

#### 5.3.3 检验数据
- test_data表：task_id, item_id, test_date, tested_by, result_status, review_status
- test_chart表：data_id, chart_type

#### 5.3.4 检验报告
- test_report表：task_id, sample_id, report_type, report_status, generated_date, approved_date
- report_template表：template_type

#### 5.3.5 质量管理
- test_standard表：standard_type, status, effective_date
- test_method表：method_type, status
- quality_exception表：related_type, related_id, exception_type, status, occurred_time

## 6. 数据存储策略

### 6.1 分区策略

- **按时间分区**：
  - 检验数据表(test_data)按test_date进行季度分区
  - 检验报告表(test_report)按generated_date进行年度分区
  - 质量异常记录表(quality_exception)按occurred_time进行年度分区

- **按状态分区**：
  - 样品表(sample)按current_status分区
  - 检验任务表(test_task)按current_status分区
  - 检验报告表(test_report)按report_status分区

### 6.2 分库分表策略

- **水平分表**：未来数据量较大时，可考虑对以下表进行水平分表
  - test_data表：按task_id或时间范围分表
  - test_chart表：按data_id分表
  - sample_flow_record表：按sample_id或时间范围分表

- **垂直分库**：
  - 核心业务库：用户、角色、权限、样品、任务、报告等核心业务数据
  - 检验数据专用库：检验原始数据、图谱数据等
  - 历史数据归档库：归档历史检验数据和报告

### 6.3 数据归档策略

- **热数据**：最近1年的数据保持在主库
- **温数据**：1-3年的数据移至归档库
- **冷数据**：3年以上的数据移至冷存储

归档周期：
- 每月进行增量归档
- 每年进行全量归档

归档方式：
- 基于分区的数据归档
- 归档数据压缩存储
- 保留归档数据的查询接口

## 7. 数据库安全设计

### 7.1 访问控制

- **最小权限原则**：数据库用户仅授予所需的最小权限
- **角色分离**：开发、测试、生产环境使用不同的数据库账号
- **连接加密**：所有数据库连接使用SSL/TLS加密

### 7.2 数据加密

- **敏感数据加密存储**：
  - 用户名密码使用加盐哈希存储
  - 个人身份信息加密存储
  - 关键检验结果可选择性加密

- **传输加密**：确保数据传输过程中的安全性

### 7.3 审计日志

- **操作审计**：记录所有关键数据的增删改操作
- **登录审计**：记录所有数据库登录活动
- **审计日志保护**：审计日志不可篡改，定期备份

## 8. 数据库性能优化

### 8.1 查询优化

- **索引优化**：根据查询模式优化索引设计
- **查询语句优化**：避免全表扫描，优化JOIN操作
- **查询缓存**：利用应用层缓存减少数据库查询

### 8.2 写入优化

- **批量操作**：使用批量插入/更新减少数据库连接开销
- **事务优化**：合理设置事务边界，避免长事务
- **异步写入**：非关键数据考虑异步写入

### 8.3 连接池优化

- **连接池配置**：合理设置最小/最大连接数
- **连接复用**：优化连接获取和释放机制
- **连接监控**：监控连接池使用情况，及时调整

## 9. 数据库备份与恢复

### 9.1 备份策略

- **全量备份**：每周进行一次全量备份
- **增量备份**：每日进行增量备份
- **日志备份**：实时备份事务日志
- **备份验证**：定期验证备份数据的完整性和可用性

### 9.2 恢复策略

- **恢复点目标(RPO)**：数据丢失不超过1小时
- **恢复时间目标(RTO)**：系统恢复时间不超过4小时
- **恢复测试**：定期进行恢复演练，验证恢复流程

## 10. 文档维护

- **文档版本**：v1.0
- **编制日期**：2023年10月25日
- **编制人**：技术部
- **审核人**：数据库管理员
- **批准人**：技术总监

---

本文档将随着系统设计的深入和业务需求的变化而定期更新，确保数据库设计与实际需求保持一致。