# GMP信息管理系统代码实现方案

## 1. 项目结构设计

### 1.1 整体项目结构
```
GMPSystem/
├── gmp-gateway/                 # API网关服务
├── gmp-auth/                    # 认证授权服务
├── gmp-qms/                     # 质量管理系统
├── gmp-mes/                     # 生产执行系统
├── gmp-lims/                    # 实验室管理系统
├── gmp-edms/                    # 电子文档管理系统
├── gmp-common/                  # 公共模块
├── gmp-frontend/                # 前端Vue.js应用
├── docker-compose.yml           # Docker编排文件
└── README.md                    # 项目说明
```

### 1.2 微服务模块结构（以QMS为例）
```
gmp-qms/
├── src/main/java/com/gmp/qms/
│   ├── QmsApplication.java      # 启动类
│   ├── controller/              # 控制器层
│   ├── service/                 # 服务层
│   ├── repository/              # 数据访问层
│   ├── entity/                  # 实体类
│   ├── dto/                     # 数据传输对象
│   ├── config/                  # 配置类
│   └── exception/               # 异常处理
├── src/main/resources/
│   ├── application.yml          # 应用配置
│   └── db/migration/            # 数据库迁移脚本
└── pom.xml                      # Maven依赖
```

## 2. 核心代码实现

### 2.1 公共基础类

#### 2.1.1 统一响应类
```java
// gmp-common/src/main/java/com/gmp/common/response/ApiResponse.java
package com.gmp.common.response;

import lombok.Data;
import java.time.LocalDateTime;

@Data
public class ApiResponse<T> {
    private boolean success;
    private int code;
    private String message;
    private T data;
    private LocalDateTime timestamp;
    
    public static <T> ApiResponse<T> success(T data) {
        ApiResponse<T> response = new ApiResponse<>();
        response.setSuccess(true);
        response.setCode(200);
        response.setMessage("操作成功");
        response.setData(data);
        response.setTimestamp(LocalDateTime.now());
        return response;
    }
    
    public static ApiResponse<Object> error(int code, String message) {
        ApiResponse<Object> response = new ApiResponse<>();
        response.setSuccess(false);
        response.setCode(code);
        response.setMessage(message);
        response.setTimestamp(LocalDateTime.now());
        return response;
    }
}
```

#### 2.1.2 基础实体类
```java
// gmp-common/src/main/java/com/gmp/common/entity/BaseEntity.java
package com.gmp.common.entity;

import lombok.Data;
import javax.persistence.*;
import java.time.LocalDateTime;

@MappedSuperclass
@Data
public class BaseEntity {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(name = "created_at", updatable = false)
    private LocalDateTime createdAt;
    
    @Column(name = "updated_at")
    private LocalDateTime updatedAt;
    
    @Column(name = "created_by")
    private String createdBy;
    
    @Column(name = "updated_by")
    private String updatedBy;
    
    @PrePersist
    protected void onCreate() {
        createdAt = LocalDateTime.now();
        updatedAt = LocalDateTime.now();
    }
    
    @PreUpdate
    protected void onUpdate() {
        updatedAt = LocalDateTime.now();
    }
}
```

### 2.2 QMS模块核心实现

#### 2.2.1 偏差管理实体类
```java
// gmp-qms/src/main/java/com/gmp/qms/entity/Deviation.java
package com.gmp.qms.entity;

import com.gmp.common.entity.BaseEntity;
import lombok.Data;
import lombok.EqualsAndHashCode;

import javax.persistence.*;
import java.time.LocalDateTime;

@Entity
@Table(name = "deviations")
@Data
@EqualsAndHashCode(callSuper = true)
public class Deviation extends BaseEntity {
    
    @Column(name = "deviation_number", unique = true, nullable = false)
    private String deviationNumber;
    
    @Column(name = "title", nullable = false)
    private String title;
    
    @Column(name = "description", columnDefinition = "TEXT")
    private String description;
    
    @Enumerated(EnumType.STRING)
    @Column(name = "severity")
    private DeviationSeverity severity;
    
    @Enumerated(EnumType.STRING)
    @Column(name = "status")
    private DeviationStatus status = DeviationStatus.OPEN;
    
    @Column(name = "reported_by", nullable = false)
    private String reportedBy;
    
    @Column(name = "reported_date")
    private LocalDateTime reportedDate;
    
    @Column(name = "due_date")
    private LocalDateTime dueDate;
    
    @Column(name = "closed_date")
    private LocalDateTime closedDate;
    
    @Column(name = "closed_by")
    private String closedBy;
    
    public enum DeviationSeverity {
        LOW, MEDIUM, HIGH, CRITICAL
    }
    
    public enum DeviationStatus {
        OPEN, IN_PROGRESS, UNDER_REVIEW, CLOSED, REJECTED
    }
}
```

#### 2.2.2 偏差管理服务类
```java
// gmp-qms/src/main/java/com/gmp/qms/service/DeviationService.java
package com.gmp.qms.service;

import com.gmp.qms.entity.Deviation;
import com.gmp.qms.repository.DeviationRepository;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;
import java.util.Optional;

@Service
@RequiredArgsConstructor
@Slf4j
public class DeviationService {
    
    private final DeviationRepository deviationRepository;
    
    /**
     * 创建偏差
     */
    @Transactional
    public Deviation createDeviation(Deviation deviation, String currentUser) {
        // 生成偏差编号
        String deviationNumber = generateDeviationNumber();
        deviation.setDeviationNumber(deviationNumber);
        deviation.setReportedBy(currentUser);
        deviation.setReportedDate(LocalDateTime.now());
        deviation.setCreatedBy(currentUser);
        
        Deviation savedDeviation = deviationRepository.save(deviation);
        log.info("创建偏差成功，编号：{}", deviationNumber);
        
        return savedDeviation;
    }
    
    /**
     * 更新偏差状态
     */
    @Transactional
    public Deviation updateDeviationStatus(Long id, Deviation.DeviationStatus status, 
                                         String remarks, String currentUser) {
        Optional<Deviation> optionalDeviation = deviationRepository.findById(id);
        if (optionalDeviation.isEmpty()) {
            throw new RuntimeException("偏差记录不存在");
        }
        
        Deviation deviation = optionalDeviation.get();
        deviation.setStatus(status);
        deviation.setUpdatedBy(currentUser);
        
        if (status == Deviation.DeviationStatus.CLOSED) {
            deviation.setClosedDate(LocalDateTime.now());
            deviation.setClosedBy(currentUser);
        }
        
        log.info("更新偏差状态，编号：{}，新状态：{}", 
                deviation.getDeviationNumber(), status);
        
        return deviationRepository.save(deviation);
    }
    
    /**
     * 分页查询偏差
     */
    public Page<Deviation> getDeviations(Pageable pageable, Deviation.DeviationStatus status) {
        if (status != null) {
            return deviationRepository.findByStatus(status, pageable);
        }
        return deviationRepository.findAll(pageable);
    }
    
    /**
     * 生成偏差编号：DEV-YYYYMMDD-XXXX
     */
    private String generateDeviationNumber() {
        String datePart = LocalDateTime.now().format(
            java.time.format.DateTimeFormatter.ofPattern("yyyyMMdd"));
        long count = deviationRepository.countByCreatedAtAfter(
            LocalDateTime.now().withHour(0).withMinute(0).withSecond(0));
        return String.format("DEV-%s-%04d", datePart, count + 1);
    }
}
```

#### 2.2.3 偏差管理控制器
```java
// gmp-qms/src/main/java/com/gmp/qms/controller/DeviationController.java
package com.gmp.qms.controller;

import com.gmp.common.response.ApiResponse;
import com.gmp.qms.entity.Deviation;
import com.gmp.qms.service.DeviationService;
import lombok.RequiredArgsConstructor;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.web.bind.annotation.*;

import java.security.Principal;

@RestController
@RequestMapping("/api/qms/deviations")
@RequiredArgsConstructor
public class DeviationController {
    
    private final DeviationService deviationService;
    
    /**
     * 创建偏差
     */
    @PostMapping
    public ApiResponse<Deviation> createDeviation(@RequestBody Deviation deviation, 
                                                 Principal principal) {
        Deviation created = deviationService.createDeviation(deviation, 
            principal.getName());
        return ApiResponse.success(created);
    }
    
    /**
     * 查询偏差列表
     */
    @GetMapping
    public ApiResponse<Page<Deviation>> getDeviations(
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "20") int size,
            @RequestParam(required = false) Deviation.DeviationStatus status) {
        
        Pageable pageable = PageRequest.of(page, size, 
            Sort.by(Sort.Direction.DESC, "createdAt"));
        Page<Deviation> deviations = deviationService.getDeviations(pageable, status);
        return ApiResponse.success(deviations);
    }
    
    /**
     * 更新偏差状态
     */
    @PutMapping("/{id}/status")
    public ApiResponse<Deviation> updateStatus(@PathVariable Long id,
                                              @RequestParam Deviation.DeviationStatus status,
                                              @RequestParam(required = false) String remarks,
                                              Principal principal) {
        Deviation updated = deviationService.updateDeviationStatus(id, status, 
            remarks, principal.getName());
        return ApiResponse.success(updated);
    }
    
    /**
     * 获取偏差详情
     */
    @GetMapping("/{id}")
    public ApiResponse<Deviation> getDeviation(@PathVariable Long id) {
        // 实现详情查询逻辑
        return ApiResponse.success(null);
    }
}
```

### 2.3 MES模块核心实现

#### 2.3.1 生产批次实体类
```java
// gmp-mes/src/main/java/com/gmp/mes/entity/ProductionBatch.java
package com.gmp.mes.entity;

import com.gmp.common.entity.BaseEntity;
import lombok.Data;
import lombok.EqualsAndHashCode;

import javax.persistence.*;
import java.math.BigDecimal;
import java.time.LocalDateTime;

@Entity
@Table(name = "production_batches")
@Data
@EqualsAndHashCode(callSuper = true)
public class ProductionBatch extends BaseEntity {
    
    @Column(name = "batch_number", unique = true, nullable = false)
    private String batchNumber;
    
    @Column(name = "product_id", nullable = false)
    private Long productId;
    
    @Column(name = "product_name", nullable = false)
    private String productName;
    
    @Column(name = "planned_quantity", precision = 10, scale = 3)
    private BigDecimal plannedQuantity;
    
    @Column(name = "actual_quantity", precision = 10, scale = 3)
    private BigDecimal actualQuantity;
    
    @Enumerated(EnumType.STRING)
    @Column(name = "status")
    private BatchStatus status = BatchStatus.PLANNED;
    
    @Column(name = "start_time")
    private LocalDateTime startTime;
    
    @Column(name = "end_time")
    private LocalDateTime endTime;
    
    @Column(name = "equipment_id")
    private Long equipmentId;
    
    @Column(name = "operator_id")
    private Long operatorId;
    
    public enum BatchStatus {
        PLANNED, IN_PROGRESS, COMPLETED, CANCELLED, ON_HOLD
    }
}
```

#### 2.3.2 批次记录服务类
```java
// gmp-mes/src/main/java/com/gmp/mes/service/BatchRecordService.java
package com.gmp.mes.service;

import com.gmp.mes.entity.BatchRecord;
import com.gmp.mes.entity.ProductionBatch;
import com.gmp.mes.repository.BatchRecordRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;

@Service
@RequiredArgsConstructor
public class BatchRecordService {
    
    private final BatchRecordRepository batchRecordRepository;
    
    /**
     * 记录批次操作
     */
    @Transactional
    public BatchRecord recordBatchOperation(Long batchId, String stepName, 
                                          String parameterName, Double parameterValue,
                                          String unit, String operator) {
        
        BatchRecord record = new BatchRecord();
        record.setBatchId(batchId);
        record.setStepName(stepName);
        record.setParameterName(parameterName);
        record.setParameterValue(parameterValue);
        record.setUnit(unit);
        record.setOperator(operator);
        
        return batchRecordRepository.save(record);
    }
    
    /**
     * 获取批次完整记录
     */
    public List<BatchRecord> getBatchRecords(Long batchId) {
        return batchRecordRepository.findByBatchIdOrderByRecordedTimeAsc(batchId);
    }
}
```

### 2.4 前端Vue.js实现

#### 2.4.1 偏差管理页面组件
```vue
<!-- gmp-frontend/src/views/qms/DeviationList.vue -->
<template>
  <div class="deviation-list">
    <el-card>
      <template #header>
        <div class="card-header">
          <span>偏差管理</span>
          <el-button type="primary" @click="handleCreate">创建偏差</el-button>
        </div>
      </template>
      
      <!-- 搜索条件 -->
      <el-form :model="searchForm" inline>
        <el-form-item label="状态">
          <el-select v-model="searchForm.status" placeholder="请选择状态">
            <el-option label="全部" value=""></el-option>
            <el-option label="待处理" value="OPEN"></el-option>
            <el-option label="处理中" value="IN_PROGRESS"></el-option>
            <el-option label="已关闭" value="CLOSED"></el-option>
          </el-select>
        </el-form-item>
        <el-form-item>
          <el-button type="primary" @click="handleSearch">查询</el-button>
        </el-form-item>
      </el-form>
      
      <!-- 数据表格 -->
      <el-table :data="tableData" v-loading="loading">
        <el-table-column prop="deviationNumber" label="偏差编号" width="150"></el-table-column>
        <el-table-column prop="title" label="标题" min-width="200"></el-table-column>
        <el-table-column prop="severity" label="严重程度" width="100">
          <template #default="{row}">
            <el-tag :type="getSeverityType(row.severity)">{{ row.severity }}</el-tag>
          </template>
        </el-table-column>
        <el-table-column prop="status" label="状态" width="100">
          <template #default="{row}">
            <el-tag :type="getStatusType(row.status)">{{ row.status }}</el-tag>
          </template>
        </el-table-column>
        <el-table-column prop="reportedBy" label="报告人" width="120"></el-table-column>
        <el-table-column prop="reportedDate" label="报告时间" width="180">
          <template #default="{row}">
            {{ formatDate(row.reportedDate) }}
          </template>
        </el-table-column>
        <el-table-column label="操作" width="200" fixed="right">
          <template #default="{row}">
            <el-button size="small" @click="handleView(row)">查看</el-button>
            <el-button size="small" type="primary" @click="handleEdit(row)" 
                       v-if="row.status === 'OPEN'">处理</el-button>
          </template>
        </el-table-column>
      </el-table>
      
      <!-- 分页 -->
      <div class="pagination">
        <el-pagination
          v-model:current-page="currentPage"
          v-model:page-size="pageSize"
          :page-sizes="[10, 20, 50, 100]"
          :total="total"
          layout="total, sizes, prev, pager, next, jumper"
          @size-change="handleSizeChange"
          @current-change="handleCurrentChange"
        />
      </div>
    </el-card>
    
    <!-- 创建/编辑对话框 -->
    <deviation-dialog
      v-model="dialogVisible"
      :deviation="currentDeviation"
      @success="handleDialogSuccess"
    />
  </div>
</template>

<script setup>
import { ref, reactive, onMounted } from 'vue'
import { ElMessage } from 'element-plus'
import { deviationApi } from '@/api/qms'
import DeviationDialog from './components/DeviationDialog.vue'

// 响应式数据
const loading = ref(false)
const tableData = ref([])
const currentPage = ref(1)
const pageSize = ref(20)
const total = ref(0)
const dialogVisible = ref(false)
const currentDeviation = ref(null)

const searchForm = reactive({
  status: ''
})

// 生命周期
onMounted(() => {
  loadData()
})

// 方法
const loadData = async () => {
  loading.value = true
  try {
    const response = await deviationApi.getDeviations({
      page: currentPage.value - 1,
      size: pageSize.value,
      status: searchForm.status
    })
    tableData.value = response.data.content
    total.value = response.data.totalElements
  } catch (error) {
    ElMessage.error('加载数据失败')
  } finally {
    loading.value = false
  }
}

const handleSearch = () => {
  currentPage.value = 1
  loadData()
}

const handleCreate = () => {
  currentDeviation.value = null
  dialogVisible.value = true
}

const handleView = (row) => {
  // 跳转到详情页面
}

const handleEdit = (row) => {
  currentDeviation.value = { ...row }
  dialogVisible.value = true
}

const handleDialogSuccess = () => {
  dialogVisible.value = false
  loadData()
}

const getSeverityType = (severity) => {
  const map = {
    'LOW': 'success',
    'MEDIUM': 'warning',
    'HIGH': 'danger',
    'CRITICAL': 'danger'
  }
  return map[severity] || 'info'
}

const getStatusType = (status) => {
  const map = {
    'OPEN': 'warning',
    'IN_PROGRESS': 'primary',
    'CLOSED': 'success',
    'REJECTED': 'danger'
  }
  return map[status] || 'info'
}

const formatDate = (dateString) => {
  return new Date(dateString).toLocaleString('zh-CN')
}
</script>

<style scoped>
.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.pagination {
  margin-top: 20px;
  display: flex;
  justify-content: flex-end;
}
</style>
```

## 3. 数据库迁移脚本

### 3.1 QMS模块数据库脚本
```sql
-- gmp-qms/src/main/resources/db/migration/V1__Create_deviation_tables.sql

-- 创建偏差表
CREATE TABLE deviations (
    id BIGSERIAL PRIMARY KEY,
    deviation_number VARCHAR(50) UNIQUE NOT NULL,
    title VARCHAR(200) NOT NULL,
    description TEXT,
    severity VARCHAR(20) CHECK (severity IN ('LOW', 'MEDIUM', 'HIGH', 'CRITICAL')),
    status VARCHAR(20) DEFAULT 'OPEN' CHECK (status IN ('OPEN', 'IN_PROGRESS', 'UNDER_REVIEW', 'CLOSED', 'REJECTED')),
    reported_by VARCHAR(100) NOT NULL,
    reported_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    due_date TIMESTAMP,
    closed_date TIMESTAMP,
    closed_by VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by VARCHAR(100),
    updated_by VARCHAR(100)
);

-- 创建CAPA表
CREATE TABLE capas (
    id BIGSERIAL PRIMARY KEY,
    capa_number VARCHAR(50) UNIQUE NOT NULL,
    deviation_id BIGINT REFERENCES deviations(id),
    description TEXT,
    root_cause_analysis TEXT,
    corrective_action TEXT,
    preventive_action TEXT,
    status VARCHAR(20) DEFAULT 'OPEN' CHECK (status IN ('OPEN', 'IN_PROGRESS', 'COMPLETED', 'VERIFIED')),
    due_date TIMESTAMP,
    completed_date TIMESTAMP,
    effectiveness_check TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by VARCHAR(100),
    updated_by VARCHAR(100)
);

-- 创建索引
CREATE INDEX idx_deviations_status ON deviations(status);
CREATE INDEX idx_deviations_reported_date ON deviations(reported_date);
CREATE INDEX idx_capas_deviation_id ON capas(deviation_id);
```

## 4. 配置文件

### 4.1 应用配置文件
```yaml
# gmp-qms/src/main/resources/application.yml
server:
  port: 8081

spring:
  application:
    name: gmp-qms
  
  datasource:
    url: jdbc:postgresql://localhost:5432/qms_db
    username: qms_user
    password: qms_pass
    driver-class-name: org.postgresql.Driver
  
  jpa:
    hibernate:
      ddl-auto: validate
    show-sql: true
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
        format_sql: true
  
  redis:
    host: localhost
    port: 6379
    database: 0

# 日志配置
logging:
  level:
    com.gmp.qms: DEBUG
    org.hibernate.SQL: DEBUG

# 自定义配置
gmp:
  security:
    jwt-secret: your-jwt-secret-key
    token-expiration: 86400
```

## 5. Docker配置

### 5.1 Dockerfile示例
```dockerfile
# gmp-qms/Dockerfile
FROM openjdk:17-jdk-slim

# 设置工作目录
WORKDIR /app

# 复制JAR文件
COPY target/gmp-qms-1.0.0.jar app.jar

# 设置JVM参数
ENV JAVA_OPTS="-Xmx512m -Xms256m"

# 暴露端口
EXPOSE 8081

# 启动应用
ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar app.jar"]
```

### 5.2 Docker Compose配置
```yaml
# docker-compose.yml
version: '3.8'

services:
  # 数据库
  postgres:
    image: postgres:13
    environment:
      POSTGRES_DB: gmp_system
      POSTGRES_USER: gmp_user
      POSTGRES_PASSWORD: gmp_pass
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
  
  # Redis
  redis:
    image: redis:6-alpine
    ports:
      - "6379:6379"
  
  # QMS服务
  qms-service:
    build: ./gmp-qms
    ports:
      - "8081:8081"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
    depends_on:
      - postgres
      - redis

volumes:
  postgres_data:
```

---

**文档版本**：v1.0
**更新日期**：2024年
**编制人员**：开发团队