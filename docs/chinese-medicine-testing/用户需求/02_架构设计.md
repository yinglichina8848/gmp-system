# 中药材检验子系统 - 架构设计

## 1. 引言

### 1.1 文档目的

本文档详细描述了中药材检验子系统的架构设计，包括系统的整体架构、技术栈选择、模块划分、数据流程、接口设计等内容，为系统的开发和实现提供技术指导。

### 1.2 术语定义

| 术语 | 解释 |
|-----|------|
| 微服务架构 | 一种软件架构风格，将应用程序构建为一系列松耦合的服务 |
| 前后端分离 | 前端和后端代码分别独立开发和部署的架构模式 |
| RESTful API | 一种基于HTTP协议的API设计风格，使用JSON作为数据交换格式 |
| 数据完整性 | 确保数据的准确性、一致性和可靠性的特性 |
| RBAC | 基于角色的访问控制(Role-Based Access Control) |
| JWT | JSON Web Token，一种用于身份验证和授权的开放标准 |
| 容器化 | 将应用程序及其依赖打包到容器中的技术 |

## 2. 系统架构概述

### 2.1 整体架构设计

中药材检验子系统采用微服务架构，遵循前后端分离的设计原则。系统主要分为前端展示层、后端服务层、数据存储层和外部集成层四个主要部分。

![系统整体架构图](系统整体架构图.png)

### 2.2 技术栈选择

#### 2.2.1 前端技术栈
- **框架**：Vue.js 3 + Vite
- **状态管理**：Pinia
- **UI组件库**：Element Plus
- **表格组件**：AG Grid
- **图表库**：ECharts
- **HTTP客户端**：Axios
- **表单验证**：Vee Validate
- **PDF生成**：jsPDF

#### 2.2.2 后端技术栈
- **框架**：Spring Boot 2.7.x
- **ORM框架**：MyBatis-Plus
- **安全框架**：Spring Security + JWT
- **API文档**：Swagger/OpenAPI 3.0
- **日志框架**：SLF4J + Logback
- **缓存框架**：Redis
- **消息队列**：RabbitMQ
- **定时任务**：Quartz

#### 2.2.3 数据存储
- **主数据库**：PostgreSQL 14
- **缓存数据库**：Redis 7.0
- **文件存储**：MinIO
- **搜索引擎**：Elasticsearch（可选，用于大数据量检索）

#### 2.2.4 部署与集成
- **容器化**：Docker
- **容器编排**：Kubernetes
- **CI/CD**：Jenkins
- **服务注册与发现**：Eureka/Consul
- **配置中心**：Spring Cloud Config
- **API网关**：Spring Cloud Gateway
- **监控告警**：Prometheus + Grafana
- **日志管理**：ELK Stack

## 3. 模块划分

### 3.1 前端模块划分

| 模块名称 | 主要功能 | 关键组件 |
|---------|---------|--------|
| 样品管理模块 | 样品接收、登记、存储管理 | SampleRegister.vue, SampleList.vue, SampleStorage.vue |
| 检验计划模块 | 检验计划制定、查询、调整 | TestPlanCreate.vue, TestPlanList.vue, TestPlanEdit.vue |
| 检验执行模块 | 检验任务分配、执行、结果录入 | TaskAssign.vue, TestExecution.vue, ResultEntry.vue |
| 质量标准模块 | 质量标准管理、查询、更新 | StandardManage.vue, StandardQuery.vue, StandardUpdate.vue |
| 数据管理模块 | 检验数据查询、统计、分析 | DataQuery.vue, DataStatistics.vue, DataAnalysis.vue |
| 报告管理模块 | 检验报告生成、审核、发布 | ReportGenerate.vue, ReportAudit.vue, ReportPublish.vue |
| 不合格品模块 | 不合格品处理、跟踪 | UnqualifiedProcess.vue, UnqualifiedTrack.vue |
| 系统管理模块 | 用户管理、权限设置、系统配置 | UserManage.vue, PermissionSet.vue, SystemConfig.vue |

### 3.2 后端模块划分

| 模块名称 | 主要功能 | 关键类/接口 |
|---------|---------|------------|
| 样品管理服务 | 样品全生命周期管理 | SampleService, SampleController |
| 检验计划服务 | 检验计划的制定和执行管理 | TestPlanService, TestPlanController |
| 检验执行服务 | 检验任务的执行和结果管理 | TestExecutionService, TestExecutionController |
| 质量标准服务 | 质量标准的维护和应用 | QualityStandardService, QualityStandardController |
| 数据管理服务 | 检验数据的存储和分析 | DataManagementService, DataManagementController |
| 报告管理服务 | 检验报告的生成和管理 | ReportService, ReportController |
| 不合格品服务 | 不合格品的处理和跟踪 | UnqualifiedProductService, UnqualifiedProductController |
| 认证授权服务 | 用户认证和权限管理 | AuthService, UserController, RoleController |
| 系统配置服务 | 系统参数和配置管理 | SystemConfigService, SystemConfigController |
| 接口集成服务 | 与外部系统的接口集成 | IntegrationService, IntegrationController |

## 4. 数据流程

### 4.1 主数据流程

中药材检验的主要数据流程如下：

1. **样品接收阶段**：
   - 样品信息录入系统，生成样品编号和标识
   - 样品基本信息存储到数据库
   - 样品状态更新为待检验

2. **检验计划阶段**：
   - 根据样品信息制定检验计划
   - 系统分配检验任务给检验人员
   - 检验任务信息存储到数据库

3. **检验执行阶段**：
   - 检验人员执行检验任务
   - 检验数据采集和录入系统
   - 系统根据质量标准自动判定结果
   - 检验结果存储到数据库

4. **报告生成阶段**：
   - 系统根据检验数据生成检验报告
   - 报告审核和批准流程
   - 报告正式发布和归档

5. **不合格品处理阶段**（如有）：
   - 识别不合格品
   - 执行不合格品评审和处理流程
   - 更新不合格品处理状态

### 4.2 数据流图

![数据流程图](数据流程图.png)

## 5. 数据库设计

### 5.1 数据模型概述

系统主要数据实体包括：样品(Sample)、检验计划(TestPlan)、检验任务(TestTask)、质量标准(QualityStandard)、检验数据(TestData)、检验报告(Report)、不合格品(UnqualifiedProduct)、用户(User)、角色(Role)等。

### 5.2 关键数据表结构

#### 5.2.1 样品表(t_sample)
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | BIGINT | PRIMARY KEY | 样品ID |
| sample_code | VARCHAR(50) | UNIQUE NOT NULL | 样品编号 |
| sample_name | VARCHAR(100) | NOT NULL | 样品名称 |
| source | VARCHAR(100) | NOT NULL | 样品来源 |
| batch_number | VARCHAR(100) | NOT NULL | 批次号 |
| quantity | DECIMAL(10,2) | NOT NULL | 样品数量 |
| unit | VARCHAR(20) | NOT NULL | 单位 |
| received_date | TIMESTAMP | NOT NULL | 接收日期 |
| received_by | BIGINT | NOT NULL | 接收人ID |
| storage_location | VARCHAR(100) | NOT NULL | 存储位置 |
| status | VARCHAR(20) | NOT NULL | 样品状态 |
| remark | TEXT | | 备注 |
| created_at | TIMESTAMP | NOT NULL | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL | 更新时间 |

#### 5.2.2 检验计划表(t_test_plan)
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | BIGINT | PRIMARY KEY | 计划ID |
| plan_code | VARCHAR(50) | UNIQUE NOT NULL | 计划编号 |
| plan_name | VARCHAR(100) | NOT NULL | 计划名称 |
| created_by | BIGINT | NOT NULL | 制定人ID |
| created_date | TIMESTAMP | NOT NULL | 制定日期 |
| execute_status | VARCHAR(20) | NOT NULL | 执行状态 |
| remark | TEXT | | 备注 |

#### 5.2.3 检验任务表(t_test_task)
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | BIGINT | PRIMARY KEY | 任务ID |
| task_code | VARCHAR(50) | UNIQUE NOT NULL | 任务编号 |
| sample_id | BIGINT | NOT NULL | 样品ID |
| test_plan_id | BIGINT | NOT NULL | 检验计划ID |
| assigned_to | BIGINT | NOT NULL | 检验人员ID |
| assigned_date | TIMESTAMP | NOT NULL | 分配日期 |
| start_date | TIMESTAMP | | 开始日期 |
| end_date | TIMESTAMP | | 结束日期 |
| status | VARCHAR(20) | NOT NULL | 任务状态 |
| remark | TEXT | | 备注 |

#### 5.2.4 质量标准表(t_quality_standard)
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | BIGINT | PRIMARY KEY | 标准ID |
| standard_code | VARCHAR(50) | UNIQUE NOT NULL | 标准编号 |
| medicine_name | VARCHAR(100) | NOT NULL | 中药材名称 |
| standard_type | VARCHAR(20) | NOT NULL | 标准类型 |
| version | VARCHAR(20) | NOT NULL | 版本号 |
| effective_date | TIMESTAMP | NOT NULL | 生效日期 |
| expiry_date | TIMESTAMP | | 失效日期 |
| content | TEXT | NOT NULL | 标准内容 |
| status | VARCHAR(20) | NOT NULL | 标准状态 |

#### 5.2.5 检验数据表(t_test_data)
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | BIGINT | PRIMARY KEY | 数据ID |
| task_id | BIGINT | NOT NULL | 检验任务ID |
| test_item | VARCHAR(100) | NOT NULL | 检验项目 |
| test_method | VARCHAR(200) | NOT NULL | 检验方法 |
| instrument | VARCHAR(100) | | 使用仪器 |
| raw_data | TEXT | | 原始数据 |
| test_result | VARCHAR(200) | NOT NULL | 检验结果 |
| standard_value | VARCHAR(100) | NOT NULL | 标准值 |
| judgment | VARCHAR(10) | NOT NULL | 判定结果 |
| tested_by | BIGINT | NOT NULL | 检验人ID |
| tested_date | TIMESTAMP | NOT NULL | 检验日期 |
| unit | VARCHAR(20) | | 单位 |

## 6. 接口设计

### 6.1 API设计原则

- 采用RESTful API设计风格
- 使用JSON作为数据交换格式
- 遵循HTTP状态码规范
- 统一的错误响应格式
- 接口版本管理
- 接口安全验证

### 6.2 主要接口列表

#### 6.2.1 样品管理接口

| API路径 | 方法 | 功能描述 | 请求体 (JSON) | 成功响应 (200 OK) |
|---------|------|---------|--------------|-----------------|
| /api/v1/samples | POST | 创建样品 | `{"sampleName": "...", "source": "...", "batchNumber": "...", ...}` | `{"id": 1, "sampleCode": "SMP2024001", ...}` |
| /api/v1/samples | GET | 查询样品列表 | N/A | `[{"id": 1, "sampleCode": "SMP2024001", ...}]` |
| /api/v1/samples/{id} | GET | 获取样品详情 | N/A | `{"id": 1, "sampleCode": "SMP2024001", ...}` |
| /api/v1/samples/{id} | PUT | 更新样品信息 | `{"sampleName": "...", "storageLocation": "...", ...}` | `{"id": 1, "sampleCode": "SMP2024001", ...}` |
| /api/v1/samples/{id}/status | PUT | 更新样品状态 | `{"status": "WAITING_TEST"}` | `{"success": true}` |

#### 6.2.2 检验计划接口

| API路径 | 方法 | 功能描述 | 请求体 (JSON) | 成功响应 (200 OK) |
|---------|------|---------|--------------|-----------------|
| /api/v1/test-plans | POST | 创建检验计划 | `{"planName": "...", "sampleIds": [1, 2, 3], ...}` | `{"id": 1, "planCode": "PLN2024001", ...}` |
| /api/v1/test-plans | GET | 查询检验计划列表 | N/A | `[{"id": 1, "planCode": "PLN2024001", ...}]` |
| /api/v1/test-plans/{id} | GET | 获取检验计划详情 | N/A | `{"id": 1, "planCode": "PLN2024001", ...}` |
| /api/v1/test-plans/{id} | PUT | 更新检验计划 | `{"planName": "...", "executeStatus": "...", ...}` | `{"id": 1, "planCode": "PLN2024001", ...}` |
| /api/v1/test-plans/{id}/tasks | GET | 获取计划关联的任务 | N/A | `[{"id": 1, "taskCode": "TASK2024001", ...}]` |

#### 6.2.3 检验执行接口

| API路径 | 方法 | 功能描述 | 请求体 (JSON) | 成功响应 (200 OK) |
|---------|------|---------|--------------|-----------------|
| /api/v1/test-tasks | POST | 创建检验任务 | `{"sampleId": 1, "assignedTo": 1, ...}` | `{"id": 1, "taskCode": "TASK2024001", ...}` |
| /api/v1/test-tasks | GET | 查询检验任务列表 | N/A | `[{"id": 1, "taskCode": "TASK2024001", ...}]` |
| /api/v1/test-tasks/{id} | GET | 获取检验任务详情 | N/A | `{"id": 1, "taskCode": "TASK2024001", ...}` |
| /api/v1/test-tasks/{id}/start | PUT | 开始检验任务 | N/A | `{"success": true}` |
| /api/v1/test-tasks/{id}/complete | PUT | 完成检验任务 | `{"testResults": [...]}` | `{"success": true}` |
| /api/v1/test-data | POST | 录入检验数据 | `{"taskId": 1, "testItem": "...", "testResult": "...", ...}` | `{"id": 1, "taskId": 1, ...}` |

#### 6.2.4 质量标准接口

| API路径 | 方法 | 功能描述 | 请求体 (JSON) | 成功响应 (200 OK) |
|---------|------|---------|--------------|-----------------|
| /api/v1/standards | POST | 创建质量标准 | `{"medicineName": "...", "standardType": "...", "content": "...", ...}` | `{"id": 1, "standardCode": "STD2024001", ...}` |
| /api/v1/standards | GET | 查询质量标准列表 | N/A | `[{"id": 1, "standardCode": "STD2024001", ...}]` |
| /api/v1/standards/{id} | GET | 获取质量标准详情 | N/A | `{"id": 1, "standardCode": "STD2024001", ...}` |
| /api/v1/standards/{id} | PUT | 更新质量标准 | `{"content": "...", "version": "...", ...}` | `{"id": 1, "standardCode": "STD2024001", ...}` |
| /api/v1/standards/by-medicine/{medicineName} | GET | 根据中药材名称查询标准 | N/A | `[{"id": 1, "standardCode": "STD2024001", ...}]` |

## 7. 安全设计

### 7.1 认证与授权

- 采用JWT Token进行用户认证
- 基于RBAC模型实现权限控制
- 细粒度的功能权限和数据权限管理
- 支持多因素认证（可选）

### 7.2 数据安全

- 敏感数据传输加密（HTTPS）
- 数据库字段级加密存储
- 数据访问审计日志
- 定期数据备份和恢复机制

### 7.3 操作安全

- 关键操作需要电子签名确认
- 操作日志完整记录
- 防SQL注入、XSS攻击等安全措施
- 输入数据验证和过滤

## 8. 部署架构

### 8.1 部署模式

系统采用容器化部署模式，使用Docker和Kubernetes进行容器编排和管理。

### 8.2 环境规划

- 开发环境：Docker Compose本地部署
- 测试环境：小型Kubernetes集群
- 生产环境：高可用Kubernetes集群

### 8.3 高可用设计

- 服务多副本部署
- 数据库主从复制
- 缓存集群
- 负载均衡
- 故障自动切换

## 9. 扩展性设计

### 9.1 功能扩展性

- 模块化设计，支持插件式扩展
- 配置化的业务规则
- 可自定义的工作流

### 9.2 性能扩展性

- 水平扩展能力
- 缓存机制
- 数据库读写分离
- 分库分表策略（预留）

## 10. 附录

### 10.1 参考文档
- GMP系统总体架构设计文档
- Spring Boot官方文档
- Vue.js官方文档
- PostgreSQL官方文档
- Redis官方文档

### 10.2 架构图索引
- 系统整体架构图
- 数据流程图
- 部署架构图
- 模块依赖关系图