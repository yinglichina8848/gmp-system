# GMP系统人事管理模块数据流和接口定义

## 文档信息
- **文档版本**: v1.0
- **创建日期**: 2025-11-21
- **最后更新**: 2025-11-21
- **作者**: 系统架构师
- **审核人**: 数据架构师

## 目录
1. [概述](#概述)
2. [数据流架构](#数据流架构)
3. [核心业务数据流](#核心业务数据流)
4. [系统间接口定义](#系统间接口定义)
5. [API接口规范](#api接口规范)
6. [消息队列接口](#消息队列接口)
7. [数据库接口定义](#数据库接口定义)
8. [数据同步和一致性](#数据同步和一致性)

---

## 概述

### 设计原则
- **解耦性**: 系统间通过标准接口进行通信
- **可扩展性**: 接口支持水平扩展和版本升级
- **安全性**: 所有数据传输采用加密和认证机制
- **性能优化**: 支持高并发和大量数据处理
- **合规性**: 数据流转符合GMP和隐私保护要求

### 数据流类型
1. **实时数据流**: 用户操作产生的即时数据更新
2. **批量数据流**: 定期批处理的数据同步
3. **事件驱动流**: 基于业务事件的数据传递
4. **查询数据流**: 跨系统数据查询和展示

### 接口分类
- **RESTful API**: 标准HTTP接口
- **消息队列**: 异步事件通信
- **数据库直连**: 高性能数据访问
- **文件传输**: 批量数据导入导出

---

## 数据流架构

### 整体架构图
```
┌─────────────────────────────────────────────────────────────┐
│                    人事管理数据流架构                         │
├─────────────────────────────────────────────────────────────┤
│  前端应用层  │  移动端  │  Web端  │  第三方集成  │  内部系统    │
├─────────────────────────────────────────────────────────────┤
│                    API Gateway                              │
├─────────────────────────────────────────────────────────────┤
│  认证服务  │  人事服务  │  培训服务  │  绩效服务  │  薪酬服务    │
├─────────────────────────────────────────────────────────────┤
│  消息队列  │  缓存层  │  数据同步  │  文件存储  │  审计日志    │
├─────────────────────────────────────────────────────────────┤
│  关系型DB │  文档库 │  时序库 │  全文检索 │  区块链审计     │
└─────────────────────────────────────────────────────────────┘
```

### 数据流分层
1. **展示层数据流**: 用户界面与业务服务的交互
2. **业务层数据流**: 业务服务间的数据传递
3. **数据层数据流**: 数据存储和访问模式
4. **集成层数据流**: 与外部系统的数据交换

---

## 核心业务数据流

### 1. 员工入职数据流

#### 数据流向
```
HR系统 → 认证系统 → 培训系统 → 考勤系统 → 薪酬系统
  ↓         ↓         ↓         ↓         ↓
数据库     用户库     培训库     考勤库     薪资库
```

#### 详细数据流
1. **员工信息创建**
   ```json
   {
     "employeeId": "EMP001",
     "personalInfo": {
       "name": "张三",
       "idCard": "110xxxxxxxxxxxxx",
       "contact": {
         "phone": "138xxxxx",
         "email": "zhangsan@company.com"
       }
     },
     "jobInfo": {
       "department": "生产部",
       "position": "生产技术员",
       "startDate": "2025-11-21",
       "manager": "李四"
     },
     "compliance": {
       "gmpCertified": true,
       "healthCheck": "PASSED",
       "trainingRequired": ["GMP基础", "安全培训"]
     }
   }
   ```

2. **自动触发事件**
   - 创建用户账户
   - 分配培训计划
   - 设置考勤规则
   - 配置薪酬模板

### 2. GMP培训数据流

#### 数据流向
```
培训计划 → 课程内容 → 培训记录 → 考核结果 → 认证更新
    ↓         ↓         ↓         ↓         ↓
  员工档案    课程库    学习记录    考核库    资质库
```

#### 关键数据流
1. **培训计划生成**
   ```json
   {
     "planId": "TRAIN2025Q4",
     "employeeId": "EMP001",
     "courses": [
       {
         "courseCode": "GMP001",
         "courseName": "GMP基础知识",
         "duration": 8,
         "mandatory": true,
         "deadline": "2025-12-31"
       },
       {
         "courseCode": "SEC001", 
         "courseName": "安全生产培训",
         "duration": 4,
         "mandatory": true,
         "deadline": "2025-12-15"
       }
     ]
   }
   ```

2. **培训进度跟踪**
   ```json
   {
     "progressId": "PROG001",
     "employeeId": "EMP001",
     "courseProgress": [
       {
         "courseCode": "GMP001",
         "status": "COMPLETED",
         "completionDate": "2025-11-25",
         "score": 95,
         "certificate": "GMP001-2025-EMP001"
       }
     ]
   }
   ```

### 3. 绩效评估数据流

#### 数据流向
```
目标设定 → 过程跟踪 → 考核评估 → 结果分析 → 改进计划
    ↓         ↓         ↓         ↓         ↓
 KPI数据库   过程库    评估库    分析库    改进库
```

#### 数据流示例
1. **KPI数据收集**
   ```json
   {
     "kpiId": "KPI2025Q4-EMP001",
     "employeeId": "EMP001",
     "metrics": [
       {
         "metricName": "生产效率",
         "targetValue": 100,
         "actualValue": 105,
         "unit": "件/小时",
         "period": "2025Q4"
       },
       {
         "metricName": "质量合格率",
         "targetValue": 99.5,
         "actualValue": 99.8,
         "unit": "%",
         "period": "2025Q4"
       }
     ],
     "complianceScore": {
       "gmpCompliance": 98,
       "safetyScore": 100,
       "documentCompliance": 95
     }
   }
   ```

### 4. 薪酬管理数据流

#### 数据流向
```
考勤数据 → 绩效考核 → 薪酬计算 → 审批流程 → 发放执行
    ↓         ↓         ↓         ↓         ↓
 考勤库     绩效库     薪资库     审批库     银行接口
```

#### 数据流处理
1. **薪酬计算输入**
   ```json
   {
     "payrollId": "PAY2025-11",
     "employeeId": "EMP001",
     "attendance": {
       "regularHours": 160,
       "overtimeHours": 12,
       "lateTimes": 0,
       "absentDays": 0
     },
     "performance": {
       "overallRating": "B+",
       "kpiAchievement": 105,
       "bonusEligible": true
     },
     "deductions": {
       "tax": 1200,
       "socialInsurance": 800,
       "housingFund": 600
     }
   }
   ```

---

## 系统间接口定义

### 1. 认证服务接口

#### 接口概述
人事系统需要与认证服务集成，实现单点登录和权限管理。

#### 接口清单
| 接口名称 | 方法 | URL | 描述 |
|---------|------|-----|------|
| 用户登录 | POST | /auth/login | 用户身份验证 |
| 获取用户信息 | GET | /auth/user/{userId} | 获取用户基本信息 |
| 权限验证 | POST | /auth/validate | 验证用户权限 |
| 令牌刷新 | POST | /auth/refresh | 刷新访问令牌 |

#### 接口详细定义

**1.1 用户登录接口**
```yaml
POST /auth/login
Request:
  headers:
    Content-Type: application/json
  body:
    username: string
    password: string
    deviceId: string
    clientType: string

Response:
  status: 200
  body:
    success: true
    data:
      accessToken: string
      refreshToken: string
      expiresIn: 3600
      userInfo:
        userId: string
        username: string
        roles: array
        permissions: array
    timestamp: 2025-11-21T12:00:00Z
```

**1.2 获取用户信息接口**
```yaml
GET /auth/user/{userId}
Request:
  headers:
    Authorization: Bearer {accessToken}
  pathParameters:
    userId: string

Response:
  status: 200
  body:
    success: true
    data:
      userId: string
      username: string
      email: string
      phone: string
      status: string
      department: string
      position: string
      roles: array
      permissions: array
      lastLoginTime: string
    timestamp: 2025-11-21T12:00:00Z
```

### 2. 培训服务接口

#### 接口概述
人事系统与培训系统集成，管理员工培训计划和进度。

#### 接口清单
| 接口名称 | 方法 | URL | 描述 |
|---------|------|-----|------|
| 创建培训计划 | POST | /training/plan | 创建员工培训计划 |
| 查询培训进度 | GET | /training/progress/{employeeId} | 查询员工培训进度 |
| 更新培训结果 | PUT | /training/result | 更新培训考核结果 |
| 生成培训证书 | POST | /training/certificate | 生成培训合格证书 |

#### 接口详细定义

**2.1 创建培训计划接口**
```yaml
POST /training/plan
Request:
  headers:
    Content-Type: application/json
    Authorization: Bearer {accessToken}
  body:
    employeeId: string
    planName: string
    courses: array
      courseCode: string
      courseName: string
      mandatory: boolean
      deadline: string
    priority: string

Response:
  status: 201
  body:
    success: true
    data:
      planId: string
      employeeId: string
      status: string
      totalCourses: number
      estimatedHours: number
      createdAt: string
    timestamp: 2025-11-21T12:00:00Z
```

### 3. 考勤服务接口

#### 接口概述
人事系统获取员工考勤数据，用于绩效评估和薪酬计算。

#### 接口清单
| 接口名称 | 方法 | URL | 描述 |
|---------|------|-----|------|
| 获取考勤数据 | GET | /attendance/{employeeId}/{period} | 获取指定期间考勤数据 |
| 批量获取考勤 | POST | /attendance/batch | 批量获取多个员工考勤数据 |
| 考勤异常查询 | GET | /attendance/anomalies | 查询考勤异常记录 |

#### 接口详细定义

**3.1 获取考勤数据接口**
```yaml
GET /attendance/{employeeId}/{period}
Request:
  headers:
    Authorization: Bearer {accessToken}
  pathParameters:
    employeeId: string
    period: string (格式: YYYY-MM)

Response:
  status: 200
  body:
    success: true
    data:
      employeeId: string
      period: string
      summary:
        totalDays: number
        workDays: number
        absentDays: number
        lateTimes: number
        earlyLeaveTimes: number
        overtimeHours: number
      details: array
        date: string
        checkInTime: string
        checkOutTime: string
        workingHours: number
        status: string
        note: string
    timestamp: 2025-11-21T12:00:00Z
```

### 4. 薪酬服务接口

#### 接口概述
人事系统与薪酬系统集成，处理薪酬计算和发放。

#### 接口清单
| 接口名称 | 方法 | URL | 描述 |
|---------|------|-----|------|
| 薪酬计算 | POST | /payroll/calculate | 计算员工薪酬 |
| 获取薪资单 | GET | /payroll/slip/{employeeId}/{period} | 获取指定期间薪资单 |
| 薪酬调整 | PUT | /payroll/adjustment | 执行薪酬调整 |

#### 接口详细定义

**4.1 薪酬计算接口**
```yaml
POST /payroll/calculate
Request:
  headers:
    Content-Type: application/json
    Authorization: Bearer {accessToken}
  body:
    employeeId: string
    period: string
    attendance: object
    performance: object
    adjustments: array

Response:
  status: 200
  body:
    success: true
    data:
      payrollId: string
      employeeId: string
      period: string
      breakdown:
        basicSalary: number
        performanceBonus: number
        overtimePay: number
        allowances: number
        deductions: number
      netSalary: number
      taxCalculation: object
      socialInsurance: object
      status: string
    timestamp: 2025-11-21T12:00:00Z
```

---

## API接口规范

### 通用接口规范

#### 请求规范
```yaml
标准请求头:
  Content-Type: application/json
  Authorization: Bearer {accessToken}
  X-Request-ID: {uuid}
  X-Client-Version: {version}
  X-Timestamp: {timestamp}

请求体结构:
  {
    "requestId": "uuid",
    "timestamp": "ISO8601",
    "data": {业务数据}
  }
```

#### 响应规范
```yaml
标准响应结构:
  {
    "success": boolean,
    "code": string,
    "message": string,
    "data": {响应数据},
    "timestamp": "ISO8601",
    "requestId": "uuid"
  }

成功响应示例:
  {
    "success": true,
    "code": "HR_SUCCESS_001",
    "message": "操作成功",
    "data": {...},
    "timestamp": "2025-11-21T12:00:00Z",
    "requestId": "req-uuid-123"
  }

错误响应示例:
  {
    "success": false,
    "code": "HR_ERROR_001",
    "message": "数据验证失败",
    "errors": [
      {
        "field": "employeeId",
        "message": "员工ID不能为空"
      }
    ],
    "timestamp": "2025-11-21T12:00:00Z",
    "requestId": "req-uuid-123"
  }
```

### 错误码规范

#### 错误码分类
- **HR_SUCCESS_xxx**: 成功响应
- **HR_ERROR_xxx**: 业务错误
- **HR_VALIDATION_xxx**: 验证错误
- **HR_AUTH_xxx**: 认证授权错误
- **HR_SYSTEM_xxx**: 系统错误

#### 常用错误码
```yaml
HR_SUCCESS_001: 操作成功
HR_ERROR_001: 员工信息不存在
HR_ERROR_002: 数据已存在，无法重复创建
HR_ERROR_003: 操作权限不足
HR_VALIDATION_001: 必填字段缺失
HR_VALIDATION_002: 数据格式错误
HR_AUTH_001: 用户未登录
HR_AUTH_002: 访问令牌已过期
HR_AUTH_003: 用户权限不足
HR_SYSTEM_001: 系统内部错误
HR_SYSTEM_002: 数据库连接失败
```

---

## 消息队列接口

### 消息队列架构

#### 队列配置
```yaml
队列类型: RabbitMQ / Apache Kafka
队列命名: hr.{eventType}.{environment}
消息格式: JSON
持久化: true
确认机制: ACK
重试策略: 3次重试，指数退避
```

#### 消息事件类型
1. **employee.created**: 员工创建事件
2. **employee.updated**: 员工信息更新事件
3. **training.completed**: 培训完成事件
4. **performance.evaluated**: 绩效评估完成事件
5. **payroll.processed**: 薪酬处理完成事件

### 消息格式定义

#### 1. 员工创建事件
```json
{
  "eventId": "evt-uuid-123",
  "eventType": "employee.created",
  "timestamp": "2025-11-21T12:00:00Z",
  "source": "hr-service",
  "data": {
    "employeeId": "EMP001",
    "department": "生产部",
    "position": "生产技术员",
    "startDate": "2025-11-21",
    "status": "ACTIVE"
  }
}
```

#### 2. 培训完成事件
```json
{
  "eventId": "evt-uuid-124",
  "eventType": "training.completed",
  "timestamp": "2025-11-21T12:00:00Z",
  "source": "training-service",
  "data": {
    "employeeId": "EMP001",
    "courseCode": "GMP001",
    "courseName": "GMP基础知识",
    "completionDate": "2025-11-25",
    "score": 95,
    "certificateIssued": true
  }
}
```

#### 3. 绩效评估事件
```json
{
  "eventId": "evt-uuid-125",
  "eventType": "performance.evaluated",
  "timestamp": "2025-11-21T12:00:00Z",
  "source": "performance-service",
  "data": {
    "employeeId": "EMP001",
    "evaluationPeriod": "2025Q4",
    "overallRating": "B+",
    "kpiScore": 105,
    "complianceScore": 98,
    "improvementAreas": ["文档规范性"],
    "actionPlan": "加强GMP文档培训"
  }
}
```

### 消息处理策略

#### 消费者处理
```yaml
消费者组: hr-consumer-group
并发度: 10
最大处理时间: 30秒
重试队列: hr.retry
死信队列: hr.dlq
处理幂等性: 基于eventId去重
```

---

## 数据库接口定义

### 数据库架构

#### 主数据库 (PostgreSQL)
```yaml
数据库名: gmp_hr_system
字符集: UTF-8
时区: Asia/Shanghai
连接池配置:
  最大连接数: 100
  最小连接数: 10
  连接超时: 30秒
  空闲超时: 600秒
```

#### 核心数据表
```sql
-- 员工基本信息表
CREATE TABLE employees (
    employee_id VARCHAR(20) PRIMARY KEY,
    personal_info JSONB NOT NULL,
    job_info JSONB NOT NULL,
    compliance_info JSONB,
    status VARCHAR(20) NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    version INTEGER DEFAULT 1
);

-- 培训记录表
CREATE TABLE training_records (
    record_id VARCHAR(50) PRIMARY KEY,
    employee_id VARCHAR(20) NOT NULL,
    course_code VARCHAR(20) NOT NULL,
    course_name VARCHAR(200) NOT NULL,
    training_date DATE NOT NULL,
    completion_date DATE,
    score INTEGER,
    certificate_id VARCHAR(100),
    status VARCHAR(20) NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 绩效评估表
CREATE TABLE performance_evaluations (
    evaluation_id VARCHAR(50) PRIMARY KEY,
    employee_id VARCHAR(20) NOT NULL,
    period VARCHAR(20) NOT NULL,
    overall_rating VARCHAR(10) NOT NULL,
    kpi_score DECIMAL(5,2),
    compliance_score INTEGER,
    improvement_areas TEXT[],
    action_plan TEXT,
    evaluator_id VARCHAR(20),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 薪酬记录表
CREATE TABLE payroll_records (
    payroll_id VARCHAR(50) PRIMARY KEY,
    employee_id VARCHAR(20) NOT NULL,
    period VARCHAR(20) NOT NULL,
    basic_salary DECIMAL(10,2) NOT NULL,
    performance_bonus DECIMAL(10,2),
    overtime_pay DECIMAL(10,2),
    allowances DECIMAL(10,2),
    deductions DECIMAL(10,2),
    net_salary DECIMAL(10,2) NOT NULL,
    status VARCHAR(20) NOT NULL,
    processed_at TIMESTAMP WITH TIME ZONE
);
```

### 数据访问接口

#### Repository接口定义
```java
// 员工信息Repository
public interface EmployeeRepository extends JpaRepository<Employee, String> {
    List<Employee> findByDepartmentAndStatus(String department, String status);
    
    @Query("SELECT e FROM Employee e WHERE e.complianceInfo->>'gmpCertified' = :certified")
    List<Employee> findByGmpCertified(@Param("certified") boolean certified);
    
    @Query("SELECT e FROM Employee e WHERE e.updatedAt >= :since ORDER BY e.updatedAt DESC")
    List<Employee> findUpdatedSince(@Param("since") LocalDateTime since);
}

// 培训记录Repository
public interface TrainingRecordRepository extends JpaRepository<TrainingRecord, String> {
    List<TrainingRecord> findByEmployeeIdAndStatus(String employeeId, String status);
    
    @Query("SELECT COUNT(t) FROM TrainingRecord t WHERE t.employeeId = :employeeId AND t.courseCode = :courseCode AND t.status = 'COMPLETED'")
    Long countCompletedCourses(@Param("employeeId") String employeeId, @Param("courseCode") String courseCode);
}
```

#### 数据同步策略
```yaml
同步策略: 事件驱动 + 定期补偿
同步频率:
  实时同步: 关键业务数据变更
  批量同步: 每小时执行一次
  增量同步: 基于变更日志
  全量同步: 每日凌晨执行

同步验证:
  数据完整性检查
  业务规则验证
  性能监控
  错误重试机制
```

---

## 数据同步和一致性

### 数据一致性策略

#### 强一致性场景
- 员工身份认证数据
- 薪酬计算结果
- 绩效评估最终结果

#### 最终一致性场景
- 培训进度数据
- 考勤统计数据
- 报表汇总数据

### 数据同步机制

#### 1. 双写模式
```yaml
应用场景: 关键业务数据写入
实现方式:
  1. 写入主数据库
  2. 写入备用数据库  
  3. 发送消息队列事件
  4. 确认写入结果

失败处理:
  - 回滚主数据库操作
  - 记录失败日志
  - 触发补偿机制
```

#### 2. 事件溯源模式
```yaml
应用场景: 复杂的业务状态变更
实现方式:
  1. 记录所有状态变更事件
  2. 通过事件重放恢复状态
  3. 支持历史数据查询
  4. 便于审计和回溯

存储设计:
  事件表: 存储所有变更事件
  状态表: 存储当前最终状态
  快照表: 定期状态快照
```

#### 3. CQRS模式
```yaml
应用场景: 读写分离，高性能查询
实现方式:
  命令端: 处理业务写操作
  查询端: 处理数据查询请求
  数据同步: 异步同步读写数据

优势:
  - 读写性能优化
  - 独立扩展能力
  - 更好的可扩展性
```

### 数据质量保证

#### 数据验证规则
```yaml
数据完整性:
  - 必填字段检查
  - 外键约束验证
  - 业务规则验证

数据准确性:
  - 数据格式验证
  - 业务逻辑验证
  - 交叉数据验证

数据一致性:
  - 事务一致性保证
  - 分布式事务处理
  - 最终一致性验证
```

#### 数据监控指标
```yaml
数据质量指标:
  - 数据完整率 > 99%
  - 数据准确率 > 98%
  - 数据一致性 > 99.5%

性能指标:
  - 数据查询响应时间 < 2秒
  - 数据同步延迟 < 5分钟
  - 系统可用性 > 99.9%
```

---

## 附录

### 附录A: 接口测试用例
- [ ] 用户认证接口测试
- [ ] 员工管理接口测试
- [ ] 培训管理接口测试
- [ ] 绩效评估接口测试
- [ ] 薪酬管理接口测试

### 附录B: 性能测试指标
- [ ] 并发用户数: 1000+
- [ ] 响应时间: < 3秒
- [ ] 系统可用性: 99.9%
- [ ] 数据一致性: 99.5%+

### 附录C: 安全测试要求
- [ ] 接口鉴权测试
- [ ] 数据加密验证
- [ ] SQL注入防护
- [ ] XSS攻击防护
- [ ] 访问权限验证

---

*本文档定义了GMP系统人事管理模块的完整数据流和接口规范，为系统集成和开发提供技术基础。*
