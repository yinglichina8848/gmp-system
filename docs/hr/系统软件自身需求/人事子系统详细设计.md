# äººäº‹ç®¡ç†å­ç³»ç»Ÿ - è¯¦ç»†è®¾è®¡

## ğŸ“‹ æ–‡æ¡£ä¿¡æ¯

| å±æ€§ | å€¼ |
|------|---|
| æ–‡æ¡£æ ‡é¢˜ | äººäº‹ç®¡ç†å­ç³»ç»Ÿ - è¯¦ç»†è®¾è®¡ |
| ç‰ˆæœ¬å· | v0.1.0-draft |
| åˆ›å»ºæ—¥æœŸ | 2025å¹´11æœˆ20æ—¥ |
| æ›´æ–°æ—¥æœŸ | 2025å¹´11æœˆ20æ—¥ |
| ä½œè€… | GMPç³»ç»Ÿå¼€å‘å›¢é˜Ÿ |
| çŠ¶æ€ | è‰ç¨¿ |

## ğŸ“Š æ•°æ®åº“è®¾è®¡

### æ•°æ®åº“æ¶æ„

```sql
-- GMPäººäº‹ç³»ç»Ÿæ•°æ®åº“
CREATE DATABASE hr_db;

-- è¿æ¥åˆ°hr_db
\c hr_db;
```

### æ ¸å¿ƒæ•°æ®è¡¨

#### 1. éƒ¨é—¨è¡¨ (departments)

```sql
-- éƒ¨é—¨ä¿¡æ¯è¡¨
CREATE TABLE departments (
    id BIGSERIAL PRIMARY KEY,
    department_code VARCHAR(50) NOT NULL UNIQUE,
    department_name VARCHAR(100) NOT NULL,
    parent_id BIGINT REFERENCES departments(id) ON DELETE SET NULL,
    manager_id BIGINT,
    description TEXT,
    location VARCHAR(100),
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by BIGINT,
    updated_by BIGINT,
    version INTEGER DEFAULT 1
);

-- ç´¢å¼•
CREATE UNIQUE INDEX idx_departments_code ON departments(department_code);
CREATE INDEX idx_departments_parent ON departments(parent_id);
CREATE INDEX idx_departments_manager ON departments(manager_id);
CREATE INDEX idx_departments_active ON departments(is_active);
```

#### 2. å²—ä½è¡¨ (positions)

```sql
-- å²—ä½ä¿¡æ¯è¡¨
CREATE TABLE positions (
    id BIGSERIAL PRIMARY KEY,
    position_code VARCHAR(50) NOT NULL UNIQUE,
    position_name VARCHAR(100) NOT NULL,
    department_id BIGINT REFERENCES departments(id),
    job_level_id BIGINT,
    responsibilities TEXT,
    qualifications TEXT,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by BIGINT,
    updated_by BIGINT,
    version INTEGER DEFAULT 1
);

-- ç´¢å¼•
CREATE UNIQUE INDEX idx_positions_code ON positions(position_code);
CREATE INDEX idx_positions_dept ON positions(department_id);
CREATE INDEX idx_positions_level ON positions(job_level_id);
CREATE INDEX idx_positions_active ON positions(is_active);
```

#### 3. èŒçº§è¡¨ (job_levels)

```sql
-- èŒçº§ä¿¡æ¯è¡¨
CREATE TABLE job_levels (
    id BIGSERIAL PRIMARY KEY,
    level_code VARCHAR(50) NOT NULL UNIQUE,
    level_name VARCHAR(100) NOT NULL,
    priority INTEGER DEFAULT 0,
    salary_range_min DECIMAL(12,2),
    salary_range_max DECIMAL(12,2),
    description TEXT,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by BIGINT,
    updated_by BIGINT,
    version INTEGER DEFAULT 1
);

-- ç´¢å¼•
CREATE UNIQUE INDEX idx_job_levels_code ON job_levels(level_code);
CREATE INDEX idx_job_levels_active ON job_levels(is_active);
```

#### 4. å‘˜å·¥è¡¨ (employees)

```sql
-- å‘˜å·¥åŸºæœ¬ä¿¡æ¯è¡¨
CREATE TABLE employees (
    id BIGSERIAL PRIMARY KEY,
    employee_code VARCHAR(50) NOT NULL UNIQUE,
    full_name VARCHAR(100) NOT NULL,
    chinese_name VARCHAR(50),
    english_name VARCHAR(100),
    gender VARCHAR(10) CHECK (gender IN ('ç”·', 'å¥³', 'å…¶ä»–')),
    date_of_birth DATE,
    id_card_number VARCHAR(20),
    nationality VARCHAR(50),
    marital_status VARCHAR(20),
    email VARCHAR(100),
    mobile VARCHAR(20),
    work_phone VARCHAR(20),
    department_id BIGINT REFERENCES departments(id),
    position_id BIGINT REFERENCES positions(id),
    job_level_id BIGINT REFERENCES job_levels(id),
    employment_type VARCHAR(50) CHECK (employment_type IN ('æ­£å¼', 'è¯•ç”¨', 'å…¼èŒ', 'ä¸´æ—¶å·¥')),
    hire_date DATE NOT NULL,
    probation_end_date DATE,
    contract_end_date DATE,
    work_status VARCHAR(20) DEFAULT 'åœ¨èŒ' CHECK (work_status IN ('åœ¨èŒ', 'ç¦»èŒ', 'å¾…å…¥èŒ', 'åœèŒ', 'é€€ä¼‘')),
    last_work_date DATE,
    supervisor_id BIGINT REFERENCES employees(id),
    user_id BIGINT, -- å…³è”è®¤è¯ç³»ç»Ÿç”¨æˆ·ID
    notes TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by BIGINT,
    updated_by BIGINT,
    version INTEGER DEFAULT 1
);

-- ç´¢å¼•
CREATE UNIQUE INDEX idx_employees_code ON employees(employee_code);
CREATE INDEX idx_employees_dept ON employees(department_id);
CREATE INDEX idx_employees_position ON employees(position_id);
CREATE INDEX idx_employees_level ON employees(job_level_id);
CREATE INDEX idx_employees_status ON employees(work_status);
CREATE INDEX idx_employees_supervisor ON employees(supervisor_id);
CREATE INDEX idx_employees_hire_date ON employees(hire_date);
```

#### 5. å‘˜å·¥è”ç³»æ–¹å¼è¡¨ (employee_contacts)

```sql
-- å‘˜å·¥è”ç³»æ–¹å¼è¡¨
CREATE TABLE employee_contacts (
    id BIGSERIAL PRIMARY KEY,
    employee_id BIGINT NOT NULL REFERENCES employees(id) ON DELETE CASCADE,
    contact_type VARCHAR(50) NOT NULL, -- å®¶åº­åœ°å€ã€ç´§æ€¥è”ç³»äººç­‰
    contact_name VARCHAR(100),
    phone_number VARCHAR(20),
    relationship VARCHAR(50),
    address TEXT,
    is_primary BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç´¢å¼•
CREATE INDEX idx_employee_contacts_emp ON employee_contacts(employee_id);
CREATE INDEX idx_employee_contacts_type ON employee_contacts(contact_type);
CREATE INDEX idx_employee_contacts_primary ON employee_contacts(is_primary);
```

#### 6. è€ƒå‹¤è®°å½•è¡¨ (time_records)

```sql
-- è€ƒå‹¤è®°å½•è¡¨
CREATE TABLE time_records (
    id BIGSERIAL PRIMARY KEY,
    employee_id BIGINT NOT NULL REFERENCES employees(id),
    record_date DATE NOT NULL,
    check_in_time TIME,
    check_out_time TIME,
    work_hours DECIMAL(5,2),
    overtime_hours DECIMAL(5,2) DEFAULT 0,
    record_type VARCHAR(20) CHECK (record_type IN ('æ­£å¸¸', 'è¿Ÿåˆ°', 'æ—©é€€', 'ç¼ºå‹¤', 'è¯·å‡', 'åŠ ç­', 'è°ƒä¼‘')),
    reason VARCHAR(200),
    approver_id BIGINT REFERENCES employees(id),
    status VARCHAR(20) DEFAULT 'å¾…ç¡®è®¤' CHECK (status IN ('å¾…ç¡®è®¤', 'å·²ç¡®è®¤', 'å·²é©³å›')),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(employee_id, record_date)
);

-- ç´¢å¼•
CREATE INDEX idx_time_records_emp ON time_records(employee_id);
CREATE INDEX idx_time_records_date ON time_records(record_date);
CREATE INDEX idx_time_records_type ON time_records(record_type);
CREATE INDEX idx_time_records_status ON time_records(status);
```

#### 7. åŸ¹è®­è¯¾ç¨‹è¡¨ (training_courses)

```sql
-- åŸ¹è®­è¯¾ç¨‹è¡¨
CREATE TABLE training_courses (
    id BIGSERIAL PRIMARY KEY,
    course_code VARCHAR(50) NOT NULL UNIQUE,
    course_name VARCHAR(100) NOT NULL,
    course_type VARCHAR(50),
    trainer_id BIGINT REFERENCES employees(id),
    duration_hours DECIMAL(5,2),
    content TEXT,
    prerequisite TEXT,
    target_audience TEXT,
    is_gmp_required BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by BIGINT,
    updated_by BIGINT,
    version INTEGER DEFAULT 1
);

-- ç´¢å¼•
CREATE UNIQUE INDEX idx_training_courses_code ON training_courses(course_code);
CREATE INDEX idx_training_courses_trainer ON training_courses(trainer_id);
CREATE INDEX idx_training_courses_gmp ON training_courses(is_gmp_required);
```

#### 8. åŸ¹è®­è®°å½•è¡¨ (training_records)

```sql
-- åŸ¹è®­è®°å½•è¡¨
CREATE TABLE training_records (
    id BIGSERIAL PRIMARY KEY,
    employee_id BIGINT NOT NULL REFERENCES employees(id),
    course_id BIGINT NOT NULL REFERENCES training_courses(id),
    training_date DATE NOT NULL,
    score DECIMAL(5,2),
    pass_score DECIMAL(5,2),
    is_passed BOOLEAN,
    trainer_id BIGINT REFERENCES employees(id),
    training_location VARCHAR(100),
    certificate_number VARCHAR(100),
    certificate_expiry_date DATE,
    notes TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç´¢å¼•
CREATE INDEX idx_training_records_emp ON training_records(employee_id);
CREATE INDEX idx_training_records_course ON training_records(course_id);
CREATE INDEX idx_training_records_date ON training_records(training_date);
CREATE INDEX idx_training_records_cert_expiry ON training_records(certificate_expiry_date);
```

#### 9. è¯ä¹¦ç±»å‹è¡¨ (certificate_types)

```sql
-- è¯ä¹¦ç±»å‹è¡¨
CREATE TABLE certificate_types (
    id BIGSERIAL PRIMARY KEY,
    type_code VARCHAR(50) NOT NULL UNIQUE,
    type_name VARCHAR(100) NOT NULL,
    description TEXT,
    validity_years DECIMAL(5,2),
    is_gmp_required BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç´¢å¼•
CREATE UNIQUE INDEX idx_certificate_types_code ON certificate_types(type_code);
CREATE INDEX idx_certificate_types_gmp ON certificate_types(is_gmp_required);
```

#### 10. è¯ä¹¦ä¿¡æ¯è¡¨ (certificates)

```sql
-- è¯ä¹¦ä¿¡æ¯è¡¨
CREATE TABLE certificates (
    id BIGSERIAL PRIMARY KEY,
    employee_id BIGINT NOT NULL REFERENCES employees(id),
    certificate_type_id BIGINT NOT NULL REFERENCES certificate_types(id),
    certificate_number VARCHAR(100) NOT NULL,
    issue_date DATE NOT NULL,
    expiry_date DATE,
    issuing_authority VARCHAR(100),
    certificate_file_url VARCHAR(255),
    status VARCHAR(20) DEFAULT 'æœ‰æ•ˆ' CHECK (status IN ('æœ‰æ•ˆ', 'è¿‡æœŸ', 'åŠé”€', 'å¾…å®¡æ ¸')),
    notes TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(employee_id, certificate_type_id, certificate_number)
);

-- ç´¢å¼•
CREATE INDEX idx_certificates_emp ON certificates(employee_id);
CREATE INDEX idx_certificates_type ON certificates(certificate_type_id);
CREATE INDEX idx_certificates_expiry ON certificates(expiry_date);
CREATE INDEX idx_certificates_status ON certificates(status);
```

## ğŸ”Œ APIæ¥å£è®¾è®¡

### APIè®¾è®¡åŸåˆ™

1. **RESTfulè®¾è®¡**ï¼šéµå¾ªRESTfulè§„èŒƒ
2. **ç‰ˆæœ¬æ§åˆ¶**ï¼šAPIç‰ˆæœ¬ç®¡ç† `/api/hr/v1`
3. **æ–‡æ¡£åŒ–**ï¼šSwagger/OpenAPIæ–‡æ¡£
4. **å®‰å…¨æ€§**ï¼šHTTPS + JWTè®¤è¯
5. **ç»Ÿä¸€å“åº”**ï¼šæ ‡å‡†JSONå“åº”æ ¼å¼

### ç»Ÿä¸€å“åº”æ ¼å¼

```typescript
// æˆåŠŸå“åº”
{
    "success": true,
    "code": "200",
    "message": "æ“ä½œæˆåŠŸ",
    "data": { /* ä¸šåŠ¡æ•°æ® */ },
    "timestamp": "2025-11-20T10:30:00Z"
}

// å¤±è´¥å“åº”
{
    "success": false,
    "code": "400",
    "message": "æ“ä½œå¤±è´¥",
    "data": null,
    "timestamp": "2025-11-20T10:30:00Z"
}

// åˆ†é¡µå“åº”
{
    "success": true,
    "code": "200",
    "data": {
        "records": [...],  // æ•°æ®åˆ—è¡¨
        "total": 100,
        "current": 1,
        "size": 10,
        "pages": 10
    }
}
```

### å‘˜å·¥ç®¡ç†API

#### è·å–å‘˜å·¥åˆ—è¡¨ (GET /api/hr/v1/employees)

**æŸ¥è¯¢å‚æ•°**ï¼š
- `page`: é¡µç  (é»˜è®¤1)
- `size`: é¡µå¤§å° (é»˜è®¤10)
- `sort`: æ’åºå­—æ®µ (é»˜è®¤employee_code)
- `order`: æ’åºæ–¹å‘ (asc/desc)
- `departmentId`: éƒ¨é—¨IDè¿‡æ»¤
- `positionId`: å²—ä½IDè¿‡æ»¤
- `workStatus`: å·¥ä½œçŠ¶æ€è¿‡æ»¤
- `keyword`: å…³é”®å­—æœç´¢ï¼ˆå‘˜å·¥ç¼–å·ã€å§“åï¼‰

**å“åº”**ï¼š
```typescript
{
    "success": true,
    "code": "200",
    "data": {
        "records": [
            {
                "id": 1,
                "employeeCode": "EMP0001",
                "fullName": "å¼ ä¸‰",
                "department": {
                    "id": 1,
                    "departmentName": "è´¨é‡ç®¡ç†éƒ¨"
                },
                "position": {
                    "id": 1,
                    "positionName": "è´¨é‡ç»ç†"
                },
                "jobLevel": {
                    "id": 3,
                    "levelName": "é«˜çº§ç»ç†"
                },
                "employmentType": "æ­£å¼",
                "hireDate": "2020-01-15",
                "workStatus": "åœ¨èŒ",
                "email": "zhangsan@gmp-system.com",
                "mobile": "13800138000"
            }
        ],
        "total": 50,
        "current": 1,
        "size": 10,
        "pages": 5
    }
}
```

#### åˆ›å»ºå‘˜å·¥ (POST /api/hr/v1/employees)

**è¯·æ±‚ä½“**ï¼š
```typescript
{
    "employeeCode": "EMP0001",
    "fullName": "å¼ ä¸‰",
    "chineseName": "å¼ ä¸‰",
    "englishName": "Zhang San",
    "gender": "ç”·",
    "dateOfBirth": "1985-05-15",
    "idCardNumber": "110101198505150001",
    "nationality": "ä¸­å›½",
    "maritalStatus": "å·²å©š",
    "email": "zhangsan@gmp-system.com",
    "mobile": "13800138000",
    "workPhone": "010-12345678",
    "departmentId": 1,
    "positionId": 1,
    "jobLevelId": 3,
    "employmentType": "æ­£å¼",
    "hireDate": "2020-01-15",
    "probationEndDate": "2020-04-15",
    "contractEndDate": "2025-01-14",
    "workStatus": "åœ¨èŒ",
    "supervisorId": null,
    "contacts": [
        {
            "contactType": "å®¶åº­åœ°å€",
            "address": "åŒ—äº¬å¸‚æµ·æ·€åŒºæŸæŸè¡—é“100å·",
            "isPrimary": true
        },
        {
            "contactType": "ç´§æ€¥è”ç³»äºº",
            "contactName": "æå››",
            "phoneNumber": "13900139000",
            "relationship": "é…å¶",
            "isPrimary": false
        }
    ]
}
```

**å“åº”**ï¼š
```typescript
{
    "success": true,
    "code": "201",
    "data": {
        "id": 1,
        "employeeCode": "EMP0001",
        "createdAt": "2025-11-20T10:30:00"
    }
}
```

### è€ƒå‹¤ç®¡ç†API

#### è·å–è€ƒå‹¤è®°å½• (GET /api/hr/v1/attendance/records)

**æŸ¥è¯¢å‚æ•°**ï¼š
- `page`: é¡µç  (é»˜è®¤1)
- `size`: é¡µå¤§å° (é»˜è®¤10)
- `startDate`: å¼€å§‹æ—¥æœŸ
- `endDate`: ç»“æŸæ—¥æœŸ
- `employeeId`: å‘˜å·¥ID
- `departmentId`: éƒ¨é—¨ID
- `recordType`: è®°å½•ç±»å‹
- `status`: çŠ¶æ€

**å“åº”**ï¼š
```typescript
{
    "success": true,
    "code": "200",
    "data": {
        "records": [
            {
                "id": 1,
                "employeeId": 1,
                "employeeName": "å¼ ä¸‰",
                "recordDate": "2025-11-20",
                "checkInTime": "09:00:00",
                "checkOutTime": "18:00:00",
                "workHours": 8.0,
                "overtimeHours": 0.0,
                "recordType": "æ­£å¸¸",
                "status": "å·²ç¡®è®¤"
            }
        ],
        "total": 100,
        "current": 1,
        "size": 10,
        "pages": 10
    }
}
```

#### æäº¤è€ƒå‹¤å¼‚å¸¸ç”³è¯· (POST /api/hr/v1/attendance/exceptions)

**è¯·æ±‚ä½“**ï¼š
```typescript
{
    "employeeId": 1,
    "recordDate": "2025-11-20",
    "recordType": "è¯·å‡",
    "reason": "ç—…å‡",
    "durationHours": 4.0,
    "attachmentUrl": "http://example.com/uploads/medical_certificate.pdf"
}
```

**å“åº”**ï¼š
```typescript
{
    "success": true,
    "code": "200",
    "data": {
        "id": 1,
        "applicationNumber": "ATTEX202511200001",
        "status": "å¾…å®¡æ‰¹"
    }
}
```

### åŸ¹è®­ç®¡ç†API

#### è·å–åŸ¹è®­è¯¾ç¨‹åˆ—è¡¨ (GET /api/hr/v1/training/courses)

**æŸ¥è¯¢å‚æ•°**ï¼š
- `page`: é¡µç  (é»˜è®¤1)
- `size`: é¡µå¤§å° (é»˜è®¤10)
- `courseType`: è¯¾ç¨‹ç±»å‹
- `isGmpRequired`: æ˜¯å¦GMPå¿…éœ€
- `keyword`: å…³é”®å­—æœç´¢

**å“åº”**ï¼š
```typescript
{
    "success": true,
    "code": "200",
    "data": {
        "records": [
            {
                "id": 1,
                "courseCode": "TRN001",
                "courseName": "GMPåŸºç¡€çŸ¥è¯†åŸ¹è®­",
                "courseType": "å¿…ä¿®",
                "trainerName": "æè€å¸ˆ",
                "durationHours": 8.0,
                "isGmpRequired": true
            }
        ],
        "total": 20,
        "current": 1,
        "size": 10,
        "pages": 2
    }
}
```

#### è®°å½•åŸ¹è®­å‚ä¸ (POST /api/hr/v1/training/records)

**è¯·æ±‚ä½“**ï¼š
```typescript
{
    "employeeId": 1,
    "courseId": 1,
    "trainingDate": "2025-11-20",
    "score": 95.0,
    "passScore": 80.0,
    "isPassed": true,
    "trainerId": 2,
    "trainingLocation": "ä¼šè®®å®¤A",
    "certificateNumber": "CERT20251120001",
    "certificateExpiryDate": "2027-11-19"
}
```

**å“åº”**ï¼š
```typescript
{
    "success": true,
    "code": "200",
    "data": {
        "id": 1,
        "recordNumber": "TRNREC202511200001"
    }
}
```

### èµ„è´¨è®¤è¯API

#### è·å–è¯ä¹¦ç±»å‹åˆ—è¡¨ (GET /api/hr/v1/certificates/types)

**æŸ¥è¯¢å‚æ•°**ï¼š
- `isGmpRequired`: æ˜¯å¦GMPå¿…éœ€
- `keyword`: å…³é”®å­—æœç´¢

**å“åº”**ï¼š
```typescript
{
    "success": true,
    "code": "200",
    "data": [
        {
            "id": 1,
            "typeCode": "CERT001",
            "typeName": "GMPè¯ä¹¦",
            "description": "è¯å“ç”Ÿäº§è´¨é‡ç®¡ç†è§„èŒƒè¯ä¹¦",
            "validityYears": 3.0,
            "isGmpRequired": true
        }
    ]
}
```

#### å½•å…¥è¯ä¹¦ä¿¡æ¯ (POST /api/hr/v1/certificates)

**è¯·æ±‚ä½“**ï¼š
```typescript
{
    "employeeId": 1,
    "certificateTypeId": 1,
    "certificateNumber": "GMP202500001",
    "issueDate": "2025-01-15",
    "expiryDate": "2028-01-14",
    "issuingAuthority": "å›½å®¶è¯å“ç›‘ç£ç®¡ç†å±€",
    "certificateFileUrl": "http://example.com/uploads/certificates/GMP202500001.pdf"
}
```

**å“åº”**ï¼š
```typescript
{
    "success": true,
    "code": "201",
    "data": {
        "id": 1,
        "status": "æœ‰æ•ˆ"
    }
}
```

## ğŸ” å®‰å…¨å®ç°æ–¹æ¡ˆ

### æƒé™æ§åˆ¶å®ç°

```java
@Configuration
@EnableMethodSecurity
public class MethodSecurityConfig {

    @Bean
    public PermissionEvaluator permissionEvaluator() {
        return new CustomPermissionEvaluator();
    }
    
    @Bean
    public AccessDeniedHandler accessDeniedHandler() {
        return new CustomAccessDeniedHandler();
    }
}

@Component
public class CustomPermissionEvaluator implements PermissionEvaluator {

    @Override
    public boolean hasPermission(Authentication auth, Object target, Object permission) {
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰ç‰¹å®šæƒé™è®¿é—®ç›®æ ‡èµ„æº
        // å®ç°ç»†ç²’åº¦çš„æƒé™æ§åˆ¶
        if (!(auth instanceof JwtAuthenticationToken)) {
            return false;
        }
        
        JwtAuthenticationToken token = (JwtAuthenticationToken) auth;
        Map<String, Object> claims = ((Jwt) token.getCredentials()).getClaims();
        
        List<String> permissions = (List<String>) claims.getOrDefault("permissions", Collections.emptyList());
        return permissions.contains(permission);
    }
    
    @Override
    public boolean hasPermission(Authentication auth, Serializable targetId, String targetType, Object permission) {
        // å®ç°åŸºäºIDçš„æƒé™æ£€æŸ¥
        return hasPermission(auth, null, permission);
    }
}
```

### æ•°æ®å®‰å…¨å®ç°

```java
@Service
public class EmployeeServiceImpl implements EmployeeService {

    @Autowired
    private EmployeeRepository employeeRepository;
    
    @Autowired
    private DataMaskingService dataMaskingService;
    
    @Override
    @PreAuthorize("hasPermission('EMPLOYEE_VIEW', 'HR_PERMISSION')")
    public Page<EmployeeDTO> findEmployees(EmployeeQuery query, Pageable pageable) {
        Page<Employee> employees = employeeRepository.findByQuery(query, pageable);
        
        // å¯¹æ•æ„Ÿæ•°æ®è¿›è¡Œè„±æ•å¤„ç†
        return employees.map(employee -> {
            EmployeeDTO dto = EmployeeMapper.INSTANCE.toDTO(employee);
            // æ ¹æ®ç”¨æˆ·æƒé™å†³å®šæ˜¯å¦è„±æ•
            if (!SecurityContextHolder.getContext().getAuthentication()
                    .getAuthorities().contains(new SimpleGrantedAuthority("HR_ADMIN"))) {
                dto.setIdCardNumber(dataMaskingService.maskIdCard(dto.getIdCardNumber()));
                dto.setMobile(dataMaskingService.maskPhone(dto.getMobile()));
            }
            return dto;
        });
    }
}
```

## ğŸ“Š ç›‘æ§ä¸å®¡è®¡

### æ“ä½œå®¡è®¡æ—¥å¿—

```java
@Aspect
@Component
@Slf4j
public class OperationAuditAspect {

    @Autowired
    private OperationLogRepository operationLogRepository;
    
    @Around("execution(* com.gmp.hr.service.*.*(..)) && @annotation(auditable)")
    public Object auditOperation(ProceedingJoinPoint joinPoint, Auditable auditable) throws Throwable {
        // è®°å½•æ“ä½œå‰ä¿¡æ¯
        String operationType = auditable.operationType();
        String module = auditable.module();
        String username = SecurityContextHolder.getContext().getAuthentication().getName();
        
        log.info("Starting operation: {} in module: {} by user: {}", operationType, module, username);
        
        long startTime = System.currentTimeMillis();
        Object result;
        String status = "SUCCESS";
        String errorMessage = null;
        
        try {
            result = joinPoint.proceed();
            return result;
        } catch (Exception e) {
            status = "FAILED";
            errorMessage = e.getMessage();
            log.error("Operation failed: {}", e.getMessage(), e);
            throw e;
        } finally {
            long duration = System.currentTimeMillis() - startTime;
            
            // ä¿å­˜æ“ä½œæ—¥å¿—
            UserOperationLog logEntity = new UserOperationLog();
            logEntity.setUsername(username);
            logEntity.setOperation(operationType);
            logEntity.setModule(module);
            logEntity.setAction(joinPoint.getSignature().getName());
            logEntity.setResult(status);
            logEntity.setDurationMs((int) duration);
            logEntity.setErrorMessage(errorMessage);
            logEntity.setIpAddress(RequestContextHolder.currentRequestAttributes() != null ?
                    ((ServletRequestAttributes) RequestContextHolder.currentRequestAttributes()).getRequest().getRemoteAddr() : "unknown");
            
            operationLogRepository.save(logEntity);
        }
    }
}
```

## ğŸš€ éƒ¨ç½²é…ç½®

### Dockeré…ç½®

```dockerfile
# hr-service Dockerfile
FROM openjdk:17-jre-slim

COPY target/hr-service.jar /app/app.jar

EXPOSE 8086

CMD ["java", "-jar", "/app/app.jar", "--spring.profiles.active=prod"]
```

### Docker Composeé…ç½®

```yaml
services:
  hr-service:
    image: gmp/hr-service:v0.1.0
    container_name: gmp-hr-service
    ports:
      - "8086:8086"
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/hr_db
      - SPRING_DATASOURCE_USERNAME=hr_user
      - SPRING_DATASOURCE_PASSWORD=${HR_DB_PASSWORD}
      - SPRING_REDIS_HOST=redis
      - SPRING_REDIS_PASSWORD=${REDIS_PASSWORD}
      - EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://eureka-server:8761/eureka/
      - SECURITY_OAUTH2_RESOURCE_USER_INFO_URI=http://auth-service:8085/api/auth/v1/userinfo
    restart: unless-stopped
    depends_on:
      - postgres
      - redis
      - auth-service
    networks:
      - gmp-network
```

## ğŸ“‹ å®ç°è¿›åº¦è¡¨

| æ¨¡å— | çŠ¶æ€ | é¢„è®¡å®Œæˆæ—¥æœŸ | è´Ÿè´£äºº |
|------|------|--------------|--------|
| æ•°æ®åº“è®¾è®¡ | âœ… å®Œæˆ | 2025-11-20 | ç³»ç»Ÿæ¶æ„å¸ˆ |
| å‘˜å·¥ç®¡ç†æ¨¡å— | â³ å¾…å¼€å‘ | 2025-11-27 | åç«¯å¼€å‘å·¥ç¨‹å¸ˆ |
| è€ƒå‹¤ç®¡ç†æ¨¡å— | â³ å¾…å¼€å‘ | 2025-12-04 | åç«¯å¼€å‘å·¥ç¨‹å¸ˆ |
| åŸ¹è®­ç®¡ç†æ¨¡å— | â³ å¾…å¼€å‘ | 2025-12-11 | åç«¯å¼€å‘å·¥ç¨‹å¸ˆ |
| èµ„è´¨è®¤è¯æ¨¡å— | â³ å¾…å¼€å‘ | 2025-12-18 | åç«¯å¼€å‘å·¥ç¨‹å¸ˆ |
| ç»©æ•ˆç®¡ç†æ¨¡å— | â³ å¾…å¼€å‘ | 2025-12-25 | åç«¯å¼€å‘å·¥ç¨‹å¸ˆ |
| è–ªé…¬ç®¡ç†æ¨¡å— | â³ å¾…å¼€å‘ | 2026-01-08 | åç«¯å¼€å‘å·¥ç¨‹å¸ˆ |
| å‰ç«¯é¡µé¢å¼€å‘ | â³ å¾…å¼€å‘ | 2026-01-15 | å‰ç«¯å¼€å‘å·¥ç¨‹å¸ˆ |
| ç³»ç»Ÿé›†æˆ | â³ å¾…å¼€å‘ | 2026-01-22 | å…¨æ ˆå¼€å‘å·¥ç¨‹å¸ˆ |
| æµ‹è¯•éªŒè¯ | â³ å¾…å¼€å‘ | 2026-01-29 | æµ‹è¯•å·¥ç¨‹å¸ˆ |

---

*æ–‡æ¡£ç‰ˆæœ¬ï¼šv0.1.0-draft*
*å®¡æ ¸çŠ¶æ€ï¼šå¾…å®¡æ ¸*
*ä¸‹æ¬¡æ›´æ–°ï¼šå®ç°å®Œæˆå*