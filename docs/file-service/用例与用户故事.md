# 文件服务子系统 - 用例与用户故事

## 1. 简介

本文档详细描述文件服务子系统的用例和用户故事，旨在从用户视角清晰地定义系统功能和交互方式，为开发团队提供明确的需求参考。文档涵盖主要参与者、用例场景、详细用例描述和用户故事等内容，确保系统开发符合GMP法规要求和用户实际业务需求。

### 1.1 文档目的

- 明确文件服务子系统的用户角色和职责
- 详细描述系统的核心用例和交互流程
- 通过用户故事理解用户期望和业务价值
- 为系统设计和开发提供明确的功能参考
- 确保系统满足GMP合规性要求

### 1.2 术语定义

| 术语 | 解释说明 |
|------|----------|
| 文件 | 电子形式存储的各类文档、图片、音视频等内容 |
| 电子记录 | 由计算机系统生成、修改、维护、归档、检索或分发的数字形式信息 |
| 电子签名 | 用于确认操作执行者身份并表明其对操作内容的认可的电子数据 |
| 审计跟踪 | 系统自动记录的所有关键操作的详细日志，用于合规审计 |
| 工作流 | 预设的业务流程，定义了文件处理的步骤和审批规则 |
| 批记录 | 记录药品生产全过程的文档集合 |
| SOP | 标准操作程序，规定特定操作步骤和标准的文档 |
| 偏差 | 与已批准的程序、指令或既定标准的偏离 |

## 2. 参与者识别

文件服务子系统涉及多个角色，每个角色具有不同的权限和职责。以下是主要参与者及其职责说明：

| 参与者 | 角色描述 | 主要职责 |
|--------|----------|----------|
| **普通用户** | 系统的一般使用者 | 创建、上传、下载、预览和管理个人文件，参与文件审批流程 |
| **部门管理员** | 各部门的文件管理负责人 | 管理部门文件，审批部门内文件，查看部门文件统计报表 |
| **质量部门专员** | 质量保证和质量控制人员 | 审批涉及质量的文件，监督文件合规性，执行质量相关任务 |
| **系统管理员** | 系统维护和配置人员 | 配置系统参数，管理用户权限，监控系统性能，执行备份恢复 |
| **安全审计员** | 合规审计和安全监督人员 | 查看审计日志，执行合规审计，验证电子签名有效性 |
| **高级管理层** | 企业决策人员 | 审批重要文件，查看系统整体报表，做出战略决策 |
| **外部合作伙伴** | 与企业有业务往来的外部机构人员 | 接收和查看共享文件，参与协作项目 |

## 3. 用例图

以下用例图展示了文件服务子系统的主要功能和参与者交互关系：

```mermaid
actor "普通用户" as User
actor "部门管理员" as DeptAdmin
actor "质量部门专员" as QualityStaff
actor "系统管理员" as SysAdmin
actor "安全审计员" as Auditor
actor "高级管理层" as Executive
actor "外部合作伙伴" as External

rectangle "文件服务子系统" {
  usecase "文件上传" as Upload
  usecase "文件下载" as Download
  usecase "文件预览" as Preview
  usecase "文件搜索" as Search
  usecase "文件共享" as Share
  usecase "文件版本管理" as Version
  usecase "电子签名" as ESign
  usecase "工作流审批" as Workflow
  usecase "权限管理" as Permissions
  usecase "审计跟踪" as Audit
  usecase "系统配置" as Config
  usecase "报表生成" as Report
}

User --> Upload
User --> Download
User --> Preview
User --> Search
User --> Share
User --> Version
User --> ESign
User --> Workflow
DeptAdmin --> Upload
DeptAdmin --> Download
DeptAdmin --> Preview
DeptAdmin --> Search
DeptAdmin --> Share
DeptAdmin --> Version
DeptAdmin --> ESign
DeptAdmin --> Workflow
DeptAdmin --> Report
QualityStaff --> Download
QualityStaff --> Preview
QualityStaff --> Search
QualityStaff --> ESign
QualityStaff --> Workflow
QualityStaff --> Audit
SysAdmin --> Permissions
SysAdmin --> Config
SysAdmin --> Audit
SysAdmin --> Report
Auditor --> Audit
Executive --> Report
Executive --> Workflow
External --> Download
External --> Preview
```

## 4. 详细用例描述

### 4.1 文件上传

| 用例ID | FS-U001 |
|--------|--------|
| 用例名称 | 文件上传 |
| 参与者 | 普通用户、部门管理员 |
| 前置条件 | 1. 用户已登录系统<br>2. 用户拥有文件上传权限<br>3. 文件大小和格式符合系统要求 |
| 后置条件 | 1. 文件成功上传到系统<br>2. 文件元数据记录到数据库<br>3. 文件内容存储到存储服务<br>4. 审计日志记录上传操作 |
| 流程描述 | 1. 用户点击"上传文件"按钮<br>2. 系统显示文件选择对话框<br>3. 用户选择一个或多个文件<br>4. 用户选择目标文件夹<br>5. 用户添加文件元数据（如描述、标签、分类等）<br>6. 用户点击"确认上传"<br>7. 系统开始上传文件<br>8. 系统显示上传进度<br>9. 上传完成后，系统显示上传结果<br>10. 系统记录文件上传审计日志 |
| 异常流程 | 1. 文件大小超过限制：系统提示文件过大，建议使用分片上传<br>2. 文件格式不支持：系统提示文件格式不支持，列出支持的格式<br>3. 上传中断：系统支持断点续传，提示用户重新开始上传<br>4. 存储空间不足：系统提示存储空间不足，请联系管理员 |
| 数据需求 | 1. 文件内容<br>2. 文件元数据（名称、大小、类型、路径、上传时间、上传人、描述、标签等）<br>3. 文件访问权限 |
| 业务规则 | 1. 文件大小限制为5GB<br>2. 支持常见文件格式，如PDF、Word、Excel、图片、视频等<br>3. 文件名不能包含特殊字符<br>4. 上传文件自动记录审计日志<br>5. 上传的文件需符合数据分类和安全级别要求 |

### 4.2 文件下载

| 用例ID | FS-U002 |
|--------|--------|
| 用例名称 | 文件下载 |
| 参与者 | 普通用户、部门管理员、质量部门专员、外部合作伙伴 |
| 前置条件 | 1. 用户已登录系统（外部用户除外）<br>2. 用户拥有文件下载权限<br>3. 文件存在且可访问 |
| 后置条件 | 1. 文件成功下载到用户设备<br>2. 审计日志记录下载操作 |
| 流程描述 | 1. 用户在文件列表或文件详情页选择一个或多个文件<br>2. 用户点击"下载"按钮<br>3. 对于需要电子签名的文件，系统提示用户进行电子签名<br>4. 用户完成电子签名（如需要）<br>5. 系统开始下载文件<br>6. 系统显示下载进度（大文件）<br>7. 文件下载完成<br>8. 系统记录文件下载审计日志 |
| 异常流程 | 1. 权限不足：系统提示用户无权限下载文件<br>2. 文件不存在：系统提示文件不存在或已被删除<br>3. 网络中断：系统提示下载失败，建议重新尝试<br>4. 存储空间不足：系统提示用户设备存储空间不足 |
| 数据需求 | 1. 文件ID<br>2. 用户身份信息<br>3. 下载操作记录<br>4. 电子签名信息（如需要） |
| 业务规则 | 1. 只有具有下载权限的用户可以下载文件<br>2. 敏感文件下载前需进行电子签名<br>3. 文件下载自动记录审计日志<br>4. 支持批量下载多个文件为压缩包 |

### 4.3 工作流审批

| 用例ID | FS-U003 |
|--------|--------|
| 用例名称 | 工作流审批 |
| 参与者 | 普通用户、部门管理员、质量部门专员、高级管理层 |
| 前置条件 | 1. 用户已登录系统<br>2. 用户参与审批流程<br>3. 待审批文件存在 |
| 后置条件 | 1. 审批状态更新<br>2. 文件状态根据审批结果更新<br>3. 相关人员收到通知<br>4. 审计日志记录审批操作 |
| 流程描述 | 1. 用户提交文件审批申请<br>2. 系统根据预设工作流路由到第一审批人<br>3. 审批人收到审批通知<br>4. 审批人查看待审批文件内容<br>5. 审批人选择"通过"或"拒绝"<br>6. 审批人添加审批意见和电子签名<br>7. 系统记录审批结果<br>8. 若审批通过，系统根据工作流路由到下一审批人或完成审批<br>9. 若审批拒绝，系统通知文件提交人<br>10. 审批完成后，系统更新文件状态并通知相关人员 |
| 异常流程 | 1. 审批人无权限：系统提示用户无审批权限，并将申请路由给有权限的审批人<br>2. 审批超时：系统自动提醒审批人或升级给上级审批人<br>3. 文件被修改：系统提示文件已被修改，需要重新发起审批<br>4. 工作流配置错误：系统提示工作流配置错误，请联系管理员 |
| 数据需求 | 1. 文件信息<br>2. 审批流程配置<br>3. 审批记录<br>4. 电子签名信息<br>5. 通知配置 |
| 业务规则 | 1. 审批操作必须进行电子签名<br>2. 审批过程需完整记录审计日志<br>3. 支持多级审批流程<br>4. 支持审批流程的撤回和重新提交<br>5. 重要文件（如SOP、质量标准）需质量部门和高级管理层审批 |

### 4.4 电子签名

| 用例ID | FS-U004 |
|--------|--------|
| 用例名称 | 电子签名 |
| 参与者 | 普通用户、部门管理员、质量部门专员、高级管理层 |
| 前置条件 | 1. 用户已登录系统<br>2. 用户有电子签名权限<br>3. 操作需要进行电子签名 |
| 后置条件 | 1. 电子签名成功记录<br>2. 业务操作完成<br>3. 审计日志记录签名操作 |
| 流程描述 | 1. 系统提示用户需要进行电子签名<br>2. 用户输入用户名和密码/生物识别信息<br>3. 用户选择签名原因（如：审批、确认、完成等）<br>4. 用户点击"确认签名"<br>5. 系统验证用户身份和权限<br>6. 系统记录电子签名信息<br>7. 系统完成相关业务操作<br>8. 系统记录签名审计日志 |
| 异常流程 | 1. 身份验证失败：系统提示用户名或密码错误，允许重试<br>2. 权限不足：系统提示用户无电子签名权限<br>3. 签名超时：系统提示签名超时，需要重新发起签名<br>4. 系统错误：系统提示签名失败，请联系管理员 |
| 数据需求 | 1. 用户身份信息<br>2. 签名凭证<br>3. 签名原因<br>4. 签名时间<br>5. 关联业务数据ID |
| 业务规则 | 1. 电子签名必须符合21 CFR Part 11等法规要求<br>2. 签名信息必须包含：签名人、签名时间、签名原因<br>3. 签名操作必须记录完整审计日志<br>4. 支持多种签名方式：密码、生物识别等<br>5. 敏感操作必须强制电子签名 |

### 4.5 审计跟踪

| 用例ID | FS-U005 |
|--------|--------|
| 用例名称 | 审计跟踪 |
| 参与者 | 系统管理员、安全审计员、质量部门专员 |
| 前置条件 | 1. 用户已登录系统<br>2. 用户拥有审计日志查询权限<br>3. 系统已记录审计日志 |
| 后置条件 | 1. 用户成功查询审计日志<br>2. 用户查看审计日志详情<br>3. 审计日志导出（如需要） |
| 流程描述 | 1. 用户进入审计日志查询页面<br>2. 用户设置查询条件（如：时间范围、操作类型、操作人、文件名称等）<br>3. 用户点击"查询"按钮<br>4. 系统显示符合条件的审计日志列表<br>5. 用户可以查看日志详情<br>6. 用户可以导出审计日志<br>7. 用户可以筛选和排序日志 |
| 异常流程 | 1. 查询条件错误：系统提示查询条件无效，请重新设置<br>2. 权限不足：系统提示用户无权限查看特定审计日志<br>3. 日志不存在：系统提示未找到符合条件的审计日志<br>4. 导出失败：系统提示导出失败，请重试 |
| 数据需求 | 1. 审计日志记录（操作类型、操作人、操作时间、操作内容、IP地址等）<br>2. 查询条件<br>3. 用户权限信息 |
| 业务规则 | 1. 审计日志必须完整、不可篡改<br>2. 审计日志保留期限符合法规要求<br>3. 只有授权人员可以查看审计日志<br>4. 审计日志查询操作本身也需要记录审计<br>5. 支持高级筛选和多条件组合查询 |

## 5. 用户故事

以下是从不同角色视角出发的用户故事，帮助理解系统功能的业务价值和用户期望：

### 5.1 普通用户故事

| ID | 用户故事 | 验收标准 |
|----|----------|----------|
| US-001 | 作为一名生产操作员，我希望能够上传和管理批生产记录，以便记录药品生产过程中的所有操作和数据。 | 1. 能够轻松上传多种格式的批记录文件<br>2. 能够为文件添加分类、标签和描述<br>3. 能够查看自己上传的文件列表和状态<br>4. 上传操作自动记录审计日志 |
| US-002 | 作为一名研发人员，我希望能够下载和预览研发相关文档，以便查阅资料进行研发工作。 | 1. 能够快速找到并下载所需文档<br>2. 能够在线预览常见格式文档内容<br>3. 下载操作符合权限控制<br>4. 能够查看文档的版本历史 |
| US-003 | 作为一名QA人员，我希望能够对文档进行电子签名，以便确认我已审查过文档内容并认可其有效性。 | 1. 签名过程简单直观<br>2. 签名信息清晰可见（包括签名人、时间、原因）<br>3. 签名后文档状态自动更新<br>4. 签名操作符合21 CFR Part 11要求 |

### 5.2 部门管理员故事

| ID | 用户故事 | 验收标准 |
|----|----------|----------|
| US-004 | 作为一名部门管理员，我希望能够管理部门内的文件和用户权限，以便确保部门文档的安全和有序管理。 | 1. 能够查看部门所有文件<br>2. 能够为部门用户分配文件访问权限<br>3. 能够监控部门文件的使用情况<br>4. 能够设置部门文件分类和标签规则 |
| US-005 | 作为一名部门经理，我希望能够审批部门内的文档，以便确保文档内容符合部门标准和要求。 | 1. 能够收到待审批文档的通知<br>2. 能够在线查看和比较文档版本<br>3. 能够添加审批意见并进行电子签名<br>4. 审批结果自动通知相关人员 |
| US-006 | 作为一名质量部门主管，我希望能够查看部门文件的统计报表，以便了解部门文档管理状况和工作效率。 | 1. 能够生成多种维度的文件统计报表<br>2. 能够查看文件审批进度和历史<br>3. 能够导出报表为Excel或PDF格式<br>4. 报表数据准确反映部门文件状态 |

### 5.3 系统管理员故事

| ID | 用户故事 | 验收标准 |
|----|----------|----------|
| US-007 | 作为一名系统管理员，我希望能够配置系统参数和维护系统，以便确保系统稳定运行和满足业务需求。 | 1. 能够配置文件存储路径和大小限制<br>2. 能够设置电子签名和审计日志策略<br>3. 能够监控系统性能和资源使用情况<br>4. 能够执行系统备份和恢复操作 |
| US-008 | 作为一名安全管理员，我希望能够管理用户权限和安全策略，以便确保系统的安全性和合规性。 | 1. 能够创建和管理用户角色<br>2. 能够为用户分配细粒度的权限<br>3. 能够设置密码策略和访问控制规则<br>4. 能够监控安全事件和异常访问 |
| US-009 | 作为一名IT运维人员，我希望能够执行系统日志审计，以便排查问题和确保系统合规。 | 1. 能够查询和分析各类系统日志<br>2. 能够设置日志告警规则<br>3. 能够生成日志分析报表<br>4. 日志数据完整且不可篡改 |

### 5.4 高级管理层故事

| ID | 用户故事 | 验收标准 |
|----|----------|----------|
| US-010 | 作为一名高管，我希望能够查看系统的整体运行状况和业务报表，以便了解企业文档管理水平和决策支持。 | 1. 能够查看系统整体使用情况的仪表盘<br>2. 能够查看各类业务报表和趋势分析<br>3. 能够快速访问重要文档和审批事项<br>4. 数据可视化直观清晰 |
| US-011 | 作为一名质量总监，我希望能够审批重要的质量文档，以便确保企业质量管理体系的有效运行。 | 1. 能够收到重要质量文档的审批通知<br>2. 能够查看文档的详细内容和历史版本<br>3. 能够进行电子签名并添加质量评审意见<br>4. 审批结果影响文档的最终发布状态 |

## 6. 特殊场景描述

### 6.1 新SOP文档发布流程

**场景背景**：企业需要更新或发布新的标准操作程序(SOP)文档，确保所有员工遵循统一的操作规范。

**参与角色**：
- 文档编写人（普通用户）
- 部门管理员（部门审核）
- 质量部门专员（质量审核）
- 高级管理层（最终审批）
- 员工（SOP执行人）

**流程描述**：
1. 文档编写人创建新SOP文档并上传到系统
2. 文档编写人填写文档元数据并提交审批申请
3. 系统根据预设工作流将申请路由给部门管理员
4. 部门管理员审核文档并进行电子签名
5. 部门管理员审核通过后，系统将申请路由给质量部门专员
6. 质量部门专员审核文档的合规性并进行电子签名
7. 质量部门审核通过后，系统将申请路由给高级管理层
8. 高级管理层最终审批并进行电子签名
9. 审批全部通过后，系统将文档状态更新为"已发布"
10. 系统自动通知所有相关员工新SOP已发布
11. 员工查看并确认已阅读新SOP
12. 系统记录完整的审批和发布过程的审计日志

**特殊要求**：
- SOP文档必须经过多级审批流程
- 所有审批操作必须进行符合法规要求的电子签名
- 审批过程中，文档内容不得修改
- 发布后的SOP必须通知所有相关员工
- 员工确认阅读SOP也需要记录审计日志

### 6.2 批记录归档与检索

**场景背景**：药品生产完成后，需要将批记录进行归档保存，并在需要时能够方便地检索和查看历史批记录。

**参与角色**：
- 生产操作员（批记录创建者）
- 质量部门专员（批记录审核者）
- 仓库管理员（物料信息提供者）
- QA审核员（最终审核）
- 审计员（批记录检索者）

**流程描述**：
1. 生产操作员完成生产后，将批记录上传至系统
2. 系统自动关联相关的物料信息、设备信息和检验数据
3. 质量部门专员审核批记录的完整性和准确性
4. QA审核员进行最终审核并批准放行
5. 系统自动将批准放行的批记录归档到指定存储位置
6. 系统自动设置批记录的保留期限
7. 当需要检索历史批记录时，审计员使用系统的搜索功能
8. 审计员可以使用多种条件（如批次号、产品名称、日期范围等）进行搜索
9. 系统返回符合条件的批记录列表
10. 审计员可以查看批记录的详细内容、审批历史和相关数据
11. 系统记录所有检索操作的审计日志

**特殊要求**：
- 批记录归档后不得修改，确需修改需走偏差处理流程
- 批记录必须保存符合GMP要求的期限（通常为产品有效期后1年或至少5年）
- 批记录检索必须支持高级搜索功能
- 所有检索操作必须记录审计日志
- 归档的批记录必须支持电子签名确认

### 6.3 合规审计支持

**场景背景**：企业面临外部监管机构（如FDA、NMPA）的GMP合规审计，需要提供完整的文件管理记录和审计跟踪。

**参与角色**：
- 外部审计员
- 内部审计协调员（系统管理员或质量部门专员）
- 各部门负责人

**流程描述**：
1. 内部审计协调员在系统中创建审计项目
2. 内部审计协调员根据审计范围确定需要提供的文档清单
3. 系统根据文档清单自动收集相关文档和审计记录
4. 内部审计协调员对收集的文档进行整理和审核
5. 外部审计员通过专用的审计账户访问系统
6. 外部审计员根据审计计划查看相关文档和审计记录
7. 外部审计员可以查看文件的完整生命周期（创建、修改、审批、归档等）
8. 外部审计员可以验证电子签名的有效性和完整性
9. 外部审计员可以生成所需的审计报告
10. 系统记录外部审计员的所有操作日志
11. 审计结束后，内部审计协调员关闭审计项目

**特殊要求**：
- 审计账户拥有临时的高权限，但所有操作都必须记录详细日志
- 系统必须能够证明审计日志的完整性和不可篡改性
- 电子签名必须能够追溯到具体的操作人和操作时间
- 系统必须能够生成满足法规要求的审计报告
- 审计过程中不得影响系统的正常运行

## 7. 文档版本信息

| 版本 | 日期 | 修改人 | 修改内容 | 审核人 |
|------|------|--------|----------|--------|
| V1.0 | 2023-12-15 | 系统分析师 | 初始版本 | 质量经理 |
| V1.1 | 2024-01-10 | 系统设计师 | 更新用例图和业务规则 | 技术总监 |
| V1.2 | 2024-02-05 | 需求分析师 | 补充用户故事和特殊场景 | 项目经理 |

## 8. 审批信息

| 审批人 | 职位 | 审批日期 | 审批意见 | 电子签名 |
|--------|------|----------|----------|----------|
| 张三 | 质量总监 | 2024-02-15 | 同意发布 | 数字签名 |
| 李四 | IT总监 | 2024-02-16 | 同意发布 | 数字签名 |
| 王五 | 生产总监 | 2024-02-18 | 同意发布 | 数字签名 |

本文档包含电子记录，已通过电子签名确认其有效性和完整性。