# 仓库管理子系统 - 数据流和接口定义文档

## 1. 文档目的

本文档旨在详细描述仓库管理子系统的数据流和接口定义，包括系统内部的数据流动关系、外部系统间的数据交互以及接口的具体规范。本文档将作为系统设计、开发和集成测试的重要依据。

## 2. 数据流概述

仓库管理子系统的数据流主要包括以下几个方面：

1. **内部数据流**：系统内部各模块之间的数据传递和处理
2. **外部输入流**：从外部系统或用户输入的数据
3. **外部输出流**：系统向外部系统或用户输出的数据
4. **存储数据流**：数据在系统存储层的存取过程

## 3. 顶层数据流图

仓库管理子系统作为GMP系统的一个重要组成部分，与其他子系统（如认证子系统、生产管理子系统、质量管理子系统等）存在数据交互关系。下图展示了仓库管理子系统的顶层数据流：

```mermaid
digraph G {
    rankdir=TB;
    
    subgraph 外部系统与用户
        用户["用户\n(仓库管理员等)"];
        认证系统["认证子系统"];
        生产系统["生产管理子系统"];
        质量系统["质量管理子系统"];
        采购系统["采购管理子系统"];
    }
    
    subgraph 仓库管理子系统
        物料管理["物料主数据管理"];
        库存管理["库存管理"];
        入库管理["入库管理"];
        发放管理["发放管理"];
        批次管理["批次追溯管理"];
        货位管理["货位管理"];
        报表管理["报表统计管理"];
    }
    
    subgraph 数据存储
        数据库["数据库"];
    end
    
    用户 -> 物料管理;
    用户 -> 库存管理;
    用户 -> 入库管理;
    用户 -> 发放管理;
    用户 -> 批次管理;
    用户 -> 货位管理;
    用户 -> 报表管理;
    
    认证系统 -> 物料管理;
    认证系统 -> 库存管理;
    认证系统 -> 入库管理;
    认证系统 -> 发放管理;
    认证系统 -> 批次管理;
    认证系统 -> 货位管理;
    认证系统 -> 报表管理;
    
    采购系统 -> 入库管理;
    入库管理 -> 质量系统;
    发放管理 -> 生产系统;
    生产系统 -> 入库管理;
    质量系统 -> 入库管理;
    
    物料管理 -> 数据库;
    库存管理 -> 数据库;
    入库管理 -> 数据库;
    发放管理 -> 数据库;
    批次管理 -> 数据库;
    货位管理 -> 数据库;
    报表管理 -> 数据库;
    
    数据库 -> 物料管理;
    数据库 -> 库存管理;
    数据库 -> 入库管理;
    数据库 -> 发放管理;
    数据库 -> 批次管理;
    数据库 -> 货位管理;
    数据库 -> 报表管理;
}
```

## 4. 详细数据流分析

### 4.1 物料主数据管理数据流

**数据输入**：
- 用户录入的物料基本信息
- 从外部系统导入的物料数据

**数据处理**：
- 物料信息验证与标准化
- 物料分类管理
- 物料信息更新与维护

**数据输出**：
- 物料主数据记录
- 物料分类树结构
- 物料信息变更日志

**数据流向**：
- 物料主数据管理模块负责维护物料的基础信息
- 物料信息被库存管理、入库管理、发放管理等模块引用
- 物料分类信息被报表统计管理模块用于数据分析

### 4.2 库存管理数据流

**数据输入**：
- 入库操作产生的库存增加数据
- 发放操作产生的库存减少数据
- 库存调整操作产生的库存变动数据

**数据处理**：
- 实时库存数量计算
- 库存状态监控
- 库存预警分析

**数据输出**：
- 当前库存状态报表
- 库存预警通知
- 库存变动记录

**数据流向**：
- 入库管理模块向库存管理模块传递入库数据
- 发放管理模块向库存管理模块传递发放数据
- 库存管理模块向报表统计管理模块提供库存数据
- 库存管理模块向用户界面提供实时库存查询结果

### 4.3 入库管理数据流

**数据输入**：
- 采购订单信息（来自采购管理子系统）
- 生产工单信息（来自生产管理子系统）
- 质检结果信息（来自质量管理子系统）
- 用户录入的入库单信息

**数据处理**：
- 入库单创建与验证
- 入库单审核
- 入库执行与库存更新

**数据输出**：
- 入库单记录
- 入库操作日志
- 库存更新信息
- 批次信息记录

**数据流向**：
- 采购管理子系统向入库管理模块传递采购订单数据
- 入库管理模块向质量管理子系统请求质检结果
- 入库管理模块向库存管理模块传递入库数据
- 入库管理模块向批次追溯管理模块传递批次信息

### 4.4 发放管理数据流

**数据输入**：
- 生产工单信息（来自生产管理子系统）
- 用户录入的发放申请信息
- 当前库存数据（来自库存管理模块）

**数据处理**：
- 发放申请创建与验证
- 发放申请审核
- 发放执行与库存扣减
- 批次分配

**数据输出**：
- 发放申请记录
- 发放执行记录
- 库存更新信息
- 批次使用记录

**数据流向**：
- 生产管理子系统向发放管理模块传递工单需求
- 库存管理模块向发放管理模块提供库存数据
- 发放管理模块向批次追溯管理模块传递批次使用信息
- 发放管理模块向库存管理模块传递发放数据

### 4.5 批次追溯管理数据流

**数据输入**：
- 入库操作产生的批次信息
- 发放操作产生的批次使用信息
- 用户发起的追溯请求

**数据处理**：
- 批次信息记录与维护
- 正向追溯分析
- 反向追溯分析
- 追溯路径构建

**数据输出**：
- 批次信息记录
- 追溯结果报告
- 追溯路径可视化

**数据流向**：
- 入库管理模块向批次追溯管理模块传递批次创建信息
- 发放管理模块向批次追溯管理模块传递批次使用信息
- 批次追溯管理模块向用户界面提供追溯结果
- 批次追溯管理模块向报表统计管理模块提供追溯数据

### 4.6 货位管理数据流

**数据输入**：
- 用户录入的货位信息
- 入库操作产生的货位分配数据
- 发放操作产生的货位释放数据

**数据处理**：
- 货位信息维护
- 货位状态监控
- 货位分配与优化

**数据输出**：
- 货位信息记录
- 货位状态报表
- 货位分配建议

**数据流向**：
- 入库管理模块向货位管理模块请求货位分配
- 发放管理模块向货位管理模块提供货位释放信息
- 货位管理模块向用户界面提供货位查询结果

### 4.7 报表统计管理数据流

**数据输入**：
- 库存管理模块提供的库存数据
- 入库管理模块提供的入库数据
- 发放管理模块提供的发放数据
- 用户的报表查询条件

**数据处理**：
- 数据聚合与计算
- 报表生成
- 图表绘制
- 数据分析

**数据输出**：
- 各类统计报表
- 数据可视化图表
- 分析结论与建议

**数据流向**：
- 各业务模块向报表统计管理模块提供原始数据
- 报表统计管理模块向用户界面提供报表与图表

## 5. 接口定义

### 5.1 系统内部接口

#### 5.1.1 物料主数据管理接口

| 接口名称 | 接口描述 | 输入参数 | 输出参数 | 接口类型 |
|---------|---------|---------|---------|--------|
| `createMaterial` | 创建物料信息 | MaterialDTO 对象 | `{"success": boolean, "materialId": string, "message": string}` | 服务接口 |
| `updateMaterial` | 更新物料信息 | materialId: string, MaterialDTO 对象 | `{"success": boolean, "message": string}` | 服务接口 |
| `deleteMaterial` | 删除物料信息 | materialId: string | `{"success": boolean, "message": string}` | 服务接口 |
| `getMaterialById` | 根据ID获取物料信息 | materialId: string | Material 对象 | 服务接口 |
| `queryMaterials` | 查询物料列表 | QueryParams 对象 | `{"total": number, "data": Material[]}` | 服务接口 |
| `importMaterials` | 导入物料数据 | File 对象 | `{"success": boolean, "successCount": number, "failCount": number, "errors": []}` | 服务接口 |
| `exportMaterials` | 导出物料数据 | QueryParams 对象 | 文件流 | 服务接口 |

#### 5.1.2 库存管理接口

| 接口名称 | 接口描述 | 输入参数 | 输出参数 | 接口类型 |
|---------|---------|---------|---------|--------|
| `getInventoryByMaterial` | 查询物料库存信息 | materialId: string | Inventory 对象 | 服务接口 |
| `queryInventory` | 多条件查询库存 | QueryParams 对象 | `{"total": number, "data": Inventory[]}` | 服务接口 |
| `checkInventory` | 检查库存是否充足 | materialId: string, quantity: number | `{"sufficient": boolean, "availableQuantity": number}` | 服务接口 |
| `adjustInventory` | 调整库存数量 | AdjustInventoryDTO 对象 | `{"success": boolean, "message": string}` | 服务接口 |
| `getInventoryWarnings` | 获取库存预警信息 | WarningParams 对象 | `{"total": number, "data": InventoryWarning[]}` | 服务接口 |

#### 5.1.3 入库管理接口

| 接口名称 | 接口描述 | 输入参数 | 输出参数 | 接口类型 |
|---------|---------|---------|---------|--------|
| `createReceipt` | 创建入库单 | ReceiptDTO 对象 | `{"success": boolean, "receiptId": string, "message": string}` | 服务接口 |
| `updateReceipt` | 更新入库单 | receiptId: string, ReceiptDTO 对象 | `{"success": boolean, "message": string}` | 服务接口 |
| `auditReceipt` | 审核入库单 | receiptId: string, AuditDTO 对象 | `{"success": boolean, "message": string}` | 服务接口 |
| `executeReceipt` | 执行入库操作 | receiptId: string, ExecuteDTO 对象 | `{"success": boolean, "message": string}` | 服务接口 |
| `getReceiptById` | 获取入库单详情 | receiptId: string | Receipt 对象 | 服务接口 |
| `queryReceipts` | 查询入库单列表 | QueryParams 对象 | `{"total": number, "data": Receipt[]}` | 服务接口 |

#### 5.1.4 发放管理接口

| 接口名称 | 接口描述 | 输入参数 | 输出参数 | 接口类型 |
|---------|---------|---------|---------|--------|
| `createIssueRequest` | 创建发放申请 | IssueRequestDTO 对象 | `{"success": boolean, "requestId": string, "message": string}` | 服务接口 |
| `updateIssueRequest` | 更新发放申请 | requestId: string, IssueRequestDTO 对象 | `{"success": boolean, "message": string}` | 服务接口 |
| `auditIssueRequest` | 审核发放申请 | requestId: string, AuditDTO 对象 | `{"success": boolean, "message": string}` | 服务接口 |
| `executeIssue` | 执行发放操作 | requestId: string, ExecuteDTO 对象 | `{"success": boolean, "message": string}` | 服务接口 |
| `getIssueRequestById` | 获取发放申请详情 | requestId: string | IssueRequest 对象 | 服务接口 |
| `queryIssueRequests` | 查询发放申请列表 | QueryParams 对象 | `{"total": number, "data": IssueRequest[]}` | 服务接口 |

#### 5.1.5 批次追溯管理接口

| 接口名称 | 接口描述 | 输入参数 | 输出参数 | 接口类型 |
|---------|---------|---------|---------|--------|
| `createBatch` | 创建批次信息 | BatchDTO 对象 | `{"success": boolean, "batchId": string, "message": string}` | 服务接口 |
| `getBatchById` | 获取批次详情 | batchId: string | Batch 对象 | 服务接口 |
| `queryBatches` | 查询批次列表 | QueryParams 对象 | `{"total": number, "data": Batch[]}` | 服务接口 |
| `traceForward` | 正向追溯 | materialId: string, batchId: string, timeRange: TimeRange | TraceResult 对象 | 服务接口 |
| `traceBackward` | 反向追溯 | productId: string, batchId: string | TraceResult 对象 | 服务接口 |
| `generateTraceReport` | 生成追溯报告 | TraceRequest 对象 | 文件流 | 服务接口 |

#### 5.1.6 货位管理接口

| 接口名称 | 接口描述 | 输入参数 | 输出参数 | 接口类型 |
|---------|---------|---------|---------|--------|
| `createLocation` | 创建货位 | LocationDTO 对象 | `{"success": boolean, "locationId": string, "message": string}` | 服务接口 |
| `updateLocation` | 更新货位信息 | locationId: string, LocationDTO 对象 | `{"success": boolean, "message": string}` | 服务接口 |
| `deleteLocation` | 删除货位 | locationId: string | `{"success": boolean, "message": string}` | 服务接口 |
| `getLocationById` | 获取货位详情 | locationId: string | Location 对象 | 服务接口 |
| `queryLocations` | 查询货位列表 | QueryParams 对象 | `{"total": number, "data": Location[]}` | 服务接口 |
| `recommendLocations` | 推荐货位 | RecommendParams 对象 | `{"locations": Location[]}` | 服务接口 |

#### 5.1.7 报表统计管理接口

| 接口名称 | 接口描述 | 输入参数 | 输出参数 | 接口类型 |
|---------|---------|---------|---------|--------|
| `generateInventoryReport` | 生成库存报表 | ReportParams 对象 | 文件流 | 服务接口 |
| `generateBusinessReport` | 生成业务报表 | ReportParams 对象 | 文件流 | 服务接口 |
| `createCustomReport` | 创建自定义报表 | CustomReportDTO 对象 | `{"success": boolean, "reportId": string, "message": string}` | 服务接口 |
| `updateCustomReport` | 更新自定义报表 | reportId: string, CustomReportDTO 对象 | `{"success": boolean, "message": string}` | 服务接口 |
| `executeCustomReport` | 执行自定义报表 | reportId: string, Params 对象 | 文件流 | 服务接口 |

### 5.2 外部系统接口

#### 5.2.1 认证子系统接口

| 接口名称 | 接口描述 | 输入参数 | 输出参数 | 接口类型 | 安全方式 |
|---------|---------|---------|---------|--------|--------|
| `authenticate` | 用户认证 | username: string, password: string | `{"token": string, "userInfo": UserInfo}` | REST API | HTTPS + JWT |
| `validateToken` | 令牌验证 | token: string | `{"valid": boolean, "userInfo": UserInfo}` | REST API | HTTPS |
| `getUserPermissions` | 获取用户权限 | userId: string, systemCode: string | `{"permissions": Permission[]}` | REST API | HTTPS + JWT |
| `logout` | 用户登出 | token: string | `{"success": boolean}` | REST API | HTTPS |

#### 5.2.2 生产管理子系统接口

| 接口名称 | 接口描述 | 输入参数 | 输出参数 | 接口类型 | 安全方式 |
|---------|---------|---------|---------|--------|--------|
| `getWorkOrderMaterials` | 获取工单物料需求 | workOrderId: string | `{"materials": MaterialDemand[]}` | REST API | HTTPS + API Key |
| `confirmMaterialIssue` | 确认物料发放 | issueRequestId: string, workOrderId: string | `{"success": boolean}` | REST API | HTTPS + API Key |
| `notifyProductionComplete` | 通知生产完成 | workOrderId: string, productionResults: ProductionResult[] | `{"success": boolean}` | REST API | HTTPS + API Key |

#### 5.2.3 质量管理子系统接口

| 接口名称 | 接口描述 | 输入参数 | 输出参数 | 接口类型 | 安全方式 |
|---------|---------|---------|---------|--------|--------|
| `requestQualityInspection` | 请求质量检验 | receiptId: string, materials: MaterialInspection[] | `{"inspectionId": string}` | REST API | HTTPS + API Key |
| `getInspectionResult` | 获取检验结果 | inspectionId: string | InspectionResult 对象 | REST API | HTTPS + API Key |
| `notifyMaterialReleased` | 通知物料放行 | materialId: string, batchId: string, status: string | `{"success": boolean}` | REST API | HTTPS + API Key |

#### 5.2.4 采购管理子系统接口

| 接口名称 | 接口描述 | 输入参数 | 输出参数 | 接口类型 | 安全方式 |
|---------|---------|---------|---------|--------|--------|
| `getPurchaseOrder` | 获取采购订单信息 | orderId: string | PurchaseOrder 对象 | REST API | HTTPS + API Key |
| `notifyGoodsReceived` | 通知收货完成 | orderId: string, receiptDetails: ReceiptDetail[] | `{"success": boolean}` | REST API | HTTPS + API Key |
| `getSupplierInfo` | 获取供应商信息 | supplierId: string | Supplier 对象 | REST API | HTTPS + API Key |

## 6. 数据模型定义

### 6.1 核心数据实体

#### 6.1.1 物料主数据（Material）

```json
{
  "materialId": "string",       // 物料编号（主键）
  "materialName": "string",     // 物料名称
  "specification": "string",    // 规格
  "model": "string",            // 型号
  "categoryId": "string",       // 分类ID
  "unit": "string",             // 计量单位
  "safetyStock": "number",      // 安全库存
  "minOrderQuantity": "number", // 最小订单量
  "description": "string",      // 描述
  "status": "string",           // 状态（启用/禁用）
  "createdAt": "datetime",      // 创建时间
  "updatedAt": "datetime",      // 更新时间
  "createdBy": "string"         // 创建人
}
```

#### 6.1.2 库存信息（Inventory）

```json
{
  "inventoryId": "string",       // 库存ID（主键）
  "materialId": "string",        // 物料ID
  "batchId": "string",          // 批次ID
  "locationId": "string",       // 货位ID
  "currentQuantity": "number",  // 当前数量
  "availableQuantity": "number", // 可用数量
  "reservedQuantity": "number", // 预留数量
  "unitCost": "number",         // 单位成本
  "expiryDate": "date",         // 有效期
  "status": "string",           // 状态（合格/待检/不合格）
  "lastUpdated": "datetime"     // 最后更新时间
}
```

#### 6.1.3 入库单（Receipt）

```json
{
  "receiptId": "string",        // 入库单ID（主键）
  "receiptNumber": "string",    // 入库单号
  "receiptType": "string",      // 入库类型（采购/生产/退货）
  "sourceId": "string",         // 来源单据ID（采购订单/工单）
  "supplierId": "string",       // 供应商ID（采购入库时）
  "totalAmount": "number",      // 总金额
  "status": "string",           // 状态（草稿/已提交/已审核/已完成/已取消）
  "createDate": "datetime",     // 创建日期
  "auditDate": "datetime",      // 审核日期
  "completeDate": "datetime",   // 完成日期
  "createdBy": "string",        // 创建人
  "auditedBy": "string",        // 审核人
  "details": [                   // 入库明细
    {
      "materialId": "string",    // 物料ID
      "quantity": "number",      // 数量
      "unitCost": "number",      // 单位成本
      "batchId": "string",      // 批次ID
      "locationId": "string",   // 存放货位
      "status": "string"         // 明细状态
    }
  ]
}
```

#### 6.1.4 发放申请（IssueRequest）

```json
{
  "requestId": "string",        // 申请ID（主键）
  "requestNumber": "string",    // 申请单号
  "requestType": "string",      // 申请类型（生产/研发/维修）
  "departmentId": "string",     // 申请部门
  "applicantId": "string",      // 申请人
  "purpose": "string",          // 用途
  "workOrderId": "string",      // 关联工单
  "status": "string",           // 状态（草稿/已提交/已审核/已完成/已取消）
  "createDate": "datetime",     // 创建日期
  "auditDate": "datetime",      // 审核日期
  "completeDate": "datetime",   // 完成日期
  "createdBy": "string",        // 创建人
  "auditedBy": "string",        // 审核人
  "details": [                   // 申请明细
    {
      "materialId": "string",    // 物料ID
      "requestQuantity": "number", // 申请数量
      "issuedQuantity": "number",  // 实际发放数量
      "batchId": "string",      // 发放批次ID
      "locationId": "string",   // 发放货位
      "status": "string"         // 明细状态
    }
  ]
}
```

#### 6.1.5 批次信息（Batch）

```json
{
  "batchId": "string",           // 批次ID（主键）
  "batchNumber": "string",       // 批次号
  "materialId": "string",        // 物料ID
  "manufacturerId": "string",    // 生产厂商
  "productionDate": "date",      // 生产日期
  "expiryDate": "date",          // 有效期
  "supplierId": "string",        // 供应商ID
  "totalQuantity": "number",     // 总数量
  "currentQuantity": "number",   // 当前数量
  "qualityStatus": "string",     // 质量状态（合格/待检/不合格）
  "traceCode": "string",         // 追溯码
  "createdAt": "datetime",       // 创建时间
  "relatedDocuments": [           // 关联单据
    {
      "docType": "string",       // 单据类型
      "docId": "string"          // 单据ID
    }
  ]
}
```

#### 6.1.6 货位信息（Location）

```json
{
  "locationId": "string",        // 货位ID（主键）
  "locationCode": "string",      // 货位编码
  "warehouseId": "string",       // 仓库ID
  "areaId": "string",            // 区域ID
  "shelfCode": "string",         // 货架编号
  "level": "string",             // 层号
  "position": "string",          // 位号
  "status": "string",            // 状态（可用/占用/禁用）
  "capacity": "number",          // 容量
  "materialType": "string",      // 适合存放物料类型
  "description": "string",       // 描述
  "createdAt": "datetime",       // 创建时间
  "updatedAt": "datetime"        // 更新时间
}
```

### 6.2 数据传输对象（DTO）

#### 6.2.1 通用查询参数（QueryParams）

```json
{
  "pageNum": "number",           // 页码
  "pageSize": "number",          // 每页大小
  "sortField": "string",         // 排序字段
  "sortOrder": "string",         // 排序方向（asc/desc）
  "filters": [                    // 过滤条件
    {
      "field": "string",         // 字段名
      "operator": "string",      // 操作符（eq, neq, gt, lt, etc.）
      "value": "any"             // 过滤值
    }
  ],
  "keywords": "string"            // 关键字搜索
}
```

#### 6.2.2 审核DTO（AuditDTO）

```json
{
  "auditResult": "string",        // 审核结果（approve/reject）
  "auditComments": "string",      // 审核意见
  "auditorId": "string"          // 审核人ID
}
```

#### 6.2.3 执行DTO（ExecuteDTO）

```json
{
  "executorId": "string",        // 执行人ID
  "executeDate": "datetime",     // 执行日期
  "details": [                    // 执行明细
    {
      "itemId": "string",        // 项目ID（明细行ID）
      "actualQuantity": "number", // 实际数量
      "batchId": "string",      // 批次ID
      "locationId": "string",   // 货位ID
      "remark": "string"         // 备注
    }
  ],
  "remark": "string"              // 备注
}
```

## 7. 数据交换格式和协议

### 7.1 内部数据交换

- **数据格式**：JSON
- **编码方式**：UTF-8
- **传输协议**：内部服务调用
- **序列化方式**：Jackson/Gson

### 7.2 外部系统接口

- **接口类型**：REST API
- **数据格式**：JSON
- **编码方式**：UTF-8
- **传输协议**：HTTPS
- **安全机制**：JWT Token / API Key
- **请求方法**：GET, POST, PUT, DELETE
- **状态码**：HTTP标准状态码

## 8. 文档版本管理

| 版本号 | 修改日期 | 修改人 | 修改内容 | 审批人 |
|--------|----------|--------|----------|--------|
| V1.0   | 2023-XX-XX | XXX | 初始版本 | XXX |

---

*本文档由仓库管理子系统项目组编制，最终解释权归项目组所有。*