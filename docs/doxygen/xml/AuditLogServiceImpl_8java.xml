<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<doxygen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="compound.xsd" version="1.9.8" xml:lang="en-US">
  <compounddef id="AuditLogServiceImpl_8java" kind="file" language="Java">
    <compoundname>AuditLogServiceImpl.java</compoundname>
    <includes local="no">com.fasterxml.jackson.databind.ObjectMapper</includes>
    <incdepgraph>
      <node id="1">
        <label>auth-service/src/main/java/com/gmp/auth/service/impl/AuditLogServiceImpl.java</label>
        <link refid="AuditLogServiceImpl_8java"/>
        <childnode refid="2" relation="include">
        </childnode>
      </node>
      <node id="2">
        <label>com.fasterxml.jackson.databind.ObjectMapper</label>
      </node>
    </incdepgraph>
    <innerclass refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl" prot="public">com::gmp::auth::service::impl::AuditLogServiceImpl</innerclass>
    <innernamespace refid="namespacecom_1_1gmp_1_1auth_1_1service_1_1impl">com::gmp::auth::service::impl</innernamespace>
    <briefdescription>
    </briefdescription>
    <detaileddescription>
    </detaileddescription>
    <programlisting>
<codeline lineno="1" refid="namespacecom_1_1gmp_1_1auth_1_1service_1_1impl" refkind="compound"><highlight class="keyword">package<sp/></highlight><highlight class="normal">com.gmp.auth.service.impl;</highlight></codeline>
<codeline lineno="2"><highlight class="normal"></highlight></codeline>
<codeline lineno="3"><highlight class="normal"></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>com.fasterxml.jackson.databind.ObjectMapper;</highlight></codeline>
<codeline lineno="4"><highlight class="normal"></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>com.gmp.auth.entity.OperationLog;</highlight></codeline>
<codeline lineno="5"><highlight class="normal"></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>com.gmp.auth.repository.OperationLogRepository;</highlight></codeline>
<codeline lineno="6"><highlight class="normal"></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>com.gmp.auth.service.AuditLogService;</highlight></codeline>
<codeline lineno="7"><highlight class="normal"></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>org.slf4j.Logger;</highlight></codeline>
<codeline lineno="8"><highlight class="normal"></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>org.slf4j.LoggerFactory;</highlight></codeline>
<codeline lineno="9"><highlight class="normal"></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>org.springframework.beans.factory.annotation.Autowired;</highlight></codeline>
<codeline lineno="10"><highlight class="normal"></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>org.springframework.data.domain.Page;</highlight></codeline>
<codeline lineno="11"><highlight class="normal"></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>org.springframework.data.domain.Pageable;</highlight></codeline>
<codeline lineno="12"><highlight class="normal"></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>org.springframework.stereotype.Service;</highlight></codeline>
<codeline lineno="13"><highlight class="normal"></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>org.springframework.transaction.annotation.Transactional;</highlight></codeline>
<codeline lineno="14"><highlight class="normal"></highlight></codeline>
<codeline lineno="15"><highlight class="normal"></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>java.io.ByteArrayOutputStream;</highlight></codeline>
<codeline lineno="16"><highlight class="normal"></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>java.io.IOException;</highlight></codeline>
<codeline lineno="17"><highlight class="normal"></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>java.time.LocalDateTime;</highlight></codeline>
<codeline lineno="18"><highlight class="normal"></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>java.util.HashMap;</highlight></codeline>
<codeline lineno="19"><highlight class="normal"></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>java.util.List;</highlight></codeline>
<codeline lineno="20"><highlight class="normal"></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>java.util.Map;</highlight></codeline>
<codeline lineno="21"><highlight class="normal"></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>java.util.stream.Collectors;</highlight></codeline>
<codeline lineno="22"><highlight class="normal"></highlight></codeline>
<codeline lineno="29"><highlight class="normal">@Service</highlight></codeline>
<codeline lineno="30" refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">public</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">class<sp/></highlight><highlight class="normal"><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl" kindref="compound">AuditLogServiceImpl</ref><sp/></highlight><highlight class="keyword">implements</highlight><highlight class="normal"><sp/><ref refid="interfacecom_1_1gmp_1_1auth_1_1service_1_1AuditLogService" kindref="compound">AuditLogService</ref><sp/>{</highlight></codeline>
<codeline lineno="31"><highlight class="normal"></highlight></codeline>
<codeline lineno="32" refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a17e592b09f9e8b8a707a7100f024c26c" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">private</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">final</highlight><highlight class="normal"><sp/>Logger<sp/><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a17e592b09f9e8b8a707a7100f024c26c" kindref="member">logger</ref><sp/>=<sp/>LoggerFactory.getLogger(<ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl" kindref="compound">AuditLogServiceImpl</ref>.class);</highlight></codeline>
<codeline lineno="33"><highlight class="normal"></highlight></codeline>
<codeline lineno="34"><highlight class="normal"><sp/><sp/><sp/><sp/>@Autowired</highlight></codeline>
<codeline lineno="35" refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a54c9a855f90a0156cf02b42cd8b0613d" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">private</highlight><highlight class="normal"><sp/>OperationLogRepository<sp/><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a54c9a855f90a0156cf02b42cd8b0613d" kindref="member">operationLogRepository</ref>;</highlight></codeline>
<codeline lineno="36"><highlight class="normal"></highlight></codeline>
<codeline lineno="37"><highlight class="normal"><sp/><sp/><sp/><sp/>@Autowired</highlight></codeline>
<codeline lineno="38" refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a0617bbd4e9397ffcfe64617de6664984" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">private</highlight><highlight class="normal"><sp/>ObjectMapper<sp/><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a0617bbd4e9397ffcfe64617de6664984" kindref="member">objectMapper</ref>;</highlight></codeline>
<codeline lineno="39"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="40"><highlight class="normal"><sp/><sp/><sp/><sp/>@Override</highlight></codeline>
<codeline lineno="41" refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a0398e14f9882963c8a4e7154619bf2a9" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">public</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a0398e14f9882963c8a4e7154619bf2a9" kindref="member">logLogout</ref>(String<sp/>username)<sp/>{</highlight></codeline>
<codeline lineno="42"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>实现登出日志记录逻辑</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="43"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a17e592b09f9e8b8a707a7100f024c26c" kindref="member">logger</ref>.info(</highlight><highlight class="stringliteral">&quot;User<sp/>{}<sp/>logged<sp/>out&quot;</highlight><highlight class="normal">,<sp/>username);</highlight></codeline>
<codeline lineno="44"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="45"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="46"><highlight class="normal"><sp/><sp/><sp/><sp/>@Override</highlight></codeline>
<codeline lineno="47" refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1ac68c111390771f1e9738d32e52f8079b" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">public</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1ac68c111390771f1e9738d32e52f8079b" kindref="member">logLoginSuccess</ref>(String<sp/>username,<sp/>String<sp/>ipAddress,<sp/>String<sp/>userAgent)<sp/>{</highlight></codeline>
<codeline lineno="48"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>实现登录成功日志记录逻辑</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="49"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a17e592b09f9e8b8a707a7100f024c26c" kindref="member">logger</ref>.info(</highlight><highlight class="stringliteral">&quot;User<sp/>{}<sp/>successfully<sp/>logged<sp/>in<sp/>from<sp/>IP<sp/>{}<sp/>using<sp/>agent<sp/>{}&quot;</highlight><highlight class="normal">,<sp/>username,<sp/>ipAddress,<sp/>userAgent);</highlight></codeline>
<codeline lineno="50"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="51"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="52"><highlight class="normal"><sp/><sp/><sp/><sp/>@Override</highlight></codeline>
<codeline lineno="53" refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1addfd6d2f15f6dcec4ee7c550816e2723" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">public</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1addfd6d2f15f6dcec4ee7c550816e2723" kindref="member">logLoginFailure</ref>(String<sp/>username,<sp/>String<sp/>ipAddress,<sp/>String<sp/>userAgent,<sp/>String<sp/>reason)<sp/>{</highlight></codeline>
<codeline lineno="54"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>实现登录失败日志记录逻辑</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="55"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a17e592b09f9e8b8a707a7100f024c26c" kindref="member">logger</ref>.warn(</highlight><highlight class="stringliteral">&quot;User<sp/>{}<sp/>failed<sp/>to<sp/>login<sp/>from<sp/>IP<sp/>{}<sp/>using<sp/>agent<sp/>{}:<sp/>{}&quot;</highlight><highlight class="normal">,<sp/>username,<sp/>ipAddress,<sp/>userAgent,<sp/>reason);</highlight></codeline>
<codeline lineno="56"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="57"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="58"><highlight class="normal"><sp/><sp/><sp/><sp/>@Override</highlight></codeline>
<codeline lineno="59" refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1acf5c8cbd5f508ca174feaaf41a541b59" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">public</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1acf5c8cbd5f508ca174feaaf41a541b59" kindref="member">logPasswordChange</ref>(String<sp/>username)<sp/>{</highlight></codeline>
<codeline lineno="60"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>实现密码修改日志记录逻辑</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="61"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a17e592b09f9e8b8a707a7100f024c26c" kindref="member">logger</ref>.info(</highlight><highlight class="stringliteral">&quot;User<sp/>{}<sp/>changed<sp/>password&quot;</highlight><highlight class="normal">,<sp/>username);</highlight></codeline>
<codeline lineno="62"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="63"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="64"><highlight class="normal"><sp/><sp/><sp/><sp/>@Override</highlight></codeline>
<codeline lineno="65" refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a6838e04ef756446e21c0e651fd91c8a0" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">public</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a6838e04ef756446e21c0e651fd91c8a0" kindref="member">logPasswordReset</ref>(String<sp/>username)<sp/>{</highlight></codeline>
<codeline lineno="66"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>实现密码重置日志记录逻辑</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="67"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a17e592b09f9e8b8a707a7100f024c26c" kindref="member">logger</ref>.info(</highlight><highlight class="stringliteral">&quot;User<sp/>{}<sp/>reset<sp/>password&quot;</highlight><highlight class="normal">,<sp/>username);</highlight></codeline>
<codeline lineno="68"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="69"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="70"><highlight class="normal"><sp/><sp/><sp/><sp/>@Override</highlight></codeline>
<codeline lineno="71" refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a3b1a94ad4273f14a5515105362f0cf02" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">public</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a3b1a94ad4273f14a5515105362f0cf02" kindref="member">logPasswordReset</ref>(Long<sp/>userId,<sp/>String<sp/>username,<sp/>String<sp/>ipAddress)<sp/>{</highlight></codeline>
<codeline lineno="72"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>简化实现，避免使用可能不存在的常量</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="73"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>OperationLog<sp/>log<sp/>=<sp/>OperationLog.builder()</highlight></codeline>
<codeline lineno="74"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.userId(userId)</highlight></codeline>
<codeline lineno="75"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.username(username)</highlight></codeline>
<codeline lineno="76"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.ipAddress(ipAddress)</highlight></codeline>
<codeline lineno="77"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.build();</highlight></codeline>
<codeline lineno="78"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a9fc4fc5dd941306edc94397967728e30" kindref="member">logOperation</ref>(log);</highlight></codeline>
<codeline lineno="79"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="80"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="81"><highlight class="normal"><sp/><sp/><sp/><sp/>@Override</highlight></codeline>
<codeline lineno="82" refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a67bce7f0c99abd61386a963913bf2485" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">public</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a67bce7f0c99abd61386a963913bf2485" kindref="member">logPasswordChange</ref>(Long<sp/>userId,<sp/>String<sp/>username,<sp/>String<sp/>ipAddress)<sp/>{</highlight></codeline>
<codeline lineno="83"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>简化实现</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="84"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>OperationLog<sp/>log<sp/>=<sp/>OperationLog.builder()</highlight></codeline>
<codeline lineno="85"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.userId(userId)</highlight></codeline>
<codeline lineno="86"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.username(username)</highlight></codeline>
<codeline lineno="87"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.ipAddress(ipAddress)</highlight></codeline>
<codeline lineno="88"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.build();</highlight></codeline>
<codeline lineno="89"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a9fc4fc5dd941306edc94397967728e30" kindref="member">logOperation</ref>(log);</highlight></codeline>
<codeline lineno="90"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="91"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="92"><highlight class="normal"><sp/><sp/><sp/><sp/>@Override</highlight></codeline>
<codeline lineno="93" refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a1c196a6aaea6fee65c8807db112a5f3a" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">public</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a1c196a6aaea6fee65c8807db112a5f3a" kindref="member">logLoginSuccess</ref>(Long<sp/>userId,<sp/>String<sp/>username,<sp/>String<sp/>ipAddress,<sp/>String<sp/>userAgent)<sp/>{</highlight></codeline>
<codeline lineno="94"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>简化实现</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="95"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>OperationLog<sp/>log<sp/>=<sp/>OperationLog.builder()</highlight></codeline>
<codeline lineno="96"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.userId(userId)</highlight></codeline>
<codeline lineno="97"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.username(username)</highlight></codeline>
<codeline lineno="98"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.ipAddress(ipAddress)</highlight></codeline>
<codeline lineno="99"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.build();</highlight></codeline>
<codeline lineno="100"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a9fc4fc5dd941306edc94397967728e30" kindref="member">logOperation</ref>(log);</highlight></codeline>
<codeline lineno="101"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="102"><highlight class="normal"></highlight></codeline>
<codeline lineno="103"><highlight class="normal"><sp/><sp/><sp/><sp/>@Override</highlight></codeline>
<codeline lineno="104"><highlight class="normal"><sp/><sp/><sp/><sp/>@Transactional</highlight></codeline>
<codeline lineno="105" refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a9fc4fc5dd941306edc94397967728e30" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">public</highlight><highlight class="normal"><sp/>OperationLog<sp/><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a9fc4fc5dd941306edc94397967728e30" kindref="member">logOperation</ref>(OperationLog<sp/>log)<sp/>{</highlight></codeline>
<codeline lineno="106"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="107"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a54c9a855f90a0156cf02b42cd8b0613d" kindref="member">operationLogRepository</ref>.save(log);</highlight></codeline>
<codeline lineno="108"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">catch</highlight><highlight class="normal"><sp/>(Exception<sp/>e)<sp/>{</highlight></codeline>
<codeline lineno="109"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a17e592b09f9e8b8a707a7100f024c26c" kindref="member">logger</ref>.error(</highlight><highlight class="stringliteral">&quot;Failed<sp/>to<sp/>log<sp/>operation:<sp/>{}&quot;</highlight><highlight class="normal">,<sp/>e.getMessage(),<sp/>e);</highlight></codeline>
<codeline lineno="110"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">throw</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">new</highlight><highlight class="normal"><sp/><ref refid="classRuntimeException" kindref="compound">RuntimeException</ref>(</highlight><highlight class="stringliteral">&quot;Failed<sp/>to<sp/>log<sp/>operation&quot;</highlight><highlight class="normal">,<sp/>e);</highlight></codeline>
<codeline lineno="111"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="112"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="113"><highlight class="normal"></highlight></codeline>
<codeline lineno="114"><highlight class="normal"><sp/><sp/><sp/><sp/>@Override</highlight></codeline>
<codeline lineno="115" refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a9e1c21699a664e1ea730d4156a40c90e" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">public</highlight><highlight class="normal"><sp/>OperationLog<sp/><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a9e1c21699a664e1ea730d4156a40c90e" kindref="member">logLogin</ref>(Long<sp/>userId,<sp/>String<sp/>username,<sp/>String<sp/>ipAddress,<sp/>String<sp/>userAgent,</highlight></codeline>
<codeline lineno="116"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">boolean</highlight><highlight class="normal"><sp/>success,<sp/>Map&lt;String,<sp/>Object&gt;<sp/>additionalInfo)<sp/>{</highlight></codeline>
<codeline lineno="117"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>OperationLog<sp/>log<sp/>=<sp/>OperationLog.builder()</highlight></codeline>
<codeline lineno="118"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.userId(userId)</highlight></codeline>
<codeline lineno="119"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.username(username)</highlight></codeline>
<codeline lineno="120"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.operation(OperationLog.OperationType.LOGIN.name())</highlight></codeline>
<codeline lineno="121"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.module(OperationLog.Module.AUTH.name())</highlight></codeline>
<codeline lineno="122"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.action(success<sp/>?<sp/></highlight><highlight class="stringliteral">&quot;用户登录成功&quot;</highlight><highlight class="normal"><sp/>:<sp/></highlight><highlight class="stringliteral">&quot;用户登录失败&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="123"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.result(success<sp/>?<sp/>OperationLog.Result.SUCCESS<sp/>:<sp/>OperationLog.Result.FAILED)</highlight></codeline>
<codeline lineno="124"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.ipAddress(ipAddress)</highlight></codeline>
<codeline lineno="125"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.userAgent(userAgent)</highlight></codeline>
<codeline lineno="126"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.build();</highlight></codeline>
<codeline lineno="127"><highlight class="normal"></highlight></codeline>
<codeline lineno="128"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>添加附加信息作为元数据</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="129"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(additionalInfo<sp/>!=<sp/></highlight><highlight class="keyword">null</highlight><highlight class="normal"><sp/>&amp;&amp;<sp/>!additionalInfo.isEmpty())<sp/>{</highlight></codeline>
<codeline lineno="130"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="131"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>log.setMetadata(<ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a0617bbd4e9397ffcfe64617de6664984" kindref="member">objectMapper</ref>.writeValueAsString(additionalInfo));</highlight></codeline>
<codeline lineno="132"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">catch</highlight><highlight class="normal"><sp/>(Exception<sp/>e)<sp/>{</highlight></codeline>
<codeline lineno="133"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a17e592b09f9e8b8a707a7100f024c26c" kindref="member">logger</ref>.warn(</highlight><highlight class="stringliteral">&quot;Failed<sp/>to<sp/>serialize<sp/>additional<sp/>info:<sp/>{}&quot;</highlight><highlight class="normal">,<sp/>e.getMessage());</highlight></codeline>
<codeline lineno="134"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="135"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="136"><highlight class="normal"></highlight></codeline>
<codeline lineno="137"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a9fc4fc5dd941306edc94397967728e30" kindref="member">logOperation</ref>(log);</highlight></codeline>
<codeline lineno="138"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="139"><highlight class="normal"></highlight></codeline>
<codeline lineno="140"><highlight class="normal"><sp/><sp/><sp/><sp/>@Override</highlight></codeline>
<codeline lineno="141" refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a13b90bfa6b9c16b94452eab0740fc012" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">public</highlight><highlight class="normal"><sp/>OperationLog<sp/><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a13b90bfa6b9c16b94452eab0740fc012" kindref="member">logLogout</ref>(Long<sp/>userId,<sp/>String<sp/>username,<sp/>String<sp/>ipAddress)<sp/>{</highlight></codeline>
<codeline lineno="142"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a9fc4fc5dd941306edc94397967728e30" kindref="member">logOperation</ref>(OperationLog.createLogoutLog(userId,<sp/>username,<sp/>ipAddress));</highlight></codeline>
<codeline lineno="143"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="144"><highlight class="normal"></highlight></codeline>
<codeline lineno="145"><highlight class="normal"><sp/><sp/><sp/><sp/>@Override</highlight></codeline>
<codeline lineno="146" refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a3c0e35787cac9c2f661ef874ec9dfd59" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">public</highlight><highlight class="normal"><sp/>OperationLog<sp/><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a3c0e35787cac9c2f661ef874ec9dfd59" kindref="member">logUserManagement</ref>(Long<sp/>operatorId,<sp/>String<sp/>operatorName,</highlight></codeline>
<codeline lineno="147"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Long<sp/>targetUserId,<sp/>String<sp/>targetUsername,</highlight></codeline>
<codeline lineno="148"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>OperationLog.OperationType<sp/>operationType,</highlight></codeline>
<codeline lineno="149"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">boolean</highlight><highlight class="normal"><sp/>success,<sp/>String<sp/>details)<sp/>{</highlight></codeline>
<codeline lineno="150"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Map&lt;String,<sp/>Object&gt;<sp/>metadata<sp/>=<sp/></highlight><highlight class="keyword">new</highlight><highlight class="normal"><sp/>HashMap&lt;&gt;();</highlight></codeline>
<codeline lineno="151"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>metadata.put(</highlight><highlight class="stringliteral">&quot;targetUserId&quot;</highlight><highlight class="normal">,<sp/>targetUserId);</highlight></codeline>
<codeline lineno="152"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>metadata.put(</highlight><highlight class="stringliteral">&quot;targetUsername&quot;</highlight><highlight class="normal">,<sp/>targetUsername);</highlight></codeline>
<codeline lineno="153"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(details<sp/>!=<sp/></highlight><highlight class="keyword">null</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="154"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>metadata.put(</highlight><highlight class="stringliteral">&quot;details&quot;</highlight><highlight class="normal">,<sp/>details);</highlight></codeline>
<codeline lineno="155"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="156"><highlight class="normal"></highlight></codeline>
<codeline lineno="157"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>OperationLog<sp/>log<sp/>=<sp/>OperationLog.builder()</highlight></codeline>
<codeline lineno="158"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.userId(operatorId)</highlight></codeline>
<codeline lineno="159"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.username(operatorName)</highlight></codeline>
<codeline lineno="160"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.operation(operationType.name())</highlight></codeline>
<codeline lineno="161"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.module(OperationLog.Module.USER.name())</highlight></codeline>
<codeline lineno="162"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.action(operationType.getDescription()<sp/>+<sp/>(success<sp/>?<sp/></highlight><highlight class="stringliteral">&quot;成功&quot;</highlight><highlight class="normal"><sp/>:<sp/></highlight><highlight class="stringliteral">&quot;失败&quot;</highlight><highlight class="normal">))</highlight></codeline>
<codeline lineno="163"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.result(success<sp/>?<sp/>OperationLog.Result.SUCCESS<sp/>:<sp/>OperationLog.Result.FAILED)</highlight></codeline>
<codeline lineno="164"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.build();</highlight></codeline>
<codeline lineno="165"><highlight class="normal"></highlight></codeline>
<codeline lineno="166"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="167"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>log.setMetadata(<ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a0617bbd4e9397ffcfe64617de6664984" kindref="member">objectMapper</ref>.writeValueAsString(metadata));</highlight></codeline>
<codeline lineno="168"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">catch</highlight><highlight class="normal"><sp/>(Exception<sp/>e)<sp/>{</highlight></codeline>
<codeline lineno="169"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a17e592b09f9e8b8a707a7100f024c26c" kindref="member">logger</ref>.warn(</highlight><highlight class="stringliteral">&quot;Failed<sp/>to<sp/>serialize<sp/>user<sp/>management<sp/>metadata:<sp/>{}&quot;</highlight><highlight class="normal">,<sp/>e.getMessage());</highlight></codeline>
<codeline lineno="170"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="171"><highlight class="normal"></highlight></codeline>
<codeline lineno="172"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a9fc4fc5dd941306edc94397967728e30" kindref="member">logOperation</ref>(log);</highlight></codeline>
<codeline lineno="173"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="174"><highlight class="normal"></highlight></codeline>
<codeline lineno="175"><highlight class="normal"><sp/><sp/><sp/><sp/>@Override</highlight></codeline>
<codeline lineno="176" refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a410bf5d173899e0ea9177796d0328869" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">public</highlight><highlight class="normal"><sp/>OperationLog<sp/><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a410bf5d173899e0ea9177796d0328869" kindref="member">logRolePermissionChange</ref>(Long<sp/>operatorId,<sp/>String<sp/>operatorName,</highlight></codeline>
<codeline lineno="177"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Long<sp/>roleId,<sp/>String<sp/>roleCode,</highlight></codeline>
<codeline lineno="178"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>String<sp/>permissionChanges,<sp/></highlight><highlight class="keywordtype">boolean</highlight><highlight class="normal"><sp/>success)<sp/>{</highlight></codeline>
<codeline lineno="179"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Map&lt;String,<sp/>Object&gt;<sp/>metadata<sp/>=<sp/></highlight><highlight class="keyword">new</highlight><highlight class="normal"><sp/>HashMap&lt;&gt;();</highlight></codeline>
<codeline lineno="180"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>metadata.put(</highlight><highlight class="stringliteral">&quot;roleId&quot;</highlight><highlight class="normal">,<sp/>roleId);</highlight></codeline>
<codeline lineno="181"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>metadata.put(</highlight><highlight class="stringliteral">&quot;roleCode&quot;</highlight><highlight class="normal">,<sp/>roleCode);</highlight></codeline>
<codeline lineno="182"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>metadata.put(</highlight><highlight class="stringliteral">&quot;permissionChanges&quot;</highlight><highlight class="normal">,<sp/>permissionChanges);</highlight></codeline>
<codeline lineno="183"><highlight class="normal"></highlight></codeline>
<codeline lineno="184"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>OperationLog<sp/>log<sp/>=<sp/>OperationLog.builder()</highlight></codeline>
<codeline lineno="185"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.userId(operatorId)</highlight></codeline>
<codeline lineno="186"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.username(operatorName)</highlight></codeline>
<codeline lineno="187"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.operation(OperationLog.OperationType.ROLE_PERMISSION_CHANGE.name())</highlight></codeline>
<codeline lineno="188"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.module(OperationLog.Module.ROLE.name())</highlight></codeline>
<codeline lineno="189"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.action(</highlight><highlight class="stringliteral">&quot;角色权限变更&quot;</highlight><highlight class="normal"><sp/>+<sp/>(success<sp/>?<sp/></highlight><highlight class="stringliteral">&quot;成功&quot;</highlight><highlight class="normal"><sp/>:<sp/></highlight><highlight class="stringliteral">&quot;失败&quot;</highlight><highlight class="normal">))</highlight></codeline>
<codeline lineno="190"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.result(success<sp/>?<sp/>OperationLog.Result.SUCCESS<sp/>:<sp/>OperationLog.Result.FAILED)</highlight></codeline>
<codeline lineno="191"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.build();</highlight></codeline>
<codeline lineno="192"><highlight class="normal"></highlight></codeline>
<codeline lineno="193"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="194"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>log.setMetadata(<ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a0617bbd4e9397ffcfe64617de6664984" kindref="member">objectMapper</ref>.writeValueAsString(metadata));</highlight></codeline>
<codeline lineno="195"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">catch</highlight><highlight class="normal"><sp/>(Exception<sp/>e)<sp/>{</highlight></codeline>
<codeline lineno="196"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a17e592b09f9e8b8a707a7100f024c26c" kindref="member">logger</ref>.warn(</highlight><highlight class="stringliteral">&quot;Failed<sp/>to<sp/>serialize<sp/>role<sp/>permission<sp/>metadata:<sp/>{}&quot;</highlight><highlight class="normal">,<sp/>e.getMessage());</highlight></codeline>
<codeline lineno="197"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="198"><highlight class="normal"></highlight></codeline>
<codeline lineno="199"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a9fc4fc5dd941306edc94397967728e30" kindref="member">logOperation</ref>(log);</highlight></codeline>
<codeline lineno="200"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="201"><highlight class="normal"></highlight></codeline>
<codeline lineno="202"><highlight class="normal"><sp/><sp/><sp/><sp/>@Override</highlight></codeline>
<codeline lineno="203" refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a2154e2e532ce4918475966ec1551aaa9" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">public</highlight><highlight class="normal"><sp/>OperationLog<sp/><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a2154e2e532ce4918475966ec1551aaa9" kindref="member">logRoleAssignment</ref>(Long<sp/>operatorId,<sp/>String<sp/>operatorName,</highlight></codeline>
<codeline lineno="204"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Long<sp/>userId,<sp/>String<sp/>username,</highlight></codeline>
<codeline lineno="205"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Long<sp/>roleId,<sp/>String<sp/>roleCode,</highlight></codeline>
<codeline lineno="206"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">boolean</highlight><highlight class="normal"><sp/>isAssign,<sp/></highlight><highlight class="keywordtype">boolean</highlight><highlight class="normal"><sp/>success)<sp/>{</highlight></codeline>
<codeline lineno="207"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Map&lt;String,<sp/>Object&gt;<sp/>metadata<sp/>=<sp/></highlight><highlight class="keyword">new</highlight><highlight class="normal"><sp/>HashMap&lt;&gt;();</highlight></codeline>
<codeline lineno="208"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>metadata.put(</highlight><highlight class="stringliteral">&quot;userId&quot;</highlight><highlight class="normal">,<sp/>userId);</highlight></codeline>
<codeline lineno="209"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>metadata.put(</highlight><highlight class="stringliteral">&quot;username&quot;</highlight><highlight class="normal">,<sp/>username);</highlight></codeline>
<codeline lineno="210"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>metadata.put(</highlight><highlight class="stringliteral">&quot;roleId&quot;</highlight><highlight class="normal">,<sp/>roleId);</highlight></codeline>
<codeline lineno="211"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>metadata.put(</highlight><highlight class="stringliteral">&quot;roleCode&quot;</highlight><highlight class="normal">,<sp/>roleCode);</highlight></codeline>
<codeline lineno="212"><highlight class="normal"></highlight></codeline>
<codeline lineno="213"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>String<sp/>operation<sp/>=<sp/>isAssign<sp/>?<sp/>OperationLog.OperationType.ROLE_ASSIGN.name()<sp/>:<sp/></highlight></codeline>
<codeline lineno="214"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>OperationLog.OperationType.ROLE_REVOKE.name();</highlight></codeline>
<codeline lineno="215"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>String<sp/>action<sp/>=<sp/>(isAssign<sp/>?<sp/></highlight><highlight class="stringliteral">&quot;分配角色&quot;</highlight><highlight class="normal"><sp/>:<sp/></highlight><highlight class="stringliteral">&quot;撤销角色&quot;</highlight><highlight class="normal">)<sp/>+<sp/>(success<sp/>?<sp/></highlight><highlight class="stringliteral">&quot;成功&quot;</highlight><highlight class="normal"><sp/>:<sp/></highlight><highlight class="stringliteral">&quot;失败&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="216"><highlight class="normal"></highlight></codeline>
<codeline lineno="217"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>OperationLog<sp/>log<sp/>=<sp/>OperationLog.builder()</highlight></codeline>
<codeline lineno="218"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.userId(operatorId)</highlight></codeline>
<codeline lineno="219"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.username(operatorName)</highlight></codeline>
<codeline lineno="220"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.operation(operation)</highlight></codeline>
<codeline lineno="221"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.module(OperationLog.Module.USER.name())</highlight></codeline>
<codeline lineno="222"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.action(action)</highlight></codeline>
<codeline lineno="223"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.result(success<sp/>?<sp/>OperationLog.Result.SUCCESS<sp/>:<sp/>OperationLog.Result.FAILED)</highlight></codeline>
<codeline lineno="224"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.build();</highlight></codeline>
<codeline lineno="225"><highlight class="normal"></highlight></codeline>
<codeline lineno="226"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="227"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>log.setMetadata(<ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a0617bbd4e9397ffcfe64617de6664984" kindref="member">objectMapper</ref>.writeValueAsString(metadata));</highlight></codeline>
<codeline lineno="228"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">catch</highlight><highlight class="normal"><sp/>(Exception<sp/>e)<sp/>{</highlight></codeline>
<codeline lineno="229"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a17e592b09f9e8b8a707a7100f024c26c" kindref="member">logger</ref>.warn(</highlight><highlight class="stringliteral">&quot;Failed<sp/>to<sp/>serialize<sp/>role<sp/>assignment<sp/>metadata:<sp/>{}&quot;</highlight><highlight class="normal">,<sp/>e.getMessage());</highlight></codeline>
<codeline lineno="230"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="231"><highlight class="normal"></highlight></codeline>
<codeline lineno="232"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a9fc4fc5dd941306edc94397967728e30" kindref="member">logOperation</ref>(log);</highlight></codeline>
<codeline lineno="233"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="234"><highlight class="normal"></highlight></codeline>
<codeline lineno="235"><highlight class="normal"><sp/><sp/><sp/><sp/>@Override</highlight></codeline>
<codeline lineno="236" refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1ae72889541bb474261112d72a8d6d9dbc" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">public</highlight><highlight class="normal"><sp/>OperationLog<sp/><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1ae72889541bb474261112d72a8d6d9dbc" kindref="member">logSecurityEvent</ref>(Long<sp/>userId,<sp/>String<sp/>username,<sp/></highlight></codeline>
<codeline lineno="237"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>String<sp/>eventType,<sp/>String<sp/>severity,</highlight></codeline>
<codeline lineno="238"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>String<sp/>details,<sp/>String<sp/>ipAddress)<sp/>{</highlight></codeline>
<codeline lineno="239"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Map&lt;String,<sp/>Object&gt;<sp/>metadata<sp/>=<sp/></highlight><highlight class="keyword">new</highlight><highlight class="normal"><sp/>HashMap&lt;&gt;();</highlight></codeline>
<codeline lineno="240"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>metadata.put(</highlight><highlight class="stringliteral">&quot;eventType&quot;</highlight><highlight class="normal">,<sp/>eventType);</highlight></codeline>
<codeline lineno="241"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>metadata.put(</highlight><highlight class="stringliteral">&quot;severity&quot;</highlight><highlight class="normal">,<sp/>severity);</highlight></codeline>
<codeline lineno="242"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(details<sp/>!=<sp/></highlight><highlight class="keyword">null</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="243"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>metadata.put(</highlight><highlight class="stringliteral">&quot;details&quot;</highlight><highlight class="normal">,<sp/>details);</highlight></codeline>
<codeline lineno="244"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="245"><highlight class="normal"></highlight></codeline>
<codeline lineno="246"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>OperationLog<sp/>log<sp/>=<sp/>OperationLog.builder()</highlight></codeline>
<codeline lineno="247"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.userId(userId)</highlight></codeline>
<codeline lineno="248"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.username(username)</highlight></codeline>
<codeline lineno="249"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.operation(OperationLog.OperationType.AUDIT_REVIEW.name())</highlight></codeline>
<codeline lineno="250"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.module(OperationLog.Module.SYSTEM.name())</highlight></codeline>
<codeline lineno="251"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.action(</highlight><highlight class="stringliteral">&quot;安全事件：&quot;</highlight><highlight class="normal"><sp/>+<sp/>eventType)</highlight></codeline>
<codeline lineno="252"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.result(OperationLog.Result.FAILED)<sp/></highlight><highlight class="comment">//<sp/>安全事件通常被视为失败</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="253"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.ipAddress(ipAddress)</highlight></codeline>
<codeline lineno="254"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.build();</highlight></codeline>
<codeline lineno="255"><highlight class="normal"></highlight></codeline>
<codeline lineno="256"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="257"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>log.setMetadata(<ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a0617bbd4e9397ffcfe64617de6664984" kindref="member">objectMapper</ref>.writeValueAsString(metadata));</highlight></codeline>
<codeline lineno="258"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">catch</highlight><highlight class="normal"><sp/>(Exception<sp/>e)<sp/>{</highlight></codeline>
<codeline lineno="259"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a17e592b09f9e8b8a707a7100f024c26c" kindref="member">logger</ref>.warn(</highlight><highlight class="stringliteral">&quot;Failed<sp/>to<sp/>serialize<sp/>security<sp/>event<sp/>metadata:<sp/>{}&quot;</highlight><highlight class="normal">,<sp/>e.getMessage());</highlight></codeline>
<codeline lineno="260"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="261"><highlight class="normal"></highlight></codeline>
<codeline lineno="262"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a9fc4fc5dd941306edc94397967728e30" kindref="member">logOperation</ref>(log);</highlight></codeline>
<codeline lineno="263"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="264"><highlight class="normal"></highlight></codeline>
<codeline lineno="265"><highlight class="normal"><sp/><sp/><sp/><sp/>@Override</highlight></codeline>
<codeline lineno="266" refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a7af910afc96c5acdfbece8330787e8cd" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">public</highlight><highlight class="normal"><sp/>Page&lt;OperationLog&gt;<sp/><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a7af910afc96c5acdfbece8330787e8cd" kindref="member">findLogsByPage</ref>(Pageable<sp/>pageable,<sp/>Map&lt;String,<sp/>Object&gt;<sp/>filters)<sp/>{</highlight></codeline>
<codeline lineno="267"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>这里可以实现更复杂的动态查询逻辑</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="268"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>暂时返回所有日志的分页结果</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="269"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a54c9a855f90a0156cf02b42cd8b0613d" kindref="member">operationLogRepository</ref>.findAll(pageable);</highlight></codeline>
<codeline lineno="270"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="271"><highlight class="normal"></highlight></codeline>
<codeline lineno="272"><highlight class="normal"><sp/><sp/><sp/><sp/>@Override</highlight></codeline>
<codeline lineno="273" refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a8b9eca9703a1420923e4969283d5a762" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">public</highlight><highlight class="normal"><sp/>Page&lt;OperationLog&gt;<sp/><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a8b9eca9703a1420923e4969283d5a762" kindref="member">findLogsByUserId</ref>(Long<sp/>userId,<sp/>Pageable<sp/>pageable)<sp/>{</highlight></codeline>
<codeline lineno="274"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>List&lt;OperationLog&gt;<sp/>logs<sp/>=<sp/><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a54c9a855f90a0156cf02b42cd8b0613d" kindref="member">operationLogRepository</ref>.findByUserIdOrderByOperationTimeDesc(userId);</highlight></codeline>
<codeline lineno="275"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>start<sp/>=<sp/>Math.min((</highlight><highlight class="keywordtype">int</highlight><highlight class="normal">)<sp/>pageable.getOffset(),<sp/>logs.size());</highlight></codeline>
<codeline lineno="276"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>end<sp/>=<sp/>Math.min((start<sp/>+<sp/>pageable.getPageSize()),<sp/>logs.size());</highlight></codeline>
<codeline lineno="277"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">new</highlight><highlight class="normal"><sp/>org.springframework.data.domain.PageImpl&lt;&gt;(</highlight></codeline>
<codeline lineno="278"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>logs.subList(start,<sp/>end),</highlight></codeline>
<codeline lineno="279"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pageable,</highlight></codeline>
<codeline lineno="280"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>logs.size()</highlight></codeline>
<codeline lineno="281"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>);</highlight></codeline>
<codeline lineno="282"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="283"><highlight class="normal"></highlight></codeline>
<codeline lineno="284"><highlight class="normal"><sp/><sp/><sp/><sp/>@Override</highlight></codeline>
<codeline lineno="285" refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a0224e9ba4f448f1b4cb241942fff22a2" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">public</highlight><highlight class="normal"><sp/>Page&lt;OperationLog&gt;<sp/><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a0224e9ba4f448f1b4cb241942fff22a2" kindref="member">findLogsByTimeRange</ref>(LocalDateTime<sp/>startTime,<sp/>LocalDateTime<sp/>endTime,<sp/>Pageable<sp/>pageable)<sp/>{</highlight></codeline>
<codeline lineno="286"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>List&lt;OperationLog&gt;<sp/>logs<sp/>=<sp/><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a54c9a855f90a0156cf02b42cd8b0613d" kindref="member">operationLogRepository</ref>.findByOperationTimeBetween(startTime,<sp/>endTime);</highlight></codeline>
<codeline lineno="287"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>start<sp/>=<sp/>Math.min((</highlight><highlight class="keywordtype">int</highlight><highlight class="normal">)<sp/>pageable.getOffset(),<sp/>logs.size());</highlight></codeline>
<codeline lineno="288"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>end<sp/>=<sp/>Math.min((start<sp/>+<sp/>pageable.getPageSize()),<sp/>logs.size());</highlight></codeline>
<codeline lineno="289"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">new</highlight><highlight class="normal"><sp/>org.springframework.data.domain.PageImpl&lt;&gt;(</highlight></codeline>
<codeline lineno="290"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>logs.subList(start,<sp/>end),</highlight></codeline>
<codeline lineno="291"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pageable,</highlight></codeline>
<codeline lineno="292"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>logs.size()</highlight></codeline>
<codeline lineno="293"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>);</highlight></codeline>
<codeline lineno="294"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="295"><highlight class="normal"></highlight></codeline>
<codeline lineno="296"><highlight class="normal"><sp/><sp/><sp/><sp/>@Override</highlight></codeline>
<codeline lineno="297" refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1ab379357aa31f4e68639e354971104d1b" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">public</highlight><highlight class="normal"><sp/>Page&lt;OperationLog&gt;<sp/><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1ab379357aa31f4e68639e354971104d1b" kindref="member">findFailedOperations</ref>(LocalDateTime<sp/>since,<sp/>Pageable<sp/>pageable)<sp/>{</highlight></codeline>
<codeline lineno="298"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>List&lt;OperationLog&gt;<sp/>logs<sp/>=<sp/><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a54c9a855f90a0156cf02b42cd8b0613d" kindref="member">operationLogRepository</ref>.findFailedOperationsSince(since);</highlight></codeline>
<codeline lineno="299"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>start<sp/>=<sp/>Math.min((</highlight><highlight class="keywordtype">int</highlight><highlight class="normal">)<sp/>pageable.getOffset(),<sp/>logs.size());</highlight></codeline>
<codeline lineno="300"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>end<sp/>=<sp/>Math.min((start<sp/>+<sp/>pageable.getPageSize()),<sp/>logs.size());</highlight></codeline>
<codeline lineno="301"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">new</highlight><highlight class="normal"><sp/>org.springframework.data.domain.PageImpl&lt;&gt;(</highlight></codeline>
<codeline lineno="302"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>logs.subList(start,<sp/>end),</highlight></codeline>
<codeline lineno="303"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>pageable,</highlight></codeline>
<codeline lineno="304"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>logs.size()</highlight></codeline>
<codeline lineno="305"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>);</highlight></codeline>
<codeline lineno="306"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="307"><highlight class="normal"></highlight></codeline>
<codeline lineno="308"><highlight class="normal"><sp/><sp/><sp/><sp/>@Override</highlight></codeline>
<codeline lineno="309" refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a36172a917e68ef068ea1d7f1435faae4" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">public</highlight><highlight class="normal"><sp/>Map&lt;String,<sp/>Object&gt;<sp/><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a36172a917e68ef068ea1d7f1435faae4" kindref="member">getOperationStatistics</ref>(LocalDateTime<sp/>startTime,<sp/>LocalDateTime<sp/>endTime)<sp/>{</highlight></codeline>
<codeline lineno="310"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>List&lt;OperationLog&gt;<sp/>logs<sp/>=<sp/><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a54c9a855f90a0156cf02b42cd8b0613d" kindref="member">operationLogRepository</ref>.findByOperationTimeBetween(startTime,<sp/>endTime);</highlight></codeline>
<codeline lineno="311"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="312"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Map&lt;String,<sp/>Object&gt;<sp/>statistics<sp/>=<sp/></highlight><highlight class="keyword">new</highlight><highlight class="normal"><sp/>HashMap&lt;&gt;();</highlight></codeline>
<codeline lineno="313"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>statistics.put(</highlight><highlight class="stringliteral">&quot;totalOperations&quot;</highlight><highlight class="normal">,<sp/>logs.size());</highlight></codeline>
<codeline lineno="314"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="315"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>按结果统计</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="316"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal"><sp/>successCount<sp/>=<sp/>logs.stream().filter(log<sp/>-&gt;<sp/>log.getResult()<sp/>==<sp/>OperationLog.Result.SUCCESS).count();</highlight></codeline>
<codeline lineno="317"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">long</highlight><highlight class="normal"><sp/>failedCount<sp/>=<sp/>logs.size()<sp/>-<sp/>successCount;</highlight></codeline>
<codeline lineno="318"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>statistics.put(</highlight><highlight class="stringliteral">&quot;successCount&quot;</highlight><highlight class="normal">,<sp/>successCount);</highlight></codeline>
<codeline lineno="319"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>statistics.put(</highlight><highlight class="stringliteral">&quot;failedCount&quot;</highlight><highlight class="normal">,<sp/>failedCount);</highlight></codeline>
<codeline lineno="320"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="321"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>按操作类型统计</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="322"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Map&lt;String,<sp/>Long&gt;<sp/>operationTypeStats<sp/>=<sp/>logs.stream()</highlight></codeline>
<codeline lineno="323"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.collect(Collectors.groupingBy(OperationLog::getOperation,<sp/>Collectors.counting()));</highlight></codeline>
<codeline lineno="324"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>statistics.put(</highlight><highlight class="stringliteral">&quot;operationTypeStats&quot;</highlight><highlight class="normal">,<sp/>operationTypeStats);</highlight></codeline>
<codeline lineno="325"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="326"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>按模块统计</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="327"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Map&lt;String,<sp/>Long&gt;<sp/>moduleStats<sp/>=<sp/>logs.stream()</highlight></codeline>
<codeline lineno="328"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>.collect(Collectors.groupingBy(OperationLog::getModule,<sp/>Collectors.counting()));</highlight></codeline>
<codeline lineno="329"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>statistics.put(</highlight><highlight class="stringliteral">&quot;moduleStats&quot;</highlight><highlight class="normal">,<sp/>moduleStats);</highlight></codeline>
<codeline lineno="330"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="331"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>statistics;</highlight></codeline>
<codeline lineno="332"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="333"><highlight class="normal"></highlight></codeline>
<codeline lineno="334"><highlight class="normal"><sp/><sp/><sp/><sp/>@Override</highlight></codeline>
<codeline lineno="335"><highlight class="normal"><sp/><sp/><sp/><sp/>@Transactional</highlight></codeline>
<codeline lineno="336" refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1aca4bc1602888ea25c0a88d468a198193" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">public</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1aca4bc1602888ea25c0a88d468a198193" kindref="member">cleanupOldLogs</ref>(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>daysToKeep)<sp/>{</highlight></codeline>
<codeline lineno="337"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>LocalDateTime<sp/>cutoffDate<sp/>=<sp/>LocalDateTime.now().minusDays(daysToKeep);</highlight></codeline>
<codeline lineno="338"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="339"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>List&lt;OperationLog&gt;<sp/>oldLogs<sp/>=<sp/><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a54c9a855f90a0156cf02b42cd8b0613d" kindref="member">operationLogRepository</ref>.findByOperationTimeBetween(</highlight></codeline>
<codeline lineno="340"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>LocalDateTime.MIN,<sp/>cutoffDate);</highlight></codeline>
<codeline lineno="341"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>count<sp/>=<sp/>oldLogs.size();</highlight></codeline>
<codeline lineno="342"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a54c9a855f90a0156cf02b42cd8b0613d" kindref="member">operationLogRepository</ref>.deleteLogsBefore(cutoffDate);</highlight></codeline>
<codeline lineno="343"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>count;</highlight></codeline>
<codeline lineno="344"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">catch</highlight><highlight class="normal"><sp/>(Exception<sp/>e)<sp/>{</highlight></codeline>
<codeline lineno="345"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a17e592b09f9e8b8a707a7100f024c26c" kindref="member">logger</ref>.error(</highlight><highlight class="stringliteral">&quot;Failed<sp/>to<sp/>cleanup<sp/>old<sp/>logs:<sp/>{}&quot;</highlight><highlight class="normal">,<sp/>e.getMessage(),<sp/>e);</highlight></codeline>
<codeline lineno="346"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">throw</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">new</highlight><highlight class="normal"><sp/><ref refid="classRuntimeException" kindref="compound">RuntimeException</ref>(</highlight><highlight class="stringliteral">&quot;Failed<sp/>to<sp/>cleanup<sp/>old<sp/>logs&quot;</highlight><highlight class="normal">,<sp/>e);</highlight></codeline>
<codeline lineno="347"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="348"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="349"><highlight class="normal"></highlight></codeline>
<codeline lineno="350"><highlight class="normal"><sp/><sp/><sp/><sp/>@Override</highlight></codeline>
<codeline lineno="351" refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a0b716c72360450d48ae2330ce5318ab2" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">public</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">byte</highlight><highlight class="normal">[]<sp/><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a0b716c72360450d48ae2330ce5318ab2" kindref="member">exportLogs</ref>(Map&lt;String,<sp/>Object&gt;<sp/>filters,<sp/>String<sp/>format)<sp/>{</highlight></codeline>
<codeline lineno="352"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="353"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>获取要导出的日志</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="354"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>List&lt;OperationLog&gt;<sp/>logs<sp/>=<sp/><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a54c9a855f90a0156cf02b42cd8b0613d" kindref="member">operationLogRepository</ref>.findAll();</highlight></codeline>
<codeline lineno="355"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="356"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>ByteArrayOutputStream<sp/>outputStream<sp/>=<sp/></highlight><highlight class="keyword">new</highlight><highlight class="normal"><sp/>ByteArrayOutputStream();</highlight></codeline>
<codeline lineno="357"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="358"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>暂时只支持JSON格式导出</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="359"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(</highlight><highlight class="stringliteral">&quot;json&quot;</highlight><highlight class="normal">.equalsIgnoreCase(format))<sp/>{</highlight></codeline>
<codeline lineno="360"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a0617bbd4e9397ffcfe64617de6664984" kindref="member">objectMapper</ref>.writerWithDefaultPrettyPrinter().writeValue(outputStream,<sp/>logs);</highlight></codeline>
<codeline lineno="361"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="362"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">throw</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">new</highlight><highlight class="normal"><sp/>IllegalArgumentException(</highlight><highlight class="stringliteral">&quot;Unsupported<sp/>export<sp/>format:<sp/>&quot;</highlight><highlight class="normal"><sp/>+<sp/>format);</highlight></codeline>
<codeline lineno="363"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="364"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="365"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>outputStream.toByteArray();</highlight></codeline>
<codeline lineno="366"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">catch</highlight><highlight class="normal"><sp/>(IOException<sp/>e)<sp/>{</highlight></codeline>
<codeline lineno="367"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1impl_1_1AuditLogServiceImpl_1a17e592b09f9e8b8a707a7100f024c26c" kindref="member">logger</ref>.error(</highlight><highlight class="stringliteral">&quot;Failed<sp/>to<sp/>export<sp/>logs:<sp/>{}&quot;</highlight><highlight class="normal">,<sp/>e.getMessage(),<sp/>e);</highlight></codeline>
<codeline lineno="368"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">throw</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">new</highlight><highlight class="normal"><sp/><ref refid="classRuntimeException" kindref="compound">RuntimeException</ref>(</highlight><highlight class="stringliteral">&quot;Failed<sp/>to<sp/>export<sp/>logs&quot;</highlight><highlight class="normal">,<sp/>e);</highlight></codeline>
<codeline lineno="369"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="370"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="371"><highlight class="normal">}</highlight></codeline>
    </programlisting>
    <location file="auth-service/src/main/java/com/gmp/auth/service/impl/AuditLogServiceImpl.java"/>
  </compounddef>
</doxygen>
