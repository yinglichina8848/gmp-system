<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<doxygen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="compound.xsd" version="1.9.8" xml:lang="en-US">
  <compounddef id="McpMessageListener_8java" kind="file" language="Java">
    <compoundname>McpMessageListener.java</compoundname>
    <includes local="no">com.gmp.qms.monitoring.McpMonitoringService</includes>
    <incdepgraph>
      <node id="1">
        <label>qms-service/src/main/java/com/gmp/qms/listener/McpMessageListener.java</label>
        <link refid="McpMessageListener_8java"/>
        <childnode refid="2" relation="include">
        </childnode>
      </node>
      <node id="2">
        <label>com.gmp.qms.monitoring.McpMonitoringService</label>
      </node>
    </incdepgraph>
    <innerclass refid="classcom_1_1gmp_1_1qms_1_1listener_1_1McpMessageListener" prot="public">com::gmp::qms::listener::McpMessageListener</innerclass>
    <innernamespace refid="namespacecom_1_1gmp_1_1qms_1_1listener">com::gmp::qms::listener</innernamespace>
    <briefdescription>
    </briefdescription>
    <detaileddescription>
    </detaileddescription>
    <programlisting>
<codeline lineno="1" refid="namespacecom_1_1gmp_1_1qms_1_1listener" refkind="compound"><highlight class="keyword">package<sp/></highlight><highlight class="normal">com.gmp.qms.listener;</highlight></codeline>
<codeline lineno="2"><highlight class="normal"></highlight></codeline>
<codeline lineno="3"><highlight class="normal"></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>com.gmp.qms.monitoring.McpMonitoringService;</highlight></codeline>
<codeline lineno="4"><highlight class="normal"></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>com.gmp.qms.service.messaging.McpMessageService;</highlight></codeline>
<codeline lineno="5"><highlight class="normal"></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>org.springframework.amqp.rabbit.annotation.RabbitListener;</highlight></codeline>
<codeline lineno="6"><highlight class="normal"></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>org.springframework.amqp.support.converter.Jackson2JsonMessageConverter;</highlight></codeline>
<codeline lineno="7"><highlight class="normal"></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>org.springframework.beans.factory.annotation.Autowired;</highlight></codeline>
<codeline lineno="8"><highlight class="normal"></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>org.springframework.stereotype.Component;</highlight></codeline>
<codeline lineno="9"><highlight class="normal"></highlight></codeline>
<codeline lineno="10"><highlight class="normal"></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>java.util.Map;</highlight></codeline>
<codeline lineno="11"><highlight class="normal"></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>java.util.concurrent.ConcurrentHashMap;</highlight></codeline>
<codeline lineno="12"><highlight class="normal"></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>java.util.function.Consumer;</highlight></codeline>
<codeline lineno="13"><highlight class="normal"></highlight></codeline>
<codeline lineno="19"><highlight class="normal">@Component</highlight></codeline>
<codeline lineno="20" refid="classcom_1_1gmp_1_1qms_1_1listener_1_1McpMessageListener" refkind="compound"><highlight class="normal"></highlight><highlight class="keyword">public</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">class<sp/></highlight><highlight class="normal"><ref refid="classcom_1_1gmp_1_1qms_1_1listener_1_1McpMessageListener" kindref="compound">McpMessageListener</ref><sp/>{</highlight></codeline>
<codeline lineno="21"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="22"><highlight class="normal"><sp/><sp/><sp/><sp/>@Autowired</highlight></codeline>
<codeline lineno="23" refid="classcom_1_1gmp_1_1qms_1_1listener_1_1McpMessageListener_1ab500d520848a2db2c112a38476c8097f" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">private</highlight><highlight class="normal"><sp/>McpMonitoringService<sp/><ref refid="classcom_1_1gmp_1_1qms_1_1listener_1_1McpMessageListener_1ab500d520848a2db2c112a38476c8097f" kindref="member">monitoringService</ref>;</highlight></codeline>
<codeline lineno="24"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="25"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>消息处理器注册表</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="26" refid="classcom_1_1gmp_1_1qms_1_1listener_1_1McpMessageListener_1a05dc672f9d00db6bd2bd2ff706bbb927" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">private</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">final</highlight><highlight class="normal"><sp/>Map&lt;String,<sp/>Consumer&lt;Map&lt;String,<sp/>Object&gt;&gt;&gt;<sp/><ref refid="classcom_1_1gmp_1_1qms_1_1listener_1_1McpMessageListener_1a05dc672f9d00db6bd2bd2ff706bbb927" kindref="member">messageHandlers</ref><sp/>=<sp/></highlight><highlight class="keyword">new</highlight><highlight class="normal"><sp/>ConcurrentHashMap&lt;&gt;();</highlight></codeline>
<codeline lineno="27"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="31"><highlight class="normal"><sp/><sp/><sp/><sp/>@RabbitListener(queues<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;qms.edms.queue&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="32" refid="classcom_1_1gmp_1_1qms_1_1listener_1_1McpMessageListener_1a398b0282f11fba572ba2a6f00031b208" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>public<sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="classcom_1_1gmp_1_1qms_1_1listener_1_1McpMessageListener_1a398b0282f11fba572ba2a6f00031b208" kindref="member">listenEdmsMessages</ref>(Map&lt;String,<sp/>Object&gt;<sp/>message)<sp/>{</highlight></codeline>
<codeline lineno="33"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classcom_1_1gmp_1_1qms_1_1listener_1_1McpMessageListener_1a465f47802922d9fb47b58c141041b86c" kindref="member">processMessage</ref>(</highlight><highlight class="stringliteral">&quot;edms&quot;</highlight><highlight class="normal">,<sp/>message);</highlight></codeline>
<codeline lineno="34"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="35"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="39"><highlight class="normal"><sp/><sp/><sp/><sp/>@RabbitListener(queues<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;qms.mes.queue&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="40" refid="classcom_1_1gmp_1_1qms_1_1listener_1_1McpMessageListener_1ae16b5685b1d147fb0f992eee2030e67d" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>public<sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="classcom_1_1gmp_1_1qms_1_1listener_1_1McpMessageListener_1ae16b5685b1d147fb0f992eee2030e67d" kindref="member">listenMesMessages</ref>(Map&lt;String,<sp/>Object&gt;<sp/>message)<sp/>{</highlight></codeline>
<codeline lineno="41"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classcom_1_1gmp_1_1qms_1_1listener_1_1McpMessageListener_1a465f47802922d9fb47b58c141041b86c" kindref="member">processMessage</ref>(</highlight><highlight class="stringliteral">&quot;mes&quot;</highlight><highlight class="normal">,<sp/>message);</highlight></codeline>
<codeline lineno="42"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="43"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="47"><highlight class="normal"><sp/><sp/><sp/><sp/>@RabbitListener(queues<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;qms.lims.queue&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="48" refid="classcom_1_1gmp_1_1qms_1_1listener_1_1McpMessageListener_1ab5cd2afeb1af9d3fc2e21197128d482c" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>public<sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="classcom_1_1gmp_1_1qms_1_1listener_1_1McpMessageListener_1ab5cd2afeb1af9d3fc2e21197128d482c" kindref="member">listenLimsMessages</ref>(Map&lt;String,<sp/>Object&gt;<sp/>message)<sp/>{</highlight></codeline>
<codeline lineno="49"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classcom_1_1gmp_1_1qms_1_1listener_1_1McpMessageListener_1a465f47802922d9fb47b58c141041b86c" kindref="member">processMessage</ref>(</highlight><highlight class="stringliteral">&quot;lims&quot;</highlight><highlight class="normal">,<sp/>message);</highlight></codeline>
<codeline lineno="50"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="51"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="55"><highlight class="normal"><sp/><sp/><sp/><sp/>@RabbitListener(queues<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;qms.erp.queue&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="56" refid="classcom_1_1gmp_1_1qms_1_1listener_1_1McpMessageListener_1a5dfffb7e4d51074e2e0072694feb5468" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>public<sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="classcom_1_1gmp_1_1qms_1_1listener_1_1McpMessageListener_1a5dfffb7e4d51074e2e0072694feb5468" kindref="member">listenErpMessages</ref>(Map&lt;String,<sp/>Object&gt;<sp/>message)<sp/>{</highlight></codeline>
<codeline lineno="57"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classcom_1_1gmp_1_1qms_1_1listener_1_1McpMessageListener_1a465f47802922d9fb47b58c141041b86c" kindref="member">processMessage</ref>(</highlight><highlight class="stringliteral">&quot;erp&quot;</highlight><highlight class="normal">,<sp/>message);</highlight></codeline>
<codeline lineno="58"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="59"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="63"><highlight class="normal"><sp/><sp/><sp/><sp/>@RabbitListener(queues<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;qms.training.queue&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="64" refid="classcom_1_1gmp_1_1qms_1_1listener_1_1McpMessageListener_1a20c8f12896457420cbb169a801f4be63" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>public<sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="classcom_1_1gmp_1_1qms_1_1listener_1_1McpMessageListener_1a20c8f12896457420cbb169a801f4be63" kindref="member">listenTrainingMessages</ref>(Map&lt;String,<sp/>Object&gt;<sp/>message)<sp/>{</highlight></codeline>
<codeline lineno="65"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classcom_1_1gmp_1_1qms_1_1listener_1_1McpMessageListener_1a465f47802922d9fb47b58c141041b86c" kindref="member">processMessage</ref>(</highlight><highlight class="stringliteral">&quot;training&quot;</highlight><highlight class="normal">,<sp/>message);</highlight></codeline>
<codeline lineno="66"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="67"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="71"><highlight class="normal"><sp/><sp/><sp/><sp/>@RabbitListener(queues<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;qms.equipment.queue&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="72" refid="classcom_1_1gmp_1_1qms_1_1listener_1_1McpMessageListener_1a3492441373f7bb901e517e2b1647c5c4" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>public<sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="classcom_1_1gmp_1_1qms_1_1listener_1_1McpMessageListener_1a3492441373f7bb901e517e2b1647c5c4" kindref="member">listenEquipmentMessages</ref>(Map&lt;String,<sp/>Object&gt;<sp/>message)<sp/>{</highlight></codeline>
<codeline lineno="73"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classcom_1_1gmp_1_1qms_1_1listener_1_1McpMessageListener_1a465f47802922d9fb47b58c141041b86c" kindref="member">processMessage</ref>(</highlight><highlight class="stringliteral">&quot;equipment&quot;</highlight><highlight class="normal">,<sp/>message);</highlight></codeline>
<codeline lineno="74"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="75"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="79"><highlight class="normal"><sp/><sp/><sp/><sp/>@RabbitListener(queues<sp/>=<sp/></highlight><highlight class="stringliteral">&quot;qms.mcp.dead.letter.queue&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="80" refid="classcom_1_1gmp_1_1qms_1_1listener_1_1McpMessageListener_1aa2e5a4a47ba5e8b1532cd090984a35e0" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>public<sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="classcom_1_1gmp_1_1qms_1_1listener_1_1McpMessageListener_1aa2e5a4a47ba5e8b1532cd090984a35e0" kindref="member">listenDeadLetterMessages</ref>(Map&lt;String,<sp/>Object&gt;<sp/>message)<sp/>{</highlight></codeline>
<codeline lineno="81"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>String<sp/>messageId<sp/>=<sp/>message.getOrDefault(</highlight><highlight class="stringliteral">&quot;messageId&quot;</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&quot;unknown&quot;</highlight><highlight class="normal">).toString();</highlight></codeline>
<codeline lineno="82"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>String<sp/>sourceSystem<sp/>=<sp/>message.getOrDefault(</highlight><highlight class="stringliteral">&quot;sourceSystem&quot;</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&quot;unknown&quot;</highlight><highlight class="normal">).toString();</highlight></codeline>
<codeline lineno="83"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>String<sp/>operation<sp/>=<sp/>message.getOrDefault(</highlight><highlight class="stringliteral">&quot;operation&quot;</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&quot;unknown&quot;</highlight><highlight class="normal">).toString();</highlight></codeline>
<codeline lineno="84"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Integer<sp/>retryCount<sp/>=<sp/>(Integer)<sp/>message.getOrDefault(</highlight><highlight class="stringliteral">&quot;retryCount&quot;</highlight><highlight class="normal">,<sp/>0);</highlight></codeline>
<codeline lineno="85"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="86"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>记录死信消息</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="87"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classcom_1_1gmp_1_1qms_1_1listener_1_1McpMessageListener_1ab500d520848a2db2c112a38476c8097f" kindref="member">monitoringService</ref>.incrementCounter(</highlight><highlight class="stringliteral">&quot;mq_dead_letter&quot;</highlight><highlight class="normal">,<sp/>sourceSystem);</highlight></codeline>
<codeline lineno="88"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="89"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>这里可以实现死信处理逻辑，如记录到失败表、告警等</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="90"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>System.err.println(</highlight><highlight class="stringliteral">&quot;Dead<sp/>letter<sp/>message<sp/>received:<sp/>&quot;</highlight><highlight class="normal"><sp/>+<sp/>messageId<sp/>+<sp/></highlight></codeline>
<codeline lineno="91"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;<sp/>from<sp/>&quot;</highlight><highlight class="normal"><sp/>+<sp/>sourceSystem<sp/>+<sp/></highlight></codeline>
<codeline lineno="92"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;<sp/>operation:<sp/>&quot;</highlight><highlight class="normal"><sp/>+<sp/>operation<sp/>+<sp/></highlight></codeline>
<codeline lineno="93"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;<sp/>retryCount:<sp/>&quot;</highlight><highlight class="normal"><sp/>+<sp/>retryCount);</highlight></codeline>
<codeline lineno="94"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="95"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="101" refid="classcom_1_1gmp_1_1qms_1_1listener_1_1McpMessageListener_1ae65221db770789daaf964cc885a85bb3" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">public</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="classcom_1_1gmp_1_1qms_1_1listener_1_1McpMessageListener_1ae65221db770789daaf964cc885a85bb3" kindref="member">registerMessageHandler</ref>(String<sp/>operation,<sp/>Consumer&lt;Map&lt;String,<sp/>Object&gt;&gt;<sp/>handler)<sp/>{</highlight></codeline>
<codeline lineno="102"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classcom_1_1gmp_1_1qms_1_1listener_1_1McpMessageListener_1a05dc672f9d00db6bd2bd2ff706bbb927" kindref="member">messageHandlers</ref>.put(operation,<sp/>handler);</highlight></codeline>
<codeline lineno="103"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="104"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="109" refid="classcom_1_1gmp_1_1qms_1_1listener_1_1McpMessageListener_1ad89fc40efb3d167139b6b80924dea04a" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">public</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="classcom_1_1gmp_1_1qms_1_1listener_1_1McpMessageListener_1ad89fc40efb3d167139b6b80924dea04a" kindref="member">unregisterMessageHandler</ref>(String<sp/>operation)<sp/>{</highlight></codeline>
<codeline lineno="110"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classcom_1_1gmp_1_1qms_1_1listener_1_1McpMessageListener_1a05dc672f9d00db6bd2bd2ff706bbb927" kindref="member">messageHandlers</ref>.remove(operation);</highlight></codeline>
<codeline lineno="111"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="112"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="116" refid="classcom_1_1gmp_1_1qms_1_1listener_1_1McpMessageListener_1a465f47802922d9fb47b58c141041b86c" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">private</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="classcom_1_1gmp_1_1qms_1_1listener_1_1McpMessageListener_1a465f47802922d9fb47b58c141041b86c" kindref="member">processMessage</ref>(String<sp/>sourceSystem,<sp/>Map&lt;String,<sp/>Object&gt;<sp/>message)<sp/>{</highlight></codeline>
<codeline lineno="117"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>String<sp/>messageId<sp/>=<sp/>message.getOrDefault(</highlight><highlight class="stringliteral">&quot;messageId&quot;</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&quot;unknown&quot;</highlight><highlight class="normal">).toString();</highlight></codeline>
<codeline lineno="118"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>String<sp/>operation<sp/>=<sp/>message.getOrDefault(</highlight><highlight class="stringliteral">&quot;operation&quot;</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&quot;unknown&quot;</highlight><highlight class="normal">).toString();</highlight></codeline>
<codeline lineno="119"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="120"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>开始计时</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="121"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>McpMonitoringService.McpTimer<sp/>timer<sp/>=<sp/><ref refid="classcom_1_1gmp_1_1qms_1_1listener_1_1McpMessageListener_1ab500d520848a2db2c112a38476c8097f" kindref="member">monitoringService</ref>.startTimer(</highlight><highlight class="stringliteral">&quot;mq_receive_&quot;</highlight><highlight class="normal"><sp/>+<sp/>sourceSystem);</highlight></codeline>
<codeline lineno="122"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="123"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">try</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="124"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>记录接收计数</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="125"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classcom_1_1gmp_1_1qms_1_1listener_1_1McpMessageListener_1ab500d520848a2db2c112a38476c8097f" kindref="member">monitoringService</ref>.incrementCounter(</highlight><highlight class="stringliteral">&quot;mq_receive&quot;</highlight><highlight class="normal">,<sp/>sourceSystem);</highlight></codeline>
<codeline lineno="126"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="127"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>查找对应的处理器</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="128"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>Consumer&lt;Map&lt;String,<sp/>Object&gt;&gt;<sp/>handler<sp/>=<sp/><ref refid="classcom_1_1gmp_1_1qms_1_1listener_1_1McpMessageListener_1a05dc672f9d00db6bd2bd2ff706bbb927" kindref="member">messageHandlers</ref>.get(operation);</highlight></codeline>
<codeline lineno="129"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="130"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(handler<sp/>!=<sp/></highlight><highlight class="keyword">null</highlight><highlight class="normal">)<sp/>{</highlight></codeline>
<codeline lineno="131"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>使用注册的处理器处理消息</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="132"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>handler.accept(message);</highlight></codeline>
<codeline lineno="133"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>timer.complete(</highlight><highlight class="keyword">true</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="134"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="135"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>默认处理逻辑</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="136"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classcom_1_1gmp_1_1qms_1_1listener_1_1McpMessageListener_1aecac98a17e707ece5e018104a922cb9c" kindref="member">handleDefaultMessage</ref>(sourceSystem,<sp/>message);</highlight></codeline>
<codeline lineno="137"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>timer.complete(</highlight><highlight class="keyword">true</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="138"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="139"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">catch</highlight><highlight class="normal"><sp/>(Exception<sp/>e)<sp/>{</highlight></codeline>
<codeline lineno="140"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>记录错误</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="141"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><ref refid="classcom_1_1gmp_1_1qms_1_1listener_1_1McpMessageListener_1ab500d520848a2db2c112a38476c8097f" kindref="member">monitoringService</ref>.incrementCounter(</highlight><highlight class="stringliteral">&quot;mq_process_error&quot;</highlight><highlight class="normal">,<sp/>sourceSystem);</highlight></codeline>
<codeline lineno="142"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>timer.complete(</highlight><highlight class="keyword">false</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="143"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="144"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>这里可以实现重试逻辑，或者将消息发送到死信队列</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="145"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">throw</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">new</highlight><highlight class="normal"><sp/><ref refid="classRuntimeException" kindref="compound">RuntimeException</ref>(</highlight><highlight class="stringliteral">&quot;Failed<sp/>to<sp/>process<sp/>message<sp/>&quot;</highlight><highlight class="normal"><sp/>+<sp/>messageId<sp/>+<sp/></highlight><highlight class="stringliteral">&quot;<sp/>from<sp/>&quot;</highlight><highlight class="normal"><sp/>+<sp/>sourceSystem,<sp/>e);</highlight></codeline>
<codeline lineno="146"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="147"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="148"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="152" refid="classcom_1_1gmp_1_1qms_1_1listener_1_1McpMessageListener_1aecac98a17e707ece5e018104a922cb9c" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">private</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="classcom_1_1gmp_1_1qms_1_1listener_1_1McpMessageListener_1aecac98a17e707ece5e018104a922cb9c" kindref="member">handleDefaultMessage</ref>(String<sp/>sourceSystem,<sp/>Map&lt;String,<sp/>Object&gt;<sp/>message)<sp/>{</highlight></codeline>
<codeline lineno="153"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>记录未处理的消息</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="154"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>System.out.println(</highlight><highlight class="stringliteral">&quot;Received<sp/>message<sp/>from<sp/>&quot;</highlight><highlight class="normal"><sp/>+<sp/>sourceSystem<sp/>+<sp/></highlight></codeline>
<codeline lineno="155"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;,<sp/>messageId:<sp/>&quot;</highlight><highlight class="normal"><sp/>+<sp/>message.getOrDefault(</highlight><highlight class="stringliteral">&quot;messageId&quot;</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&quot;unknown&quot;</highlight><highlight class="normal">)<sp/>+<sp/></highlight></codeline>
<codeline lineno="156"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="stringliteral">&quot;,<sp/>operation:<sp/>&quot;</highlight><highlight class="normal"><sp/>+<sp/>message.getOrDefault(</highlight><highlight class="stringliteral">&quot;operation&quot;</highlight><highlight class="normal">,<sp/></highlight><highlight class="stringliteral">&quot;unknown&quot;</highlight><highlight class="normal">));</highlight></codeline>
<codeline lineno="157"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="158"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>这里可以实现一些通用的消息处理逻辑</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="159"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>例如日志记录、基本验证等</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="160"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="161"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="165" refid="classcom_1_1gmp_1_1qms_1_1listener_1_1McpMessageListener_1a6837dd15642e723e0572d9ec0b251a80" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">public</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/><ref refid="classcom_1_1gmp_1_1qms_1_1listener_1_1McpMessageListener_1a6837dd15642e723e0572d9ec0b251a80" kindref="member">getRegisteredHandlersCount</ref>()<sp/>{</highlight></codeline>
<codeline lineno="166"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="classcom_1_1gmp_1_1qms_1_1listener_1_1McpMessageListener_1a05dc672f9d00db6bd2bd2ff706bbb927" kindref="member">messageHandlers</ref>.size();</highlight></codeline>
<codeline lineno="167"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="168"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="172" refid="classcom_1_1gmp_1_1qms_1_1listener_1_1McpMessageListener_1abeb10afe26644fca25c3e0d689862b33" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">public</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">boolean</highlight><highlight class="normal"><sp/><ref refid="classcom_1_1gmp_1_1qms_1_1listener_1_1McpMessageListener_1abeb10afe26644fca25c3e0d689862b33" kindref="member">hasHandlerForOperation</ref>(String<sp/>operation)<sp/>{</highlight></codeline>
<codeline lineno="173"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/><ref refid="classcom_1_1gmp_1_1qms_1_1listener_1_1McpMessageListener_1a05dc672f9d00db6bd2bd2ff706bbb927" kindref="member">messageHandlers</ref>.containsKey(operation);</highlight></codeline>
<codeline lineno="174"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="175"><highlight class="normal">}</highlight></codeline>
    </programlisting>
    <location file="qms-service/src/main/java/com/gmp/qms/listener/McpMessageListener.java"/>
  </compounddef>
</doxygen>
