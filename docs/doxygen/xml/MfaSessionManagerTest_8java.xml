<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<doxygen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="compound.xsd" version="1.9.8" xml:lang="en-US">
  <compounddef id="MfaSessionManagerTest_8java" kind="file" language="Java">
    <compoundname>MfaSessionManagerTest.java</compoundname>
    <includes local="no">com.gmp.auth.entity.User</includes>
    <incdepgraph>
      <node id="1">
        <label>auth-service/src/test/java/com/gmp/auth/service/MfaSessionManagerTest.java</label>
        <link refid="MfaSessionManagerTest_8java"/>
        <childnode refid="2" relation="include">
        </childnode>
      </node>
      <node id="2">
        <label>com.gmp.auth.entity.User</label>
      </node>
    </incdepgraph>
    <innerclass refid="classcom_1_1gmp_1_1auth_1_1service_1_1MfaSessionManagerTest" prot="public">com::gmp::auth::service::MfaSessionManagerTest</innerclass>
    <innernamespace refid="namespacecom_1_1gmp_1_1auth_1_1service">com::gmp::auth::service</innernamespace>
    <briefdescription>
    </briefdescription>
    <detaileddescription>
    </detaileddescription>
    <programlisting>
<codeline lineno="1"><highlight class="keyword">package<sp/></highlight><highlight class="normal">com.gmp.auth.service;</highlight></codeline>
<codeline lineno="2"><highlight class="normal"></highlight></codeline>
<codeline lineno="3"><highlight class="normal"></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>com.gmp.auth.entity.User;</highlight></codeline>
<codeline lineno="4"><highlight class="normal"></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>org.junit.jupiter.api.BeforeEach;</highlight></codeline>
<codeline lineno="5"><highlight class="normal"></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>org.junit.jupiter.api.Test;</highlight></codeline>
<codeline lineno="6"><highlight class="normal"></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>org.junit.jupiter.api.DisplayName;</highlight></codeline>
<codeline lineno="7"><highlight class="normal"></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>org.junit.jupiter.api.extension.ExtendWith;</highlight></codeline>
<codeline lineno="8"><highlight class="normal"></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>org.mockito.InjectMocks;</highlight></codeline>
<codeline lineno="9"><highlight class="normal"></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/>org.mockito.junit.jupiter.MockitoExtension;</highlight></codeline>
<codeline lineno="10"><highlight class="normal"></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/>org.assertj.core.api.Assertions.assertThat;</highlight></codeline>
<codeline lineno="11"><highlight class="normal"></highlight><highlight class="keyword">import</highlight><highlight class="normal"><sp/></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/>org.junit.jupiter.api.Assertions.assertThrows;</highlight></codeline>
<codeline lineno="12"><highlight class="normal"></highlight></codeline>
<codeline lineno="16"><highlight class="normal">@ExtendWith(MockitoExtension.class)</highlight></codeline>
<codeline lineno="17" refid="classcom_1_1gmp_1_1auth_1_1service_1_1MfaSessionManagerTest" refkind="compound"><highlight class="normal">public<sp/>class<sp/><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1MfaSessionManagerTest" kindref="compound">MfaSessionManagerTest</ref><sp/>{</highlight></codeline>
<codeline lineno="18"><highlight class="normal"></highlight></codeline>
<codeline lineno="19"><highlight class="normal"><sp/><sp/><sp/><sp/>@InjectMocks</highlight></codeline>
<codeline lineno="20" refid="classcom_1_1gmp_1_1auth_1_1service_1_1MfaSessionManagerTest_1a49d85a432d11e727bc5449902c5f023a" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">private</highlight><highlight class="normal"><sp/><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1MfaSessionManager" kindref="compound">MfaSessionManager</ref><sp/><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1MfaSessionManagerTest_1a49d85a432d11e727bc5449902c5f023a" kindref="member">mfaSessionManager</ref>;</highlight></codeline>
<codeline lineno="21"><highlight class="normal"></highlight></codeline>
<codeline lineno="22" refid="classcom_1_1gmp_1_1auth_1_1service_1_1MfaSessionManagerTest_1a3797fec3761fa16bacf62f3b9e2b4489" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keyword">private</highlight><highlight class="normal"><sp/>User<sp/><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1MfaSessionManagerTest_1a3797fec3761fa16bacf62f3b9e2b4489" kindref="member">testUser</ref>;</highlight></codeline>
<codeline lineno="23"><highlight class="normal"></highlight></codeline>
<codeline lineno="24"><highlight class="normal"><sp/><sp/><sp/><sp/>@BeforeEach</highlight></codeline>
<codeline lineno="25" refid="classcom_1_1gmp_1_1auth_1_1service_1_1MfaSessionManagerTest_1a04121ddbca9c86dea1994852a642eb57" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1MfaSessionManagerTest_1a04121ddbca9c86dea1994852a642eb57" kindref="member">setUp</ref>()<sp/>{</highlight></codeline>
<codeline lineno="26"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>初始化测试用户</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="27"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>testUser<sp/>=<sp/></highlight><highlight class="keyword">new</highlight><highlight class="normal"><sp/>User();</highlight></codeline>
<codeline lineno="28"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>testUser.setId(1L);</highlight></codeline>
<codeline lineno="29"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>testUser.setUsername(</highlight><highlight class="stringliteral">&quot;testuser&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="30"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>testUser.setUserStatus(User.UserStatus.ACTIVE);</highlight></codeline>
<codeline lineno="31"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="32"><highlight class="normal"></highlight></codeline>
<codeline lineno="33"><highlight class="normal"><sp/><sp/><sp/><sp/>@Test</highlight></codeline>
<codeline lineno="34"><highlight class="normal"><sp/><sp/><sp/><sp/>@DisplayName(</highlight><highlight class="stringliteral">&quot;测试创建会话&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="35" refid="classcom_1_1gmp_1_1auth_1_1service_1_1MfaSessionManagerTest_1aaccb7f6d5c360c17d9503e4565fd6e32" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>void<sp/>testCreateSession()<sp/>{</highlight></codeline>
<codeline lineno="36"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>When</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="37"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>String<sp/>sessionId<sp/>=<sp/>mfaSessionManager.<ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1MfaSessionManager_1a1adfa09c2062d2b32861f43035515a68" kindref="member">createSession</ref>(testUser);</highlight></codeline>
<codeline lineno="38"><highlight class="normal"></highlight></codeline>
<codeline lineno="39"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Then</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="40"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>assertThat(sessionId).isNotNull();</highlight></codeline>
<codeline lineno="41"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>assertThat(sessionId).matches(</highlight><highlight class="stringliteral">&quot;^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="42"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="43"><highlight class="normal"></highlight></codeline>
<codeline lineno="44"><highlight class="normal"><sp/><sp/><sp/><sp/>@Test</highlight></codeline>
<codeline lineno="45"><highlight class="normal"><sp/><sp/><sp/><sp/>@DisplayName(</highlight><highlight class="stringliteral">&quot;测试创建会话时传入null用户&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="46" refid="classcom_1_1gmp_1_1auth_1_1service_1_1MfaSessionManagerTest_1acf361fb9db0cc86bfae13b54da647f56" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>void<sp/>testCreateSessionWithNullUser()<sp/>{</highlight></codeline>
<codeline lineno="47"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>When<sp/>&amp;<sp/>Then</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="48"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>assertThrows(IllegalArgumentException.class,<sp/>()<sp/>-&gt;<sp/>{</highlight></codeline>
<codeline lineno="49"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>mfaSessionManager.createSession(null);</highlight></codeline>
<codeline lineno="50"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>});</highlight></codeline>
<codeline lineno="51"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="52"><highlight class="normal"></highlight></codeline>
<codeline lineno="53"><highlight class="normal"><sp/><sp/><sp/><sp/>@Test</highlight></codeline>
<codeline lineno="54"><highlight class="normal"><sp/><sp/><sp/><sp/>@DisplayName(</highlight><highlight class="stringliteral">&quot;测试获取会话&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="55" refid="classcom_1_1gmp_1_1auth_1_1service_1_1MfaSessionManagerTest_1a91e1eaeb439fddad925ff5d4eeb070a0" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>void<sp/>testGetSession()<sp/>{</highlight></codeline>
<codeline lineno="56"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Given</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="57"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>String<sp/>sessionId<sp/>=<sp/>mfaSessionManager.<ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1MfaSessionManager_1a1adfa09c2062d2b32861f43035515a68" kindref="member">createSession</ref>(testUser);</highlight></codeline>
<codeline lineno="58"><highlight class="normal"></highlight></codeline>
<codeline lineno="59"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>When</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="60"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MfaSessionManager.MfaSession<sp/>session<sp/>=<sp/>mfaSessionManager.<ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1MfaSessionManager_1aa26dd449561742077d4a10620671c847" kindref="member">getSession</ref>(sessionId);</highlight></codeline>
<codeline lineno="61"><highlight class="normal"></highlight></codeline>
<codeline lineno="62"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Then</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="63"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>assertThat(session).isNotNull();</highlight></codeline>
<codeline lineno="64"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>assertThat(session.getSessionId()).isEqualTo(sessionId);</highlight></codeline>
<codeline lineno="65"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>assertThat(session.getUser()).isEqualTo(testUser);</highlight></codeline>
<codeline lineno="66"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="67"><highlight class="normal"></highlight></codeline>
<codeline lineno="68"><highlight class="normal"><sp/><sp/><sp/><sp/>@Test</highlight></codeline>
<codeline lineno="69"><highlight class="normal"><sp/><sp/><sp/><sp/>@DisplayName(</highlight><highlight class="stringliteral">&quot;测试获取不存在的会话&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="70" refid="classcom_1_1gmp_1_1auth_1_1service_1_1MfaSessionManagerTest_1a16f180a27fc44b3c49c829b4e9982667" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>void<sp/>testGetNonExistentSession()<sp/>{</highlight></codeline>
<codeline lineno="71"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>When</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="72"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MfaSessionManager.MfaSession<sp/>session<sp/>=<sp/>mfaSessionManager.<ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1MfaSessionManager_1aa26dd449561742077d4a10620671c847" kindref="member">getSession</ref>(</highlight><highlight class="stringliteral">&quot;non-existent-session&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="73"><highlight class="normal"></highlight></codeline>
<codeline lineno="74"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Then</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="75"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>assertThat(session).isNull();</highlight></codeline>
<codeline lineno="76"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="77"><highlight class="normal"></highlight></codeline>
<codeline lineno="78"><highlight class="normal"><sp/><sp/><sp/><sp/>@Test</highlight></codeline>
<codeline lineno="79"><highlight class="normal"><sp/><sp/><sp/><sp/>@DisplayName(</highlight><highlight class="stringliteral">&quot;测试获取null会话ID&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="80" refid="classcom_1_1gmp_1_1auth_1_1service_1_1MfaSessionManagerTest_1acdf82c9ab3e8296d9f96d38f80a16db7" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>void<sp/>testGetNullSessionId()<sp/>{</highlight></codeline>
<codeline lineno="81"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>When</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="82"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MfaSessionManager.MfaSession<sp/>session<sp/>=<sp/>mfaSessionManager.<ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1MfaSessionManager_1aa26dd449561742077d4a10620671c847" kindref="member">getSession</ref>(</highlight><highlight class="keyword">null</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="83"><highlight class="normal"></highlight></codeline>
<codeline lineno="84"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Then</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="85"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>assertThat(session).isNull();</highlight></codeline>
<codeline lineno="86"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="87"><highlight class="normal"></highlight></codeline>
<codeline lineno="88"><highlight class="normal"><sp/><sp/><sp/><sp/>@Test</highlight></codeline>
<codeline lineno="89"><highlight class="normal"><sp/><sp/><sp/><sp/>@DisplayName(</highlight><highlight class="stringliteral">&quot;测试会话失效&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="90" refid="classcom_1_1gmp_1_1auth_1_1service_1_1MfaSessionManagerTest_1ae30224e3f28e53e1072e8aef5805f953" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>void<sp/>testInvalidateSession()<sp/>{</highlight></codeline>
<codeline lineno="91"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Given</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="92"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>String<sp/>sessionId<sp/>=<sp/>mfaSessionManager.<ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1MfaSessionManager_1a1adfa09c2062d2b32861f43035515a68" kindref="member">createSession</ref>(testUser);</highlight></codeline>
<codeline lineno="93"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="94"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>验证会话创建成功</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="95"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>assertThat(mfaSessionManager.<ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1MfaSessionManager_1aa26dd449561742077d4a10620671c847" kindref="member">getSession</ref>(sessionId)).isNotNull();</highlight></codeline>
<codeline lineno="96"><highlight class="normal"></highlight></codeline>
<codeline lineno="97"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>When</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="98"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>mfaSessionManager.<ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1MfaSessionManager_1a520811b94222ae61889928d98962cfc7" kindref="member">invalidateSession</ref>(sessionId);</highlight></codeline>
<codeline lineno="99"><highlight class="normal"></highlight></codeline>
<codeline lineno="100"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Then</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="101"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>assertThat(mfaSessionManager.<ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1MfaSessionManager_1aa26dd449561742077d4a10620671c847" kindref="member">getSession</ref>(sessionId)).isNull();</highlight></codeline>
<codeline lineno="102"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="103"><highlight class="normal"></highlight></codeline>
<codeline lineno="104"><highlight class="normal"><sp/><sp/><sp/><sp/>@Test</highlight></codeline>
<codeline lineno="105"><highlight class="normal"><sp/><sp/><sp/><sp/>@DisplayName(</highlight><highlight class="stringliteral">&quot;测试失效null会话ID&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="106" refid="classcom_1_1gmp_1_1auth_1_1service_1_1MfaSessionManagerTest_1a16bb74a55dd5cd532ab65f7eea1436bb" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>void<sp/>testInvalidateNullSession()<sp/>{</highlight></codeline>
<codeline lineno="107"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>When<sp/>&amp;<sp/>Then<sp/>-<sp/>不应抛出异常</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="108"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>mfaSessionManager.<ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1MfaSessionManager_1a520811b94222ae61889928d98962cfc7" kindref="member">invalidateSession</ref>(</highlight><highlight class="keyword">null</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="109"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="110"><highlight class="normal"></highlight></codeline>
<codeline lineno="111"><highlight class="normal"><sp/><sp/><sp/><sp/>@Test</highlight></codeline>
<codeline lineno="112"><highlight class="normal"><sp/><sp/><sp/><sp/>@DisplayName(</highlight><highlight class="stringliteral">&quot;测试会话失败尝试计数&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="113" refid="classcom_1_1gmp_1_1auth_1_1service_1_1MfaSessionManagerTest_1a5e85829b5f0e54cb5c25463b73892194" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>void<sp/>testFailedAttempts()<sp/>{</highlight></codeline>
<codeline lineno="114"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Given</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="115"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>String<sp/>sessionId<sp/>=<sp/>mfaSessionManager.<ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1MfaSessionManager_1a1adfa09c2062d2b32861f43035515a68" kindref="member">createSession</ref>(testUser);</highlight></codeline>
<codeline lineno="116"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>MfaSessionManager.MfaSession<sp/>session<sp/>=<sp/>mfaSessionManager.<ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1MfaSessionManager_1aa26dd449561742077d4a10620671c847" kindref="member">getSession</ref>(sessionId);</highlight></codeline>
<codeline lineno="117"><highlight class="normal"></highlight></codeline>
<codeline lineno="118"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Then<sp/>-<sp/>初始失败计数应为0</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="119"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>assertThat(session.getFailedAttempts()).isEqualTo(0);</highlight></codeline>
<codeline lineno="120"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>assertThat(session.isLocked()).isFalse();</highlight></codeline>
<codeline lineno="121"><highlight class="normal"></highlight></codeline>
<codeline lineno="122"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>When<sp/>-<sp/>增加失败尝试</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="123"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>session.<ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1MfaSessionManager_1_1MfaSession_1a6072de9c89ebe386215bca8c0a57198c" kindref="member">incrementFailedAttempts</ref>();</highlight></codeline>
<codeline lineno="124"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="125"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Then</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="126"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>assertThat(session.getFailedAttempts()).isEqualTo(1);</highlight></codeline>
<codeline lineno="127"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>assertThat(session.isLocked()).isFalse();</highlight></codeline>
<codeline lineno="128"><highlight class="normal"></highlight></codeline>
<codeline lineno="129"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>When<sp/>-<sp/>达到锁定阈值</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="130"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal"><sp/>(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>i<sp/>=<sp/>0;<sp/>i<sp/>&lt;<sp/>4;<sp/>i++)<sp/>{</highlight></codeline>
<codeline lineno="131"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>session.incrementFailedAttempts();</highlight></codeline>
<codeline lineno="132"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="133"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="134"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Then</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="135"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>assertThat(session.getFailedAttempts()).isEqualTo(5);</highlight></codeline>
<codeline lineno="136"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>assertThat(session.isLocked()).isTrue();</highlight></codeline>
<codeline lineno="137"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="138"><highlight class="normal"></highlight></codeline>
<codeline lineno="139"><highlight class="normal"><sp/><sp/><sp/><sp/>@Test</highlight></codeline>
<codeline lineno="140"><highlight class="normal"><sp/><sp/><sp/><sp/>@DisplayName(</highlight><highlight class="stringliteral">&quot;测试清理过期会话&quot;</highlight><highlight class="normal">)</highlight></codeline>
<codeline lineno="141" refid="classcom_1_1gmp_1_1auth_1_1service_1_1MfaSessionManagerTest_1af48c62548d0e156ea3430a1106d7dc2f" refkind="member"><highlight class="normal"><sp/><sp/><sp/><sp/>void<sp/>testCleanupExpiredSessions()<sp/>{</highlight></codeline>
<codeline lineno="142"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Given</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="143"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>String<sp/>sessionId1<sp/>=<sp/>mfaSessionManager.<ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1MfaSessionManager_1a1adfa09c2062d2b32861f43035515a68" kindref="member">createSession</ref>(testUser);</highlight></codeline>
<codeline lineno="144"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="145"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>User<sp/>user2<sp/>=<sp/></highlight><highlight class="keyword">new</highlight><highlight class="normal"><sp/>User();</highlight></codeline>
<codeline lineno="146"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>user2.setId(2L);</highlight></codeline>
<codeline lineno="147"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>user2.setUsername(</highlight><highlight class="stringliteral">&quot;testuser2&quot;</highlight><highlight class="normal">);</highlight></codeline>
<codeline lineno="148"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>user2.setUserStatus(User.UserStatus.ACTIVE);</highlight></codeline>
<codeline lineno="149"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="150"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>String<sp/>sessionId2<sp/>=<sp/>mfaSessionManager.<ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1MfaSessionManager_1a1adfa09c2062d2b32861f43035515a68" kindref="member">createSession</ref>(user2);</highlight></codeline>
<codeline lineno="151"><highlight class="normal"></highlight></codeline>
<codeline lineno="152"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>验证两个会话都存在</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="153"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>assertThat(mfaSessionManager.<ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1MfaSessionManager_1aa26dd449561742077d4a10620671c847" kindref="member">getSession</ref>(sessionId1)).isNotNull();</highlight></codeline>
<codeline lineno="154"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>assertThat(mfaSessionManager.<ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1MfaSessionManager_1aa26dd449561742077d4a10620671c847" kindref="member">getSession</ref>(sessionId2)).isNotNull();</highlight></codeline>
<codeline lineno="155"><highlight class="normal"></highlight></codeline>
<codeline lineno="156"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>When<sp/>-<sp/>使一个会话失效</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="157"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>mfaSessionManager.<ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1MfaSessionManager_1a520811b94222ae61889928d98962cfc7" kindref="member">invalidateSession</ref>(sessionId1);</highlight></codeline>
<codeline lineno="158"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="159"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>清理过期会话</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="160"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>mfaSessionManager.<ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1MfaSessionManager_1a6121d9c31c1deb3b42292886c6f57859" kindref="member">cleanupExpiredSessions</ref>();</highlight></codeline>
<codeline lineno="161"><highlight class="normal"></highlight></codeline>
<codeline lineno="162"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//<sp/>Then<sp/>-<sp/>只有一个会话应该存在</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="163"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>assertThat(mfaSessionManager.<ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1MfaSessionManager_1aa26dd449561742077d4a10620671c847" kindref="member">getSession</ref>(sessionId1)).isNull();</highlight></codeline>
<codeline lineno="164"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>assertThat(mfaSessionManager.<ref refid="classcom_1_1gmp_1_1auth_1_1service_1_1MfaSessionManager_1aa26dd449561742077d4a10620671c847" kindref="member">getSession</ref>(sessionId2)).isNotNull();</highlight></codeline>
<codeline lineno="165"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="166"><highlight class="normal"></highlight></codeline>
<codeline lineno="171"><highlight class="normal">}</highlight></codeline>
    </programlisting>
    <location file="auth-service/src/test/java/com/gmp/auth/service/MfaSessionManagerTest.java"/>
  </compounddef>
</doxygen>
