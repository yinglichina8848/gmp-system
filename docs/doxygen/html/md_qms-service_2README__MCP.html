<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>GMP系统: MCP集成文档 - QMS系统</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">GMP系统<span id="projectnumber">&#160;0.1.1</span>
   </div>
   <div id="projectbrief">GMP系统文档</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_qms-service_2README__MCP.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">MCP集成文档 - QMS系统</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1>1. 概述</h1>
<p>本文档详细介绍了QMS（质量管理系统）中MCP（Model Context Protocol）集成的实现、配置和使用方法。MCP协议是系统间通信的核心机制，通过统一的接口和安全认证确保各系统间数据交换的安全性和高效性。</p>
<h1>2. MCP架构</h1>
<h2>2.1 核心组件</h2>
<p>QMS系统的MCP集成包含以下核心组件：</p>
<ul>
<li>**安全认证模块**：负责MCP请求的身份验证和权限控制</li>
<li>**服务集成接口**：提供与其他系统（EDMS、MES、LIMS、ERP等）的集成接口</li>
<li>**性能优化模块**：包含缓存、断路器、异步执行等性能优化机制</li>
<li>**监控系统**：收集和展示MCP调用的性能指标和健康状态</li>
<li>**消息队列**：实现系统间的异步通信</li>
</ul>
<h2>2.2 数据流</h2>
<div class="fragment"><div class="line">外部系统 → MCP认证 → 服务接口 → 业务处理 → 响应/消息通知 → 外部系统</div>
</div><!-- fragment --><h1>3. 安全认证</h1>
<h2>3.1 认证机制</h2>
<p>QMS系统使用<code>McpAuthenticationToken</code>进行身份验证，支持以下认证方式：</p>
<ul>
<li>令牌认证（推荐）</li>
<li>基本认证</li>
<li>系统证书认证</li>
</ul>
<h2>3.2 权限管理</h2>
<p>权限通过基于角色的访问控制（RBAC）实现，主要权限包括：</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">权限   </th><th class="markdownTableHeadNone">说明   </th><th class="markdownTableHeadNone">适用系统    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">mcp:read   </td><td class="markdownTableBodyNone">读取QMS数据   </td><td class="markdownTableBodyNone">所有集成系统    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">mcp:write   </td><td class="markdownTableBodyNone">写入QMS数据   </td><td class="markdownTableBodyNone">EDMS, MES    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">mcp:admin   </td><td class="markdownTableBodyNone">管理权限   </td><td class="markdownTableBodyNone">管理员系统   </td></tr>
</table>
<h2>3.3 安全最佳实践</h2>
<ul>
<li>所有MCP通信必须使用HTTPS加密</li>
<li>令牌有效期最长为24小时</li>
<li>敏感操作需要二次验证</li>
<li>定期审计访问日志</li>
</ul>
<h1>4. 集成接口</h1>
<h2>4.1 RESTful API</h2>
<p>QMS系统提供以下MCP RESTful接口：</p>
<h3>4.1.1 文档管理接口</h3>
<div class="fragment"><div class="line">GET /api/mcp/documents/{documentId}</div>
<div class="line">POST /api/mcp/documents</div>
<div class="line">PUT /api/mcp/documents/{documentId}</div>
<div class="line">DELETE /api/mcp/documents/{documentId}</div>
</div><!-- fragment --><h3>4.1.2 批次管理接口</h3>
<div class="fragment"><div class="line">GET /api/mcp/batches/{batchId}</div>
<div class="line">POST /api/mcp/batches</div>
<div class="line">GET /api/mcp/batches/search</div>
</div><!-- fragment --><h3>4.1.3 检测数据接口</h3>
<div class="fragment"><div class="line">GET /api/mcp/inspections/{inspectionId}</div>
<div class="line">POST /api/mcp/inspections</div>
</div><!-- fragment --><h2>4.2 数据传输对象（DTOs）</h2>
<p>系统使用以下DTO进行数据交换：</p>
<ul>
<li><code>DocumentDTO</code>：文档信息</li>
<li><code>BatchInfoDTO</code>：批次信息</li>
<li><code>ProcessParameterDTO</code>：工艺参数</li>
<li><code>MaintenanceRecordDTO</code>：维护记录</li>
</ul>
<h1>5. 消息队列集成</h1>
<h2>5.1 队列配置</h2>
<p>QMS系统使用RabbitMQ作为消息中间件，配置了以下队列：</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">队列名称   </th><th class="markdownTableHeadNone">用途   </th><th class="markdownTableHeadNone">目标系统    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">qms.edms.queue   </td><td class="markdownTableBodyNone">与EDMS系统通信   </td><td class="markdownTableBodyNone">EDMS    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">qms.mes.queue   </td><td class="markdownTableBodyNone">与MES系统通信   </td><td class="markdownTableBodyNone">MES    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">qms.lims.queue   </td><td class="markdownTableBodyNone">与LIMS系统通信   </td><td class="markdownTableBodyNone">LIMS    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">qms.erp.queue   </td><td class="markdownTableBodyNone">与ERP系统通信   </td><td class="markdownTableBodyNone">ERP    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">qms.training.queue   </td><td class="markdownTableBodyNone">与培训系统通信   </td><td class="markdownTableBodyNone">Training    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">qms.equipment.queue   </td><td class="markdownTableBodyNone">与设备系统通信   </td><td class="markdownTableBodyNone">Equipment    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">qms.mcp.dead.letter.queue   </td><td class="markdownTableBodyNone">死信队列   </td><td class="markdownTableBodyNone">内部处理   </td></tr>
</table>
<h2>5.2 消息格式</h2>
<p>消息使用JSON格式，包含以下字段：</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  &quot;messageId&quot;: &quot;唯一消息ID&quot;,</div>
<div class="line">  &quot;timestamp&quot;: &quot;发送时间&quot;,</div>
<div class="line">  &quot;sourceSystem&quot;: &quot;发送系统&quot;,</div>
<div class="line">  &quot;operation&quot;: &quot;操作类型&quot;,</div>
<div class="line">  &quot;payload&quot;: {&quot;业务数据&quot;},</div>
<div class="line">  &quot;retryCount&quot;: 重试次数</div>
<div class="line">}</div>
</div><!-- fragment --><h2>5.3 消息发送示例</h2>
<div class="fragment"><div class="line"><span class="comment">// 发送消息到EDMS系统</span></div>
<div class="line">Map&lt;String, Object&gt; payload = <span class="keyword">new</span> HashMap&lt;&gt;();</div>
<div class="line">payload.put(<span class="stringliteral">&quot;documentId&quot;</span>, <span class="stringliteral">&quot;DOC-001&quot;</span>);</div>
<div class="line">payload.put(<span class="stringliteral">&quot;status&quot;</span>, <span class="stringliteral">&quot;APPROVED&quot;</span>);</div>
<div class="line"> </div>
<div class="line">String messageId = mcpMessageService.sendToEdms(payload, <span class="stringliteral">&quot;DOCUMENT_STATUS_UPDATE&quot;</span>);</div>
</div><!-- fragment --><h1>6. 性能优化</h1>
<h2>6.1 缓存策略</h2>
<p>系统实现了多级缓存机制：</p>
<ul>
<li>本地内存缓存：适用于频繁访问的数据</li>
<li>Redis分布式缓存：适用于跨实例共享的数据</li>
<li>结果缓存：缓存MCP调用结果，减少重复计算</li>
</ul>
<p>缓存配置可在<code>McpPerformanceConfig</code>中调整。</p>
<h2>6.2 断路器模式</h2>
<p>使用Resilience4J实现断路器模式，配置参数：</p>
<ul>
<li>失败阈值：50%</li>
<li>滑动窗口大小：100次调用</li>
<li>熔断时间：30秒</li>
<li>半开状态调用数：10次</li>
</ul>
<h2>6.3 异步执行</h2>
<p>系统提供异步执行服务<code>McpAsyncExecutionService</code>，支持：</p>
<ul>
<li>批量异步调用</li>
<li>并行处理</li>
<li>带超时的异步执行</li>
<li>带重试机制的异步执行</li>
</ul>
<h1>7. 监控与日志</h1>
<h2>7.1 性能指标</h2>
<p>系统收集以下MCP性能指标：</p>
<ul>
<li>调用次数（总次数、成功、失败）</li>
<li>平均响应时间</li>
<li>最大/最小响应时间</li>
<li>错误率</li>
<li>缓存命中率</li>
</ul>
<h2>7.2 监控API</h2>
<p>访问以下API获取监控数据：</p>
<div class="fragment"><div class="line">GET /api/mcp/metrics       # 系统整体性能指标</div>
<div class="line">GET /api/mcp/metrics/tools/{toolName}  # 特定工具性能指标</div>
<div class="line">GET /api/mcp/metrics/resources/{resourceName}  # 特定资源性能指标</div>
<div class="line">GET /api/mcp/health        # 系统健康状态</div>
</div><!-- fragment --><h2>7.3 日志格式</h2>
<p>MCP日志包含以下关键字段：</p>
<ul>
<li><code>mcp_trace_id</code>：追踪ID</li>
<li><code>source_system</code>：来源系统</li>
<li><code>operation</code>：操作类型</li>
<li><code>duration_ms</code>：执行时间</li>
<li><code>status</code>：执行状态</li>
</ul>
<h1>8. 故障排除</h1>
<h2>8.1 常见问题</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">问题   </th><th class="markdownTableHeadNone">可能原因   </th><th class="markdownTableHeadNone">解决方案    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">认证失败   </td><td class="markdownTableBodyNone">令牌过期或无效   </td><td class="markdownTableBodyNone">重新获取令牌    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">权限不足   </td><td class="markdownTableBodyNone">缺少必要权限   </td><td class="markdownTableBodyNone">检查权限配置    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">断路器触发   </td><td class="markdownTableBodyNone">目标系统异常   </td><td class="markdownTableBodyNone">检查目标系统状态，等待断路器重置    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">消息发送失败   </td><td class="markdownTableBodyNone">队列连接问题   </td><td class="markdownTableBodyNone">检查RabbitMQ连接    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">性能下降   </td><td class="markdownTableBodyNone">缓存配置不当   </td><td class="markdownTableBodyNone">调整缓存策略，增加资源   </td></tr>
</table>
<h2>8.2 诊断工具</h2>
<ul>
<li>监控控制台：查看实时性能指标</li>
<li>日志分析：分析系统日志</li>
<li>健康检查API：检查系统状态</li>
</ul>
<h1>9. 开发与集成指南</h1>
<h2>9.1 集成步骤</h2>
<ol type="1">
<li>在目标系统中实现MCP客户端</li>
<li>配置认证信息</li>
<li>实现业务逻辑</li>
<li>配置消息处理</li>
<li>进行集成测试</li>
</ol>
<h2>9.2 代码示例</h2>
<h3>服务集成示例</h3>
<div class="fragment"><div class="line"><span class="comment">// 创建MCP客户端</span></div>
<div class="line">McpClient client = <span class="keyword">new</span> McpClientBuilder()</div>
<div class="line">    .withBaseUrl(<span class="stringliteral">&quot;http://qms-system/api/mcp&quot;</span>)</div>
<div class="line">    .withAuthToken(<span class="stringliteral">&quot;your-auth-token&quot;</span>)</div>
<div class="line">    .build();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 调用文档接口</span></div>
<div class="line">DocumentDTO document = client.getDocument(<span class="stringliteral">&quot;DOC-001&quot;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 处理响应</span></div>
<div class="line"><span class="keywordflow">if</span> (document != <span class="keyword">null</span>) {</div>
<div class="line">    <span class="comment">// 业务逻辑</span></div>
<div class="line">}</div>
</div><!-- fragment --><h3>消息处理示例</h3>
<div class="fragment"><div class="line"><span class="comment">// 注册消息处理器</span></div>
<div class="line">mcpMessageListener.registerMessageHandler(<span class="stringliteral">&quot;DOCUMENT_APPROVED&quot;</span>, message -&gt; {</div>
<div class="line">    <span class="comment">// 处理文档批准消息</span></div>
<div class="line">    Map&lt;String, Object&gt; payload = (Map&lt;String, Object&gt;) message.get(<span class="stringliteral">&quot;payload&quot;</span>);</div>
<div class="line">    String documentId = payload.get(<span class="stringliteral">&quot;documentId&quot;</span>).toString();</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// 执行业务逻辑</span></div>
<div class="line">    documentService.updateDocumentStatus(documentId, <span class="stringliteral">&quot;APPROVED&quot;</span>);</div>
<div class="line">});</div>
</div><!-- fragment --><h1>10. 版本控制</h1>
<h2>10.1 当前版本</h2>
<ul>
<li>主要版本：1.x</li>
<li>最新版本：1.2.0</li>
</ul>
<h2>10.2 版本兼容性</h2>
<ul>
<li>1.x版本向下兼容0.x版本</li>
<li>主要版本升级（如1.x到2.x）可能不兼容</li>
</ul>
<h2>10.3 升级指南</h2>
<p>版本升级时请参考升级文档，主要包括：</p>
<ol type="1">
<li>备份现有配置</li>
<li>检查兼容性说明</li>
<li>升级依赖包</li>
<li>更新API调用</li>
<li>测试集成功能</li>
</ol>
<h1>11. 联系与支持</h1>
<p>如有问题或需要支持，请联系：</p>
<ul>
<li><a href="#" onclick="location.href='mai'+'lto:'+'技术支'+'持团'+'队：s'+'up'+'por'+'t@'+'gmp'+'-s'+'yst'+'em'+'.co'+'m'; return false;">技术支持团<span class="obfuscator">.nosp@m.</span>队：su<span class="obfuscator">.nosp@m.</span>pport<span class="obfuscator">.nosp@m.</span>@gmp<span class="obfuscator">.nosp@m.</span>-syst<span class="obfuscator">.nosp@m.</span>em.c<span class="obfuscator">.nosp@m.</span>om</a></li>
<li><a href="#" onclick="location.href='mai'+'lto:'+'集成专'+'家：'+'int'+'eg'+'rat'+'io'+'n@g'+'mp'+'-sy'+'st'+'em.'+'co'+'m'; return false;">集成专家：<span class="obfuscator">.nosp@m.</span>inte<span class="obfuscator">.nosp@m.</span>grati<span class="obfuscator">.nosp@m.</span>on@g<span class="obfuscator">.nosp@m.</span>mp-sy<span class="obfuscator">.nosp@m.</span>stem<span class="obfuscator">.nosp@m.</span>.com</a></li>
<li><a href="#" onclick="location.href='mai'+'lto:'+'紧急支'+'持：'+'eme'+'rg'+'enc'+'y@'+'gmp'+'-s'+'yst'+'em'+'.co'+'m'; return false;">紧急支持：<span class="obfuscator">.nosp@m.</span>emer<span class="obfuscator">.nosp@m.</span>gency<span class="obfuscator">.nosp@m.</span>@gmp<span class="obfuscator">.nosp@m.</span>-syst<span class="obfuscator">.nosp@m.</span>em.c<span class="obfuscator">.nosp@m.</span>om</a></li>
</ul>
<h1>12. 附录</h1>
<h2>12.1 错误代码</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">代码   </th><th class="markdownTableHeadNone">描述   </th><th class="markdownTableHeadNone">建议操作    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">4001   </td><td class="markdownTableBodyNone">认证失败   </td><td class="markdownTableBodyNone">检查认证信息    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">4002   </td><td class="markdownTableBodyNone">权限不足   </td><td class="markdownTableBodyNone">申请必要权限    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">4003   </td><td class="markdownTableBodyNone">参数错误   </td><td class="markdownTableBodyNone">检查参数格式    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">5001   </td><td class="markdownTableBodyNone">内部错误   </td><td class="markdownTableBodyNone">联系技术支持    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">5002   </td><td class="markdownTableBodyNone">外部系统错误   </td><td class="markdownTableBodyNone">检查外部系统状态    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">5003   </td><td class="markdownTableBodyNone">超时错误   </td><td class="markdownTableBodyNone">增加超时时间或重试   </td></tr>
</table>
<h2>12.2 配置参数</h2>
<p>主要配置参数可在<code>application.yml</code>中设置：</p>
<div class="fragment"><div class="line">mcp:</div>
<div class="line">  security:</div>
<div class="line">    token-validity: 86400  # 令牌有效期（秒）</div>
<div class="line">  performance:</div>
<div class="line">    cache-ttl: 3600        # 缓存有效期（秒）</div>
<div class="line">    max-concurrent-calls: 100  # 最大并发调用数</div>
<div class="line">  messaging:</div>
<div class="line">    retry-count: 3         # 消息重试次数</div>
<div class="line">    retry-interval: 1000   # 重试间隔（毫秒）</div>
</div><!-- fragment --><hr  />
<p>本文档最后更新时间：2023年12月15日 版本：1.0 </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
