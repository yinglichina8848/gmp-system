# 认证子系统业务流程详细描述

## 1. 用户管理业务流程

### 1.1 用户注册流程
#### 1.1.1 流程概述
用户注册是认证系统的基础流程，允许新用户创建账户并获得系统访问权限。根据用户类型不同，注册流程分为管理员创建和自助注册两种方式。

#### 1.1.2 管理员创建流程
```
参与者：系统管理员、新用户
前置条件：系统管理员已登录系统
后置条件：新用户账户创建成功并可使用

流程步骤：
1. 系统管理员进入用户管理页面
2. 点击"新增用户"按钮
3. 填写用户基本信息：
   - 用户名（必填，唯一性校验）
   - 姓名（必填）
   - 邮箱（必填，格式校验）
   - 所属部门（必填）
   - 联系电话（可选）
4. 设置用户初始角色
5. 点击"保存"按钮
6. 系统验证输入信息合法性
7. 系统生成初始密码
8. 系统发送账户创建通知邮件
9. 用户账户创建成功
```

#### 1.1.3 自助注册流程
```
参与者：注册用户、系统管理员
前置条件：系统开启自助注册功能
后置条件：用户提交注册申请，等待管理员审批

流程步骤：
1. 用户访问系统注册页面
2. 填写注册信息：
   - 用户名（必填，唯一性校验）
   - 姓名（必填）
   - 邮箱（必填，格式校验）
   - 所属部门（必填）
   - 联系电话（可选）
3. 阅读并同意用户协议
4. 点击"提交注册"按钮
5. 系统验证输入信息合法性
6. 系统生成注册申请并提交审批
7. 系统通知相关管理员有新注册申请
8. 注册申请进入待审批状态
```

#### 1.1.4 审批流程
```
参与者：待审批用户、审批管理员
前置条件：存在待审批的注册申请
后置条件：注册申请审批通过或拒绝

流程步骤：
1. 审批管理员登录系统
2. 进入注册审批页面
3. 查看待审批注册申请列表
4. 选择需要审批的申请
5. 查看申请详细信息
6. 选择审批结果：
   - 通过：创建用户账户，发送账户信息邮件
   - 拒绝：填写拒绝原因，通知申请人
7. 系统更新申请状态
8. 系统执行相应操作（创建账户或发送拒绝通知）
```

### 1.2 用户信息维护流程
#### 1.2.1 流程概述
已注册用户的信息可能需要更新维护，包括基本信息修改、角色调整、状态变更等操作。

#### 1.2.2 基本信息修改流程
```
参与者：用户、系统
前置条件：用户已登录系统
后置条件：用户信息更新成功

流程步骤：
1. 用户进入个人信息页面
2. 点击"编辑信息"按钮
3. 修改可编辑的信息项：
   - 姓名（如允许修改）
   - 邮箱（如允许修改）
   - 联系电话
   - 其他可修改字段
4. 点击"保存"按钮
5. 系统验证输入信息合法性
6. 系统更新用户信息
7. 系统记录信息变更日志
8. 显示更新成功提示
```

#### 1.2.3 管理员维护流程
```
参与者：系统管理员、用户
前置条件：管理员已登录系统
后置条件：用户信息更新成功

流程步骤：
1. 管理员进入用户管理页面
2. 搜索并选择目标用户
3. 点击"编辑用户"按钮
4. 修改用户信息：
   - 基本信息（姓名、邮箱等）
   - 所属部门
   - 用户角色
   - 用户状态
5. 点击"保存"按钮
6. 系统验证输入信息合法性
7. 系统更新用户信息
8. 系统记录管理员操作日志
9. 显示更新成功提示
```

### 1.3 用户状态管理流程
#### 1.3.1 状态变更流程
```
参与者：系统管理员、用户
前置条件：管理员已登录系统
后置条件：用户状态更新成功

流程步骤：
1. 管理员进入用户管理页面
2. 搜索并选择目标用户
3. 查看用户当前状态
4. 选择新的用户状态：
   - 启用：允许用户登录系统
   - 禁用：禁止用户登录系统
   - 锁定：临时锁定用户账户
5. 填写状态变更原因（必填）
6. 点击"确认变更"按钮
7. 系统验证操作权限
8. 系统更新用户状态
9. 系统记录状态变更日志
10. 如用户当前已登录，强制下线
```

## 2. 认证业务流程

### 2.1 用户登录流程
#### 2.1.1 流程概述
用户登录是认证系统的核心流程，验证用户身份并建立会话。

#### 2.1.2 标准登录流程
```
参与者：用户、认证系统
前置条件：用户拥有有效账户
后置条件：用户成功登录系统，获得访问令牌

流程步骤：
1. 用户访问系统登录页面
2. 输入用户名和密码
3. 点击"登录"按钮
4. 系统验证用户名是否存在
5. 系统验证密码是否正确
6. 系统检查用户账户状态
7. 系统生成JWT访问令牌和刷新令牌
8. 系统记录登录日志
9. 系统返回令牌信息给客户端
10. 客户端保存令牌
11. 用户进入系统主页
```

#### 2.1.3 登录失败处理流程
```
参与者：用户、认证系统
前置条件：用户登录验证失败
后置条件：用户登录失败，可能触发安全机制

流程步骤：
1. 用户输入用户名和密码
2. 点击"登录"按钮
3. 系统验证用户名和密码
4. 验证失败时：
   - 用户名不存在：提示用户名错误
   - 密码错误：提示密码错误
   - 账户锁定：提示账户已锁定
5. 系统记录登录失败日志
6. 系统更新用户失败次数
7. 如达到失败次数阈值：
   - 锁定用户账户
   - 发送安全告警
8. 显示相应错误提示信息
```

### 2.2 会话管理流程
#### 2.2.1 会话维持流程
```
参与者：用户、认证系统
前置条件：用户已成功登录
后置条件：用户会话保持有效

流程步骤：
1. 用户发起受保护资源请求
2. 客户端携带访问令牌
3. 系统验证令牌有效性
4. 系统解析用户身份信息
5. 系统检查用户权限
6. 如令牌即将过期：
   - 自动使用刷新令牌获取新令牌
7. 系统处理用户请求
8. 返回请求结果给用户
```

#### 2.2.2 会话超时流程
```
参与者：用户、认证系统
前置条件：用户会话超时
后置条件：用户会话终止，需重新登录

流程步骤：
1. 用户长时间无操作
2. 系统检测到会话超时
3. 系统自动清除本地会话信息
4. 系统将用户重定向到登录页面
5. 用户需要重新登录系统
6. 系统记录会话超时日志
```

### 2.3 用户登出流程
#### 2.3.1 主动登出流程
```
参与者：用户、认证系统
前置条件：用户已登录系统
后置条件：用户会话终止，令牌失效

流程步骤：
1. 用户点击"登出"按钮
2. 客户端发送登出请求
3. 系统验证请求合法性
4. 系统将令牌加入黑名单
5. 系统清除会话相关信息
6. 系统记录登出日志
7. 系统返回登出成功响应
8. 客户端清除本地令牌
9. 页面跳转到登录页面
```

## 3. 权限管理业务流程

### 3.1 权限分配流程
#### 3.1.1 角色权限分配流程
```
参与者：安全管理员、角色、权限
前置条件：安全管理员已登录系统
后置条件：角色权限关系建立

流程步骤：
1. 安全管理员进入角色管理页面
2. 选择需要配置权限的角色
3. 点击"权限配置"按钮
4. 查看角色当前权限列表
5. 选择需要添加的权限：
   - 从权限列表中勾选
   - 支持批量选择
6. 点击"保存"按钮
7. 系统验证权限分配合法性
8. 系统更新角色权限关系
9. 系统记录权限变更日志
10. 显示保存成功提示
```

#### 3.1.2 用户角色分配流程
```
参与者：系统管理员、用户、角色
前置条件：管理员已登录系统
后置条件：用户角色关系建立

流程步骤：
1. 管理员进入用户管理页面
2. 选择需要配置角色的用户
3. 点击"角色分配"按钮
4. 查看用户当前角色列表
5. 选择需要分配的角色：
   - 从角色列表中勾选
   - 支持批量选择
6. 点击"保存"按钮
7. 系统验证角色分配合法性
8. 系统更新用户角色关系
9. 系统记录角色变更日志
10. 显示保存成功提示
```

### 3.2 权限验证流程
#### 3.2.1 API权限验证流程
```
参与者：用户、认证系统、业务系统
前置条件：用户已登录系统
后置条件：请求被允许或拒绝

流程步骤：
1. 用户发起API请求
2. 请求携带访问令牌
3. 网关层拦截请求
4. 调用认证服务验证令牌
5. 认证服务解析用户身份
6. 认证服务获取用户权限列表
7. 认证服务验证用户是否有该API权限
8. 返回验证结果给网关：
   - 允许：转发请求到业务服务
   - 拒绝：返回403错误
9. 业务服务处理请求
10. 返回处理结果给用户
```

## 4. 安全审计业务流程

### 4.1 操作日志记录流程
#### 4.1.1 日志生成流程
```
参与者：用户、系统、日志服务
前置条件：用户执行关键操作
后置条件：操作日志被记录

流程步骤：
1. 用户执行关键操作
2. 系统拦截操作请求
3. 系统收集日志信息：
   - 操作用户ID和姓名
   - 操作类型和描述
   - 操作对象和参数
   - 操作时间和结果
   - 客户端IP和设备信息
4. 系统将日志信息发送到日志服务
5. 日志服务验证日志格式
6. 日志服务将日志存储到缓存
7. 日志服务定期同步到持久化存储
8. 日志记录完成
```

### 4.2 安全事件处理流程
#### 4.2.1 异常登录检测流程
```
参与者：用户、系统、安全管理员
前置条件：系统检测到异常登录行为
后置条件：安全事件被处理

流程步骤：
1. 用户尝试登录系统
2. 系统检测到异常行为：
   - 短时间内多次登录失败
   - 异常地理位置登录
   - 异常设备登录
3. 系统生成安全事件
4. 系统记录详细事件信息
5. 系统发送告警通知给安全管理员
6. 安全管理员查看安全事件
7. 安全管理员分析事件原因
8. 安全管理员采取相应措施：
   - 锁定账户
   - 通知用户
   - 加强安全策略
9. 系统记录事件处理结果
```

## 5. 密码管理业务流程

### 5.1 密码修改流程
#### 5.1.1 用户自主修改流程
```
参与者：用户、系统
前置条件：用户已登录系统
后置条件：用户密码更新成功

流程步骤：
1. 用户进入密码修改页面
2. 输入当前密码
3. 输入新密码
4. 确认新密码
5. 点击"修改密码"按钮
6. 系统验证当前密码正确性
7. 系统验证新密码复杂度
8. 系统验证两次输入一致性
9. 系统更新用户密码（加密存储）
10. 系统记录密码变更日志
11. 系统发送密码修改通知邮件
12. 显示修改成功提示
```

### 5.2 密码重置流程
#### 5.2.1 管理员重置流程
```
参与者：管理员、用户、系统
前置条件：管理员已登录系统
后置条件：用户密码被重置

流程步骤：
1. 管理员进入用户管理页面
2. 选择需要重置密码的用户
3. 点击"重置密码"按钮
4. 系统生成随机初始密码
5. 系统更新用户密码（加密存储）
6. 系统记录密码重置日志
7. 系统发送密码重置通知邮件
8. 显示重置成功提示
```

## 6. 业务流程约束和规则

### 6.1 数据完整性约束
1. 所有关键业务操作必须记录审计日志
2. 用户信息变更需要原因说明
3. 权限变更需要审批流程
4. 密码历史记录，防止重复使用

### 6.2 安全约束
1. 密码必须符合复杂度要求
2. 登录失败超过阈值需锁定账户
3. 会话超时时间符合安全要求
4. 敏感操作需要二次确认

### 6.3 合规约束
1. 所有操作符合GMP法规要求
2. 关键数据变更可追溯
3. 权限分配符合最小权限原则
4. 审计日志保存期限符合法规要求