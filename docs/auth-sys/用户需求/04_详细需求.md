# 认证与权限管理系统详细需求分析

请查看[详细需求目录](详细需求)下的文档内容。

## 1. 用户认证模块 (Authentication)

### 1.1 功能需求

#### 1.1.1 JWT令牌认证
- **登录认证**：用户名/密码验证，生成JWT访问令牌
- **令牌验证**：Bearer Token在请求头中传递
- **令牌刷新**：临近过期时自动生成新令牌
- **令牌吊销**：登出时清除令牌缓存
- **中药专业人员特殊认证**：针对中药鉴定师、炮制师等专业人员的认证支持

#### 1.1.2 多因子认证（预留扩展）
- **短信验证码**：关键操作二次验证
- **动态令牌**：时间同步验证器
- **生物识别**：指纹/人脸识别验证
- **中药专业认证**：专业资格证书验证

### 1.2 数据模型

#### 1.2.1 用户表 (sys_users)
```sql
CREATE TABLE IF NOT EXISTS sys_users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE,
    mobile VARCHAR(20),
    full_name VARCHAR(100) NOT NULL,
    password_hash VARCHAR(200) NOT NULL,
    user_status VARCHAR(20) NOT NULL DEFAULT 'ACTIVE',
    last_login_time TIMESTAMP,
    last_login_ip VARCHAR(50),
    password_expired_at TIMESTAMP,
    login_attempts INTEGER NOT NULL DEFAULT 0,
    locked_until TIMESTAMP,
    professional_certifications JSONB, -- 专业认证信息（如中药鉴定师证书等）
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by BIGINT,
    updated_by BIGINT,
    version INTEGER NOT NULL DEFAULT 1
);
```

#### 1.2.2 JWT令牌缓存 (Token存储在Redis)
```
Key: auth:token:{userId}
Value: {
    "token": "jwt-token-string",
    "issuedAt": "2024-01-01T00:00:00Z",
    "expiresAt": "2024-01-01T01:00:00Z",
    "refreshToken": "refresh-token-string"
}
```

## 2. 权限管理模块 (Authorization)

### 2.1 功能需求

#### 2.1.1 基于角色的访问控制 (RBAC)
- **角色定义**：系统预定义角色（ADMIN, QUALITY_MANAGER, OPERATOR等）
- **权限分配**：将权限原子操作分配给角色
- **用户授权**：将角色分配给用户
- **动态权限**：运行时权限检查，无需重启应用

#### 2.1.2 权限验证服务
- **接口权限**：REST API级别的权限控制
- **数据权限**：按用户/部门/角色划分数据可见性
- **操作权限**：增删改查等具体操作权限控制

### 2.2 数据模型

#### 2.2.1 角色表 (roles)
```sql
CREATE TABLE roles (
    id BIGSERIAL PRIMARY KEY,
    role_code VARCHAR(50) UNIQUE NOT NULL,
    role_name VARCHAR(100) NOT NULL,
    description TEXT,
    is_system_role BOOLEAN DEFAULT FALSE,
    is_tcm_role BOOLEAN DEFAULT FALSE, -- 是否为中药专业角色
    tcm_role_type VARCHAR(50), -- 中药角色类型：TCM_APPRAISER, TCM_PROCESSOR, TCM_INSPECTOR
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 2.2.2 权限表 (permissions)
```sql
CREATE TABLE permissions (
    id BIGSERIAL PRIMARY KEY,
    permission_code VARCHAR(100) UNIQUE NOT NULL,
    permission_name VARCHAR(100) NOT NULL,
    resource_type VARCHAR(50), -- API, DATA, MENU
    resource_pattern VARCHAR(200), -- /api/qms/deviations/**
    operation VARCHAR(50), -- READ, WRITE, DELETE
    description TEXT,
    is_tcm_permission BOOLEAN DEFAULT FALSE, -- 是否为中药专业权限
    tcm_permission_category VARCHAR(50), -- 中药权限类别：HERB_INSPECTION, PROCESSING_OPERATION, TCM_QUALITY_CONTROL
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 2.2.3 用户角色关联表 (user_roles)
```sql
CREATE TABLE user_roles (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL,
    role_id BIGINT NOT NULL,
    assigned_by BIGINT,
    assigned_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES sys_users(id),
    FOREIGN KEY (role_id) REFERENCES roles(id),
    UNIQUE(user_id, role_id)
);
```

#### 2.2.4 角色权限关联表 (role_permissions)
```sql
CREATE TABLE role_permissions (
    id BIGSERIAL PRIMARY KEY,
    role_id BIGINT NOT NULL,
    permission_id BIGINT NOT NULL,
    granted_by BIGINT,
    granted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (role_id) REFERENCES roles(id),
    FOREIGN KEY (permission_id) REFERENCES permissions(id),
    UNIQUE(role_id, permission_id)
);
```

## 3. 操作审计模块 (Audit Logging)

### 3.1 功能需求

#### 3.1.1 审计日志记录
- **登录审计**：记录登录成功/失败事件
- **权限变更**：记录角色权限分配变更
- **重要操作**：记录系统关键业务操作
- **API访问**：记录所有受保护API的访问

#### 3.1.2 审计查询与导出
- **条件查询**：按用户、时间、操作类型查询
- **日志导出**：支持PDF/Excel格式导出
- **统计报表**：活跃用户、访问统计等

### 3.2 数据模型

#### 3.2.1 操作日志表 (operation_logs)
```sql
CREATE TABLE operation_logs (
    id BIGSERIAL PRIMARY KEY,
    user_id VARCHAR(100) NOT NULL, -- 用户标识
    username VARCHAR(100),
    user_department VARCHAR(100),
    operation_type VARCHAR(50) NOT NULL, -- LOGIN, LOGOUT, API_CALL, PERMISSION_CHANGE
    operation_description TEXT,
    api_endpoint VARCHAR(500), -- API端点
    http_method VARCHAR(10), -- GET, POST, PUT, DELETE
    client_ip VARCHAR(45), -- IPv4/IPv6
    user_agent TEXT,
    success BOOLEAN DEFAULT TRUE,
    error_message VARCHAR(500),
    session_id VARCHAR(50),
    request_payload TEXT, -- 请求数据
    response_payload TEXT, -- 响应数据（脱敏）
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## 4. REST API接口设计

### 4.1 认证接口

#### 4.1.1 用户登录
```
POST /api/auth/login
Content-Type: application/json

{
    "username": "operator001",
    "password": "P@ssw0rd123"
}

Response:
{
    "success": true,
    "data": {
        "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
        "refreshToken": "refresh-token-uuid",
        "user": {
            "userId": 1,
            "username": "operator001",
            "roles": ["OPERATOR"],
            "permissions": ["deviation:create", "batch:read"]
        },
        "expiresIn": 3600
    }
}
```

#### 3.1.2 刷新访问令牌
```
POST /api/auth/refresh
Content-Type: application/json
Authorization: Bearer {refreshToken}

Response:
{
    "accessToken": "new-access-token-here",
    "expiresIn": 3600,
    "tokenType": "Bearer"
}
```

### 3.2 权限相关接口

#### 3.2.1 获取用户权限
```
GET /api/auth/permissions
Authorization: Bearer {accessToken}

Response:
{
    "permissions": [
        {
            "permissionCode": "TCM_HERB_INSPECTION_READ",
            "permissionName": "中药材检验查看权限",
            "resourceType": "API",
            "operation": "READ",
            "description": "允许查看中药材检验相关数据"
        },
        {
            "permissionCode": "TCM_PROCESSING_EXECUTE",
            "permissionName": "中药炮制操作权限",
            "resourceType": "API",
            "operation": "WRITE",
            "description": "允许执行中药炮制相关操作"
        }
    ]
}
```

#### 3.2.2 获取中药专业角色列表
```
GET /api/auth/roles/tcm
Authorization: Bearer {accessToken}

Response:
{
    "roles": [
        {
            "id": 101,
            "roleCode": "TCM_APPRAISER",
            "roleName": "中药鉴定师",
            "description": "负责中药材鉴定和质量评估的专业人员",
            "tcmRoleType": "TCM_APPRAISER"
        },
        {
            "id": 102,
            "roleCode": "TCM_PROCESSOR",
            "roleName": "中药炮制师",
            "description": "负责中药材炮制加工的专业人员",
            "tcmRoleType": "TCM_PROCESSOR"
        },
        {
            "id": 103,
            "roleCode": "TCM_INSPECTOR",
            "roleName": "中药检验师",
            "description": "负责中药材及相关产品质量检验的专业人员",
            "tcmRoleType": "TCM_INSPECTOR"
        }
    ]
}
```

## 5. 安全策略配置

### 5.1 密码策略
- [ ] 最小长度：12字符
- [ ] 复杂度要求：必须包含大小写字母、数字、特殊字符
- [ ] 历史密码检查：不可重用最近5次密码
- [ ] 定期更换：90天强制更换

### 5.2 登录安全
- [ ] 失败锁定：5次失败后账户锁定30分钟
- [ ] 会话超时：空闲超时1小时，强制登出
- [ ] 并行登录限制：同一账号同时在线最大3个会话
- [ ] 异地登录提醒：不同IP登录时发送提醒通知

### 5.3 JWT配置
- [ ] 访问令牌有效期：24小时 (86400000ms)
- [ ] 刷新令牌有效期：7天 (604800000ms)
- [ ] 签名算法：HS256
- [ ] 黑名单机制：令牌吊销后立即失效
- [ ] Issuer标识符：gmp-system
- [ ] 令牌刷新阈值：提前5分钟刷新

## 4. 中药专业认证模块 (TCM Professional Certification)

### 4.1 功能需求

#### 4.1.1 专业认证管理
- **证书类型管理**：
  - 中药鉴定师证书
  - 中药炮制师证书
  - 中药检验师证书
  - 其他中药相关专业证书

- **证书验证**：
  - 证书真实性验证
  - 证书有效期管理
  - 证书续证提醒

#### 4.1.2 专业权限映射
- **角色-证书映射**：
  - 不同专业证书对应不同的系统角色
  - 专业证书等级与权限级别关联

- **权限动态分配**：
  - 根据证书类型和等级动态分配系统权限
  - 证书过期时自动撤销相关权限

### 4.2 数据模型

#### 4.2.1 专业证书类型表 (professional_certificate_types)
```sql
CREATE TABLE professional_certificate_types (
    id BIGSERIAL PRIMARY KEY,
    cert_type_code VARCHAR(50) UNIQUE NOT NULL,
    cert_type_name VARCHAR(100) NOT NULL,
    description TEXT,
    issuing_authority VARCHAR(200),
    validity_period INTEGER, -- 有效期（月）
    is_tcm_cert BOOLEAN DEFAULT FALSE, -- 是否为中药专业证书
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 4.2.2 用户专业证书表 (user_professional_certificates)
```sql
CREATE TABLE user_professional_certificates (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL,
    cert_type_id BIGINT NOT NULL,
    certificate_number VARCHAR(100) NOT NULL,
    issue_date DATE NOT NULL,
    expiry_date DATE NOT NULL,
    cert_status VARCHAR(20) DEFAULT 'ACTIVE', -- ACTIVE, EXPIRED, REVOKED
    cert_image_path VARCHAR(500), -- 证书图片存储路径
    verification_code VARCHAR(100), -- 验证码
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES sys_users(id),
    FOREIGN KEY (cert_type_id) REFERENCES professional_certificate_types(id),
    UNIQUE(user_id, cert_type_id)
);
```

## 5. 审计与合规模块 (Audit & Compliance)

### 5.1 功能需求

#### 5.1.1 操作审计
- **中药特色操作审计**：
  - 中药材检验操作审计
  - 中药炮制操作审计
  - 中药质量评估操作审计

- **专业权限变更审计**：
  - 专业证书状态变更记录
  - 专业角色分配记录
  - 专业权限调整记录

#### 5.1.2 合规性管理
- **法规符合性**：
  - 符合GMP数据完整性要求
  - 符合FDA 21 CFR Part 11电子签名要求
  - 符合中药生产质量管理规范要求

- **中药特色合规**：
  - 中药专业人员资质合规性检查
  - 中药操作权限合规性验证

### 5.2 数据模型

#### 5.2.1 审计日志表 (audit_logs)
```sql
CREATE TABLE audit_logs (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL,
    username VARCHAR(100) NOT NULL,
    operation_type VARCHAR(50) NOT NULL,
    resource_type VARCHAR(100),
    resource_id VARCHAR(100),
    action_details JSONB,
    ip_address VARCHAR(50),
    user_agent TEXT,
    timestamp TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    is_tcm_operation BOOLEAN DEFAULT FALSE, -- 是否为中药特色操作
    tcm_operation_type VARCHAR(100), -- 中药操作类型
    compliance_status VARCHAR(20) DEFAULT 'COMPLIANT', -- COMPLIANT, NON_COMPLIANT
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES sys_users(id)
);
```

## 6. 附录

### 6.1 参考文档
- GMP法规（2010版）
- FDA 21 CFR Part 11
- 《中国药典》（2020年版）
- 中药材生产质量管理规范（GAP）
- 认证子系统总体需求文档
- 中药材检验子系统需求文档

### 6.2 版本历史
| 版本 | 修改日期 | 修改内容 | 修改人 |
|------|---------|---------|--------|
| v1.0.0 | 2024-01-15 | 初始版本 | 认证系统团队 |
| v1.1.0 | 2025-11-27 | 增加中药专业认证和权限管理功能 | 系统分析师 |

---

**文档信息：**
- 版本：v1.1.0
- 更新日期：2025年11月27日
- 编制人员：详细需求分析团队
- 状态：Draft
