# 认证子系统数据流和接口定义

## 1. 系统数据流设计

### 1.1 总体数据流图
```
+----------------+     +----------------+     +----------------+
|   用户界面     |     |   认证服务     |     |   数据存储     |
|  (UI Layer)    |<--->| (Service Layer)|<--->| (Data Layer)   |
+----------------+     +----------------+     +----------------+
         ^                     ^                     ^
         |                     |                     |
         v                     v                     v
+----------------+     +----------------+     +----------------+
|   外部系统     |     |   安全审计     |     |   缓存系统     |
| (External Sys) |     | (Audit Module) |     | (Cache Layer)  |
+----------------+     +----------------+     +----------------+
```

### 1.2 核心业务数据流

#### 1.2.1 用户登录数据流
```
用户 -> 前端界面 -> API网关 -> 认证服务 -> 数据库
                                    |
                                    v
                              安全审计模块
                                    |
                                    v
                               缓存系统
                                    |
                                    v
                              返回认证结果
```

**详细流程：**
1. 用户在登录页面输入用户名和密码
2. 前端界面将登录请求发送到API网关
3. API网关将请求路由到认证服务
4. 认证服务：
   - 接收登录请求参数
   - 验证用户名是否存在
   - 验证密码是否正确
   - 检查账户状态
   - 生成JWT访问令牌
   - 将会话信息存储到缓存
   - 发送操作日志到安全审计模块
5. 数据库：
   - 查询用户信息
   - 验证密码
   - 更新最后登录时间
6. 缓存系统：
   - 存储会话信息
   - 记录登录状态
7. 安全审计模块：
   - 记录登录操作日志
   - 分析登录行为
8. 认证服务将令牌返回给API网关
9. API网关将结果返回给前端界面
10. 前端界面更新用户状态并跳转到主页

#### 1.2.2 权限验证数据流
```
用户 -> 前端界面 -> API网关 -> 权限验证 -> 数据库
                                    |
                                    v
                              缓存系统
                                    |
                                    v
                              返回验证结果
```

**详细流程：**
1. 用户请求访问受保护资源
2. 前端界面在请求头中携带访问令牌
3. API网关拦截请求并转发到权限验证模块
4. 权限验证模块：
   - 解析访问令牌
   - 验证令牌有效性
   - 从缓存或数据库获取用户权限
   - 验证用户是否有访问权限
5. 缓存系统：
   - 提供用户权限缓存数据
6. 数据库：
   - 提供用户权限数据（缓存未命中时）
7. 权限验证模块将验证结果返回给API网关
8. API网关根据验证结果决定是否转发请求到业务服务

#### 1.2.3 用户管理数据流
```
管理员 -> 前端界面 -> API网关 -> 用户服务 -> 数据库
                                    |
                                    v
                              安全审计模块
                                    |
                                    v
                              返回操作结果
```

**详细流程：**
1. 管理员在用户管理界面执行操作（创建、修改、删除用户）
2. 前端界面将操作请求发送到API网关
3. API网关将请求路由到用户服务
4. 用户服务：
   - 验证操作权限
   - 验证输入数据合法性
   - 执行相应业务逻辑
   - 更新数据库
   - 发送操作日志到安全审计模块
5. 数据库：
   - 执行数据增删改操作
6. 安全审计模块：
   - 记录用户管理操作日志
7. 用户服务将操作结果返回给API网关
8. API网关将结果返回给前端界面

### 1.3 数据实体关系图

#### 1.3.1 核心实体关系
```
+----------+        +----------+        +-------------+
|  Users   |<------>|UserRoles |<------>|   Roles     |
+----------+        +----------+        +-------------+
     |                    |                    |
     |                    |                    |
     v                    v                    v
+----------+        +-------------+     +-------------+
|UserProfiles|      |RolePermissions|<->| Permissions |
+----------+        +-------------+     +-------------+
     |
     |
     v
+-------------+
|OperationLogs|
+-------------+
```

#### 1.3.2 实体详细说明

**用户实体 (Users)**
- userId (主键): 用户唯一标识
- username: 用户名，唯一
- password: 加密后的密码
- fullName: 用户全名
- email: 邮箱地址
- department: 所属部门
- phone: 联系电话
- status: 账户状态
- lastLoginTime: 最后登录时间
- createTime: 创建时间
- updateTime: 更新时间

**角色实体 (Roles)**
- roleId (主键): 角色唯一标识
- name: 角色名称，唯一
- description: 角色描述
- createTime: 创建时间
- updateTime: 更新时间

**权限实体 (Permissions)**
- permissionId (主键): 权限唯一标识
- code: 权限代码，唯一
- name: 权限名称
- description: 权限描述
- group: 权限分组
- createTime: 创建时间
- updateTime: 更新时间

**用户角色关联实体 (UserRoles)**
- userId (外键): 用户ID
- roleId (外键): 角色ID
- createTime: 关联时间

**角色权限关联实体 (RolePermissions)**
- roleId (外键): 角色ID
- permissionId (外键): 权限ID
- createTime: 关联时间

**操作日志实体 (OperationLogs)**
- logId (主键): 日志唯一标识
- userId: 操作用户ID
- operation: 操作类型
- resource: 操作资源
- parameters: 操作参数
- result: 操作结果
- ipAddress: 客户端IP地址
- userAgent: 用户代理信息
- createTime: 操作时间

## 2. 内部接口设计

### 2.1 认证服务内部接口

#### 2.1.1 用户认证接口
```java
/**
 * 用户认证服务接口
 */
public interface AuthService {
    
    /**
     * 用户登录认证
     * @param username 用户名
     * @param password 密码
     * @return 认证结果
     */
    AuthResult authenticate(String username, String password);
    
    /**
     * 验证JWT令牌
     * @param token JWT令牌
     * @return 验证结果
     */
    TokenValidationResult validateToken(String token);
    
    /**
     * 刷新访问令牌
     * @param refreshToken 刷新令牌
     * @return 新的访问令牌
     */
    TokenRefreshResult refreshToken(String refreshToken);
    
    /**
     * 用户登出
     * @param accessToken 访问令牌
     * @return 登出结果
     */
    LogoutResult logout(String accessToken);
}
```

#### 2.1.2 用户管理接口
```java
/**
 * 用户管理服务接口
 */
public interface UserService {
    
    /**
     * 创建用户
     * @param userCreateRequest 用户创建请求
     * @return 用户信息
     */
    UserInfo createUser(UserCreateRequest userCreateRequest);
    
    /**
     * 更新用户信息
     * @param userId 用户ID
     * @param userUpdateRequest 用户更新请求
     * @return 用户信息
     */
    UserInfo updateUser(Long userId, UserUpdateRequest userUpdateRequest);
    
    /**
     * 删除用户
     * @param userId 用户ID
     * @return 删除结果
     */
    boolean deleteUser(Long userId);
    
    /**
     * 查询用户列表
     * @param query 查询条件
     * @return 用户列表
     */
    PageResult<UserInfo> queryUsers(UserQuery query);
    
    /**
     * 获取用户详情
     * @param userId 用户ID
     * @return 用户详情
     */
    UserInfo getUserDetail(Long userId);
}
```

#### 2.1.3 角色管理接口
```java
/**
 * 角色管理服务接口
 */
public interface RoleService {
    
    /**
     * 创建角色
     * @param roleCreateRequest 角色创建请求
     * @return 角色信息
     */
    RoleInfo createRole(RoleCreateRequest roleCreateRequest);
    
    /**
     * 更新角色信息
     * @param roleId 角色ID
     * @param roleUpdateRequest 角色更新请求
     * @return 角色信息
     */
    RoleInfo updateRole(Long roleId, RoleUpdateRequest roleUpdateRequest);
    
    /**
     * 删除角色
     * @param roleId 角色ID
     * @return 删除结果
     */
    boolean deleteRole(Long roleId);
    
    /**
     * 查询角色列表
     * @param query 查询条件
     * @return 角色列表
     */
    PageResult<RoleInfo> queryRoles(RoleQuery query);
    
    /**
     * 获取角色详情
     * @param roleId 角色ID
     * @return 角色详情
     */
    RoleInfo getRoleDetail(Long roleId);
}
```

#### 2.1.4 权限管理接口
```java
/**
 * 权限管理服务接口
 */
public interface PermissionService {
    
    /**
     * 创建权限
     * @param permissionCreateRequest 权限创建请求
     * @return 权限信息
     */
    PermissionInfo createPermission(PermissionCreateRequest permissionCreateRequest);
    
    /**
     * 更新权限信息
     * @param permissionId 权限ID
     * @param permissionUpdateRequest 权限更新请求
     * @return 权限信息
     */
    PermissionInfo updatePermission(Long permissionId, PermissionUpdateRequest permissionUpdateRequest);
    
    /**
     * 删除权限
     * @param permissionId 权限ID
     * @return 删除结果
     */
    boolean deletePermission(Long permissionId);
    
    /**
     * 查询权限列表
     * @param query 查询条件
     * @return 权限列表
     */
    PageResult<PermissionInfo> queryPermissions(PermissionQuery query);
    
    /**
     * 获取权限详情
     * @param permissionId 权限ID
     * @return 权限详情
     */
    PermissionInfo getPermissionDetail(Long permissionId);
    
    /**
     * 验证用户权限
     * @param userId 用户ID
     * @param permissionCode 权限代码
     * @return 是否有权限
     */
    boolean checkPermission(Long userId, String permissionCode);
}
```

#### 2.1.5 安全审计接口
```java
/**
 * 安全审计服务接口
 */
public interface AuditService {
    
    /**
     * 记录操作日志
     * @param operationLog 操作日志
     */
    void recordOperationLog(OperationLog operationLog);
    
    /**
     * 查询操作日志
     * @param query 查询条件
     * @return 操作日志列表
     */
    PageResult<OperationLog> queryOperationLogs(OperationLogQuery query);
    
    /**
     * 记录安全事件
     * @param securityEvent 安全事件
     */
    void recordSecurityEvent(SecurityEvent securityEvent);
    
    /**
     * 查询安全事件
     * @param query 查询条件
     * @return 安全事件列表
     */
    PageResult<SecurityEvent> querySecurityEvents(SecurityEventQuery query);
}
```

### 2.2 数据访问接口

#### 2.2.1 用户数据访问接口
```java
/**
 * 用户数据访问接口
 */
public interface UserRepository {
    
    /**
     * 根据用户名查找用户
     * @param username 用户名
     * @return 用户信息
     */
    Optional<User> findByUsername(String username);
    
    /**
     * 根据用户ID查找用户
     * @param userId 用户ID
     * @return 用户信息
     */
    Optional<User> findById(Long userId);
    
    /**
     * 保存用户信息
     * @param user 用户信息
     * @return 保存后的用户信息
     */
    User save(User user);
    
    /**
     * 删除用户
     * @param userId 用户ID
     */
    void deleteById(Long userId);
    
    /**
     * 分页查询用户
     * @param query 查询条件
     * @param page 分页信息
     * @return 用户列表
     */
    PageResult<User> queryUsers(UserQuery query, Pageable page);
}
```

#### 2.2.2 角色数据访问接口
```java
/**
 * 角色数据访问接口
 */
public interface RoleRepository {
    
    /**
     * 根据角色名称查找角色
     * @param name 角色名称
     * @return 角色信息
     */
    Optional<Role> findByName(String name);
    
    /**
     * 根据角色ID查找角色
     * @param roleId 角色ID
     * @return 角色信息
     */
    Optional<Role> findById(Long roleId);
    
    /**
     * 保存角色信息
     * @param role 角色信息
     * @return 保存后的角色信息
     */
    Role save(Role role);
    
    /**
     * 删除角色
     * @param roleId 角色ID
     */
    void deleteById(Long roleId);
    
    /**
     * 分页查询角色
     * @param query 查询条件
     * @param page 分页信息
     * @return 角色列表
     */
    PageResult<Role> queryRoles(RoleQuery query, Pageable page);
}
```

#### 2.2.3 权限数据访问接口
```java
/**
 * 权限数据访问接口
 */
public interface PermissionRepository {
    
    /**
     * 根据权限代码查找权限
     * @param code 权限代码
     * @return 权限信息
     */
    Optional<Permission> findByCode(String code);
    
    /**
     * 根据权限ID查找权限
     * @param permissionId 权限ID
     * @return 权限信息
     */
    Optional<Permission> findById(Long permissionId);
    
    /**
     * 保存权限信息
     * @param permission 权限信息
     * @return 保存后的权限信息
     */
    Permission save(Permission permission);
    
    /**
     * 删除权限
     * @param permissionId 权限ID
     */
    void deleteById(Long permissionId);
    
    /**
     * 分页查询权限
     * @param query 查询条件
     * @param page 分页信息
     * @return 权限列表
     */
    PageResult<Permission> queryPermissions(PermissionQuery query, Pageable page);
    
    /**
     * 根据用户ID查找权限列表
     * @param userId 用户ID
     * @return 权限列表
     */
    List<Permission> findByUserId(Long userId);
    
    /**
     * 根据角色ID查找权限列表
     * @param roleId 角色ID
     * @return 权限列表
     */
    List<Permission> findByRoleId(Long roleId);
}
```

## 3. 外部接口设计

### 3.1 RESTful API接口

#### 3.1.1 认证相关接口

**用户登录**
```
POST /api/auth/login
请求体：
{
  "username": "string",
  "password": "string"
}

响应：
{
  "code": "200",
  "message": "登录成功",
  "data": {
    "accessToken": "string",
    "refreshToken": "string",
    "expiresIn": 7200
  }
}
```

**刷新令牌**
```
POST /api/auth/refresh
请求体：
{
  "refreshToken": "string"
}

响应：
{
  "code": "200",
  "message": "刷新成功",
  "data": {
    "accessToken": "string",
    "expiresIn": 7200
  }
}
```

**用户登出**
```
POST /api/auth/logout
请求头：
Authorization: Bearer {accessToken}

响应：
{
  "code": "200",
  "message": "登出成功",
  "data": null
}
```

#### 3.1.2 用户管理接口

**创建用户**
```
POST /api/users
请求头：
Authorization: Bearer {accessToken}
Content-Type: application/json

请求体：
{
  "username": "string",
  "fullName": "string",
  "email": "string",
  "department": "string",
  "phone": "string",
  "roleIds": [1, 2, 3]
}

响应：
{
  "code": "200",
  "message": "用户创建成功",
  "data": {
    "userId": 1,
    "username": "string",
    "fullName": "string",
    "email": "string",
    "department": "string",
    "phone": "string",
    "status": "ACTIVE",
    "createTime": "2025-11-22T10:00:00Z"
  }
}
```

**查询用户列表**
```
GET /api/users?username=admin&fullName=管理员&page=1&size=20
请求头：
Authorization: Bearer {accessToken}

响应：
{
  "code": "200",
  "message": "查询成功",
  "data": {
    "content": [
      {
        "userId": 1,
        "username": "admin",
        "fullName": "系统管理员",
        "email": "admin@example.com",
        "department": "IT部",
        "phone": "13800138000",
        "status": "ACTIVE",
        "createTime": "2025-11-22T10:00:00Z"
      }
    ],
    "totalElements": 1,
    "totalPages": 1,
    "currentPage": 1
  }
}
```

#### 3.1.3 角色管理接口

**创建角色**
```
POST /api/roles
请求头：
Authorization: Bearer {accessToken}
Content-Type: application/json

请求体：
{
  "name": "string",
  "description": "string",
  "permissionIds": [1, 2, 3]
}

响应：
{
  "code": "200",
  "message": "角色创建成功",
  "data": {
    "roleId": 1,
    "name": "string",
    "description": "string",
    "createTime": "2025-11-22T10:00:00Z"
  }
}
```

**查询角色列表**
```
GET /api/roles?name=管理员&page=1&size=20
请求头：
Authorization: Bearer {accessToken}

响应：
{
  "code": "200",
  "message": "查询成功",
  "data": {
    "content": [
      {
        "roleId": 1,
        "name": "系统管理员",
        "description": "拥有系统最高权限",
        "permissionCount": 50,
        "createTime": "2025-11-22T10:00:00Z"
      }
    ],
    "totalElements": 1,
    "totalPages": 1,
    "currentPage": 1
  }
}
```

#### 3.1.4 权限管理接口

**创建权限**
```
POST /api/permissions
请求头：
Authorization: Bearer {accessToken}
Content-Type: application/json

请求体：
{
  "code": "string",
  "name": "string",
  "description": "string"
}

响应：
{
  "code": "200",
  "message": "权限创建成功",
  "data": {
    "permissionId": 1,
    "code": "string",
    "name": "string",
    "description": "string",
    "createTime": "2025-11-22T10:00:00Z"
  }
}
```

**查询权限列表**
```
GET /api/permissions?code=USER&page=1&size=20
请求头：
Authorization: Bearer {accessToken}

响应：
{
  "code": "200",
  "message": "查询成功",
  "data": {
    "content": [
      {
        "permissionId": 1,
        "code": "USER_MANAGE",
        "name": "用户管理",
        "description": "管理用户信息的权限",
        "group": "系统管理",
        "createTime": "2025-11-22T10:00:00Z"
      }
    ],
    "totalElements": 1,
    "totalPages": 1,
    "currentPage": 1
  }
}
```

#### 3.1.5 安全审计接口

**查询操作日志**
```
GET /api/audit/logs?userId=1&operation=LOGIN&startDate=2025-11-22&endDate=2025-11-23&page=1&size=20
请求头：
Authorization: Bearer {accessToken}

响应：
{
  "code": "200",
  "message": "查询成功",
  "data": {
    "content": [
      {
        "logId": 1,
        "userId": 1,
        "username": "admin",
        "operation": "LOGIN",
        "resource": "/api/auth/login",
        "result": "SUCCESS",
        "ipAddress": "192.168.1.100",
        "userAgent": "Mozilla/5.0...",
        "createTime": "2025-11-22T10:00:00Z"
      }
    ],
    "totalElements": 1,
    "totalPages": 1,
    "currentPage": 1
  }
}
```

### 3.2 消息队列接口

#### 3.2.1 安全事件通知
```
队列名称：security_events
消息格式：
{
  "eventId": "string",
  "eventType": "string",
  "userId": "long",
  "username": "string",
  "description": "string",
  "severity": "string",  // LOW, MEDIUM, HIGH, CRITICAL
  "sourceIp": "string",
  "timestamp": "datetime",
  "details": "object"
}
```

#### 3.2.2 审计日志记录
```
队列名称：audit_logs
消息格式：
{
  "logId": "string",
  "userId": "long",
  "username": "string",
  "operation": "string",
  "resource": "string",
  "parameters": "object",
  "result": "string",
  "ipAddress": "string",
  "userAgent": "string",
  "timestamp": "datetime"
}
```

## 4. 接口安全设计

### 4.1 认证与授权
所有RESTful API接口都需要通过JWT令牌进行认证和授权：
- 访问令牌通过HTTP Header传递：`Authorization: Bearer {token}`
- 令牌包含用户身份信息和权限列表
- 接口层验证令牌有效性
- 服务层验证用户是否有相应权限

### 4.2 数据传输安全
- 所有接口必须通过HTTPS协议访问
- 敏感数据（如密码）必须加密传输
- 接口请求和响应数据进行签名验证

### 4.3 接口访问控制
- 基于角色的访问控制（RBAC）
- 细粒度权限控制到具体接口和操作
- 支持接口访问频率限制
- 支持IP白名单控制

### 4.4 数据完整性保护
- 关键数据操作需要记录详细日志
- 数据变更需要审批流程
- 重要接口调用需要二次确认
- 数据备份和恢复机制

## 5. 接口性能要求

### 5.1 响应时间
- 认证相关接口：≤ 1000ms
- 查询类接口：≤ 2000ms
- 写入类接口：≤ 3000ms
- 批量操作接口：≤ 5000ms

### 5.2 并发处理
- 支持1000个并发用户
- 支持每秒100个认证请求
- 支持每秒1000个查询请求
- 支持每秒100个写入请求

### 5.3 可用性
- 接口可用性：99.9%
- 平均故障恢复时间：≤ 30分钟
- 支持负载均衡和故障转移

## 6. 接口监控与运维

### 6.1 监控指标
- 接口调用次数统计
- 接口响应时间监控
- 接口错误率统计
- 接口访问量趋势

### 6.2 日志记录
- 接口调用日志
- 错误日志
- 性能日志
- 安全日志

### 6.3 告警机制
- 接口响应超时告警
- 接口错误率异常告警
- 接口访问量突增告警
- 安全事件告警