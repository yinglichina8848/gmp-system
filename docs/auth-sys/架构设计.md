# 认证与权限管理系统架构设计

## 1. 概述

认证与权限管理系统采用微服务架构，基于JWT和RBAC权限模型，提供企业级的用户身份验证、访问控制和操作审计功能。系统设计遵循高可用、易扩展、可审计的原则，确保GMP系统的安全性和合规性。

## 2. 系统架构

### 2.1 分层架构设计

```
┌────────────────────────────────────────────────────┐
│            表现层 (Presentation Layer)             │
│   ┌─────────────────────────────────────────────┐   │
│   │        REST控制器 (Controllers)            │   │
│   │ - AuthController                           │   │
│   │ - UserController                           │   │
│   │ - RoleController                           │   │
│   │ - PermissionController                     │   │
│   └─────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────┘
                                ▼
┌────────────────────────────────────────────────────┐
│           业务逻辑层 (Business Layer)               │
│   ┌─────────────────────────────────────────────┐   │
│   │       业务服务 (Services)                    │   │
│   │ - AuthService                               │   │
│   │ - UserService                               │   │
│   │ - RolePermissionService                     │   │
│   │ - AuditLogService                           │   │
│   │                                             │   │
│   │ - JWT管理器                                 │   │
│   │ - RBAC权限引擎                              │   │
│   │ - 审计追踪器                                 │   │
│   └─────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────┘
                                ▼
┌────────────────────────────────────────────────────┐
│           数据访问层 (Data Access Layer)            │
│   ┌─────────────────────────────────────────────┐   │
│   │       数据仓库 (Repositories)               │   │
│   │ - UserRepository                            │   │
│   │ - RoleRepository                            │   │
│   │ - PermissionRepository                      │   │
│   │ - OperationLogRepository                    │   │
│   └─────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────┘
                                ▼
┌────────────────────────────────────────────────────┐
│           数据存储层 (Data Storage)                │
└────────────────────────────────────────────────────┘
```

### 2.2 微服务架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    AUTH微服务 (auth-service:8085)           │
│                                                             │
│  ┌─────────────┬─────────────┬─────────────┬─────────────┐   │
│  │  用户认证   │  权限管理   │  角色管理   │  操作审计   │   │
│  │ User        │ Permission  │ Role Mgmt   │ Audit       │   │
│  │ Auth        │ Management  │             │ Logging     │   │
│  └─────────────┴─────────────┴─────────────┴─────────────┘   │
│                                                             │
│  ┌─────────────┬─────────────┬─────────────┬─────────────┐   │
│  │    JWT      │    RBAC     │  缓存管理   │  消息队列   │   │
│  │  Token      │   Engine    │   Cache     │    MQ       │   │
│  │ Management  │             │ Management  │             │   │
│  └─────────────┴─────────────┴─────────────┴─────────────┘   │
└─────────────────────────────────────────────────────────────┘
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                    数据存储与缓存                           │
│                                                             │
│  PostgreSQL auth_db      Redis Cache     RabbitMQ       │
│  - users                                                     │
│  - roles                        Token缓存，会话管理         │
│  - permissions                                              │
│  - user_roles                    权限缓存，用户状态        │
│                                                             │
│  外部服务集成：邮件服务、短信服务                           │
└─────────────────────────────────────────────────────────────┘
```

## 3. 服务设计

### 3.1 微服务边界

认证服务主要包含四个核心业务领域：

```
用户认证 (User Authentication)
├── 用户登录认证 (@Post /api/auth/login)
├── 身份令牌验证 (@Post /api/auth/verify)
├── 令牌刷新 (@Post /api/auth/refresh)
├── 用户登出 (@Post /api/auth/logout)
└── 获取用户信息 (@Get /api/auth/info)

权限管理 (Authorization Management)
├── 权限验证 (@Post /api/auth/check-permission)
├── 获取用户权限 (@Get /api/auth/permissions/my)
├── 权限缓存同步 (@Post /api/auth/permissions/sync)
├── 权限规则检查 (@Post /api/auth/permissions/validate)
└── 权限变更生效 (@Post /api/auth/permissions/invalidate)

用户角色管理 (User Role Management)
├── 用户角色查询 (@Get /api/auth/users/{id}/roles)
├── 用户角色分配 (@Put /api/auth/users/{id}/roles)
├── 角色权限查询 (@Get /api/auth/roles/{id}/permissions)
├── 批量角色分配 (@Post /api/auth/users/batch-roles)
└── 角色变更通知 (@Post /api/auth/roles/{id}/notify)

操作审计 (Audit Logging)
├── 审计日志记录 (@Post /api/auth/audit/log)
├── 审计日志查询 (@Get /api/auth/audit/logs)
├── 审计统计 (@Get /api/auth/audit/statistics)
├── 审计日志导出 (@Get /api/auth/audit/export)
└── 审计日志归档 (@Post /api/auth/audit/archive)
```

## 4. 数据架构设计

### 4.1 解析审计追踪实体类
```java
@Entity
@Table(name = "operation_logs")
@Data
@Audited
public class OperationLog {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(nullable = false)
    private String userId;

    private String username;
    private String userDepartment;

    @Column(nullable = false)
    private String operationType; // LOGIN, LOGOUT, PERMISSION_CHANGE, etc.

    @Column(columnDefinition = "TEXT")
    private String operationDescription;

    private String apiEndpoint;
    private String httpMethod;
    private String clientIp;
    private String userAgent;

    @Column(nullable = false)
    private Boolean success = true;

    private String errorMessage;
    private String sessionId;

    @Column(columnDefinition = "TEXT")
    private String requestPayload;

    @Column(columnDefinition = "TEXT")
    private String responsePayload;

    @Column(nullable = false)
    private LocalDateTime timestamp = LocalDateTime.now();
}
```

## 5. JWT令牌管理设计

### 5.1 令牌生成与验证
```java
@Service
public class JwtTokenService {

    // 生成JWT令牌
    public String generateToken(User user, List<String> roles, List<String> permissions) {
        Map<String, Object> claims = new HashMap<>();
        claims.put("userId", user.getId());
        claims.put("username", user.getUsername());
        claims.put("roles", roles);
        claims.put("permissions", permissions);
        claims.put("issuedAt", new Date());

        return Jwts.builder()
            .setClaims(claims)
            .setSubject(user.getUsername())
            .setIssuedAt(new Date())
            .setExpiration(new Date(System.currentTimeMillis() + EXPIRATION_TIME))
            .signWith(SignatureAlgorithm.HS256, SECRET_KEY)
            .compact();
    }

    // 验证JWT令牌
    public Claims validateToken(String token) {
        return Jwts.parser()
            .setSigningKey(SECRET_KEY)
            .parseClaimsJws(token)
            .getBody();
    }

    // 从令牌获取用户信息
    public Authentication getAuthentication(String token) {
        Claims claims = validateToken(token);

        List<String> roles = (List<String>) claims.get("roles");
        List<String> permissions = (List<String>) claims.get("permissions");

        // 创建认证对象
        Collection<GrantedAuthority> authorities = roles.stream()
            .map(SimpleGrantedAuthority::new)
            .collect(Collectors.toList());

        User principal = new User(claims.getSubject(), "", authorities);
        return new UsernamePasswordAuthenticationToken(principal, token, authorities);
    }
}
```

## 6. RBAC权限控制设计

### 6.1 权限评估引擎
```java
@Service
public class PermissionEvaluationService {

    @Autowired
    private UserRepository userRepository;
    private RoleRepository roleRepository;
    private PermissionRepository permissionRepository;

    // 检查用户权限
    public boolean hasPermission(Long userId, String permissionCode) {
        User user = userRepository.findById(userId).orElse(null);
        if (user == null) return false;

        List<Role> roles = roleRepository.findByUserId(userId);
        for (Role role : roles) {
            List<Permission> permissions = permissionRepository.findByRoleId(role.getId());
            if (permissions.stream().anyMatch(p -> p.getPermissionCode().equals(permissionCode))) {
                return true;
            }
        }

        return false;
    }

    // 获取用户所有权限
    public Set<String> getUserPermissions(Long userId) {
        Set<String> allPermissions = new HashSet<>();

        List<Role> roles = roleRepository.findByUserId(userId);
        for (Role role : roles) {
            List<Permission> permissions = permissionRepository.findByRoleId(role.getId());
            permissions.forEach(p -> allPermissions.add(p.getPermissionCode()));
        }

        return allPermissions;
    }

    // 检查API访问权限
    public boolean checkApiPermission(String requestUri, String method, Long userId) {
        // 实现基于URL模式的权限检查
        List<Permission> permissions = permissionRepository.findByResourceType("API");

        for (Permission permission : permissions) {
            if (matchesUrlPattern(requestUri, permission.getResourcePattern()) &&
                permission.getOperation().equalsIgnoreCase(method)) {
                if (hasPermission(userId, permission.getPermissionCode())) {
                    return true;
                }
            }
        }

        return false;
    }
}
```

## 7. 缓存架构设计

### 7.1 Redis缓存策略

#### 7.1.1 用户权限缓存
``java
@Configuration
public class CacheConfiguration {

    @Bean
    public RedisCacheManager cacheManager(RedisConnectionFactory connectionFactory) {
        return RedisCacheManager.builder(connectionFactory)
            .cacheDefaults(
                RedisCacheConfiguration.defaultCacheConfig()
                    .entryTtl(Duration.ofMinutes(30)) // 默认30分钟过期
            )
            .withCacheConfiguration("userPermissions",
                RedisCacheConfiguration.defaultCacheConfig().entryTtl(Duration.ofMinutes(15)))
            .withCacheConfiguration("userRoles",
                RedisCacheConfiguration.defaultCacheConfig().entryTtl(Duration.ofMinutes(20)))
            .withCacheConfiguration("tokens",
                RedisCacheConfiguration.defaultCacheConfig().entryTtl(Duration.ofMinutes(60)))
            .build();
    }
}
```

#### 7.1.2 缓存键设计
```
auth:user:{userId}:permissions -> ["deviation:create", "batch:read"]
auth:user:{userId}:roles -> ["OPERATOR", "QUALITY_ENGINEER"]
auth:token:{tokenId} -> {userId: 1, username: "user001", expires: 1638360000000}
auth:session:{sessionId} -> {userId: 1, loginTime: 1638356400000, lastActivity: 1638357800000}
```

---

**文档信息：**
- 版本：v1.0
- 更新日期：2024年
- 编制人员：架构设计团队
- 状态：Draft
