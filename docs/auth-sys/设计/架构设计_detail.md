# 认证子系统架构设计

## 1. 概述

### 1.1 设计目标
认证子系统采用微服务架构，基于JWT和RBAC提供安全、合规的用户管理服务。系统设计遵循高可用、易扩展、合规可追溯的原则，确保GMP系统的规范性和认证服务的可靠性。

### 1.2 设计原则
- **安全性优先**: 所有设计以安全为首要考虑因素
- **合规性保障**: 符合GMP法规对数据完整性、审计追踪的要求
- **高可用性**: 确保认证服务7x24小时稳定运行
- **可扩展性**: 支持水平扩展以应对业务增长
- **易维护性**: 架构清晰，便于系统维护和升级

## 2. 系统架构

### 2.1 总体架构
```
                    +-------------------+
                    |   API Gateway     |
                    +-------------------+
                              |
                    +-------------------+
                    | Load Balancer     |
                    +-------------------+
                              |
         +-------------------------------------+
         |         Auth Service Cluster        |
         |  +--------+  +--------+  +--------+  |
         |  | Auth   |  | Auth   |  | Auth   |  |
         |  | Node 1 |  | Node 2 |  | Node 3 |  |
         |  +--------+  +--------+  +--------+  |
         +-------------------------------------+
               |           |           |
     +---------+--+   +----+----+   +--+--------+
     | PostgreSQL |   | Redis   |   | MongoDB   |
     |   (主)     |   | (缓存)  |   | (日志)    |
     +------------+   +---------+   +-----------+
           |
     +-----+------+
     | PostgreSQL |
     |   (备)     |
     +------------+
```

### 2.2 技术架构
- **后端框架**: Spring Boot 3.x + Spring Security 6.x
- **数据库**: PostgreSQL 13 (主从复制)
- **缓存**: Redis 6.x (集群模式)
- **安全**: JWT + OAuth2 + Spring Security
- **日志**: MongoDB (审计日志)
- **监控**: Prometheus + Grafana
- **部署**: Docker + Kubernetes

## 3. 分层架构设计

### 3.1 表现层 (Presentation Layer)
```
┌────────────────────────────────────────────────────┐
│            表现层 (Presentation Layer)             │
│   ┌─────────────────────────────────────────────┐   │
│   │        REST控制器 (Controllers)            │   │
│   │ - AuthController                            │   │
│   │ - UserController                            │   │
│   │ - RoleController                            │   │
│   │ - PermissionController                      │   │
│   │ - AuditController                           │   │
│   └─────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────┘
                                ▼
```

### 3.2 业务逻辑层 (Business Layer)
```
┌────────────────────────────────────────────────────┐
│           业务逻辑层 (Business Layer)               │
│   ┌─────────────────────────────────────────────┐   │
│   │       业务服务 (Services)                    │   │
│   │ - AuthService                               │   │
│   │ - UserService                               │   │
│   │ - RoleService                               │   │
│   │ - PermissionService                         │   │
│   │ - TokenService                              │   │
│   │ - AuditService                              │   │
│   │                                             │   │
│   │ - 密码加密服务                              │   │
│   │ - JWT令牌服务                               │   │
│   │ - 权限验证服务                              │   │
│   │ - 安全审计服务                              │   │
│   └─────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────┘
                                ▼
```

### 3.3 数据访问层 (Data Access Layer)
```
┌────────────────────────────────────────────────────┐
│           数据访问层 (Data Access Layer)            │
│   ┌─────────────────────────────────────────────┐   │
│   │       数据仓库 (Repositories)               │   │
│   │ - UserRepository                            │   │
│   │ - RoleRepository                            │   │
│   │ - PermissionRepository                      │   │
│   │ - UserRoleRepository                        │   │
│   │ - RolePermissionRepository                  │   │
│   │ - OperationLogRepository                    │   │
│   └─────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────┘
                                ▼
┌────────────────────────────────────────────────────┐
│              数据存储层 (Data Storage)              │
│  ┌────────────┐ ┌────────────┐ ┌────────────────┐  │
│  │ PostgreSQL │ │   Redis    │ │   MongoDB      │  │
│  │ (结构数据)  │ │  (缓存)    │ │  (审计日志)     │  │
│  └────────────┘ └────────────┘ └────────────────┘  │
└────────────────────────────────────────────────────┘
```

## 4. 核心模块设计

### 4.1 认证模块 (Auth Module)
#### 4.1.1 功能说明
负责用户身份验证、令牌生成与验证、会话管理等核心认证功能。

#### 4.1.2 核心流程
```
用户登录流程:
1. 用户提交用户名和密码
2. 系统验证用户凭据
3. 系统生成JWT访问令牌和刷新令牌
4. 系统记录登录日志
5. 返回令牌给客户端

令牌验证流程:
1. 客户端携带访问令牌请求资源
2. 系统验证令牌有效性
3. 系统解析用户身份和权限
4. 系统检查资源访问权限
5. 返回资源或拒绝访问
```

#### 4.1.3 安全设计
- 密码加密：BCrypt强加密算法
- 令牌安全：JWT + RSA签名
- 会话管理：Redis存储会话状态
- 防暴力破解：登录失败次数限制

### 4.2 用户管理模块 (User Management Module)
#### 4.2.1 功能说明
负责用户信息管理、状态管理、密码管理等用户相关功能。

#### 4.2.2 核心实体
- **User**: 用户基本信息
- **UserRole**: 用户角色关联
- **UserProfile**: 用户详细信息
- **UserStatus**: 用户状态信息

#### 4.2.3 业务规则
- 用户名全局唯一
- 密码符合复杂度要求
- 用户状态变更需记录原因
- 用户删除采用软删除机制

### 4.3 角色权限模块 (Role & Permission Module)
#### 4.3.1 功能说明
实现基于角色的访问控制(RBAC)，管理角色、权限及其关联关系。

#### 4.3.2 核心实体
- **Role**: 角色定义
- **Permission**: 权限定义
- **RolePermission**: 角色权限关联
- **UserRole**: 用户角色关联

#### 4.3.3 权限模型
```
RBAC权限模型:
          +----------+
          |  User    |
          +----------+
               |
         +-----------+
         | UserRole  |
         +-----------+
               |
          +----------+
          |  Role    |
          +----------+
               |
     +-----------------+
     | RolePermission  |
     +-----------------+
               |
          +----------+
          |Permission|
          +----------+
```

### 4.4 安全审计模块 (Security Audit Module)
#### 4.4.1 功能说明
记录系统关键操作日志，提供安全审计和合规支持。

#### 4.4.2 日志内容
- 操作类型：登录、登出、增删改查等
- 操作时间：精确到毫秒
- 操作用户：用户ID和用户名
- 操作对象：被操作的资源
- 操作结果：成功/失败状态
- 客户端信息：IP地址、User-Agent等

#### 4.4.3 存储设计
- 实时日志：存储在Redis中，提高写入性能
- 持久日志：定期同步到MongoDB，便于查询分析

## 5. 数据库设计

### 5.1 核心数据表
#### 5.1.1 用户表 (users)
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT | 用户ID，主键 |
| username | VARCHAR(50) | 用户名，唯一 |
| password | VARCHAR(255) | 密码（加密存储） |
| email | VARCHAR(100) | 邮箱 |
| full_name | VARCHAR(100) | 姓名 |
| status | VARCHAR(20) | 状态（ACTIVE/INACTIVE/LOCKED） |
| created_at | TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | 更新时间 |

#### 5.1.2 角色表 (roles)
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT | 角色ID，主键 |
| name | VARCHAR(50) | 角色名称，唯一 |
| description | TEXT | 角色描述 |
| created_at | TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | 更新时间 |

#### 5.1.3 权限表 (permissions)
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT | 权限ID，主键 |
| code | VARCHAR(100) | 权限代码，唯一 |
| name | VARCHAR(100) | 权限名称 |
| description | TEXT | 权限描述 |
| created_at | TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | 更新时间 |

#### 5.1.4 操作日志表 (operation_logs)
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT | 日志ID，主键 |
| user_id | BIGINT | 用户ID |
| operation | VARCHAR(50) | 操作类型 |
| resource | VARCHAR(100) | 操作资源 |
| result | VARCHAR(20) | 操作结果 |
| ip_address | VARCHAR(50) | IP地址 |
| user_agent | TEXT | 用户代理 |
| created_at | TIMESTAMP | 操作时间 |

### 5.2 关系表设计
#### 5.2.1 用户角色关系表 (user_roles)
| 字段名 | 类型 | 说明 |
|--------|------|------|
| user_id | BIGINT | 用户ID，外键 |
| role_id | BIGINT | 角色ID，外键 |
| created_at | TIMESTAMP | 关联时间 |

#### 5.2.2 角色权限关系表 (role_permissions)
| 字段名 | 类型 | 说明 |
|--------|------|------|
| role_id | BIGINT | 角色ID，外键 |
| permission_id | BIGINT | 权限ID，外键 |
| created_at | TIMESTAMP | 关联时间 |

## 6. 安全设计

### 6.1 认证安全
#### 6.1.1 密码安全
- 使用BCrypt算法加密存储密码
- 密码复杂度要求：至少8位，包含大小写字母、数字和特殊字符
- 密码有效期：90天强制更换
- 登录失败处理：5次失败后锁定账户30分钟

#### 6.1.2 令牌安全
- JWT令牌采用RSA非对称加密签名
- 访问令牌有效期：2小时
- 刷新令牌有效期：7天
- 令牌撤销机制：支持令牌加入黑名单

### 6.2 传输安全
- 所有通信采用HTTPS加密传输
- 敏感数据字段加密传输
- 防止重放攻击机制
- CSRF防护机制

### 6.3 访问控制
#### 6.3.1 权限控制
- 基于RBAC的权限模型
- 方法级别的权限控制
- 数据级别的权限控制
- URL级别的访问控制

#### 6.3.2 会话安全
- 会话固定攻击防护
- 会话超时机制（30分钟）
- 多点登录控制
- 会话并发限制

## 7. 性能设计

### 7.1 缓存策略
#### 7.1.1 Redis缓存
- 用户信息缓存：TTL 30分钟
- 权限信息缓存：TTL 60分钟
- 会话信息缓存：与会话有效期一致
- 令牌黑名单缓存：与令牌有效期一致

#### 7.1.2 本地缓存
- 热点数据本地缓存
- 缓存预热机制
- 缓存更新策略

### 7.2 数据库优化
#### 7.2.1 索引优化
- 用户名字段唯一索引
- 角色名称字段唯一索引
- 权限代码字段唯一索引
- 操作日志时间字段索引

#### 7.2.2 查询优化
- 分页查询优化
- 批量操作优化
- 连接查询优化

### 7.3 负载均衡
#### 7.3.1 无状态设计
- 认证服务无状态化
- 会话信息外置存储
- 缓存信息共享

#### 7.3.2 集群部署
- 支持水平扩展
- 负载均衡策略
- 故障自动转移

## 8. 高可用设计

### 8.1 数据库高可用
#### 8.1.1 主从复制
- PostgreSQL主从复制
- 读写分离策略
- 自动故障切换

#### 8.1.2 数据备份
- 每日全量备份
- 每小时增量备份
- 备份数据异地存储

### 8.2 服务高可用
#### 8.2.1 集群部署
- 多节点部署
- 负载均衡
- 健康检查机制

#### 8.2.2 容错机制
- 熔断机制
- 降级策略
- 重试机制

## 9. 监控与运维

### 9.1 监控指标
#### 9.1.1 性能指标
- API响应时间
- 系统吞吐量
- 数据库查询性能
- 缓存命中率

#### 9.1.2 安全指标
- 登录失败次数
- 异常访问行为
- 权限异常使用
- 安全事件统计

### 9.2 日志管理
#### 9.2.1 日志分类
- 应用日志：系统运行日志
- 安全日志：安全相关事件
- 审计日志：用户操作记录
- 性能日志：性能相关数据

#### 9.2.2 日志分析
- 实时日志监控
- 异常行为分析
- 安全事件预警
- 性能瓶颈分析

### 9.3 运维支持
#### 9.3.1 配置管理
- 外部化配置
- 配置热更新
- 环境隔离

#### 9.3.2 部署管理
- 容器化部署
- 自动化部署
- 灰度发布

## 10. 合规性设计

### 10.1 GMP合规
#### 10.1.1 数据完整性
- 数据修改审计追踪
- 电子签名支持
- 数据备份与恢复
- 防数据篡改机制

#### 10.1.2 权限管理
- 职责分离原则
- 最小权限分配
- 权限变更审批
- 定期权限审查

### 10.2 审计追踪
#### 10.2.1 操作日志
- 关键操作完整记录
- 日志防篡改机制
- 日志长期保存
- 日志查询分析

#### 10.2.2 合规报告
- 定期合规性报告
- 异常操作统计
- 权限使用分析
- 安全事件汇总