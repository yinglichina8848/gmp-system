# ç”¨æˆ·è®¤è¯ã€æƒé™ç®¡ç†å’Œç™»å½•ç³»ç»Ÿ - è¯¦ç»†è®¾è®¡

## ğŸ“‹ æ–‡æ¡£ä¿¡æ¯

| å±æ€§ | å€¼ |
|------|---|
| æ–‡æ¡£æ ‡é¢˜ | ç”¨æˆ·è®¤è¯ã€æƒé™ç®¡ç†å’Œç™»å½•ç³»ç»Ÿ - è¯¦ç»†è®¾è®¡ |
| ç‰ˆæœ¬å· | v0.3.0-draft |
| åˆ›å»ºæ—¥æœŸ | 2025å¹´11æœˆ19æ—¥ |
| æ›´æ–°æ—¥æœŸ | 2025å¹´11æœˆ19æ—¥ |
| ä½œè€… | GMPç³»ç»Ÿå¼€å‘å›¢é˜Ÿ |
| çŠ¶æ€ | è‰ç¨¿ |

## ğŸ“Š æ•°æ®åº“è®¾è®¡

### æ•°æ®åº“æ¶æ„

```sql
-- GMPè®¤è¯ç³»ç»Ÿæ•°æ®åº“
CREATE DATABASE auth_db;

-- è¿æ¥åˆ°auth_db
\c auth_db;
```

### æ ¸å¿ƒæ•°æ®è¡¨

#### 1. ç”¨æˆ·è¡¨ (sys_users)

```sql
-- ç”¨æˆ·åŸºæœ¬ä¿¡æ¯è¡¨
CREATE TABLE sys_users (
    id BIGSERIAL PRIMARY KEY,
    username VARCHAR(50) NOT NULL UNIQUE,
    email VARCHAR(100) UNIQUE,
    mobile VARCHAR(20),
    full_name VARCHAR(100) NOT NULL,
    password_hash VARCHAR(200) NOT NULL,
    user_status VARCHAR(20) DEFAULT 'ACTIVE' CHECK (user_status IN ('ACTIVE', 'INACTIVE', 'LOCKED', 'EXPIRED')),
    last_login_time TIMESTAMP,
    last_login_ip VARCHAR(50),
    password_expired_at TIMESTAMP,
    login_attempts INTEGER DEFAULT 0,
    locked_until TIMESTAMP,

    -- å®¡è®¡å­—æ®µ
    created_by BIGINT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_by BIGINT,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    version INTEGER DEFAULT 1
);

-- ç´¢å¼•åˆ›å»º
CREATE UNIQUE INDEX idx_users_username ON sys_users(username);
CREATE UNIQUE INDEX idx_users_email ON sys_users(email);
CREATE INDEX idx_users_status ON sys_users(user_status);
CREATE INDEX idx_users_last_login ON sys_users(last_login_time);
```

#### 2. è§’è‰²è¡¨ (sys_roles)

```sql
-- è§’è‰²å®šä¹‰è¡¨
CREATE TABLE sys_roles (
    id BIGSERIAL PRIMARY KEY,
    role_code VARCHAR(50) NOT NULL UNIQUE,
    role_name VARCHAR(100) NOT NULL,
    description TEXT,
    priority INTEGER DEFAULT 0,
    is_builtin BOOLEAN DEFAULT FALSE,
    is_active BOOLEAN DEFAULT TRUE,

    -- å®¡è®¡å­—æ®µ
    created_by BIGINT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_by BIGINT,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    version INTEGER DEFAULT 1
);

-- é¢„è®¾æ•°æ®
INSERT INTO sys_roles (role_code, role_name, description, is_builtin, is_active) VALUES
('ROLE_SYSTEM_ADMIN', 'ç³»ç»Ÿç®¡ç†å‘˜', 'ç³»ç»Ÿè¶…çº§ç®¡ç†å‘˜ï¼Œæ‹¥æœ‰æ‰€æœ‰æƒé™', TRUE, TRUE),
('ROLE_GMP_ADMIN', 'GMPç®¡ç†å‘˜', 'GMPç³»ç»Ÿç®¡ç†å‘˜ï¼Œç®¡ç†è¯å“ç”Ÿäº§åˆè§„', TRUE, TRUE),
('ROLE_QMS_MANAGER', 'è´¨é‡ç®¡ç†å‘˜', 'è´¨é‡ç®¡ç†ä½“ç³»ç®¡ç†å‘˜', TRUE, TRUE),
('ROLE_MES_MANAGER', 'ç”Ÿäº§ç®¡ç†å‘˜', 'ç”Ÿäº§æ‰§è¡Œç³»ç»Ÿç®¡ç†å‘˜', TRUE, TRUE),
('ROLE_LIMS_MANAGER', 'å®éªŒå®¤ç®¡ç†å‘˜', 'å®éªŒå®¤ä¿¡æ¯ç®¡ç†ç³»ç»Ÿç®¡ç†å‘˜', TRUE, TRUE),
('ROLE_OPERATOR', 'æ“ä½œå‘˜', 'æ™®é€šæ“ä½œå‘˜', TRUE, TRUE);
```

#### 3. æƒé™è¡¨ (sys_permissions)

```sql
-- æƒé™å®šä¹‰è¡¨
CREATE TABLE sys_permissions (
    id BIGSERIAL PRIMARY KEY,
    permission_code VARCHAR(100) NOT NULL UNIQUE,
    permission_name VARCHAR(200) NOT NULL,
    resource_type VARCHAR(50) NOT NULL, -- MENU, API, BUTTON, DATA
    resource_url VARCHAR(200),
    http_method VARCHAR(10), -- GET, POST, PUT, DELETE
    description TEXT,
    is_active BOOLEAN DEFAULT TRUE,

    -- å®¡è®¡å­—æ®µ
    created_by BIGINT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_by BIGINT,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    version INTEGER DEFAULT 1
);

-- é¢„è®¾æƒé™æ•°æ®
INSERT INTO sys_permissions (permission_code, permission_name, resource_type, resource_url, http_method, description) VALUES
-- ç³»ç»Ÿç®¡ç†
('PERMISSION_USER_MANAGE', 'ç”¨æˆ·ç®¡ç†', 'MENU', '/api/auth/users', 'ALL', 'ç”¨æˆ·å¢åˆ æ”¹æŸ¥'),
('PERMISSION_ROLE_MANAGE', 'è§’è‰²ç®¡ç†', 'MENU', '/api/auth/roles', 'ALL', 'è§’è‰²æƒé™é…ç½®'),
('PERMISSION_SYSTEM_CONFIG', 'ç³»ç»Ÿé…ç½®', 'MENU', '/api/auth/config', 'ALL', 'ç³»ç»Ÿå‚æ•°è®¾ç½®'),

-- QMSæƒé™
('PERMISSION_DEVIATION_MANAGE', 'åå·®ç®¡ç†', 'API', '/api/qms/deviations', 'ALL', 'åå·®è®°å½•ç®¡ç†'),
('PERMISSION_CAPA_MANAGE', 'CAPAç®¡ç†', 'API', '/api/qms/capas', 'ALL', 'çº æ­£é¢„é˜²æªæ–½ç®¡ç†'),
('PERMISSION_INCIDENT_MANAGE', 'ä¸è‰¯äº‹ä»¶ç®¡ç†', 'API', '/api/qms/incidents', 'ALL', 'ä¸è‰¯äº‹ä»¶è®°å½•ç®¡ç†'),

-- MESæƒé™
('PERMISSION_BATCH_MANAGE', 'æ‰¹æ¬¡ç®¡ç†', 'API', '/api/mes/batches', 'ALL', 'ç”Ÿäº§æ‰¹æ¬¡ç”Ÿå‘½å‘¨æœŸç®¡ç†'),
('PERMISSION_PLAN_MANAGE', 'è®¡åˆ’ç®¡ç†', 'API', '/api/mes/plans', 'ALL', 'ç”Ÿäº§è®¡åˆ’åˆ¶å®šä¸æ‰§è¡Œ'),
('PERMISSION_EQUIPMENT_MANAGE', 'è®¾å¤‡ç®¡ç†', 'API', '/api/mes/equipment', 'ALL', 'ç”Ÿäº§è®¾å¤‡ç›‘æ§ä¸ç»´æŠ¤'),

-- LIMSæƒé™
('PERMISSION_SAMPLE_MANAGE', 'æ ·å“ç®¡ç†', 'API', '/api/lims/samples', 'ALL', 'å®éªŒå®¤æ ·å“ç®¡ç†'),
('PERMISSION_METHOD_MANAGE', 'æ£€æµ‹æ–¹æ³•ç®¡ç†', 'API', '/api/lims/methods', 'ALL', 'æ£€æµ‹æ–¹æ³•å®šä¹‰ä¸ç»´æŠ¤'),
('PERMISSION_RESULT_MANAGE', 'ç»“æœå®¡æ ¸', 'API', '/api/lims/results', 'ALL', 'æµ‹è¯•ç»“æœå®¡æ ¸å‘å¸ƒ');
```

#### 4. ç”¨æˆ·è§’è‰²å…³è”è¡¨ (user_roles)

```sql
-- ç”¨æˆ·è§’è‰²å…³è”è¡¨
CREATE TABLE user_roles (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL,
    role_id BIGINT NOT NULL,

    -- æ—¶é—´æ§åˆ¶
    assigned_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    expired_at TIMESTAMP,
    is_active BOOLEAN DEFAULT TRUE,

    -- å®¡è®¡å­—æ®µ
    assigned_by BIGINT,
    assigned_at_audit TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (user_id) REFERENCES sys_users(id) ON DELETE CASCADE,
    FOREIGN KEY (role_id) REFERENCES sys_roles(id) ON DELETE CASCADE,
    CONSTRAINT uk_user_role UNIQUE (user_id, role_id)
);

-- ç´¢å¼•
CREATE INDEX idx_user_roles_user_id ON user_roles(user_id);
CREATE INDEX idx_user_roles_role_id ON user_roles(role_id);
CREATE INDEX idx_user_roles_active ON user_roles(is_active);
```

#### 5. è§’è‰²æƒé™å…³è”è¡¨ (role_permissions)

```sql
-- è§’è‰²æƒé™å…³è”è¡¨
CREATE TABLE role_permissions (
    id BIGSERIAL PRIMARY KEY,
    role_id BIGINT NOT NULL,
    permission_id BIGINT NOT NULL,

    -- æ—¶é—´æ§åˆ¶
    granted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    expired_at TIMESTAMP,
    is_active BOOLEAN DEFAULT TRUE,

    -- å®¡è®¡å­—æ®µ
    granted_by BIGINT,
    granted_at_audit TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (role_id) REFERENCES sys_roles(id) ON DELETE CASCADE,
    FOREIGN KEY (permission_id) REFERENCES sys_permissions(id) ON DELETE CASCADE,
    CONSTRAINT uk_role_permission UNIQUE (role_id, permission_id)
);

-- ç´¢å¼•
CREATE INDEX idx_role_perm_role_id ON role_permissions(role_id);
CREATE INDEX idx_role_perm_perm_id ON role_permissions(permission_id);
CREATE INDEX idx_role_perm_active ON role_permissions(is_active);
```

#### 6. JWTä»¤ç‰Œé»‘åå•è¡¨ (jwt_blacklist)

```sql
-- JWTä»¤ç‰Œé»‘åå•è¡¨
CREATE TABLE jwt_blacklist (
    id BIGSERIAL PRIMARY KEY,
    token_id VARCHAR(100) NOT NULL UNIQUE,
    token_content TEXT,
    expired_at TIMESTAMP NOT NULL,
    blacklisted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    blacklist_reason VARCHAR(200),

    -- å…³è”ç”¨æˆ·
    user_id BIGINT,
    username VARCHAR(50),

    FOREIGN KEY (user_id) REFERENCES sys_users(id)
);

-- ç´¢å¼•
CREATE UNIQUE INDEX idx_jwt_token_id ON jwt_blacklist(token_id);
CREATE INDEX idx_jwt_expired_at ON jwt_blacklist(expired_at);
CREATE INDEX idx_jwt_user_id ON jwt_blacklist(user_id);
```

### å®¡è®¡æ—¥å¿—è¡¨

#### 7. ç”¨æˆ·æ“ä½œæ—¥å¿— (user_operation_logs)

```sql
-- ç”¨æˆ·æ“ä½œå®¡è®¡æ—¥å¿—
CREATE TABLE user_operation_logs (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT,
    username VARCHAR(50),
    operation VARCHAR(100) NOT NULL, -- LOGIN, LOGOUT, ROLE_CHANGE, etc.
    module VARCHAR(50) NOT NULL, -- AUTH, USER, ROLE, PERMISSION
    action VARCHAR(200) NOT NULL, -- å…·ä½“æ“ä½œæè¿°
    result VARCHAR(20) DEFAULT 'SUCCESS' CHECK (result IN ('SUCCESS', 'FAILED')),

    -- è¯·æ±‚ä¿¡æ¯
    ip_address VARCHAR(50),
    user_agent TEXT,

    -- è¯·æ±‚æ•°æ®
    request_data JSONB,
    response_data JSONB,

    -- æ—¶é—´ä¿¡æ¯
    operation_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    duration_ms INTEGER, -- æ“ä½œè€—æ—¶

    -- å…ƒæ•°æ®
    metadata JSONB
);

-- ç´¢å¼•
CREATE INDEX idx_logs_user_id ON user_operation_logs(user_id);
CREATE INDEX idx_logs_username ON user_operation_logs(username);
CREATE INDEX idx_logs_operation ON user_operation_logs(operation);
CREATE INDEX idx_logs_module ON user_operation_logs(module);
CREATE INDEX idx_logs_time ON user_operation_logs(operation_time);
CREATE INDEX idx_logs_result ON user_operation_logs(result);
```

## ğŸ”Œ APIæ¥å£è®¾è®¡

### APIè®¾è®¡åŸåˆ™

1. **RESTfulè®¾è®¡**ï¼šéµå¾ªRESTfulè§„èŒƒ
2. **ç‰ˆæœ¬æ§åˆ¶**ï¼šAPIç‰ˆæœ¬ç®¡ç† `/api/v1/auth`
3. **æ–‡æ¡£åŒ–**ï¼šSwagger/OpenAPIæ–‡æ¡£
4. **å®‰å…¨æ€§**ï¼šHTTPS + JWTè®¤è¯
5. **ç»Ÿä¸€å“åº”**ï¼šæ ‡å‡†JSONå“åº”æ ¼å¼

### ç»Ÿä¸€å“åº”æ ¼å¼

```typescript
// æˆåŠŸå“åº”
{
    "success": true,
    "code": "200",
    "message": "æ“ä½œæˆåŠŸ",
    "data": { /* ä¸šåŠ¡æ•°æ® */ },
    "timestamp": "2025-11-19T10:30:00Z"
}

// å¤±è´¥å“åº”
{
    "success": false,
    "code": "401",
    "message": "è®¤è¯å¤±è´¥",
    "data": null,
    "timestamp": "2025-11-19T10:30:00Z"
}

// åˆ†é¡µå“åº”
{
    "success": true,
    "code": "200",
    "data": {
        "records": [...],  // æ•°æ®åˆ—è¡¨
        "total": 100,
        "current": 1,
        "size": 10,
        "pages": 10
    }
}
```

### è®¤è¯APIæ¥å£

#### ç”¨æˆ·ç™»å½• (POST /api/auth/v1/login)

```typescript
// è¯·æ±‚
{
    "username": "admin",
    "password": "Admin123!",
    "rememberMe": false
}

// å“åº”
{
    "success": true,
    "code": "200",
    "data": {
        "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
        "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
        "tokenType": "Bearer",
        "expiresIn": 86400,
        "username": "admin",
        "fullName": "ç³»ç»Ÿç®¡ç†å‘˜",
        "roles": ["ROLE_SYSTEM_ADMIN"],
        "permissions": ["PERMISSION_USER_MANAGE", "..."]
    }
}
```

#### ä»¤ç‰Œåˆ·æ–° (POST /api/auth/v1/refresh)

```typescript
// è¯·æ±‚
{
    "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}

// å“åº”
{
    "success": true,
    "code": "200",
    "data": {
        "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
        "expiresIn": 86400
    }
}
```

#### ç”¨æˆ·ç™»å‡º (POST /api/auth/v1/logout)

```typescript
// è¯·æ±‚ Headers: Authorization: Bearer {token}

// å“åº”
{
    "success": true,
    "code": "200",
    "message": "ç™»å‡ºæˆåŠŸ"
}
```

### ç”¨æˆ·ç®¡ç†API

#### è·å–ç”¨æˆ·ä¿¡æ¯ (GET /api/auth/v1/users/me)

```typescript
// å“åº”
{
    "success": true,
    "code": "200",
    "data": {
        "id": 1,
        "username": "admin",
        "email": "admin@gmp-system.com",
        "fullName": "ç³»ç»Ÿç®¡ç†å‘˜",
        "userStatus": "ACTIVE",
        "lastLoginTime": "2025-11-19T09:30:00",
        "roles": [
            {
                "id": 1,
                "roleCode": "ROLE_SYSTEM_ADMIN",
                "roleName": "ç³»ç»Ÿç®¡ç†å‘˜"
            }
        ]
    }
}
```

#### ç”¨æˆ·åˆ—è¡¨æŸ¥è¯¢ (GET /api/auth/v1/users)

**æŸ¥è¯¢å‚æ•°**ï¼š
- `page`: é¡µç  (é»˜è®¤1)
- `size`: é¡µå¤§å° (é»˜è®¤10)
- `sort`: æ’åºå­—æ®µ
- `order`: æ’åºæ–¹å‘ (asc/desc)
- `username`: ç”¨æˆ·åæ¨¡ç³ŠæŸ¥è¯¢
- `status`: ç”¨æˆ·çŠ¶æ€è¿‡æ»¤

#### åˆ›å»ºç”¨æˆ· (POST /api/auth/v1/users)

```typescript
// è¯·æ±‚
{
    "username": "john.doe",
    "email": "john.doe@gmp-system.com",
    "fullName": "John Doe",
    "password": "TempPass123!",
    "mobile": "13800138000",
    "roleIds": [2, 3]  // GMP_ADMIN, QMS_MANAGER
}

// å“åº”
{
    "success": true,
    "code": "201",
    "data": {
        "id": 10010,
        "username": "john.doe",
        "createdAt": "2025-11-19T10:30:00"
    }
}
```

### è§’è‰²ç®¡ç†API

#### è§’è‰²æƒé™é…ç½® (PUT /api/auth/v1/roles/{roleId}/permissions)

```typescript
// è¯·æ±‚
{
    "permissionIds": [1, 2, 3, 4, 5]
}

// å“åº”
{
    "success": true,
    "code": "200",
    "message": "è§’è‰²æƒé™é…ç½®æˆåŠŸ"
}
```

### æƒé™éªŒè¯API

#### ä»¤ç‰ŒéªŒè¯ (POST /api/auth/v1/verify)

```typescript
// è¯·æ±‚
{
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "requiredPermissions": ["PERMISSION_USER_MANAGE"]
}

// å“åº”
{
    "success": true,
    "code": "200",
    "data": {
        "valid": true,
        "user": {
            "id": 1,
            "username": "admin"
        },
        "permissions": ["PERMISSION_USER_MANAGE", "..."]
    }
}
```

## ğŸ–¥ï¸ å‰ç«¯ç•Œé¢è®¾è®¡

### é¡µé¢æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             â”‚             â”‚             â”‚
â”‚   ç™»å½•é¡µ    â”‚  ç”¨æˆ·ç®¡ç†   â”‚  è§’è‰²ç®¡ç†   â”‚
â”‚             â”‚             â”‚             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚             â”‚             â”‚             â”‚
â”‚ ç”¨æˆ·åˆ—è¡¨    â”‚ æƒé™é…ç½®    â”‚ ç³»ç»Ÿç›‘æ§    â”‚
â”‚             â”‚             â”‚             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚             â”‚             â”‚             â”‚
â”‚ æ“ä½œæ—¥å¿—    â”‚ å®‰å…¨è®¾ç½®    â”‚   è®¾ç½®       â”‚
â”‚             â”‚             â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç™»å½•é¡µé¢è®¾è®¡

```html
<form id="loginForm" class="login-form">
    <div class="form-header">
        <h2>GMPä¿¡æ¯ç®¡ç†ç³»ç»Ÿ</h2>
        <p>è¯·ä½¿ç”¨æ‚¨çš„è´¦å·ç™»å½•</p>
    </div>

    <div class="form-group">
        <label for="username">ç”¨æˆ·å</label>
        <input type="text" id="username" name="username" required>
    </div>

    <div class="form-group">
        <label for="password">å¯†ç </label>
        <input type="password" id="password" name="password" required>
    </div>

    <div class="form-options">
        <label class="checkbox">
            <input type="checkbox" name="rememberMe">
            è®°ä½æˆ‘
        </label>
        <a href="/forgot-password" class="link">å¿˜è®°å¯†ç ï¼Ÿ</a>
    </div>

    <button type="submit" class="login-btn">ç™»å½•</button>
    <div id="errorMessage" class="error-message" style="display:none;"></div>
</form>
```

### ç®¡ç†æ§åˆ¶å°è®¾è®¡

```html
<div class="admin-dashboard">
    <!-- é¡µé¢å¤´éƒ¨ -->
    <header class="dashboard-header">
        <div class="logo">GMP Auth</div>
        <nav class="nav-menu">
            <a href="/admin/users">ç”¨æˆ·ç®¡ç†</a>
            <a href="/admin/roles">è§’è‰²ç®¡ç†</a>
            <a href="/admin/logs">æ“ä½œæ—¥å¿—</a>
            <a href="/logout">é€€å‡ºç™»å½•</a>
        </nav>
    </header>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <main class="dashboard-body">
        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="stats-cards">
            <div class="stat-card">
                <h3>æ€»ç”¨æˆ·æ•°</h3>
                <div class="number">1250</div>
                <div class="change positive">+12%</div>
            </div>
            <!-- å…¶ä»–ç»Ÿè®¡å¡ç‰‡ -->
        </div>

        <!--å¯¼èˆªèœå•-->
        <nav class="sys-nav">
            <ul>
                <li><a href="#users" id="menu-users">ç”¨æˆ·ç®¡ç†</a></li>
                <li><a href="#roles" id="menu-roles">è§’è‰²ç®¡ç†</a></li>
                <li><a href="#permissions" id="menu-permissions">æƒé™ç®¡ç†</a></li>
                <li><a href="#logs" id="menu-logs">æ“ä½œæ—¥å¿—</a></li>
            </ul>
        </nav>

        <!--æ•°æ®è¡¨æ ¼-->
        <section id="content-section" class="content">
            <!--åŠ¨æ€åŠ è½½é¡µé¢å†…å®¹-->
        </section>
    </main>
</div>
```

## ğŸ” å®‰å…¨å®ç°æ–¹æ¡ˆ

### JWTå®ç°ç»†èŠ‚

```java
@Configuration
public class JwtConfig {

    @Value("${jwt.secret:default-secret}")
    private String secret;

    @Value("${jwt.expiration:86400000}")
    private Long expiration;

    public String generateToken(User user) {
        Map<String, Object> claims = Map.of(
            "sub", user.getUsername(),
            "iat", System.currentTimeMillis() / 1000,
            "exp", (System.currentTimeMillis() / 1000) + expiration,
            "roles", user.getRoles().stream()
                .map(Role::getRoleCode)
                .collect(Collectors.toList()),
            "permissions", user.getPermissions()
        );

        return Jwts.builder()
            .setClaims(claims)
            .signWith(SignatureAlgorithm.HS256, secret.getBytes())
            .compact();
    }
}
```

### ç½‘å…³è¿‡æ»¤å™¨å®ç°

```java
@Component
public class JwtAuthenticationFilter extends AbstractGatewayFilterFactory<JwtAuthenticationFilter.Config> {

    @Autowired
    private AuthServiceFeignClient authClient;

    @Override
    public GatewayFilter apply(Config config) {
        return (exchange, chain) -> {
            String token = extractToken(exchange);

            if (token == null) {
                return onError(exchange, "Missing JWT token");
            }

            try {
                // éªŒè¯ä»¤ç‰Œ
                TokenVerificationResult result = authClient.verifyToken(token);

                // æ·»åŠ ç”¨æˆ·ä¿¡æ¯åˆ°è¯·æ±‚å¤´
                exchange.getRequest().mutate()
                    .header("X-Authenticated-User", result.getUsername())
                    .header("X-User-Roles", String.join(",", result.getRoles()))
                    .build();

                return chain.filter(exchange);

            } catch (Exception e) {
                return onError(exchange, "Invalid JWT token");
            }
        };
    }
}
```

## ğŸ“Š ç›‘æ§ä¸å®¡è®¡

### Prometheusç›‘æ§æŒ‡æ ‡

```
# HTTPè¯·æ±‚è®¡æ•°å™¨
http_requests_total{method,endpoint,status}

# è®¤è¯æ“ä½œè®¡æ•°å™¨
auth_operations_total{operation,type,result}

# ç”¨æˆ·ä¼šè¯ç»Ÿè®¡
active_user_sessions{gauge}

# JWTä»¤ç‰ŒéªŒè¯å»¶è¿Ÿ
jwt_verification_duration_seconds{quantile}

# æ•°æ®åº“è¿æ¥æ± ä½¿ç”¨ç‡
db_connection_pool_usage{gauge}
```

### æ—¥å¿—æ¶æ„

```java
@Slf4j
@Component
public class OperationLogger {

    @PostConstruct
    public void init() {
        MDC.put("service", "auth-service");
    }

    public void logUserOperation(UserOperationLog operation) {
        log.info("User operation: user={}, operation={}, module={}, action={}",
            operation.getUsername(),
            operation.getOperation(),
            operation.getModule(),
            operation.getAction()
        );

        // ä¿å­˜åˆ°æ•°æ®åº“
        operationLogRepository.save(operation);
    }
}
```

## ğŸš€ éƒ¨ç½²é…ç½®

### Dockeré…ç½®

```dockerfile
# auth-service Dockerfile
FROM openjdk:17-jre-slim

COPY target/auth-service.jar /app/app.jar

EXPOSE 8085

CMD ["java", "-jar", "/app/app.jar", "--spring.profiles.active=prod"]
```

### Docker Composeé…ç½®

```yaml
services:
  auth-service:
    image: gmp/auth-service:v0.3.0
    container_name: gmp-auth-service
    ports:
      - "8085:8085"
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/auth_db
      - SPRING_DATASOURCE_USERNAME=auth_user
      - SPRING_DATASOURCE_PASSWORD=${AUTH_DB_PASSWORD}
      - SPRING_REDIS_HOST=redis
      - SPRING_REDIS_PASSWORD=${REDIS_PASSWORD}
      - EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://eureka-server:8761/eureka/
    restart: unless-stopped
    depends_on:
      - postgres
      - redis
    networks:
      - gmp-network
```

## ğŸ“‹ å®ç°è¿›åº¦è¡¨

| æ¨¡å— | çŠ¶æ€ | é¢„è®¡å®Œæˆæ—¥æœŸ | è´Ÿè´£äºº |
|------|------|--------------|--------|
| æ•°æ®åº“è®¾è®¡ | âœ… å®Œæˆ | 2025-11-19 | ç³»ç»Ÿæ¶æ„å¸ˆ |
| ç”¨æˆ·ç®¡ç†API | ğŸ”„ å¼€å‘ä¸­ | 2025-11-22 | åç«¯å¼€å‘å·¥ç¨‹å¸ˆ |
| è§’è‰²æƒé™ç³»ç»Ÿ | â³ å¾…å¼€å‘ | 2025-11-25 | åç«¯å¼€å‘å·¥ç¨‹å¸ˆ |
| JWTè®¤è¯æ¨¡å— | ğŸ”„ å¼€å‘ä¸­ | 2025-11-22 | åç«¯å¼€å‘å·¥ç¨‹å¸ˆ |
| å‰ç«¯ç™»å½•é¡µé¢ | â³ å¾…å¼€å‘ | 2025-11-26 | å‰ç«¯å¼€å‘å·¥ç¨‹å¸ˆ |
| ç®¡ç†æ§åˆ¶å° | â³ å¾…å¼€å‘ | 2025-11-28 | å‰ç«¯å¼€å‘å·¥ç¨‹å¸ˆ |
| å®¡è®¡æ—¥å¿—ç³»ç»Ÿ | â³ å¾…å¼€å‘ | 2025-11-25 | åç«¯å¼€å‘å·¥ç¨‹å¸ˆ |
| å•å…ƒæµ‹è¯• | â³ å¾…å¼€å‘ | 2025-11-30 | æµ‹è¯•å·¥ç¨‹å¸ˆ |
| é›†æˆæµ‹è¯• | â³ å¾…å¼€å‘ | 2025-12-02 | æµ‹è¯•å·¥ç¨‹å¸ˆ |

---

*æ–‡æ¡£ç‰ˆæœ¬ï¼šv0.3.0-draft*
*å®¡æ ¸çŠ¶æ€ï¼šå¾…å®¡æ ¸*
*ä¸‹æ¬¡æ›´æ–°ï¼šå®ç°å®Œæˆå*