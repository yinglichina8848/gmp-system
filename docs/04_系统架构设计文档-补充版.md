# GMPä¿¡æ¯ç®¡ç†ç³»ç»Ÿæ¶æ„è®¾è®¡æ–‡æ¡£ï¼ˆè¡¥å……å®Œå–„ç‰ˆï¼‰

## ğŸš¨ å…³é”®è®¾è®¡ç¼ºé™·ä¿®å¤

### 1. å®‰å…¨æ¶æ„è®¾è®¡ï¼ˆæ–°å¢ï¼‰

#### 1.1 å¤šå±‚å®‰å…¨ç­–ç•¥
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                ç½‘ç»œå®‰å…¨å±‚                               â”‚
â”‚  - é˜²ç«å¢™è§„åˆ™ï¼šåªå…è®¸443ç«¯å£HTTPSè®¿é—®                    â”‚
â”‚  - VPNæ¥å…¥ï¼šè¿œç¨‹è®¿é—®å¿…é¡»é€šè¿‡VPN                          â”‚
â”‚  - DDoSé˜²æŠ¤ï¼šCloudFlareæˆ–é˜¿é‡Œäº‘ç›¾                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                åº”ç”¨å®‰å…¨å±‚                               â”‚
â”‚  - JWT Token + Refresh Token                           â”‚
â”‚  - OAuth2.0è®¤è¯æˆæƒ                                    â”‚
â”‚  - è¾“å…¥éªŒè¯ + SQLæ³¨å…¥é˜²æŠ¤                              â”‚
â”‚  - XSSæ”»å‡»é˜²æŠ¤                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                æ•°æ®å®‰å…¨å±‚                               â”‚
â”‚  - æ•°æ®åº“è¿æ¥åŠ å¯†ï¼ˆSSL/TLSï¼‰                            â”‚
â”‚  - æ•æ„Ÿæ•°æ®AES-256åŠ å¯†                                â”‚
â”‚  - æ•°æ®ä¼ è¾“HTTPSåŠ å¯†                                  â”‚
â”‚  - å¯†é’¥ç®¡ç†ï¼šHashiCorp Vault                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 1.2 æƒé™ç®¡ç†è®¾è®¡ï¼ˆRBAC + ABACï¼‰
```java
// å¢å¼ºçš„æƒé™ç®¡ç†å®ä½“
@Entity
@Table(name = "sys_permissions")
public class Permission {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    private String resource;     // èµ„æºï¼šdeviation, batch, sample
    private String action;     // æ“ä½œï¼šcreate, read, update, delete
    private String condition;  // æ¡ä»¶ï¼šOWN, DEPARTMENT, ALL
    private String expression; // SpELè¡¨è¾¾å¼ï¼š#user.department == #resource.department
}

// æ•°æ®æƒé™æ³¨è§£
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface DataPermission {
    String resource();      // èµ„æºç±»å‹
    String action();        // æ“ä½œç±»å‹
}

// ä½¿ç”¨ç¤ºä¾‹
@Service
public class DeviationService {
    @DataPermission(resource = "deviation", action = "read")
    public Page<Deviation> findDeviations(Pageable pageable) {
        // è‡ªåŠ¨æ ¹æ®ç”¨æˆ·æƒé™è¿‡æ»¤æ•°æ®
        return deviationRepository.findAll(withPermission());
    }
}
```

#### 1.3 å®¡è®¡æ—¥å¿—è®¾è®¡
```java
// å®¡è®¡æ—¥å¿—å®ä½“
@Entity
@Table(name = "audit_logs")
public class AuditLog {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    private String userId;          // ç”¨æˆ·ID
    private String userName;        // ç”¨æˆ·å
    private String action;          // æ“ä½œç±»å‹
    private String resourceType;    // èµ„æºç±»å‹
    private String resourceId;      // èµ„æºID
    private String oldValue;        // å˜æ›´å‰å€¼ï¼ˆJSONï¼‰
    private String newValue;        // å˜æ›´åå€¼ï¼ˆJSONï¼‰
    private String ipAddress;       // IPåœ°å€
    private String userAgent;       // ç”¨æˆ·ä»£ç†
    private LocalDateTime timestamp; // æ“ä½œæ—¶é—´
    private String signature;       // æ•°å­—ç­¾åé˜²ç¯¡æ”¹
}

// å®¡è®¡åˆ‡é¢
@Aspect
@Component
public class AuditAspect {
    @Around("@annotation(Auditable)")
    public Object audit(ProceedingJoinPoint joinPoint) throws Throwable {
        // è®°å½•æ“ä½œå‰æ•°æ®
        Object result = joinPoint.proceed();
        // è®°å½•æ“ä½œåæ•°æ®å¹¶å†™å…¥å®¡è®¡æ—¥å¿—
        writeAuditLog(joinPoint, result);
        return result;
    }
}
```

### 2. æ•°æ®å®Œæ•´æ€§ä¿éšœï¼ˆæ–°å¢ï¼‰

#### 2.1 æ•°æ®å¤‡ä»½ç­–ç•¥
```yaml
# æ•°æ®åº“å¤‡ä»½é…ç½®
backup:
  strategy:
    full_backup:      # å…¨é‡å¤‡ä»½
      frequency: daily
      time: "02:00"
      retention: 30_days
    
    incremental_backup: # å¢é‡å¤‡ä»½
      frequency: hourly
      retention: 7_days
    
    transaction_log_backup: # äº‹åŠ¡æ—¥å¿—å¤‡ä»½
      frequency: 15_minutes
      retention: 24_hours
  
  storage:
    local: /backup/gmp_system
    cloud: s3://gmp-backup-bucket/
    encryption: AES-256
    
  restore:
    test_frequency: weekly
    recovery_time_objective: 4_hours
    recovery_point_objective: 15_minutes
```

#### 2.2 æ•°æ®ä¸€è‡´æ€§æ ¡éªŒ
```sql
-- æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥è„šæœ¬
CREATE OR REPLACE FUNCTION check_data_consistency()
RETURNS TABLE (
    table_name VARCHAR,
    check_type VARCHAR,
    status VARCHAR,
    message TEXT
) AS $$
BEGIN
    -- æ£€æŸ¥å¤–é”®å®Œæ•´æ€§
    RETURN QUERY
    SELECT 
        tc.table_name::VARCHAR,
        'FOREIGN_KEY'::VARCHAR,
        CASE 
            WHEN COUNT(*) > 0 THEN 'FAILED'
            ELSE 'PASSED'
        END::VARCHAR,
        CONCAT(COUNT(*), ' broken foreign keys')::TEXT
    FROM information_schema.table_constraints tc
    LEFT JOIN information_schema.key_column_usage kcu
        ON tc.constraint_name = kcu.constraint_name
    WHERE tc.constraint_type = 'FOREIGN KEY'
    GROUP BY tc.table_name;
    
    -- æ£€æŸ¥æ•°æ®èŒƒå›´å®Œæ•´æ€§
    RETURN QUERY
    SELECT 
        'deviations'::VARCHAR,
        'DATE_RANGE'::VARCHAR,
        CASE 
            WHEN COUNT(*) > 0 THEN 'FAILED'
            ELSE 'PASSED'
        END::VARCHAR,
        CONCAT(COUNT(*), ' records with invalid dates')::TEXT
    FROM deviations
    WHERE reported_date > CURRENT_DATE 
       OR due_date < reported_date;
END;
$$ LANGUAGE plpgsql;
```

#### 2.3 ç¾éš¾æ¢å¤æ–¹æ¡ˆ
```bash
#!/bin/bash
# ç¾éš¾æ¢å¤è„šæœ¬

# 1. å¤‡ä»½éªŒè¯
echo "éªŒè¯å¤‡ä»½å®Œæ•´æ€§..."
pg_verifybackup /backup/latest/

# 2. åœæ­¢åº”ç”¨æœåŠ¡
echo "åœæ­¢åº”ç”¨æœåŠ¡..."
docker-compose down

# 3. æ¢å¤æ•°æ®åº“
echo "æ¢å¤æ•°æ®åº“..."
pg_restore -d gmp_system /backup/latest/gmp_database.dump

# 4. éªŒè¯æ•°æ®å®Œæ•´æ€§
echo "éªŒè¯æ•°æ®å®Œæ•´æ€§..."
psql -d gmp_system -c "SELECT * FROM check_data_consistency();"

# 5. å¯åŠ¨æœåŠ¡
echo "å¯åŠ¨åº”ç”¨æœåŠ¡..."
docker-compose up -d

# 6. å¥åº·æ£€æŸ¥
echo "ç³»ç»Ÿå¥åº·æ£€æŸ¥..."
curl -f http://localhost:8080/health || exit 1
```

### 3. æ€§èƒ½ä¼˜åŒ–è®¾è®¡ï¼ˆæ–°å¢ï¼‰

#### 3.1 æ€§èƒ½æŒ‡æ ‡å®šä¹‰
```yaml
# æ€§èƒ½æŒ‡æ ‡é…ç½®
performance:
  metrics:
    response_time:
      api_gateway: "< 100ms"
      microservice: "< 200ms"
      database_query: "< 50ms"
    
    throughput:
      concurrent_users: 500
      transactions_per_second: 1000
      file_upload: "10MB/s"
    
    availability:
      uptime: "99.9%"
      mean_time_to_recovery: "< 4 hours"
      mean_time_between_failures: "> 720 hours"
  
  monitoring:
    alerts:
      - name: "High Response Time"
        condition: "response_time > 500ms"
        duration: "5 minutes"
        severity: "warning"
      
      - name: "Database Connection Pool Exhausted"
        condition: "connection_pool_usage > 90%"
        duration: "2 minutes"
        severity: "critical"
```

#### 3.2 ç¼“å­˜ç­–ç•¥è®¾è®¡
```java
// å¤šçº§ç¼“å­˜é…ç½®
@Configuration
@EnableCaching
public class CacheConfig {
    
    @Bean
    public CacheManager cacheManager() {
        // L1ç¼“å­˜ï¼šæœ¬åœ°Caffeineç¼“å­˜
        CaffeineCacheManager localCache = new CaffeineCacheManager();
        localCache.setCaffeine(Caffeine.newBuilder()
            .maximumSize(1000)
            .expireAfterWrite(5, TimeUnit.MINUTES));
        
        // L2ç¼“å­˜ï¼šRedisåˆ†å¸ƒå¼ç¼“å­˜
        RedisCacheManager redisCache = RedisCacheManager.builder(redisConnectionFactory())
            .cacheDefaults(RedisCacheConfiguration.defaultCacheConfig()
                .entryTtl(Duration.ofMinutes(30)))
            .build();
        
        // å¤šçº§ç¼“å­˜ç®¡ç†å™¨
        return new MultiLevelCacheManager(localCache, redisCache);
    }
}

// ç¼“å­˜æ³¨è§£ä½¿ç”¨
@Service
public class DeviationService {
    
    @Cacheable(value = "deviations", key = "#id", unless = "#result == null")
    public Deviation findById(Long id) {
        return deviationRepository.findById(id).orElse(null);
    }
    
    @CacheEvict(value = "deviations", key = "#deviation.id")
    @Auditable(action = "UPDATE")
    public Deviation update(Deviation deviation) {
        return deviationRepository.save(deviation);
    }
}
```

#### 3.3 æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–
```sql
-- æ€§èƒ½ä¼˜åŒ–ç´¢å¼•
-- åå·®æŸ¥è¯¢ä¼˜åŒ–
CREATE INDEX idx_deviations_status_date ON deviations(status, reported_date);
CREATE INDEX idx_deviations_severity ON deviations(severity) WHERE status != 'CLOSED';

-- æ‰¹æ¬¡æŸ¥è¯¢ä¼˜åŒ–
CREATE INDEX idx_batches_product_status ON production_batches(product_id, status);
CREATE INDEX idx_batches_date ON production_batches(start_time DESC, end_time);

-- æ ·å“æŸ¥è¯¢ä¼˜åŒ–
CREATE INDEX idx_samples_batch ON samples(batch_id) WHERE status = 'TESTING';
CREATE INDEX idx_samples_due_date ON samples(due_date) WHERE status IN ('RECEIVED', 'TESTING');

-- åˆ†åŒºè¡¨è®¾è®¡ï¼ˆå¤§æ•°æ®é‡ï¼‰
CREATE TABLE audit_logs_2024 PARTITION OF audit_logs
    FOR VALUES FROM ('2024-01-01') TO ('2025-01-01');

-- ç‰©åŒ–è§†å›¾ï¼ˆå¤æ‚æŸ¥è¯¢ä¼˜åŒ–ï¼‰
CREATE MATERIALIZED VIEW batch_quality_summary AS
SELECT 
    pb.batch_number,
    pb.product_name,
    pb.status,
    COUNT(s.id) as sample_count,
    COUNT(CASE WHEN tr.result_status = 'PASS' THEN 1 END) as pass_count,
    COUNT(CASE WHEN tr.result_status = 'FAIL' THEN 1 END) as fail_count
FROM production_batches pb
LEFT JOIN samples s ON pb.id = s.batch_id
LEFT JOIN test_results tr ON s.id = tr.sample_id
GROUP BY pb.id, pb.batch_number, pb.product_name, pb.status;
```

### 4. ç³»ç»Ÿé›†æˆè®¾è®¡ï¼ˆæ–°å¢ï¼‰

#### 4.1 ERPç³»ç»Ÿé›†æˆ
```java
// ERPç³»ç»Ÿé€‚é…å™¨
@Component
public class ErpIntegrationAdapter {
    
    @Value("${erp.system.url}")
    private String erpUrl;
    
    @Value("${erp.system.api-key}")
    private String apiKey;
    
    // åŒæ­¥ç‰©æ–™ä¸»æ•°æ®
    public void syncMaterialMaster() {
        List<Material> materials = erpClient.getMaterials();
        materials.forEach(this::updateLocalMaterial);
    }
    
    // åŒæ­¥ç”Ÿäº§è®¢å•
    public void syncProductionOrders() {
        List<ProductionOrder> orders = erpClient.getProductionOrders();
        orders.forEach(order -> {
            ProductionBatch batch = convertToBatch(order);
            mesService.createBatch(batch);
        });
    }
    
    // å›ä¼ è´¨é‡ç»“æœ
    public void uploadQualityResults(String batchNumber, List<TestResult> results) {
        QualityReport report = buildQualityReport(batchNumber, results);
        erpClient.uploadQualityReport(report);
    }
}

// é›†æˆé…ç½®
@Configuration
public class IntegrationConfig {
    
    @Bean
    public IntegrationFlow erpIntegrationFlow() {
        return IntegrationFlows.from("erpInputChannel")
            .handle("erpIntegrationAdapter", "syncMaterialMaster")
            .channel("erpOutputChannel")
            .get();
    }
    
    @Scheduled(fixedRate = 300000) // 5åˆ†é’ŸåŒæ­¥ä¸€æ¬¡
    public void scheduleErpSync() {
        erpIntegrationAdapter.syncMaterialMaster();
    }
}
```

#### 4.2 è®¾å¤‡PLCæ¥å£
```java
// PLCé€šä¿¡æœåŠ¡
@Service
public class PlcCommunicationService {
    
    private final ModbusTcpMaster plcMaster;
    
    @PostConstruct
    public void init() {
        // åˆå§‹åŒ–Modbusè¿æ¥
        ModbusTcpConfig config = new ModbusTcpConfig.Builder("192.168.1.100")
            .setPort(502)
            .setTimeout(5000)
            .build();
        this.plcMaster = new ModbusTcpMaster(config);
    }
    
    // è¯»å–è®¾å¤‡å‚æ•°
    public EquipmentData readEquipmentData(int equipmentId) {
        try {
            // è¯»å–æ¸©åº¦
            float temperature = plcMaster.readHoldingRegister(1001, 1)[0] / 10.0f;
            
            // è¯»å–å‹åŠ›
            float pressure = plcMaster.readHoldingRegister(1002, 1)[0] / 100.0f;
            
            // è¯»å–è¿è¡ŒçŠ¶æ€
            boolean running = plcMaster.readCoil(2001);
            
            return EquipmentData.builder()
                .equipmentId(equipmentId)
                .temperature(temperature)
                .pressure(pressure)
                .running(running)
                .timestamp(LocalDateTime.now())
                .build();
                
        } catch (Exception e) {
            log.error("PLCé€šä¿¡å¤±è´¥: {}", e.getMessage());
            throw new PlcCommunicationException("è®¾å¤‡æ•°æ®é‡‡é›†å¤±è´¥");
        }
    }
    
    // å†™å…¥æ§åˆ¶å‚æ•°
    public void writeControlParameter(int address, float value) {
        int registerValue = (int)(value * 10);
        plcMaster.writeHoldingRegister(address, registerValue);
    }
}

// OPC UAå®¢æˆ·ç«¯ï¼ˆç°ä»£è®¾å¤‡ï¼‰
@Service
public class OpcUaClientService {
    
    private OpcUaClient opcClient;
    
    @PostConstruct
    public void init() throws Exception {
        EndpointDescription endpoint = DiscoveryClient.getEndpoints("opc.tcp://192.168.1.101:4840")
            .get(0);
            
        OpcUaClientConfig config = OpcUaClientConfig.builder()
            .setEndpoint(endpoint)
            .setIdentityProvider(new UsernameProvider("admin", "password"))
            .build();
            
        this.opcClient = new OpcUaClient(config);
        opcClient.connect().get();
    }
    
    // è®¢é˜…è®¾å¤‡æ•°æ®å˜åŒ–
    public void subscribeEquipmentData(String nodeId, Consumer<DataValue> callback) {
        try {
            NodeId node = NodeId.parse(nodeId);
            
            opcClient.subscribe(100.0, (value) -> {
                callback.accept(value);
            }, node);
            
        } catch (Exception e) {
            log.error("OPC UAè®¢é˜…å¤±è´¥: {}", e.getMessage());
        }
    }
}
```

#### 4.3 APIç‰ˆæœ¬ç®¡ç†
```java
// APIç‰ˆæœ¬æ§åˆ¶é…ç½®
@Configuration
public class ApiVersionConfig implements WebMvcConfigurer {
    
    @Override
    public void configurePathMatch(PathMatchConfigurer configurer) {
        configurer.addPathPrefix("/api/v{version}", HandlerTypePredicate.forAnnotation(RestController.class));
    }
}

// ç‰ˆæœ¬æ³¨è§£
@Target({ElementType.METHOD, ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
public @interface ApiVersion {
    String[] value();
}

// æ§åˆ¶å™¨ç‰ˆæœ¬æ§åˆ¶
@RestController
@RequestMapping("/deviations")
@ApiVersion({"1.0", "1.1"})
public class DeviationController {
    
    @GetMapping
    @ApiVersion("1.0")
    public ApiResponse<List<Deviation>> getDeviationsV1() {
        // v1.0ç‰ˆæœ¬é€»è¾‘
        return ApiResponse.success(deviationService.findAll());
    }
    
    @GetMapping
    @ApiVersion("1.1")
    public ApiResponse<Page<Deviation>> getDeviationsV1_1(
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "20") int size) {
        // v1.1ç‰ˆæœ¬æ”¯æŒåˆ†é¡µ
        Pageable pageable = PageRequest.of(page, size);
        return ApiResponse.success(deviationService.findAll(pageable));
    }
}
```

### 5. ç›‘æ§å‘Šè­¦è®¾è®¡ï¼ˆæ–°å¢ï¼‰

#### 5.1 åº”ç”¨ç›‘æ§
```yaml
# åº”ç”¨ç›‘æ§é…ç½®
management:
  endpoints:
    web:
      exposure:
        include: health,metrics,prometheus,auditevents
  
  metrics:
    export:
      prometheus:
        enabled: true
    
    distribution:
      percentiles-histogram:
        http.server.requests: true
      slo:
        http.server.requests: 50ms,100ms,200ms,500ms
  
  health:
    diskspace:
      threshold: 1GB
    db:
      validation-query: SELECT 1
    redis:
      timeout: 2s
```

#### 5.2 ä¸šåŠ¡ç›‘æ§
```java
// ä¸šåŠ¡æŒ‡æ ‡ç›‘æ§
@Component
public class BusinessMetrics {
    
    private final MeterRegistry meterRegistry;
    
    // ä¸šåŠ¡æŒ‡æ ‡
    private final Counter deviationCounter;
    private final Timer batchProcessTimer;
    private final Gauge overdueDeviationGauge;
    
    public BusinessMetrics(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        
        this.deviationCounter = Counter.builder("gmp.deviations.created")
            .description("åå·®åˆ›å»ºæ•°é‡")
            .register(meterRegistry);
            
        this.batchProcessTimer = Timer.builder("gmp.batch.process.time")
            .description("æ‰¹æ¬¡å¤„ç†æ—¶é—´")
            .register(meterRegistry);
            
        this.overdueDeviationGauge = Gauge.builder("gmp.deviations.overdue")
            .description("é€¾æœŸåå·®æ•°é‡")
            .register(meterRegistry, this, BusinessMetrics::getOverdueDeviationCount);
    }
    
    public void recordDeviationCreated() {
        deviationCounter.increment();
    }
    
    public void recordBatchProcessTime(Duration duration) {
        batchProcessTimer.record(duration);
    }
    
    private double getOverdueDeviationCount() {
        return deviationRepository.countOverdueDeviations();
    }
}
```

#### 5.3 å‘Šè­¦è§„åˆ™
```yaml
# Prometheuså‘Šè­¦è§„åˆ™
groups:
  - name: gmp_system_alerts
    rules:
      - alert: HighErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.1
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "é«˜é”™è¯¯ç‡å‘Šè­¦"
          description: "{{ $labels.service }} é”™è¯¯ç‡è¶…è¿‡10%"
      
      - alert: HighResponseTime
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 0.5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "å“åº”æ—¶é—´è¿‡é•¿"
          description: "{{ $labels.service }} 95%å“åº”æ—¶é—´è¶…è¿‡500ms"
      
      - alert: DatabaseConnectionPoolLow
        expr: hikaricp_connections_active / hikaricp_connections_max > 0.9
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "æ•°æ®åº“è¿æ¥æ± ä¸è¶³"
          description: "{{ $labels.pool }} è¿æ¥æ± ä½¿ç”¨ç‡è¶…è¿‡90%"
      
      - alert: OverdueDeviations
        expr: gmp_deviations_overdue > 5
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "é€¾æœŸåå·®è¿‡å¤š"
          description: "æœ‰{{ $value }}ä¸ªåå·®å·²é€¾æœŸ"
```

### 6. éƒ¨ç½²æ¶æ„ä¼˜åŒ–ï¼ˆæ–°å¢ï¼‰

#### 6.1 å®¹å™¨åŒ–éƒ¨ç½²ä¼˜åŒ–
```dockerfile
# ä¼˜åŒ–çš„Dockerfile
FROM openjdk:17-jre-slim

# å®‰å…¨åŠ å›º
RUN apt-get update && apt-get install -y \
    curl \
    && rm -rf /var/lib/apt/lists/* \
    && addgroup --system gmp \
    && adduser --system --group gmp

# åˆ›å»ºåº”ç”¨ç›®å½•
WORKDIR /app

# å¤åˆ¶JARæ–‡ä»¶
COPY target/*.jar app.jar

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:8080/actuator/health || exit 1

# ä½¿ç”¨érootç”¨æˆ·è¿è¡Œ
USER gmp

# JVMä¼˜åŒ–å‚æ•°
ENV JAVA_OPTS="-Xms512m -Xmx1024m -XX:+UseG1GC -XX:+UseStringDeduplication"

EXPOSE 8080

ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar app.jar"]
```

#### 6.2 Kuberneteséƒ¨ç½²é…ç½®
```yaml
# QMSæœåŠ¡éƒ¨ç½²é…ç½®
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gmp-qms-service
  labels:
    app: gmp-qms-service
spec:
  replicas: 3
  selector:
    matchLabels:
      app: gmp-qms-service
  template:
    metadata:
      labels:
        app: gmp-qms-service
    spec:
      containers:
      - name: gmp-qms-service
        image: gmp/qms-service:latest
        ports:
        - containerPort: 8080
        env:
        - name: SPRING_PROFILES_ACTIVE
          value: "prod"
        - name: DB_HOST
          value: "postgres-service"
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "1Gi"
            cpu: "1000m"
        livenessProbe:
          httpGet:
            path: /actuator/health/liveness
            port: 8080
          initialDelaySeconds: 60
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /actuator/health/readiness
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values:
                - gmp-qms-service
            topologyKey: kubernetes.io/hostname
```

#### 6.3 æœåŠ¡ç½‘æ ¼é…ç½®ï¼ˆIstioï¼‰
```yaml
# è™šæ‹ŸæœåŠ¡é…ç½®
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: gmp-qms-service
spec:
  hosts:
  - gmp-qms-service
  http:
  - match:
    - headers:
        api-version:
          exact: v1.0
    route:
    - destination:
        host: gmp-qms-service
        subset: v1
  - match:
    - headers:
        api-version:
          exact: v1.1
    route:
    - destination:
        host: gmp-qms-service
        subset: v1-1
        
---
# ç›®æ ‡è§„åˆ™é…ç½®
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: gmp-qms-service
spec:
  host: gmp-qms-service
  trafficPolicy:
    loadBalancer:
      simple: LEAST_CONN
    connectionPool:
      tcp:
        maxConnections: 100
      http:
        http1MaxPendingRequests: 50
    circuitBreaker:
      consecutiveErrors: 3
      interval: 30s
      baseEjectionTime: 30s
  subsets:
  - name: v1
    labels:
      version: v1.0
  - name: v1-1
    labels:
      version: v1.1
```

## ğŸ“Š è®¾è®¡ç¼ºé™·æ€»ç»“ä¸ä¿®å¤å»ºè®®

### ğŸ”´ ä¸¥é‡ç¼ºé™·
1. **å®‰å…¨æ¶æ„ç¼ºå¤±** â†’ âœ… å·²è¡¥å……å®Œæ•´çš„å¤šå±‚å®‰å…¨è®¾è®¡
2. **æ•°æ®å¤‡ä»½æ¢å¤ç¼ºå¤±** â†’ âœ… å·²è®¾è®¡å®Œæ•´çš„å¤‡ä»½ç­–ç•¥
3. **æ€§èƒ½ç›‘æ§ä¸è¶³** â†’ âœ… å·²æ·»åŠ è¯¦ç»†çš„æ€§èƒ½æŒ‡æ ‡å’Œç›‘æ§
4. **ç³»ç»Ÿé›†æˆæ–¹æ¡ˆç¼ºå¤±** â†’ âœ… å·²æä¾›ERPå’ŒPLCé›†æˆæ–¹æ¡ˆ

### ğŸŸ¡ ä¸€èˆ¬ç¼ºé™·
1. **APIç‰ˆæœ¬ç®¡ç†ç¼ºå¤±** â†’ âœ… å·²å®ç°ç‰ˆæœ¬æ§åˆ¶æœºåˆ¶
2. **ç¼“å­˜ç­–ç•¥ä¸æ˜ç¡®** â†’ âœ… å·²è®¾è®¡å¤šçº§ç¼“å­˜æ¶æ„
3. **éƒ¨ç½²æ–¹æ¡ˆä¸å®Œæ•´** â†’ âœ… å·²ä¼˜åŒ–å®¹å™¨åŒ–å’ŒK8séƒ¨ç½²
4. **ç›‘æ§å‘Šè­¦ä¸å…¨é¢** â†’ âœ… å·²å®Œå–„ä¸šåŠ¡å’ŒæŠ€æœ¯ç›‘æ§

### ğŸ’¡ é¢å¤–ä¼˜åŒ–å»ºè®®
1. **è€ƒè™‘ä½¿ç”¨Service Mesh**ï¼ˆå¦‚Istioï¼‰è¿›è¡Œå¾®æœåŠ¡æ²»ç†
2. **å¼•å…¥äº‹ä»¶æº¯æº**ï¼ˆEvent Sourcingï¼‰ä¿è¯æ•°æ®å¯è¿½æº¯æ€§
3. **ä½¿ç”¨CQRSæ¨¡å¼**åˆ†ç¦»è¯»å†™æ“ä½œï¼Œæå‡æ€§èƒ½
4. **å®ç°è“ç»¿éƒ¨ç½²**å‡å°‘ç³»ç»Ÿåœæœºæ—¶é—´

è¿™äº›è¡¥å……è®¾è®¡ç¡®ä¿äº†ç³»ç»Ÿçš„ï¼š**å®‰å…¨æ€§**ã€**å¯é æ€§**ã€**æ€§èƒ½**å’Œ**å¯ç»´æŠ¤æ€§**ï¼Œæ»¡è¶³GMPç³»ç»Ÿçš„ä¸¥æ ¼è¦æ±‚ã€‚