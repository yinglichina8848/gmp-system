<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ChangeControlServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">GMP QMS Service</a> &gt; <a href="index.source.html" class="el_package">com.gmp.qms.service.impl</a> &gt; <span class="el_source">ChangeControlServiceImpl.java</span></div><h1>ChangeControlServiceImpl.java</h1><pre class="source lang-java linenums">package com.gmp.qms.service.impl;

import com.gmp.qms.dto.ChangeControlDTO;
import com.gmp.qms.dto.ChangeControlSearchCriteria;
import com.gmp.qms.entity.ChangeControl;
import com.gmp.qms.entity.ChangeControlAttachment;
import com.gmp.qms.exception.ResourceNotFoundException;
import com.gmp.qms.repository.ChangeControlRepository;
import com.gmp.qms.service.ChangeControlService;
import lombok.RequiredArgsConstructor;
import org.springframework.beans.BeanUtils;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.domain.Specification;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.List;
import java.util.UUID;

/**
 * 变更控制服务实现类
 * 
 * @author GMP系统开发团队
 */
@Service
@RequiredArgsConstructor
public class ChangeControlServiceImpl implements ChangeControlService {

    private final ChangeControlRepository changeControlRepository;
    // 文件存储路径，实际应用中应配置在配置文件中
    private static final String UPLOAD_DIR = &quot;/opt/gmp-system/uploads/change-controls/&quot;;

    @Override
    @Transactional
    public ChangeControl createChangeControl(ChangeControlDTO changeControlDTO) {
<span class="fc" id="L45">        ChangeControl changeControl = new ChangeControl();</span>
<span class="fc" id="L46">        BeanUtils.copyProperties(changeControlDTO, changeControl);</span>
        
        // 生成变更编号
<span class="fc" id="L49">        changeControl.setChangeCode(generateChangeCode());</span>
        
        // 设置初始状态
<span class="fc" id="L52">        changeControl.setStatus(ChangeControl.ChangeStatus.PROPOSED);</span>
        
<span class="fc" id="L54">        return changeControlRepository.save(changeControl);</span>
    }

    @Override
    @Transactional
    public ChangeControl updateChangeControl(Long id, ChangeControlDTO changeControlDTO) {
<span class="fc" id="L60">        ChangeControl changeControl = getChangeControlById(id);</span>
<span class="fc" id="L61">        BeanUtils.copyProperties(changeControlDTO, changeControl, &quot;id&quot;, &quot;changeCode&quot;, &quot;createdAt&quot;, &quot;createdBy&quot;, &quot;status&quot;);</span>
<span class="fc" id="L62">        return changeControlRepository.save(changeControl);</span>
    }

    @Override
    public ChangeControl getChangeControlById(Long id) {
<span class="fc" id="L67">        return changeControlRepository.findById(id)</span>
<span class="fc" id="L68">                .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Change Control not found with id: &quot; + id));</span>
    }

    @Override
    public ChangeControl getChangeControlByCode(String changeCode) {
<span class="fc" id="L73">        return changeControlRepository.findByChangeCode(changeCode);</span>
    }

    @Override
    public Page&lt;ChangeControl&gt; findAllChangeControls(Pageable pageable) {
<span class="fc" id="L78">        return changeControlRepository.findAll(pageable);</span>
    }

    @Override
    public Page&lt;ChangeControl&gt; searchChangeControls(ChangeControlSearchCriteria criteria, Pageable pageable) {
<span class="fc" id="L83">        Specification&lt;ChangeControl&gt; specification = buildChangeControlSpecification(criteria);</span>
<span class="fc" id="L84">        return changeControlRepository.findAll(specification, pageable);</span>
    }

    @Override
    @Transactional
    public ChangeControl updateChangeControlStatus(Long id, ChangeControl.ChangeStatus status, String comments) {
<span class="fc" id="L90">        ChangeControl changeControl = getChangeControlById(id);</span>
<span class="fc" id="L91">        changeControl.setStatus(status);</span>
        // 这里可以添加状态变更历史记录
<span class="fc" id="L93">        return changeControlRepository.save(changeControl);</span>
    }

    @Override
    @Transactional
    public ChangeControl addAttachment(Long changeControlId, MultipartFile file, String description) {
<span class="nc" id="L99">        ChangeControl changeControl = getChangeControlById(changeControlId);</span>
        
        try {
            // 确保上传目录存在
<span class="nc" id="L103">            Path uploadPath = Paths.get(UPLOAD_DIR + changeControlId + &quot;/&quot;);</span>
<span class="nc" id="L104">            Files.createDirectories(uploadPath);</span>
            
            // 生成唯一文件名
<span class="nc" id="L107">            String originalFilename = file.getOriginalFilename();</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">            String extension = originalFilename != null ? originalFilename.substring(originalFilename.lastIndexOf('.')) : &quot;&quot;;</span>
<span class="nc" id="L109">            String fileName = UUID.randomUUID() + extension;</span>
            
            // 保存文件
<span class="nc" id="L112">            Path filePath = uploadPath.resolve(fileName);</span>
<span class="nc" id="L113">            Files.copy(file.getInputStream(), filePath);</span>
            
            // 创建附件记录
<span class="nc" id="L116">            ChangeControlAttachment attachment = new ChangeControlAttachment();</span>
<span class="nc" id="L117">            attachment.setChangeControl(changeControl);</span>
<span class="nc" id="L118">            attachment.setFileName(originalFilename);</span>
<span class="nc" id="L119">            attachment.setFilePath(filePath.toString());</span>
<span class="nc" id="L120">            attachment.setFileSize(file.getSize());</span>
<span class="nc" id="L121">            attachment.setFileType(file.getContentType());</span>
<span class="nc" id="L122">            attachment.setDescription(description);</span>
            
<span class="nc" id="L124">            changeControl.getAttachments().add(attachment);</span>
<span class="nc" id="L125">            return changeControlRepository.save(changeControl);</span>
<span class="nc" id="L126">        } catch (IOException e) {</span>
<span class="nc" id="L127">            throw new RuntimeException(&quot;Failed to upload file: &quot; + e.getMessage(), e);</span>
        }
    }

    @Override
    @Transactional
    public ChangeControl removeAttachment(Long changeControlId, Long attachmentId) {
<span class="nc" id="L134">        ChangeControl changeControl = getChangeControlById(changeControlId);</span>
        
<span class="nc" id="L136">        boolean removed = changeControl.getAttachments().removeIf(attachment -&gt; </span>
<span class="nc" id="L137">                attachment.getId().equals(attachmentId)</span>
        );
        
<span class="nc bnc" id="L140" title="All 2 branches missed.">        if (!removed) {</span>
<span class="nc" id="L141">            throw new ResourceNotFoundException(&quot;Attachment not found with id: &quot; + attachmentId);</span>
        }
        
<span class="nc" id="L144">        return changeControlRepository.save(changeControl);</span>
    }

    @Override
    public List&lt;ChangeControl&gt; findOverdueChangeControls() {
<span class="nc" id="L149">        LocalDateTime now = LocalDateTime.now();</span>
<span class="nc" id="L150">        List&lt;ChangeControl.ChangeStatus&gt; excludedStatuses = List.of(</span>
<span class="nc" id="L151">                ChangeControl.ChangeStatus.COMPLETED,</span>
<span class="nc" id="L152">                ChangeControl.ChangeStatus.CANCELLED</span>
        );
<span class="nc" id="L154">        return changeControlRepository.findOverdueChangeControls(now, excludedStatuses);</span>
    }

    @Override
    public String generateChangeCode() {
        // 生成格式：CC-YYYYMMDD-XXXXX
<span class="fc" id="L160">        String datePrefix = &quot;CC-&quot; + LocalDate.now().format(DateTimeFormatter.ofPattern(&quot;yyyyMMdd&quot;)) + &quot;-&quot;;</span>
        
        // 这里可以添加数据库查询逻辑获取当天最大编号并递增
        // 暂时返回一个简单的模拟编号
<span class="fc" id="L164">        return datePrefix + UUID.randomUUID().toString().substring(0, 5).toUpperCase();</span>
    }

    /**
     * 构建变更控制查询条件
     */
    private Specification&lt;ChangeControl&gt; buildChangeControlSpecification(ChangeControlSearchCriteria criteria) {
<span class="fc" id="L171">        return (root, query, criteriaBuilder) -&gt; {</span>
<span class="nc" id="L172">            Specification&lt;ChangeControl&gt; spec = Specification.where(null);</span>
            
            // 这里可以根据criteria构建复杂的查询条件
            
<span class="nc" id="L176">            return spec.toPredicate(root, query, criteriaBuilder);</span>
        };
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>