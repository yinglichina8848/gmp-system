<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CapaServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">GMP QMS Service</a> &gt; <a href="index.source.html" class="el_package">com.gmp.qms.service.impl</a> &gt; <span class="el_source">CapaServiceImpl.java</span></div><h1>CapaServiceImpl.java</h1><pre class="source lang-java linenums">package com.gmp.qms.service.impl;

import com.gmp.qms.dto.CapaDTO;
import com.gmp.qms.dto.CapaSearchCriteria;
import com.gmp.qms.entity.Capa;
import com.gmp.qms.entity.CapaAttachment;
import com.gmp.qms.exception.ResourceNotFoundException;
import com.gmp.qms.repository.CapaRepository;
import com.gmp.qms.service.CapaService;
import lombok.RequiredArgsConstructor;
import org.springframework.beans.BeanUtils;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.domain.Specification;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.List;
import java.util.UUID;

/**
 * CAPA管理服务实现类
 * 
 * @author GMP系统开发团队
 */
@Service
@RequiredArgsConstructor
public class CapaServiceImpl implements CapaService {

    private final CapaRepository capaRepository;
    // 文件存储路径，实际应用中应配置在配置文件中
    private static final String UPLOAD_DIR = &quot;/opt/gmp-system/uploads/capas/&quot;;

    @Override
    @Transactional
    public Capa createCapa(CapaDTO capaDTO) {
<span class="fc" id="L45">        Capa capa = new Capa();</span>
<span class="fc" id="L46">        BeanUtils.copyProperties(capaDTO, capa);</span>
        
        // 生成CAPA编号
<span class="fc" id="L49">        capa.setCapaCode(generateCapaCode());</span>
        
        // 设置初始状态
<span class="fc" id="L52">        capa.setStatus(Capa.CapaStatus.IDENTIFIED);</span>
        
<span class="fc" id="L54">        return capaRepository.save(capa);</span>
    }

    @Override
    @Transactional
    public Capa updateCapa(Long id, CapaDTO capaDTO) {
<span class="fc" id="L60">        Capa capa = getCapaById(id);</span>
<span class="fc" id="L61">        BeanUtils.copyProperties(capaDTO, capa, &quot;id&quot;, &quot;capaCode&quot;, &quot;createdAt&quot;, &quot;createdBy&quot;, &quot;status&quot;);</span>
<span class="fc" id="L62">        return capaRepository.save(capa);</span>
    }

    @Override
    public Capa getCapaById(Long id) {
<span class="fc" id="L67">        return capaRepository.findById(id)</span>
<span class="fc" id="L68">                .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;CAPA not found with id: &quot; + id));</span>
    }

    @Override
    public Capa getCapaByCode(String capaCode) {
<span class="fc" id="L73">        return capaRepository.findByCapaCode(capaCode);</span>
    }

    @Override
    public Page&lt;Capa&gt; findAllCapas(Pageable pageable) {
<span class="fc" id="L78">        return capaRepository.findAll(pageable);</span>
    }

    @Override
    public Page&lt;Capa&gt; searchCapas(CapaSearchCriteria criteria, Pageable pageable) {
<span class="fc" id="L83">        Specification&lt;Capa&gt; specification = buildCapaSpecification(criteria);</span>
<span class="fc" id="L84">        return capaRepository.findAll(specification, pageable);</span>
    }

    @Override
    @Transactional
    public Capa updateCapaStatus(Long id, Capa.CapaStatus status, String comments) {
<span class="fc" id="L90">        Capa capa = getCapaById(id);</span>
<span class="fc" id="L91">        capa.setStatus(status);</span>
        // 这里可以添加状态变更历史记录
<span class="fc" id="L93">        return capaRepository.save(capa);</span>
    }

    @Override
    @Transactional
    public Capa addAttachment(Long capaId, MultipartFile file, String description) {
<span class="fc" id="L99">        Capa capa = getCapaById(capaId);</span>
        
        try {
            // 确保上传目录存在
<span class="fc" id="L103">            Path uploadPath = Paths.get(UPLOAD_DIR + capaId + &quot;/&quot;);</span>
<span class="nc" id="L104">            Files.createDirectories(uploadPath);</span>
            
            // 生成唯一文件名
<span class="nc" id="L107">            String originalFilename = file.getOriginalFilename();</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">            String extension = originalFilename != null ? originalFilename.substring(originalFilename.lastIndexOf('.')) : &quot;&quot;;</span>
<span class="nc" id="L109">            String fileName = UUID.randomUUID() + extension;</span>
            
            // 保存文件
<span class="nc" id="L112">            Path filePath = uploadPath.resolve(fileName);</span>
<span class="nc" id="L113">            Files.copy(file.getInputStream(), filePath);</span>
            
            // 创建附件记录
<span class="nc" id="L116">            CapaAttachment attachment = new CapaAttachment();</span>
<span class="nc" id="L117">            attachment.setCapa(capa);</span>
<span class="nc" id="L118">            attachment.setFileName(originalFilename);</span>
<span class="nc" id="L119">            attachment.setFilePath(filePath.toString());</span>
<span class="nc" id="L120">            attachment.setFileSize(file.getSize());</span>
<span class="nc" id="L121">            attachment.setFileType(file.getContentType());</span>
<span class="nc" id="L122">            attachment.setDescription(description);</span>
            
<span class="nc" id="L124">            capa.getAttachments().add(attachment);</span>
<span class="nc" id="L125">            return capaRepository.save(capa);</span>
<span class="fc" id="L126">        } catch (IOException e) {</span>
<span class="fc" id="L127">            throw new RuntimeException(&quot;Failed to upload file: &quot; + e.getMessage(), e);</span>
        }
    }

    @Override
    @Transactional
    public Capa removeAttachment(Long capaId, Long attachmentId) {
<span class="fc" id="L134">        Capa capa = getCapaById(capaId);</span>
        
<span class="fc" id="L136">        boolean removed = capa.getAttachments().removeIf(attachment -&gt; </span>
<span class="fc" id="L137">                attachment.getId().equals(attachmentId)</span>
        );
        
<span class="fc bfc" id="L140" title="All 2 branches covered.">        if (!removed) {</span>
<span class="fc" id="L141">            throw new ResourceNotFoundException(&quot;Attachment not found with id: &quot; + attachmentId);</span>
        }
        
<span class="fc" id="L144">        return capaRepository.save(capa);</span>
    }

    @Override
    public List&lt;Capa&gt; findOverdueCapas() {
<span class="fc" id="L149">        LocalDateTime now = LocalDateTime.now();</span>
<span class="fc" id="L150">        List&lt;Capa.CapaStatus&gt; excludedStatuses = List.of(</span>
<span class="fc" id="L151">                Capa.CapaStatus.CLOSED,</span>
<span class="fc" id="L152">                Capa.CapaStatus.REJECTED</span>
        );
<span class="fc" id="L154">        return capaRepository.findOverdueCapa(now, excludedStatuses);</span>
    }

    @Override
    public String generateCapaCode() {
        // 生成格式：CAPA-YYYYMMDD-XXXXX
<span class="fc" id="L160">        String datePrefix = &quot;CAPA-&quot; + LocalDate.now().format(DateTimeFormatter.ofPattern(&quot;yyyyMMdd&quot;)) + &quot;-&quot;;</span>
        
        // 这里可以添加数据库查询逻辑获取当天最大编号并递增
        // 暂时返回一个简单的模拟编号
<span class="fc" id="L164">        return datePrefix + UUID.randomUUID().toString().substring(0, 5).toUpperCase();</span>
    }

    /**
     * 构建CAPA查询条件
     */
    private Specification&lt;Capa&gt; buildCapaSpecification(CapaSearchCriteria criteria) {
<span class="fc" id="L171">        return (root, query, criteriaBuilder) -&gt; {</span>
<span class="nc" id="L172">            Specification&lt;Capa&gt; spec = Specification.where(null);</span>
            
            // 这里可以根据criteria构建复杂的查询条件
            
<span class="nc" id="L176">            return spec.toPredicate(root, query, criteriaBuilder);</span>
        };
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>