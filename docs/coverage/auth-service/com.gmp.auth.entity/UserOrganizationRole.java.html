<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UserOrganizationRole.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">auth-service</a> &gt; <a href="index.source.html" class="el_package">com.gmp.auth.entity</a> &gt; <span class="el_source">UserOrganizationRole.java</span></div><h1>UserOrganizationRole.java</h1><pre class="source lang-java linenums">package com.gmp.auth.entity;

// ============================================================================
//                    GMP系统用户组织角色关联实体定义
// dịp
//
// WHY: 传统的RBAC模型不支持用户在多个组织内拥有不同角色的复杂权限场景，
//      在GMP企业中，一个质量工程师可能同时在质量组织、生产组织、培训组织中
//      担任不同角色，这种多组织多角色的权限需求需要专门的实体进行管理。
//
// WHAT: UserOrganizationRole实体实现用户、组织、角色三者间的关联管理，
//      支持临时权限、权限过期、分配审核等高级权限管理特性，确保权限
//      分配的追溯性和合规性，满足GMP审计要求。
//
// HOW: 使用唯一约束保证用户在同一组织内只能有一个角色，通过枚举约束赋值状态，
//      使用审计字段记录完整的权限变更历史，支持权限的动态激活和自动失效。
// ============================================================================

import jakarta.persistence.*;
import jakarta.validation.constraints.*;
import lombok.Data;
import lombok.NoArgsConstructor;
import lombok.AllArgsConstructor;
import lombok.Builder;
import org.springframework.data.annotation.CreatedDate;
import org.springframework.data.annotation.LastModifiedDate;
import org.springframework.data.jpa.domain.support.AuditingEntityListener;

import java.time.LocalDateTime;

/**
 * GMP系统用户组织角色关联实体
 *
 * 实现用户、组织、角色三者间的关联管理，支持：
 * - 用户可同时拥有多个组织内的不同角色
 * - 临时权限分配和自动过期
 * - 权限分配的审批流程
 * - 完整的权限变更历史记录
 * - GMP合规的权限追溯要求
 */
<span class="nc bnc" id="L41" title="All 198 branches missed.">@Data</span>
<span class="nc" id="L42">@NoArgsConstructor</span>
<span class="nc" id="L43">@AllArgsConstructor</span>
<span class="nc bnc" id="L44" title="All 8 branches missed.">@Builder</span>
@Entity
@Table(name = &quot;sys_user_org_roles&quot;,
       uniqueConstraints = @UniqueConstraint(
           columnNames = {&quot;user_id&quot;, &quot;organization_id&quot;, &quot;role_id&quot;},
           name = &quot;uk_user_org_role&quot;
       ),
       indexes = {
           @Index(name = &quot;idx_uor_user&quot;, columnList = &quot;user_id&quot;),
           @Index(name = &quot;idx_uor_org&quot;, columnList = &quot;organization_id&quot;),
           @Index(name = &quot;idx_uor_role&quot;, columnList = &quot;role_id&quot;),
           @Index(name = &quot;idx_uor_status&quot;, columnList = &quot;assignment_status&quot;),
           @Index(name = &quot;idx_uor_effective&quot;, columnList = &quot;effective_from,effective_until&quot;)
       })
@EntityListeners(AuditingEntityListener.class)
public class UserOrganizationRole {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
<span class="nc" id="L63">    private Long id;</span>

    // 核心关联关系
    @NotNull(message = &quot;用户ID不能为空&quot;)
    @Column(name = &quot;user_id&quot;, nullable = false)
<span class="nc" id="L68">    private Long userId;</span>

    @NotNull(message = &quot;组织ID不能为空&quot;)
    @Column(name = &quot;organization_id&quot;, nullable = false)
<span class="nc" id="L72">    private Long organizationId;</span>

    @NotNull(message = &quot;角色ID不能为空&quot;)
    @Column(name = &quot;role_id&quot;, nullable = false)
<span class="nc" id="L76">    private Long roleId;</span>

    // 权限分配状态管理
    @Builder.Default
    @Enumerated(EnumType.STRING)
    @Column(name = &quot;assignment_status&quot;, nullable = false)
<span class="nc" id="L82">    private AssignmentStatus status = AssignmentStatus.ACTIVE;</span>

    @Column(name = &quot;assigned_by&quot;)
<span class="nc" id="L85">    private Long assignedBy;  // 分配人ID</span>

    @Builder.Default
    @Column(name = &quot;assigned_at&quot;, nullable = false)
<span class="nc" id="L89">    private LocalDateTime assignedAt = LocalDateTime.now();</span>

    // 生效时间控制 - 支持临时权限
    @Builder.Default
    @Column(name = &quot;effective_from&quot;, nullable = false)
<span class="nc" id="L94">    private LocalDateTime effectiveFrom = LocalDateTime.now();</span>

    @Column(name = &quot;effective_until&quot;)
<span class="nc" id="L97">    private LocalDateTime effectiveUntil;  // 到期时间，为null表示永久有效</span>

<span class="nc" id="L99">    @Column(name = &quot;expires_notified&quot;)</span>
<span class="nc" id="L100">    private Boolean expiresNotified = false;  // 到期提醒标志</span>

    // 权限分配理由和备注
    @Size(max = 500, message = &quot;分配理由长度不能超过500字符&quot;)
    @Column(name = &quot;assignment_reason&quot;, columnDefinition = &quot;TEXT&quot;)
<span class="nc" id="L105">    private String assignmentReason;</span>

    @Size(max = 1000, message = &quot;备注信息长度不能超过1000字符&quot;)
    @Column(name = &quot;notes&quot;, columnDefinition = &quot;TEXT&quot;)
<span class="nc" id="L109">    private String notes;</span>

    // GMP合规相关扩展字段
<span class="nc" id="L112">    @Column(name = &quot;gmp_required&quot;)</span>
<span class="nc" id="L113">    private Boolean gmpRequired = false;  // 是否GMP必备权限</span>

    @Column(name = &quot;qualification_required&quot;)
<span class="nc" id="L116">    private String qualificationRequired;  // 需要的资质证明</span>

    @Column(name = &quot;training_required&quot;)
<span class="nc" id="L119">    private String trainingRequired;      // 需要的培训记录</span>

<span class="nc" id="L121">    @Column(name = &quot;approval_required&quot;)</span>
<span class="nc" id="L122">    private Boolean approvalRequired = false;  // 是否需要上级审批</span>

    @Column(name = &quot;approved_by&quot;)
<span class="nc" id="L125">    private Long approvedBy;  // 审批人ID</span>

    @Column(name = &quot;approved_at&quot;)
<span class="nc" id="L128">    private LocalDateTime approvedAt;      // 审批时间</span>

    @Size(max = 500, message = &quot;审批意见长度不能超过500字符&quot;)
    @Column(name = &quot;approval_note&quot;)
<span class="nc" id="L132">    private String approvalNote;</span>

    // 审计字段 - GMP合规要求完整审计记录
    @CreatedDate
    @Column(name = &quot;created_at&quot;, nullable = false, updatable = false)
<span class="nc" id="L137">    private LocalDateTime createdAt;</span>

    @LastModifiedDate
    @Column(name = &quot;updated_at&quot;, nullable = false)
<span class="nc" id="L141">    private LocalDateTime updatedAt;</span>

    @Column(name = &quot;created_by&quot;)
<span class="nc" id="L144">    private Long createdBy;</span>

    @Column(name = &quot;updated_by&quot;)
<span class="nc" id="L147">    private Long updatedBy;</span>

    @Builder.Default
    @Version
    @Column(nullable = false)
<span class="nc" id="L152">    private Integer version = 1;</span>

    /**
     * 权限分配状态枚举
     * 支持完整的权限生命周期管理
     */
<span class="nc" id="L158">    public enum AssignmentStatus {</span>
<span class="nc" id="L159">        PENDING(&quot;待审批&quot;),      // 权限分配申请已提交，等待审批</span>
<span class="nc" id="L160">        APPROVED(&quot;已批准&quot;),      // 权限分配已通过审批</span>
<span class="nc" id="L161">        ACTIVE(&quot;生效中&quot;),       // 权限已生效，可以正常使用</span>
<span class="nc" id="L162">        SUSPENDED(&quot;已暂停&quot;),    // 权限暂时被暂停（非永久）</span>
<span class="nc" id="L163">        EXPIRED(&quot;已过期&quot;),      // 权限超过有效期</span>
<span class="nc" id="L164">        REVOKED(&quot;已撤销&quot;),      // 权限被主动撤销</span>
<span class="nc" id="L165">        REJECTED(&quot;已拒绝&quot;);     // 权限分配申请被拒绝</span>

        private final String description;

<span class="nc" id="L169">        AssignmentStatus(String description) {</span>
<span class="nc" id="L170">            this.description = description;</span>
<span class="nc" id="L171">        }</span>

        public String getDescription() {
<span class="nc" id="L174">            return description;</span>
        }

        /**
         * 判断是否为活动状态（可以正常使用的状态）
         */
        public boolean isActiveStatus() {
<span class="nc bnc" id="L181" title="All 4 branches missed.">            return this == ACTIVE || this == APPROVED;</span>
        }
    }

    /**
     * 判断权限分配是否有效（可使用状态）
     */
    @Transient
    public boolean isEffective() {
        // 1. 检查状态是否为活动状态
<span class="nc bnc" id="L191" title="All 2 branches missed.">        if (!status.isActiveStatus()) {</span>
<span class="nc" id="L192">            return false;</span>
        }

        // 2. 检查生效时间
<span class="nc" id="L196">        LocalDateTime now = LocalDateTime.now();</span>
<span class="nc bnc" id="L197" title="All 2 branches missed.">        if (now.isBefore(effectiveFrom)) {</span>
<span class="nc" id="L198">            return false;  // 还未到生效时间</span>
        }

        // 3. 检查到期时间
<span class="nc bnc" id="L202" title="All 4 branches missed.">        if (effectiveUntil != null &amp;&amp; now.isAfter(effectiveUntil)) {</span>
<span class="nc" id="L203">            return false;  // 已过期</span>
        }

<span class="nc" id="L206">        return true;</span>
    }

    /**
     * 判断权限是否即将过期（需要在指定天数前预警）
     */
    @Transient
    public boolean isExpiringSoon(int warningDays) {
<span class="nc bnc" id="L214" title="All 2 branches missed.">        if (effectiveUntil == null) {</span>
<span class="nc" id="L215">            return false;  // 永久有效，无需警告</span>
        }

<span class="nc" id="L218">        LocalDateTime warningTime = LocalDateTime.now().plusDays(warningDays);</span>
<span class="nc bnc" id="L219" title="All 2 branches missed.">        return LocalDateTime.now().isBefore(effectiveUntil) &amp;&amp;</span>
<span class="nc bnc" id="L220" title="All 2 branches missed.">               effectiveUntil.isBefore(warningTime);</span>
    }

    /**
     * 判断权限是否已经过期
     */
    @Transient
    public boolean isExpired() {
<span class="nc bnc" id="L228" title="All 4 branches missed.">        return effectiveUntil != null &amp;&amp; LocalDateTime.now().isAfter(effectiveUntil);</span>
    }

    /**
     * 判断是否需要审批流程
     */
    @Transient
    public boolean requiresApproval() {
<span class="nc bnc" id="L236" title="All 6 branches missed.">        return approvalRequired &amp;&amp; (assignedBy == null || assignedBy.equals(createdBy));</span>
    }

    /**
     * 计算权限剩余有效天数
     */
    @Transient
    public Integer getRemainingDays() {
<span class="nc bnc" id="L244" title="All 2 branches missed.">        if (effectiveUntil == null) {</span>
<span class="nc" id="L245">            return null;  // 永久有效</span>
        }

<span class="nc" id="L248">        LocalDateTime now = LocalDateTime.now();</span>
<span class="nc bnc" id="L249" title="All 2 branches missed.">        if (now.isAfter(effectiveUntil)) {</span>
<span class="nc" id="L250">            return 0;  // 已过期</span>
        }

<span class="nc" id="L253">        return (int) java.time.Duration.between(now, effectiveUntil).toDays();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>