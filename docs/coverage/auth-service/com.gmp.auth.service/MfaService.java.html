<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MfaService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">auth-service</a> &gt; <a href="index.source.html" class="el_package">com.gmp.auth.service</a> &gt; <span class="el_source">MfaService.java</span></div><h1>MfaService.java</h1><pre class="source lang-java linenums">package com.gmp.auth.service;

import org.springframework.stereotype.Service;
import java.nio.ByteBuffer;
import java.nio.charset.StandardCharsets;
import java.security.SecureRandom;
import java.time.Instant;
import java.util.*;

@Service
<span class="nc" id="L11">public class MfaService {</span>
    private static final int SECRET_KEY_LENGTH = 16; // 16 bytes = 128 bits
    private static final int TOTP_TIME_STEP = 30; // 30 seconds
    private static final int TOTP_CODE_LENGTH = 6; // 6 digits
    private static final int RECOVERY_CODES_COUNT = 10;
    private static final int RECOVERY_CODE_LENGTH = 8;

<span class="nc" id="L18">    private final SecureRandom secureRandom = new SecureRandom();</span>

    /**
     * 生成新的MFA密钥
     */
    public String generateSecretKey() {
<span class="nc" id="L24">        byte[] key = new byte[SECRET_KEY_LENGTH];</span>
<span class="nc" id="L25">        secureRandom.nextBytes(key);</span>
<span class="nc" id="L26">        return Base64.getEncoder().encodeToString(key);</span>
    }

    /**
     * 生成TOTP验证码
     */
    public String generateTotpCode(String secretKey) {
<span class="nc" id="L33">        return generateTotpCode(secretKey, Instant.now().getEpochSecond());</span>
    }

    /**
     * 验证TOTP验证码
     */
    public boolean verifyTotpCode(String secretKey, String code) {
        try {
            // 验证当前时间戳和前后一个时间戳的验证码，以允许时钟偏差
<span class="nc" id="L42">            long currentTime = Instant.now().getEpochSecond();</span>
<span class="nc bnc" id="L43" title="All 2 branches missed.">            return verifyTotpCode(secretKey, code, currentTime) ||</span>
<span class="nc bnc" id="L44" title="All 2 branches missed.">                   verifyTotpCode(secretKey, code, currentTime - TOTP_TIME_STEP) ||</span>
<span class="nc bnc" id="L45" title="All 2 branches missed.">                   verifyTotpCode(secretKey, code, currentTime + TOTP_TIME_STEP);</span>
<span class="nc" id="L46">        } catch (Exception e) {</span>
<span class="nc" id="L47">            return false;</span>
        }
    }

    /**
     * 生成指定数量的恢复码
     */
    public List&lt;String&gt; generateRecoveryCodes() {
<span class="nc" id="L55">        List&lt;String&gt; recoveryCodes = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L56" title="All 2 branches missed.">        for (int i = 0; i &lt; RECOVERY_CODES_COUNT; i++) {</span>
<span class="nc" id="L57">            recoveryCodes.add(generateRecoveryCode());</span>
        }
<span class="nc" id="L59">        return recoveryCodes;</span>
    }

    /**
     * 生成单个恢复码
     */
    private String generateRecoveryCode() {
<span class="nc" id="L66">        StringBuilder sb = new StringBuilder();</span>
<span class="nc bnc" id="L67" title="All 2 branches missed.">        for (int i = 0; i &lt; RECOVERY_CODE_LENGTH; i++) {</span>
<span class="nc" id="L68">            sb.append(secureRandom.nextInt(10));</span>
        }
<span class="nc" id="L70">        return sb.toString();</span>
    }

    /**
     * 生成用于Google Authenticator等应用的二维码URL
     */
    public String generateQrCodeUrl(String username, String secretKey, String issuer) {
<span class="nc" id="L77">        String label = issuer + &quot;:&quot; + username;</span>
<span class="nc" id="L78">        String encodedLabel = Base64.getEncoder().encodeToString(label.getBytes(StandardCharsets.UTF_8));</span>
<span class="nc" id="L79">        String encodedSecret = Base64.getEncoder().encodeToString(secretKey.getBytes(StandardCharsets.UTF_8));</span>
<span class="nc" id="L80">        return String.format(&quot;otpauth://totp/%s?secret=%s&amp;issuer=%s&amp;algorithm=SHA1&amp;digits=6&amp;period=30&quot;,</span>
                encodedLabel, encodedSecret, issuer);
    }

    /**
     * 内部方法：根据指定时间戳生成TOTP码
     */
    private String generateTotpCode(String secretKey, long timestamp) {
        try {
<span class="nc" id="L89">            byte[] key = Base64.getDecoder().decode(secretKey);</span>
<span class="nc" id="L90">            long timeStep = timestamp / TOTP_TIME_STEP;</span>
            
            // 将时间戳转换为字节数组
<span class="nc" id="L93">            ByteBuffer buffer = ByteBuffer.allocate(8);</span>
<span class="nc" id="L94">            buffer.putLong(0, timeStep);</span>
<span class="nc" id="L95">            byte[] timeBytes = buffer.array();</span>
            
            // 使用HMAC-SHA1算法计算
<span class="nc" id="L98">            byte[] hmacResult = hmacSha1(key, timeBytes);</span>
            
            // 动态截断
<span class="nc" id="L101">            int offset = hmacResult[hmacResult.length - 1] &amp; 0xF;</span>
<span class="nc" id="L102">            int binary = ((hmacResult[offset] &amp; 0x7F) &lt;&lt; 24) |</span>
                        ((hmacResult[offset + 1] &amp; 0xFF) &lt;&lt; 16) |
                        ((hmacResult[offset + 2] &amp; 0xFF) &lt;&lt; 8) |
                        (hmacResult[offset + 3] &amp; 0xFF);
            
            // 生成6位验证码
<span class="nc" id="L108">            int otp = binary % (int) Math.pow(10, TOTP_CODE_LENGTH);</span>
<span class="nc" id="L109">            return String.format(&quot;%0&quot; + TOTP_CODE_LENGTH + &quot;d&quot;, otp);</span>
<span class="nc" id="L110">        } catch (Exception e) {</span>
<span class="nc" id="L111">            throw new RuntimeException(&quot;生成TOTP码失败&quot;, e);</span>
        }
    }

    /**
     * 内部方法：验证指定时间戳的TOTP码
     */
    private boolean verifyTotpCode(String secretKey, String code, long timestamp) {
<span class="nc" id="L119">        String expectedCode = generateTotpCode(secretKey, timestamp);</span>
<span class="nc" id="L120">        return expectedCode.equals(code);</span>
    }

    /**
     * 内部方法：计算HMAC-SHA1
     */
    private byte[] hmacSha1(byte[] key, byte[] data) throws Exception {
<span class="nc" id="L127">        javax.crypto.Mac mac = javax.crypto.Mac.getInstance(&quot;HmacSHA1&quot;);</span>
<span class="nc" id="L128">        javax.crypto.spec.SecretKeySpec secretKeySpec = new javax.crypto.spec.SecretKeySpec(key, &quot;HmacSHA1&quot;);</span>
<span class="nc" id="L129">        mac.init(secretKeySpec);</span>
<span class="nc" id="L130">        return mac.doFinal(data);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>