<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PasswordPolicyService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">auth-service</a> &gt; <a href="index.source.html" class="el_package">com.gmp.auth.service</a> &gt; <span class="el_source">PasswordPolicyService.java</span></div><h1>PasswordPolicyService.java</h1><pre class="source lang-java linenums">package com.gmp.auth.service;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.time.LocalDateTime;
import java.util.List;
import java.util.regex.Pattern;

/**
 * 密码策略服务
 * 负责密码复杂度验证、历史记录检查和密码过期管理
 */
@Service
<span class="nc" id="L19">public class PasswordPolicyService {</span>

    // 密码策略常量
    private static final int MIN_PASSWORD_LENGTH = 8;
    
<span class="fc" id="L24">    private static final Logger log = LoggerFactory.getLogger(PasswordPolicyService.class);</span>

    @Autowired
    private PasswordEncoder passwordEncoder;

    @Autowired
    private UserPasswordHistoryService userPasswordHistoryService;

    // 密码最小长度
    @Value(&quot;${auth.password.min-length:10}&quot;)
    private int minPasswordLength;

    // 密码过期天数
    @Value(&quot;${auth.password.expiry-days:90}&quot;)
    private int passwordExpiryDays;

    // 历史密码记录数
    @Value(&quot;${auth.password.history-count:5}&quot;)
    private int passwordHistoryCount;

    // 复杂度要求：必须包含数字
<span class="fc" id="L45">    private static final Pattern HAS_DIGIT = Pattern.compile(&quot;\\d&quot;);</span>
    // 复杂度要求：必须包含小写字母
<span class="fc" id="L47">    private static final Pattern HAS_LOWERCASE = Pattern.compile(&quot;[a-z]&quot;);</span>
    // 复杂度要求：必须包含大写字母
<span class="fc" id="L49">    private static final Pattern HAS_UPPERCASE = Pattern.compile(&quot;[A-Z]&quot;);</span>
    // 复杂度要求：必须包含特殊字符
<span class="fc" id="L51">    private static final Pattern HAS_SPECIAL = Pattern.compile(&quot;[!@#$%^&amp;*(),.?\&quot;:{}|&lt;&gt;]&quot;);</span>

    /**
     * 验证密码复杂度
     * @param password 待验证的密码
     * @return 验证结果，null表示验证通过，否则返回错误消息
     */
    public String validatePasswordComplexity(String password) {
<span class="nc bnc" id="L59" title="All 4 branches missed.">        if (password == null || password.length() &lt; minPasswordLength) {</span>
<span class="nc" id="L60">            return &quot;密码长度必须至少为&quot; + minPasswordLength + &quot;个字符&quot;;</span>
        }

<span class="nc bnc" id="L63" title="All 2 branches missed.">        if (!HAS_DIGIT.matcher(password).find()) {</span>
<span class="nc" id="L64">            return &quot;密码必须包含至少一个数字&quot;;</span>
        }

<span class="nc bnc" id="L67" title="All 2 branches missed.">        if (!HAS_LOWERCASE.matcher(password).find()) {</span>
<span class="nc" id="L68">            return &quot;密码必须包含至少一个小写字母&quot;;</span>
        }

<span class="nc bnc" id="L71" title="All 2 branches missed.">        if (!HAS_UPPERCASE.matcher(password).find()) {</span>
<span class="nc" id="L72">            return &quot;密码必须包含至少一个大写字母&quot;;</span>
        }

<span class="nc bnc" id="L75" title="All 2 branches missed.">        if (!HAS_SPECIAL.matcher(password).find()) {</span>
<span class="nc" id="L76">            return &quot;密码必须包含至少一个特殊字符&quot;;</span>
        }

<span class="nc" id="L79">        return null; // 验证通过</span>
    }

    /**
     * 检查密码是否在历史记录中
     * @param userId 用户ID
     * @param rawPassword 原始密码
     * @return 检查结果，true表示密码在历史记录中，false表示不在
     */
    public boolean isPasswordInHistory(Long userId, String rawPassword) {
<span class="nc" id="L89">        List&lt;String&gt; passwordHistory = userPasswordHistoryService.getPasswordHistory(userId, passwordHistoryCount);</span>
        
<span class="nc bnc" id="L91" title="All 2 branches missed.">        for (String hashedPassword : passwordHistory) {</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">            if (passwordEncoder.matches(rawPassword, hashedPassword)) {</span>
<span class="nc" id="L93">                log.warn(&quot;密码与历史密码重复 - 用户ID: {}&quot;, userId);</span>
<span class="nc" id="L94">                return true;</span>
            }
<span class="nc" id="L96">        }</span>
<span class="nc" id="L97">        return false;</span>
    }

    /**
     * 计算密码过期时间
     * @return 密码过期时间
     */
    public LocalDateTime calculatePasswordExpiryTime() {
<span class="nc" id="L105">        return LocalDateTime.now().plusDays(passwordExpiryDays);</span>
    }

    /**
     * 检查密码是否即将过期（提前7天提醒）
     * @param passwordExpiredAt 密码过期时间
     * @return 是否即将过期
     */
    public boolean isPasswordExpiringSoon(LocalDateTime passwordExpiredAt) {
<span class="nc bnc" id="L114" title="All 2 branches missed.">        if (passwordExpiredAt == null) {</span>
<span class="nc" id="L115">            return false;</span>
        }
<span class="nc bnc" id="L117" title="All 2 branches missed.">        return LocalDateTime.now().plusDays(7).isAfter(passwordExpiredAt) &amp;&amp; </span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">               LocalDateTime.now().isBefore(passwordExpiredAt);</span>
    }

    /**
     * 记录新密码到历史记录
     * @param userId 用户ID
     * @param hashedPassword 哈希后的密码
     */
    public void recordPasswordHistory(Long userId, String hashedPassword) {
<span class="nc" id="L127">        userPasswordHistoryService.recordPasswordHistory(userId, hashedPassword);</span>
<span class="nc" id="L128">    }</span>

    /**
     * 验证密码是否符合策略要求
     * @param password 密码
     * @return 是否符合要求
     */
    public boolean validatePassword(String password) {
        // 使用现有的密码复杂度验证方法
<span class="nc" id="L137">        String errorMessage = validatePasswordComplexity(password);</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">        return errorMessage == null; // null表示验证通过</span>
    }
    
    /**
     * 获取密码复杂度要求描述
     * @return 复杂度要求描述
     */
    public String getPasswordComplexityRequirements() {
<span class="nc" id="L146">        return String.format(</span>
            &quot;密码必须满足以下要求：\n&quot; +
            &quot;1. 长度至少%d个字符\n&quot; +
            &quot;2. 包含至少一个数字\n&quot; +
            &quot;3. 包含至少一个小写字母\n&quot; +
            &quot;4. 包含至少一个大写字母\n&quot; +
            &quot;5. 包含至少一个特殊字符(!@#$%^&amp;*(),.?\&quot;{}\\|&lt;&gt;)&quot;, 
<span class="nc" id="L153">            MIN_PASSWORD_LENGTH</span>
        );
    }
    
    /**
     * 获取密码要求描述
     * @return 密码要求描述字符串
     */
    public String getPasswordRequirementsDescription() {
<span class="nc" id="L162">        return &quot;密码必须至少包含&quot; + MIN_PASSWORD_LENGTH + &quot;个字符，包括大写字母、小写字母、数字和特殊字符。&quot;;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>