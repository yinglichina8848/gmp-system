# 质量管理子系统部署与运维指南

## 1. 文档概述

本文档提供质量管理子系统(QMS)的部署、配置和运维指南，帮助系统管理员了解如何安装、配置、监控和维护QMS系统，确保系统稳定、安全、高效地运行。

## 2. 系统要求

### 2.1 硬件要求

| 环境类型 | CPU | 内存 | 磁盘空间 | 网络 |
|---------|-----|------|---------|------|
| 开发环境 | 4核 | 8GB | 100GB | 千兆网卡 |
| 测试环境 | 8核 | 16GB | 200GB | 千兆网卡 |
| 生产环境 | 16核 | 32GB | 500GB+ | 万兆网卡 |

### 2.2 软件要求

| 软件 | 版本 | 用途 |
|------|------|------|
| JDK | 11+ | Java运行环境 |
| PostgreSQL | 13.x | 数据库 |
| Redis | 6.0+ | 缓存 |
| Elasticsearch | 7.x (可选) | 日志分析和搜索 |
| Nginx | 1.18+ | 反向代理（生产环境） |
| Docker | 20.10+ | 容器化部署 |
| Docker Compose | 1.29+ | 容器编排 |
| Maven | 3.6+ | 构建工具 |

### 2.3 操作系统要求

- **Linux**：推荐CentOS 8/RHEL 8或Ubuntu 20.04 LTS
- **Windows Server**：Windows Server 2019或更高版本

## 3. 部署架构

### 3.1 基础部署架构

```
客户端浏览器
     ↓
负载均衡器(Nginx)
     ↓
   QMS应用服务器集群
     ↓
缓存(Redis)   数据库(PostgreSQL)
```

### 3.2 高可用部署架构

```
客户端浏览器
     ↓
负载均衡器集群
     ↓
QMS应用服务器集群(多节点)
     ↓
Redis集群    PostgreSQL主从复制
     ↓          ↓
文件存储     数据备份系统
```

## 4. 部署方式

### 4.1 传统部署

#### 4.1.1 准备工作

1. 安装JDK 11+
2. 安装并配置PostgreSQL 13.x
3. 安装并配置Redis 6.0+
4. 创建数据库和用户

```sql
-- 创建数据库
CREATE DATABASE qmsdb OWNER postgres;

-- 创建用户
CREATE USER qms_user WITH PASSWORD 'strong_password';

-- 授予权限
GRANT ALL PRIVILEGES ON DATABASE qmsdb TO qms_user;

-- 切换到qmsdb数据库
\c qmsdb

-- 授予schema权限
GRANT ALL ON SCHEMA public TO qms_user;
```

#### 4.1.2 应用部署

1. 获取应用包

```bash
# 从GitLab拉取代码并构建
cd /opt
git clone https://git.example.com/gmp-system/qms.git
cd qms
mvn clean package -DskipTests
```

2. 配置应用

修改`application-prod.yml`配置文件：

```yaml
spring:
  datasource:
    url: jdbc:postgresql://localhost:5432/qmsdb
    username: qms_user
    password: strong_password
  redis:
    host: localhost
    port: 6379
  jpa:
    hibernate:
      ddl-auto: update
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect

server:
  port: 8080
  servlet:
    context-path: /qms

auth:
  jwt:
    secret: your_jwt_secret_key
    expiration: 3600

logging:
  level:
    root: INFO
    com.example.qms: DEBUG
  file:
    path: /opt/logs/qms
```

3. 启动应用

```bash
# 使用nohup后台启动
nohup java -jar -Dspring.profiles.active=prod target/qms-1.0.0.jar > /dev/null 2>&1 &

# 或者使用systemd管理
# 创建systemd服务文件
cat > /etc/systemd/system/qms.service << EOF
[Unit]
Description=Quality Management System
After=syslog.target network.target

[Service]
User=qms_user
ExecStart=/usr/bin/java -jar -Dspring.profiles.active=prod /opt/qms/target/qms-1.0.0.jar
SuccessExitStatus=143
Restart=on-failure

[Install]
WantedBy=multi-user.target
EOF

# 启用并启动服务
systemctl daemon-reload
systemctl enable qms
systemctl start qms
```

### 4.2 Docker容器化部署

#### 4.2.1 准备Docker Compose文件

创建`docker-compose.yml`：

```yaml
version: '3.8'

services:
  postgres:
    image: postgres:13
    container_name: qms_postgres
    environment:
      POSTGRES_DB: qmsdb
      POSTGRES_USER: qms_user
      POSTGRES_PASSWORD: strong_password
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-db:/docker-entrypoint-initdb.d
    ports:
      - "5432:5432"
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U qms_user -d qmsdb"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:6
    container_name: qms_redis
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    restart: always
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  qms:
    build: .
    container_name: qms_app
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/qmsdb
      SPRING_DATASOURCE_USERNAME: qms_user
      SPRING_DATASOURCE_PASSWORD: strong_password
      SPRING_REDIS_HOST: redis
      SPRING_REDIS_PORT: 6379
    ports:
      - "8080:8080"
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/qms/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  postgres_data:
  redis_data:
```

#### 4.2.2 创建Dockerfile

```dockerfile
FROM openjdk:11-jre-slim

WORKDIR /app

COPY target/qms-1.0.0.jar app.jar

EXPOSE 8080

ENTRYPOINT ["java", "-jar", "app.jar", "--spring.profiles.active=prod"]
```

#### 4.2.3 启动容器

```bash
# 构建并启动服务
docker-compose up -d --build

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f
```

## 5. 系统配置

### 5.1 数据库配置

#### 5.1.1 索引优化

```sql
-- 为常用查询字段创建索引
CREATE INDEX idx_deviations_status ON deviations(status);
CREATE INDEX idx_deviations_severity ON deviations(severity);
CREATE INDEX idx_deviations_created_at ON deviations(created_at);
CREATE INDEX idx_capa_related_deviation ON capas(related_deviation_id);
CREATE INDEX idx_changes_status ON changes(status);
CREATE INDEX idx_changes_impact_level ON changes(impact_level);
```

#### 5.1.2 数据库备份策略

```bash
# 创建备份脚本
cat > /opt/scripts/db_backup.sh << 'EOF'
#!/bin/bash

BACKUP_DIR="/opt/backups/qms_db"
DATE=$(date +%Y%m%d_%H%M%S)

# 创建备份目录
mkdir -p $BACKUP_DIR

# 执行备份
pg_dump -h localhost -U qms_user -d qmsdb -F c -b -v -f "$BACKUP_DIR/qmsdb_$DATE.dump"

# 压缩备份文件
gzip "$BACKUP_DIR/qmsdb_$DATE.dump"

# 删除7天前的备份文件
find $BACKUP_DIR -name "qmsdb_*.dump.gz" -mtime +7 -delete
EOF

# 设置执行权限
chmod +x /opt/scripts/db_backup.sh

# 添加到crontab，每天凌晨2点执行
crontab -l > mycron
echo "0 2 * * * /opt/scripts/db_backup.sh > /opt/logs/db_backup.log 2>&1" >> mycron
crontab mycron
rm mycron
```

### 5.2 安全配置

#### 5.2.1 防火墙设置

```bash
# 允许必要的端口
sudo firewall-cmd --permanent --add-port=8080/tcp  # QMS应用
# sudo firewall-cmd --permanent --add-port=5432/tcp  # PostgreSQL（仅在必要时开启）
# sudo firewall-cmd --permanent --add-port=6379/tcp  # Redis（仅在必要时开启）
sudo firewall-cmd --reload
```

#### 5.2.2 HTTPS配置（Nginx）

```nginx
server {
    listen 80;
    server_name qms.example.com;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    server_name qms.example.com;

    ssl_certificate /etc/nginx/ssl/qms.example.com.crt;
    ssl_certificate_key /etc/nginx/ssl/qms.example.com.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    ssl_ciphers 'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';

    location /qms {
        proxy_pass http://localhost:8080/qms;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### 5.3 日志配置

#### 5.3.1 应用日志配置

修改`application-prod.yml`中的日志配置：

```yaml
logging:
  level:
    root: INFO
    com.example.qms: INFO
    org.springframework.security: WARN
  file:
    path: /opt/logs/qms
    max-size: 100MB
    max-history: 30
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
```

#### 5.3.2 日志轮转配置

创建`logrotate`配置：

```
/opt/logs/qms/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 0644 qms_user qms_user
    sharedscripts
    postrotate
        systemctl restart qms > /dev/null 2>&1 || true
    endscript
}
```

## 6. 系统运维

### 6.1 健康检查

#### 6.1.1 应用健康检查

```bash
# 访问健康检查端点
curl http://localhost:8080/qms/actuator/health

# 查看应用状态
systemctl status qms

# 查看Docker容器状态
docker-compose ps
```

#### 6.1.2 数据库健康检查

```bash
# 连接数据库
psql -h localhost -U qms_user -d qmsdb

# 执行健康检查查询
SELECT datname, numbackends, xact_commit, xact_rollback FROM pg_stat_database WHERE datname = 'qmsdb';
```

### 6.2 性能监控

#### 6.2.1 JVM监控

```bash
# 使用jstat监控JVM
jstat -gcutil $(pgrep -f qms-1.0.0.jar)

# 使用jvisualvm远程连接（需要JMX配置）
```

#### 6.2.2 数据库性能监控

```sql
-- 查看慢查询
SELECT pid, now() - pg_stat_activity.query_start AS duration, query, state
FROM pg_stat_activity
WHERE (now() - pg_stat_activity.query_start) > interval '10 seconds'
  AND state = 'active';

-- 查看表大小
SELECT table_name, pg_size_pretty(pg_total_relation_size(quote_ident(table_name))) AS size
FROM information_schema.tables
WHERE table_schema = 'public'
ORDER BY pg_total_relation_size(quote_ident(table_name)) DESC;
```

### 6.3 常见问题排查

#### 6.3.1 应用启动失败

1. 检查应用日志
2. 检查数据库连接
3. 检查端口占用
4. 检查依赖服务是否运行

```bash
# 检查端口占用
lsof -i :8080

# 检查数据库连接
telnet localhost 5432

# 检查Redis连接
telnet localhost 6379
```

#### 6.3.2 数据库连接问题

1. 检查数据库服务是否运行
2. 验证用户名和密码
3. 检查防火墙设置
4. 查看数据库连接池状态

```bash
# 检查PostgreSQL服务状态
systemctl status postgresql

# 检查数据库连接数
psql -h localhost -U qms_user -d qmsdb -c "SELECT count(*) FROM pg_stat_activity;"
```

#### 6.3.3 性能问题排查

1. 检查JVM内存使用情况
2. 识别慢查询
3. 检查系统资源使用情况（CPU、内存、磁盘I/O）
4. 分析应用日志中的错误和警告

```bash
# 查看系统资源使用情况
top

# 查看磁盘I/O
iostat -xz 1

# 查看内存使用情况
free -m
```

## 7. 系统升级

### 7.1 升级前准备

1. 备份数据库
2. 备份当前应用版本
3. 验证新版本兼容性
4. 制定回滚计划

### 7.2 升级步骤

#### 7.2.1 传统部署升级

```bash
# 停止服务
systemctl stop qms

# 备份当前版本
cp /opt/qms/target/qms-1.0.0.jar /opt/backups/qms_app/qms-1.0.0.jar.$(date +%Y%m%d)

# 获取新版本
cd /opt/qms
git pull
mvn clean package -DskipTests

# 数据库迁移（如需）
java -jar target/qms-1.0.0.jar --spring.profiles.active=prod --spring.jpa.hibernate.ddl-auto=update

# 启动服务
systemctl start qms

# 验证服务状态
systemctl status qms
```

#### 7.2.2 Docker部署升级

```bash
# 停止并移除旧容器
docker-compose down

# 备份数据卷（可选）
docker run --rm -v qms_postgres_data:/source -v $(pwd)/pg_backup:/backup alpine tar -czvf /backup/postgres_data.tar.gz -C /source .

# 更新代码和配置
git pull

# 构建并启动新版本
docker-compose up -d --build

# 验证服务状态
docker-compose ps
```

### 7.3 升级后验证

1. 验证应用服务是否正常启动
2. 验证数据完整性
3. 执行关键功能测试
4. 监控系统性能和错误日志

## 8. 灾难恢复

### 8.1 数据库恢复

```bash
# 停止应用服务
systemctl stop qms

# 恢复数据库
pg_restore -h localhost -U qms_user -d qmsdb -c -v /opt/backups/qms_db/qmsdb_20230801_020000.dump.gz

# 启动应用服务
systemctl start qms
```

### 8.2 系统迁移

1. 安装目标环境
2. 备份源环境数据和配置
3. 恢复数据到目标环境
4. 配置并启动应用
5. 验证功能完整性
6. 切换流量到新环境

## 9. 安全最佳实践

1. **定期更新系统和软件包**
   - 定期更新操作系统补丁
   - 保持JDK、数据库等组件的最新安全版本

2. **访问控制**
   - 实施最小权限原则
   - 定期审查用户权限和访问日志
   - 使用强密码策略并定期更换

3. **数据安全**
   - 对敏感数据进行加密存储
   - 实施数据脱敏策略
   - 定期进行数据备份并测试恢复流程

4. **网络安全**
   - 使用HTTPS加密传输
   - 配置适当的防火墙规则
   - 限制管理接口的访问范围

5. **审计与合规**
   - 启用详细的操作审计日志
   - 定期进行安全审计和漏洞扫描
   - 保持符合GMP等行业法规要求

## 10. 附录

### 10.1 配置参考

#### 10.1.1 环境变量配置

| 环境变量 | 描述 | 默认值 |
|---------|------|-------|
| `SPRING_DATASOURCE_URL` | 数据库连接URL | `jdbc:postgresql://localhost:5432/qmsdb` |
| `SPRING_DATASOURCE_USERNAME` | 数据库用户名 | - |
| `SPRING_DATASOURCE_PASSWORD` | 数据库密码 | - |
| `SPRING_REDIS_HOST` | Redis主机地址 | `localhost` |
| `SPRING_REDIS_PORT` | Redis端口 | `6379` |
| `AUTH_JWT_SECRET` | JWT密钥 | - |
| `AUTH_JWT_EXPIRATION` | JWT过期时间(秒) | `3600` |
| `LOGGING_LEVEL_ROOT` | 根日志级别 | `INFO` |
| `LOGGING_FILE_PATH` | 日志文件路径 | `/opt/logs/qms` |

### 10.2 常用命令

```bash
# 重启应用
systemctl restart qms

# 查看应用日志
tail -f /opt/logs/qms/qms.log

# 查看数据库连接池状态
curl -s http://localhost:8080/qms/actuator/metrics/hikaricp.connections.active

# 强制GC
sudo -u qms_user jcmd $(pgrep -f qms-1.0.0.jar) GC.run
```

### 10.3 联系信息

- **系统管理员**：技术支持团队（电话：400-123-4567，邮箱：support@example.com）
- **开发团队**：QMS开发组（邮箱：qms-dev@example.com）
- **紧急联系方式**：138-0013-8000（24小时）