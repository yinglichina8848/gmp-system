# 质量管理子系统技术实现文档

## 1. 文档概述

本文档详细描述GMP系统中质量管理子系统(QMS)的技术实现方案，包括架构设计、技术栈选型、核心模块实现、数据库设计、安全机制、性能优化等方面。本文档适用于开发团队进行系统开发、维护和优化参考。

## 2. 技术栈选型

| 类别 | 技术/框架 | 版本 | 选型理由 |
|------|-----------|------|----------|
| 开发语言 | Java | 11+ | 企业级应用开发的主流选择，具有良好的跨平台性和生态系统支持。 |
| 应用框架 | Spring Boot | 2.7.x | 简化Java应用开发的微服务框架，提供自动配置、内嵌容器等特性。 |
| ORM框架 | Spring Data JPA | 2.7.x | 简化数据库访问层开发，提供强大的查询构建能力。 |
| 数据库 | PostgreSQL | 14.x | 企业级关系型数据库，支持复杂查询、事务处理和高并发访问。 |
| 缓存 | Redis | 6.x | 高性能键值存储，用于缓存热点数据和管理Session/Token。 |
| 消息队列 | RabbitMQ | 3.9.x | 可靠的消息传递机制，用于系统间异步通信和事件处理。 |
| 搜索引擎 | Elasticsearch | 7.x | 全文搜索引擎，用于实现复杂的文档检索和数据统计分析。 |
| API文档 | Swagger/OpenAPI | 3.0 | 自动生成API文档，提供交互式API测试界面。 |
| 安全框架 | Spring Security | 5.7.x | 全面的安全解决方案，支持认证、授权、防止CSRF等安全机制。 |
| 认证机制 | JWT | - | 无状态认证，便于水平扩展。 |
| 前端框架 | Vue.js | 3.x | 渐进式JavaScript框架，易于上手且性能优秀。 |
| UI组件库 | Element Plus | 2.x | 基于Vue 3的高质量UI组件库。 |

## 3. 系统架构

### 3.1 整体架构

QMS子系统采用典型的微服务架构，由以下几个主要部分组成：

1. **前端层**：基于Vue.js构建的单页应用(SPA)，通过API Gateway与后端服务交互
2. **API网关层**：统一的入口，负责路由转发、认证鉴权、限流熔断等
3. **服务层**：核心业务逻辑实现，包含多个微服务模块
4. **数据访问层**：封装数据访问操作，支持多数据源
5. **数据存储层**：包括主数据库、缓存、搜索引擎等
6. **基础设施层**：提供日志、监控、配置管理等支持

### 3.2 服务模块划分

| 模块名称 | 主要职责 | 关键接口 |
|---------|---------|----------|
| qms-service-core | 核心业务逻辑处理 | 偏差管理、CAPA管理等核心功能 |
| qms-service-audit | 审计管理 | 审计计划、审计发现等功能 |
| qms-service-complaint | 投诉管理 | 投诉记录、处理跟踪等功能 |
| qms-service-file | 文件管理 | 文件上传、下载、版本控制等功能 |
| qms-service-report | 报表服务 | 各类统计报表生成功能 |

### 3.3 数据流图

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│             │     │             │     │             │
│   前端应用   │────▶│    API网关   │────▶│    服务层    │
│             │     │             │     │             │
└─────────────┘     └─────────────┘     └──────┬──────┘
                                               │
                         ┌─────────────────────┼─────────────────────┐
                         ▼                     ▼                     ▼
                   ┌─────────────┐      ┌─────────────┐      ┌─────────────┐
                   │             │      │             │      │             │
                   │    数据库    │      │    缓存      │      │    搜索引擎   │
                   │             │      │             │      │             │
                   └─────────────┘      └─────────────┘      └─────────────┘
```

## 4. 核心模块实现

### 4.1 偏差管理模块

#### 4.1.1 核心实体类

```java
@Entity
@Table(name = "deviation")
public class Deviation {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(name = "code", unique = true, nullable = false)
    private String code;
    
    @Column(name = "title", nullable = false)
    private String title;
    
    @Column(name = "description", columnDefinition = "TEXT")
    private String description;
    
    @Enumerated(EnumType.STRING)
    @Column(name = "type", nullable = false)
    private DeviationType type;
    
    @Enumerated(EnumType.STRING)
    @Column(name = "severity", nullable = false)
    private Severity severity;
    
    @Enumerated(EnumType.STRING)
    @Column(name = "status", nullable = false)
    private DeviationStatus status;
    
    @Column(name = "occurrence_date", nullable = false)
    private LocalDateTime occurrenceDate;
    
    @Column(name = "location")
    private String location;
    
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "reporter_id")
    private User reporter;
    
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "investigator_id")
    private User investigator;
    
    @Column(name = "investigation_summary", columnDefinition = "TEXT")
    private String investigationSummary;
    
    @Column(name = "root_cause", columnDefinition = "TEXT")
    private String rootCause;
    
    @OneToMany(mappedBy = "deviation", cascade = CascadeType.ALL, orphanRemoval = true)
    private List<Action> actions = new ArrayList<>();
    
    @OneToMany(mappedBy = "deviation", cascade = CascadeType.ALL, orphanRemoval = true)
    private List<Attachment> attachments = new ArrayList<>();
    
    @OneToMany(mappedBy = "deviation", cascade = CascadeType.ALL, orphanRemoval = true)
    private List<Comment> comments = new ArrayList<>();
    
    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;
    
    @Column(name = "updated_at")
    private LocalDateTime updatedAt;
    
    @Column(name = "closed_at")
    private LocalDateTime closedAt;
    
    @PrePersist
    protected void onCreate() {
        createdAt = LocalDateTime.now();
        updatedAt = LocalDateTime.now();
    }
    
    @PreUpdate
    protected void onUpdate() {
        updatedAt = LocalDateTime.now();
    }
    
    // getter/setter 方法
}
```

#### 4.1.2 业务服务实现

```java
@Service
@Transactional
public class DeviationServiceImpl implements DeviationService {
    
    private final DeviationRepository deviationRepository;
    private final DeviationCodeGenerator codeGenerator;
    private final EventPublisher eventPublisher;
    
    public DeviationServiceImpl(DeviationRepository deviationRepository,
                               DeviationCodeGenerator codeGenerator,
                               EventPublisher eventPublisher) {
        this.deviationRepository = deviationRepository;
        this.codeGenerator = codeGenerator;
        this.eventPublisher = eventPublisher;
    }
    
    @Override
    public Deviation createDeviation(DeviationDTO deviationDTO, User reporter) {
        // 验证输入参数
        validateDeviationDTO(deviationDTO);
        
        // 创建偏差实体
        Deviation deviation = new Deviation();
        deviation.setTitle(deviationDTO.getTitle());
        deviation.setDescription(deviationDTO.getDescription());
        deviation.setType(deviationDTO.getType());
        deviation.setSeverity(deviationDTO.getSeverity());
        deviation.setStatus(DeviationStatus.NEW);
        deviation.setOccurrenceDate(deviationDTO.getOccurrenceDate());
        deviation.setLocation(deviationDTO.getLocation());
        deviation.setReporter(reporter);
        
        // 生成唯一编号
        deviation.setCode(codeGenerator.generate());
        
        // 保存偏差记录
        Deviation savedDeviation = deviationRepository.save(deviation);
        
        // 发布偏差创建事件
        eventPublisher.publishEvent(new DeviationCreatedEvent(savedDeviation));
        
        return savedDeviation;
    }
    
    @Override
    @Transactional(readOnly = true)
    public Page<Deviation> findDeviations(DeviationQuery query, Pageable pageable) {
        return deviationRepository.findByQuery(query, pageable);
    }
    
    @Override
    public void submitForInvestigation(Long deviationId, Long investigatorId) {
        Deviation deviation = deviationRepository.findById(deviationId)
            .orElseThrow(() -> new ResourceNotFoundException("偏差记录不存在: " + deviationId));
        
        // 验证偏差状态
        if (!deviation.getStatus().equals(DeviationStatus.NEW)) {
            throw new BusinessRuleException("只有新建状态的偏差才能提交调查");
        }
        
        // 设置调查人员和状态
        deviation.setInvestigator(new User(investigatorId)); // 实际应从数据库获取完整用户信息
        deviation.setStatus(DeviationStatus.UNDER_INVESTIGATION);
        
        // 保存更新
        deviationRepository.save(deviation);
        
        // 发布状态变更事件
        eventPublisher.publishEvent(new DeviationStatusChangedEvent(deviation));
    }
    
    @Override
    public void approveDeviation(Long deviationId, DeviationApprovalDTO approvalDTO, User approver) {
        Deviation deviation = deviationRepository.findById(deviationId)
            .orElseThrow(() -> new ResourceNotFoundException("偏差记录不存在: " + deviationId));
        
        // 验证偏差状态
        if (!deviation.getStatus().equals(DeviationStatus.UNDER_INVESTIGATION)) {
            throw new BusinessRuleException("只有调查中的偏差才能进行批准");
        }
        
        // 设置审批信息
        deviation.setApprovalComments(approvalDTO.getApprovalComments());
        deviation.setApprover(approver);
        deviation.setStatus(DeviationStatus.IN_PROGRESS);
        
        // 创建纠正措施
        if (approvalDTO.getActions() != null && !approvalDTO.getActions().isEmpty()) {
            for (ActionDTO actionDTO : approvalDTO.getActions()) {
                Action action = new Action();
                action.setDescription(actionDTO.getDescription());
                action.setResponsible(new User(actionDTO.getResponsibleId()));
                action.setDueDate(actionDTO.getDueDate());
                action.setStatus(ActionStatus.ASSIGNED);
                action.setDeviation(deviation);
                deviation.getActions().add(action);
            }
        }
        
        // 保存更新
        deviationRepository.save(deviation);
        
        // 发布审批事件
        eventPublisher.publishEvent(new DeviationApprovedEvent(deviation));
    }
    
    // 其他方法实现...
    
    private void validateDeviationDTO(DeviationDTO deviationDTO) {
        // 输入验证逻辑
        if (StringUtils.isBlank(deviationDTO.getTitle())) {
            throw new ValidationException("偏差标题不能为空");
        }
        if (deviationDTO.getType() == null) {
            throw new ValidationException("偏差类型不能为空");
        }
        // 更多验证...
    }
}
```

### 4.2 CAPA管理模块

#### 4.2.1 核心实体类

```java
@Entity
@Table(name = "capa")
public class CAPA {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(name = "code", unique = true, nullable = false)
    private String code;
    
    @Column(name = "title", nullable = false)
    private String title;
    
    @Column(name = "description", columnDefinition = "TEXT")
    private String description;
    
    @Enumerated(EnumType.STRING)
    @Column(name = "status", nullable = false)
    private CAPAStatus status;
    
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "owner_id")
    private User owner;
    
    @Column(name = "target_completion_date")
    private LocalDateTime targetCompletionDate;
    
    @OneToMany(mappedBy = "capa", cascade = CascadeType.ALL, orphanRemoval = true)
    private List<CAPAAction> actions = new ArrayList<>();
    
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "deviation_id")
    private Deviation deviation;
    
    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;
    
    @Column(name = "updated_at")
    private LocalDateTime updatedAt;
    
    @Column(name = "closed_at")
    private LocalDateTime closedAt;
    
    // getter/setter 方法
}
```

### 4.3 变更控制模块

#### 4.3.1 核心实体类

```java
@Entity
@Table(name = "change_control")
public class ChangeControl {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(name = "code", unique = true, nullable = false)
    private String code;
    
    @Column(name = "title", nullable = false)
    private String title;
    
    @Column(name = "description", columnDefinition = "TEXT")
    private String description;
    
    @Enumerated(EnumType.STRING)
    @Column(name = "type", nullable = false)
    private ChangeType type;
    
    @Enumerated(EnumType.STRING)
    @Column(name = "risk_level")
    private RiskLevel riskLevel;
    
    @Enumerated(EnumType.STRING)
    @Column(name = "status", nullable = false)
    private ChangeStatus status;
    
    @Column(name = "impact_assessment", columnDefinition = "TEXT")
    private String impactAssessment;
    
    @Column(name = "implementation_plan", columnDefinition = "TEXT")
    private String implementationPlan;
    
    @OneToMany(mappedBy = "changeControl", cascade = CascadeType.ALL, orphanRemoval = true)
    private List<ChangeReview> reviews = new ArrayList<>();
    
    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;
    
    @Column(name = "updated_at")
    private LocalDateTime updatedAt;
    
    // getter/setter 方法
}
```

## 5. 数据库设计

### 5.1 数据库连接配置

```java
@Configuration
@EnableTransactionManagement
@EnableJpaRepositories("com.example.qms.repository")
public class DatabaseConfig {
    
    @Bean
    @ConfigurationProperties("spring.datasource")
    public DataSource dataSource() {
        return DataSourceBuilder.create().build();
    }
    
    @Bean
    public LocalContainerEntityManagerFactoryBean entityManagerFactory(
            DataSource dataSource,
            JpaProperties jpaProperties) {
        
        LocalContainerEntityManagerFactoryBean em = new LocalContainerEntityManagerFactoryBean();
        em.setDataSource(dataSource);
        em.setPackagesToScan("com.example.qms.entity");
        em.setJpaVendorAdapter(new HibernateJpaVendorAdapter());
        em.setJpaProperties(jpaProperties.getProperties());
        
        return em;
    }
    
    @Bean
    public PlatformTransactionManager transactionManager(EntityManagerFactory entityManagerFactory) {
        return new JpaTransactionManager(entityManagerFactory);
    }
}
```

### 5.2 数据访问层实现

```java
@Repository
public interface DeviationRepository extends JpaRepository<Deviation, Long>, JpaSpecificationExecutor<Deviation> {
    
    Optional<Deviation> findByCode(String code);
    
    Page<Deviation> findByReporterId(Long reporterId, Pageable pageable);
    
    Page<Deviation> findByInvestigatorId(Long investigatorId, Pageable pageable);
    
    @Query("SELECT d FROM Deviation d WHERE d.status = :status ORDER BY d.createdAt DESC")
    Page<Deviation> findByStatus(DeviationStatus status, Pageable pageable);
    
    // 自定义查询方法，根据查询条件构建动态查询
    default Page<Deviation> findByQuery(DeviationQuery query, Pageable pageable) {
        Specification<Deviation> spec = (root, criteriaQuery, criteriaBuilder) -> {
            List<Predicate> predicates = new ArrayList<>();
            
            if (StringUtils.hasText(query.getCode())) {
                predicates.add(criteriaBuilder.like(root.get("code"), "%" + query.getCode() + "%"));
            }
            
            if (StringUtils.hasText(query.getTitle())) {
                predicates.add(criteriaBuilder.like(root.get("title"), "%" + query.getTitle() + "%"));
            }
            
            if (query.getType() != null) {
                predicates.add(criteriaBuilder.equal(root.get("type"), query.getType()));
            }
            
            if (query.getSeverity() != null) {
                predicates.add(criteriaBuilder.equal(root.get("severity"), query.getSeverity()));
            }
            
            if (query.getStatus() != null) {
                predicates.add(criteriaBuilder.equal(root.get("status"), query.getStatus()));
            }
            
            if (query.getStartDate() != null) {
                predicates.add(criteriaBuilder.greaterThanOrEqualTo(
                    root.get("occurrenceDate"), query.getStartDate()));
            }
            
            if (query.getEndDate() != null) {
                predicates.add(criteriaBuilder.lessThanOrEqualTo(
                    root.get("occurrenceDate"), query.getEndDate()));
            }
            
            return criteriaBuilder.and(predicates.toArray(new Predicate[0]));
        };
        
        return findAll(spec, pageable);
    }
}
```

## 6. 安全机制实现

### 6.1 Spring Security配置

```java
@Configuration
@EnableWebSecurity
@EnableGlobalMethodSecurity(prePostEnabled = true)
public class SecurityConfig extends WebSecurityConfigurerAdapter {
    
    private final JwtTokenProvider jwtTokenProvider;
    private final QMSAccessDeniedHandler accessDeniedHandler;
    private final QMSAuthenticationEntryPoint authenticationEntryPoint;
    
    public SecurityConfig(JwtTokenProvider jwtTokenProvider,
                         QMSAccessDeniedHandler accessDeniedHandler,
                         QMSAuthenticationEntryPoint authenticationEntryPoint) {
        this.jwtTokenProvider = jwtTokenProvider;
        this.accessDeniedHandler = accessDeniedHandler;
        this.authenticationEntryPoint = authenticationEntryPoint;
    }
    
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        // 禁用CSRF保护
        http.csrf().disable()
            
            // 配置异常处理器
            .exceptionHandling()
                .authenticationEntryPoint(authenticationEntryPoint)
                .accessDeniedHandler(accessDeniedHandler)
                .and()
            
            // 配置会话管理（使用无状态会话）
            .sessionManagement()
                .sessionCreationPolicy(SessionCreationPolicy.STATELESS)
                .and()
            
            // 配置路径安全规则
            .authorizeRequests()
                // 允许访问Swagger文档
                .antMatchers("/swagger-ui/**", "/v3/api-docs/**").permitAll()
                
                // 偏差管理相关权限
                .antMatchers("/api/v1/deviations").hasAnyRole("QUALITY_MANAGER", "QA_SPECIALIST")
                .antMatchers("/api/v1/deviations/**/approve").hasRole("QUALITY_MANAGER")
                
                // CAPA管理相关权限
                .antMatchers("/api/v1/capas").hasAnyRole("QUALITY_MANAGER", "QA_SPECIALIST")
                .antMatchers("/api/v1/capas/**/verify").hasRole("QA_SPECIALIST")
                
                // 其他API权限配置...
                
                // 所有请求必须认证
                .anyRequest().authenticated()
                .and()
            
            // 添加JWT过滤器
            .apply(new JwtSecurityConfigurer(jwtTokenProvider));
    }
}
```

### 6.2 JWT令牌验证

```java
@Component
public class JwtTokenProvider {
    
    @Value("${app.jwtSecret}")
    private String jwtSecret;
    
    @Value("${app.jwtExpirationInMs}")
    private int jwtExpirationInMs;
    
    public String generateToken(Authentication authentication) {
        UserPrincipal userPrincipal = (UserPrincipal) authentication.getPrincipal();
        
        Date now = new Date();
        Date expiryDate = new Date(now.getTime() + jwtExpirationInMs);
        
        return Jwts.builder()
                .setSubject(Long.toString(userPrincipal.getId()))
                .setIssuedAt(now)
                .setExpiration(expiryDate)
                .signWith(SignatureAlgorithm.HS512, jwtSecret)
                .compact();
    }
    
    public Long getUserIdFromJWT(String token) {
        Claims claims = Jwts.parser()
                .setSigningKey(jwtSecret)
                .parseClaimsJws(token)
                .getBody();
        
        return Long.parseLong(claims.getSubject());
    }
    
    public boolean validateToken(String authToken) {
        try {
            Jwts.parser().setSigningKey(jwtSecret).parseClaimsJws(authToken);
            return true;
        } catch (SignatureException | MalformedJwtException | UnsupportedJwtException | IllegalArgumentException ex) {
            throw new JwtAuthenticationException("无效的JWT令牌");
        } catch (ExpiredJwtException ex) {
            throw new JwtAuthenticationException("JWT令牌已过期");
        }
    }
}
```

## 7. 消息队列集成

### 7.1 RabbitMQ配置

```java
@Configuration
public class RabbitMQConfig {
    
    public static final String DEVIATION_CREATED_QUEUE = "deviation.created.queue";
    public static final String DEVIATION_STATUS_CHANGED_QUEUE = "deviation.status.changed.queue";
    public static final String CAPA_CREATED_QUEUE = "capa.created.queue";
    
    @Bean
    public Queue deviationCreatedQueue() {
        return new Queue(DEVIATION_CREATED_QUEUE);
    }
    
    @Bean
    public Queue deviationStatusChangedQueue() {
        return new Queue(DEVIATION_STATUS_CHANGED_QUEUE);
    }
    
    @Bean
    public Queue capaCreatedQueue() {
        return new Queue(CAPA_CREATED_QUEUE);
    }
    
    @Bean
    public TopicExchange qmsExchange() {
        return new TopicExchange("qms.exchange");
    }
    
    @Bean
    public Binding deviationCreatedBinding(Queue deviationCreatedQueue, TopicExchange qmsExchange) {
        return BindingBuilder.bind(deviationCreatedQueue).to(qmsExchange).with("deviation.created");
    }
    
    @Bean
    public Binding deviationStatusChangedBinding(Queue deviationStatusChangedQueue, TopicExchange qmsExchange) {
        return BindingBuilder.bind(deviationStatusChangedQueue).to(qmsExchange).with("deviation.status.changed");
    }
    
    @Bean
    public Binding capaCreatedBinding(Queue capaCreatedQueue, TopicExchange qmsExchange) {
        return BindingBuilder.bind(capaCreatedQueue).to(qmsExchange).with("capa.created");
    }
}
```

### 7.2 消息发布器

```java
@Component
public class EventPublisher {
    
    private final RabbitTemplate rabbitTemplate;
    
    public EventPublisher(RabbitTemplate rabbitTemplate) {
        this.rabbitTemplate = rabbitTemplate;
    }
    
    public void publishEvent(DeviationCreatedEvent event) {
        rabbitTemplate.convertAndSend(
            "qms.exchange", 
            "deviation.created", 
            event
        );
    }
    
    public void publishEvent(DeviationStatusChangedEvent event) {
        rabbitTemplate.convertAndSend(
            "qms.exchange", 
            "deviation.status.changed", 
            event
        );
    }
    
    public void publishEvent(CAPACreatedEvent event) {
        rabbitTemplate.convertAndSend(
            "qms.exchange", 
            "capa.created", 
            event
        );
    }
}
```

## 8. 性能优化措施

### 8.1 缓存实现

```java
@Configuration
@EnableCaching
public class CacheConfig {
    
    @Bean
    public CacheManager cacheManager(RedisConnectionFactory redisConnectionFactory) {
        RedisCacheConfiguration config = RedisCacheConfiguration.defaultCacheConfig()
            .entryTtl(Duration.ofMinutes(10))
            .serializeKeysWith(RedisSerializationContext.SerializationPair.fromSerializer(
                new StringRedisSerializer()))
            .serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(
                new GenericJackson2JsonRedisSerializer()));
        
        return RedisCacheManager.builder(redisConnectionFactory)
            .cacheDefaults(config)
            .withCacheConfiguration("deviations", 
                RedisCacheConfiguration.defaultCacheConfig().entryTtl(Duration.ofHours(1)))
            .withCacheConfiguration("capas", 
                RedisCacheConfiguration.defaultCacheConfig().entryTtl(Duration.ofHours(1)))
            .build();
    }
}

// 使用缓存的服务方法
@Service
public class DeviationServiceImpl implements DeviationService {
    
    @Override
    @Cacheable(value = "deviations", key = "#deviationId")
    public Deviation getDeviationById(Long deviationId) {
        return deviationRepository.findById(deviationId)
            .orElseThrow(() -> new ResourceNotFoundException("偏差记录不存在: " + deviationId));
    }
    
    @Override
    @CacheEvict(value = "deviations", key = "#deviation.id")
    public Deviation updateDeviation(Deviation deviation) {
        return deviationRepository.save(deviation);
    }
}
```

### 8.2 数据库优化

```java
@Entity
@Table(name = "deviation", indexes = {
    @Index(name = "idx_deviation_code", columnList = "code"),
    @Index(name = "idx_deviation_status", columnList = "status"),
    @Index(name = "idx_deviation_created_at", columnList = "created_at"),
    @Index(name = "idx_deviation_reporter_id", columnList = "reporter_id"),
    @Index(name = "idx_deviation_investigator_id", columnList = "investigator_id")
})
public class Deviation {
    // 实体类定义...
}
```

## 9. 日志与监控

### 9.1 日志配置

```java
@Aspect
@Component
public class ServiceLoggingAspect {
    
    private static final Logger logger = LoggerFactory.getLogger(ServiceLoggingAspect.class);
    
    @Around("execution(* com.example.qms.service.*.*(..))")
    public Object logMethodExecution(ProceedingJoinPoint joinPoint) throws Throwable {
        String methodName = joinPoint.getSignature().getName();
        String className = joinPoint.getTarget().getClass().getSimpleName();
        
        long startTime = System.currentTimeMillis();
        logger.info("Starting method: {}.{} with arguments: {}", 
            className, methodName, Arrays.toString(joinPoint.getArgs()));
        
        try {
            Object result = joinPoint.proceed();
            long endTime = System.currentTimeMillis();
            logger.info("Method {}.{} completed in {} ms", 
                className, methodName, (endTime - startTime));
            return result;
        } catch (Exception e) {
            long endTime = System.currentTimeMillis();
            logger.error("Exception in method {}.{} after {} ms: {}", 
                className, methodName, (endTime - startTime), e.getMessage());
            throw e;
        }
    }
}
```

### 9.2 性能监控

```java
@Configuration
@EnablePrometheusMetrics
public class MetricsConfig {
    
    @Bean
    MeterRegistryCustomizer<MeterRegistry> metricsCommonTags() {
        return registry -> registry.config().commonTags("application", "qms-service");
    }
    
    @Bean
    Timer customTimer(MeterRegistry registry) {
        return registry.timer("qms.deviation.processing", "type", "custom");
    }
}

// 在服务中使用性能监控
@Service
public class DeviationServiceImpl implements DeviationService {
    
    private final Timer deviationProcessingTimer;
    
    public DeviationServiceImpl(Timer deviationProcessingTimer) {
        this.deviationProcessingTimer = deviationProcessingTimer;
    }
    
    @Override
    public void processDeviation(Long deviationId) {
        deviationProcessingTimer.record(() -> {
            // 偏差处理逻辑
        });
    }
}
```

## 10. 文档历史

| 版本 | 修改日期 | 修改人 | 修改内容 |
|------|----------|--------|----------|
| 1.0  | 2023-08-01 | QMS团队 | 初始版本 |
| 1.1  | 2023-08-05 | QMS团队 | 增加性能优化和监控章节 |
| 1.2  | 2023-08-10 | QMS团队 | 完善安全机制和数据库设计部分 |
