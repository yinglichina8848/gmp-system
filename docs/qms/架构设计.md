# QMS子系统（质量管理系统）架构设计

## 1. 概述

QMS子系统基于微服务架构设计，采用前后端分离模式，为药品质量管理提供完整的解决方案。

## 2. 系统架构

### 2.1 总体架构图

```
┌─────────────────────────────────────────────────────────┐
│                    前端应用层                            │
│   Vue.js + Element Plus + 质量管理UI模块                  │
└─────────────────────────────────────────────────────────┘
                                ▼
┌─────────────────────────────────────────────────────────┐
│                    API网关层                             │
│   Spring Cloud Gateway (统一认证、路由、限流)            │
└─────────────────────────────────────────────────────────┘
                                ▼
┌─────────────────────────────────────────────────────────┐
│                   QMS业务服务层                           │
│                                                         │
│   ┌─────────────┬─────────────┬─────────────┬─────────────┐ │
│   │  偏差管理   │   CAPA管   │  变更控制   │  审计管理   │ │
│   │ 控制器&服务 │   理服务   │  服务      │  服务      │ │
│   └─────────────┴─────────────┴─────────────┴─────────────┘ │
│                                                         │
│   ┌─────────────┬─────────────┬─────────────┬─────────────┐ │
│   │ 实体&数据   │   数据访问  │ 缓存管理    │ 消息队列    │ │
│   │ 传输对象    │   层       │ 服务       │ 服务       │ │
│   └─────────────┴─────────────┴─────────────┴─────────────┘ │
└─────────────────────────────────────────────────────────┘
                                ▼
┌─────────────────────────────────────────────────────────┐
│                   数据存储层                             │
│                                                         │
│   PostgreSQL: qms_db                                   │
│   - deviations/deviation_attachments                   │
│   - capas/capa_actions                                 │
│   - change_controls/approvals                          │
│   - audits/findings                                    │
│                                                         │
│   Redis: 缓存层                                        │
│   - 用户权限缓存                                        │
│   - 配置参数缓存                                        │
│   - 会话数据缓存                                        │
└─────────────────────────────────────────────────────────┘
```

### 2.2 分层架构

```
┌────────────────────────────────────────────────────┐
│            表现层 (Presentation Layer)             │
│   ┌─────────────────────────────────────────────┐   │
│   │        REST控制器 (Controllers)             │   │
│   │ - DeviationController                       │   │
│   │ - CapaController                            │   │
│   │ - ChangeControlController                   │   │
│   │ - AuditController                           │   │
│   └─────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────┘
                                ▼
┌────────────────────────────────────────────────────┐
│           业务逻辑层 (Business Layer)               │
│   ┌─────────────────────────────────────────────┐   │
│   │       业务服务 (Services)                    │   │
│   │ - DeviationService                           │   │
│   │ - CapaService                                │   │
│   │ - ChangeControlService                       │   │
│   │ - AuditService                               │   │
│   │                                             │   │
│   │ - 业务规则引擎                               │   │
│   │ - 工作流管理引擎                             │   │
│   └─────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────┘
                                ▼
┌────────────────────────────────────────────────────┐
│           数据访问层 (Data Access Layer)            │
│   ┌─────────────────────────────────────────────┐   │
│   │       数据仓库 (Repositories)               │   │
│   │ - DeviationRepository                       │   │
│   │ - CapaRepository                            │   │
│   │ - ChangeControlRepository                   │   │
│   │ - AuditRepository                           │   │
│   └─────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────┘
                                ▼
┌────────────────────────────────────────────────────┐
│           数据存储层 (Data Storage)                │
└────────────────────────────────────────────────────┘
```

## 3. 服务设计

### 3.1 微服务边界

```
QMS微服务 (qms-service:8081)
├── 偏差管理模块 (Deviation Management)
│   ├── 偏差创建 (@Post /api/qms/deviations)
│   ├── 偏差查询 (@Get /api/qms/deviations)
│   ├── 偏差更新 (@Put /api/qms/deviations/{id})
│   ├── 偏差关闭 (@Patch /api/qms/deviations/{id}/close)
│   └── 偏差附件 (@Post /api/qms/deviations/{id}/attachments)
├── CAPA管理模块 (CAPA Management)
│   ├── CAPA创建 (@Post /api/qms/capas)
│   ├── CAPA查询 (@Get /api/qms/capas)
│   ├── CAPA更新 (@Put /api/qms/capas/{id})
│   ├── 行动项管理 (@Post /api/qms/capas/{id}/actions)
│   └── 有效性验证 (@Patch /api/qms/capas/{id}/verify)
├── 变更控制模块 (Change Control)
│   ├── 变更申请 (@Post /api/qms/changes)
│   ├── 变更审批 (@Patch /api/qms/changes/{id}/approve)
│   ├── 变更查询 (@Get /api/qms/changes)
│   └── 变更执行 (@Patch /api/qms/changes/{id}/execute)
└── 审计管理模块 (Audit Management)
    ├── 审计计划 (@Post /api/qms/audits)
    ├── 审计执行 (@Patch /api/qms/audits/{id}/execute)
    ├── 发现记录 (@Post /api/qms/audits/{id}/findings)
    └── 审计关闭 (@Patch /api/qms/audits/{id}/close)
```

### 3.2 服务接口设计

#### 3.2.1 偏差管理服务接口
```java
@RestController
@RequestMapping("/api/qms/deviations")
@Tag(name = "Deviation Management", description = "偏差管理API")
public class DeviationController {

    @PostMapping
    @ResponseStatus(HttpStatus.CREATED)
    public ApiResponse<DeviationDto> createDeviation(@Valid @RequestBody CreateDeviationRequest request) {
        // 实现创建逻辑
    }

    @GetMapping("/{id}")
    public ApiResponse<DeviationDto> getDeviation(@PathVariable Long id) {
        // 实现查询逻辑
    }

    @GetMapping
    public ApiResponse<Page<DeviationDto>> getDeviations(DeviationSearchCriteria criteria,
                                                          Pageable pageable) {
        // 实现分页查询逻辑
    }
}
```

## 4. 数据架构设计

### 4.1 数据库设计

#### 4.1.1 核心数据表关系图
```
deviations (偏差表)
├── id (主键)
├── deviation_number (偏差编号)
├── title (标题)
├── description (描述)
├── severity (严重程度)
├── status (状态)
├── reported_by (报告人)
├── occurred_date (发生时间)
├── location (地点)
├── due_date (截止时间)
└── attachments (附件关联)

attachments (附件表)
├── id (主键)
├── deviation_id (外键)
├── file_name (文件名)
├── file_path (文件路径)
├── file_size (文件大小)
└── uploaded_by (上传人)
```

### 4.2 数据模型设计

#### 4.2.1 Entity (实体类)
```java
@Entity
@Table(name = "deviations")
@Data
@Audited
public class Deviation {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(unique = true, nullable = false)
    private String deviationNumber;

    @Column(nullable = false, length = 200)
    private String title;

    @Column(nullable = false, columnDefinition = "TEXT")
    private String description;

    @Enumerated(EnumType.STRING)
    private DeviationSeverity severity;

    @Enumerated(EnumType.STRING)
    private DeviationStatus status = DeviationStatus.OPEN;

    @Column(nullable = false)
    private String reportedBy;

    @Column(nullable = false)
    private LocalDateTime occurredDate;

    private String location;
    private LocalDateTime dueDate;

    @OneToMany(mappedBy = "deviation", cascade = CascadeType.ALL, fetch = FetchType.LAZY)
    private List<DeviationAttachment> attachments = new ArrayList<>();

    // 审计字段
    @CreatedDate
    private LocalDateTime createdAt;

    @LastModifiedDate
    private LocalDateTime updatedAt;
}
```

#### 4.2.2 DTO (数据传输对象)
```java
@Data
@Builder
public class DeviationDto {
    private Long id;
    private String deviationNumber;
    private String title;
    private String description;
    private DeviationSeverity severity;
    private DeviationStatus status;
    private String reportedBy;
    private LocalDateTime occurredDate;
    private String location;
    private LocalDateTime dueDate;
    private List<DeviationAttachmentDto> attachments;
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
}
```

### 4.3 Repository层设计

```java
@Repository
public interface DeviationRepository extends JpaRepository<Deviation, Long>,
                                         JpaSpecificationExecutor<Deviation> {

    // 根据状态查询
    List<Deviation> findByStatus(DeviationStatus status);

    // 根据严重程度查询
    List<Deviation> findBySeverity(DeviationStatus severity);

    // 根据报告人查询
    List<Deviation> findByReportedBy(String reportedBy);

    // 复合查询
    @Query("SELECT d FROM Deviation d WHERE " +
           "(:status IS NULL OR d.status = :status) AND " +
           "(:severity IS NULL OR d.severity = :severity)")
    Page<Deviation> findByCriteria(@Param("status") DeviationStatus status,
                                   @Param("severity") DeviationStatus severity,
                                   Pageable pageable);
}
```

## 5. 业务规则引擎

### 5.1 规则引擎设计

```java
@Component
public class QmsBusinessRuleEngine {

    // 严重程度评估规则
    public DeviationSeverity evaluateSeverity(DeviationRequest request) {
        // 根据影响范围、风险等级等因素计算严重程度
        if (request.getImpactArea().contains("PRODUCT_QUALITY") &&
            request.getRiskLevel().equals("CRITICAL")) {
            return DeviationSeverity.CRITICAL;
        }
        // 其他规则...
    }

    // 响应时间计算规则
    public LocalDateTime calculateDueDate(DeviationSeverity severity) {
        LocalDateTime now = LocalDateTime.now();
        switch (severity) {
            case CRITICAL: return now.plusHours(8);
            case HIGH: return now.plusHours(24);
            case MEDIUM: return now.plusDays(3);
            case LOW: return now.plusDays(7);
            default: return now.plusDays(7);
        }
    }
}
```

## 6. 缓存设计

### 6.1 Redis缓存策略

#### 6.1.1 配置参数缓存
```java
@Configuration
public class RedisConfig {

    @Bean
    public RedisTemplate<String, Object> redisTemplate(RedisConnectionFactory connectionFactory) {
        RedisTemplate<String, Object> template = new RedisTemplate<>();
        template.setConnectionFactory(connectionFactory);

        // JSON 序列化
        Jackson2JsonRedisSerializer<Object> jackson2JsonRedisSerializer =
            new Jackson2JsonRedisSerializer<>(Object.class);
        template.setDefaultSerializer(jackson2JsonRedisSerializer);

        return template;
    }
}
```

#### 6.1.2 缓存配置
```java
@Service
@CacheConfig(cacheNames = "qms")
public class CachingService {

    @Cacheable(value = "users", key = "#userId")
    public User getUserById(Long userId) {
        // 缓存用户数据，避免频繁调用auth-service
    }

    @Cacheable(value = "permissions", key = "#userId")
    public List<String> getUserPermissions(Long userId) {
        // 缓存用户权限数据
    }
}
```

## 7. 消息队列设计

### 7.1 事件驱动架构

```java
@Component
public class DeviationEventPublisher {

    @Autowired
    private RabbitTemplate rabbitTemplate;

    // 发布偏差创建事件
    public void publishDeviationCreatedEvent(Deviation deviation) {
        DeviationCreatedEvent event = new DeviationCreatedEvent(deviation);
        rabbitTemplate.convertAndSend("qms.exchange", "deviation.created", event);
    }

    // 发布CAPA创建事件
    public void publishCapaCreatedEvent(Capa capa) {
        CapaCreatedEvent event = new CapaCreatedEvent(capa);
        rabbitTemplate.convertAndSend("qms.exchange", "capa.created", event);
    }
}
```

## 8. 安全架构

### 8.1 安全配置

```java
@Configuration
@EnableWebSecurity
public class SecurityConfig extends WebSecurityConfigurerAdapter {

    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http
            .authorizeRequests()
                .antMatchers("/api/qms/deviations").hasRole("OPERATOR")
                .antMatchers("/api/qms/deviations/*/assign").hasRole("QUALITY_ENGINEER")
                .antMatchers("/api/qms/**").hasRole("QUALITY_MANAGER")
            .and()
            .oauth2ResourceServer()
                .jwt();
    }
}
```

## 9. 监控与日志

### 9.1 应用监控

```yaml
# application.yml
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  metrics:
    export:
      prometheus:
        enabled: true
```

### 9.2 日志配置

```yaml
logging:
  level:
    com.gmp.qms: DEBUG
    org.springframework.security: DEBUG
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
```

---

**文档信息：**
- 版本：v1.0
- 更新日期：2024年
- 编制人员：架构设计团队
- 状态：Draft
