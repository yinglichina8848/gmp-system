# 质量管理子系统数据模型设计文档

## 1. 文档概述

本文档详细描述GMP系统中质量管理子系统(QMS)的数据模型设计，包括实体关系、表结构设计、数据完整性约束等。本文档是数据库实现和数据访问层开发的重要依据。

## 2. 数据模型概述

### 2.1 核心实体关系图

```
+-----------------+        +-----------------+        +------------------+
|    Deviation    |        |       CAPA      |        |   ChangeControl  |
+-----------------+        +-----------------+        +------------------+
| - id            |        | - id            |        | - id             |
| - code          |        | - code          |        | - code           |
| - title         |        | - title         |        | - title          |
| - description   |<------>| - description   |        | - description    |
| - status        |        | - status        |        | - status         |
| - severity      |        | - ownerId       |        | - initiatorId    |
| - reporterId    |        | - verifierId    |        | - reviewerId     |
| - investigatorId|<--+    | - targetDate    |        | - approverId     |
+-----------------+   |    +-----------------+        +------------------+
                      |             ^                         ^
                      |             |                         |
                      |             |                         |
                      |             |                         |
+-----------------+   |    +-----------------+        +------------------+
|   Attachment    |   |    |    Action       |        |    AuditFinding  |
+-----------------+   |    +-----------------+        +------------------+
| - id            |   |    | - id            |        | - id             |
| - name          |   |    | - description   |        | - description    |
| - path          |   |    | - status        |        | - severity       |
| - contentType   |   |    | - ownerId       |        | - auditorId      |
| - entityType    |   |    | - dueDate       |        | - findingDate    |
| - entityId      |   |    +-----------------+        +------------------+
+-----------------+   |             ^                         |
                      |             |                         |
                      |             |                         |
                      |             |                         |
+-----------------+   |    +-----------------+        +------------------+
|    Comment      |   |    |    Verification |        |       Audit      |
+-----------------+   |    +-----------------+        +------------------+
| - id            |   |    | - id            |        | - id             |
| - content       |   |    | - result        |        | - code           |
| - authorId      |   |    | - comments      |        | - title          |
| - entityType    |   |    | - verifierId    |        | - scope          |
| - entityId      |   |    +-----------------+        | - startTime      |
+-----------------+   |                               | - endTime        |
                      |                               | - leadAuditorId  |
                      |                               +------------------+
+-----------------+   |
|     Complaint   |   |
+-----------------+   |
| - id            |   |
| - code          |   |
| - title         |   |
| - description   |   |
| - status        |   |
| - customerName  |   |
| - productId     |---+
+-----------------+
```

### 2.2 实体关系说明

- **偏差(Deviation)**：与CAPA是一对一关系，一个偏差可以触发一个CAPA
- **偏差(Deviation)**：与附件(Attachment)、评论(Comment)是一对多关系
- **CAPA**：与措施(Action)、验证(Verification)是一对多关系
- **变更控制(ChangeControl)**：与附件、评论是一对多关系
- **审计(Audit)**：与审计发现(AuditFinding)是一对多关系
- **审计发现(AuditFinding)**：与CAPA是一对一关系，一个审计发现可以触发一个CAPA
- **投诉(Complaint)**：与偏差(Deviation)是一对多关系，一个投诉可以关联多个偏差

## 3. 详细表结构设计

### 3.1 基础实体表

#### 3.1.1 `users` (用户表)

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|---------|------|------|
| `id` | `SERIAL` | `PRIMARY KEY` | 用户ID |
| `username` | `VARCHAR(100)` | `UNIQUE NOT NULL` | 用户名 |
| `email` | `VARCHAR(255)` | `UNIQUE NOT NULL` | 邮箱 |
| `password_hash` | `VARCHAR(255)` | `NOT NULL` | 密码哈希 |
| `full_name` | `VARCHAR(255)` | `NOT NULL` | 全名 |
| `department` | `VARCHAR(100)` | `NOT NULL` | 部门 |
| `position` | `VARCHAR(100)` | | 职位 |
| `phone_number` | `VARCHAR(20)` | | 电话号码 |
| `enabled` | `BOOLEAN` | `DEFAULT TRUE` | 是否启用 |
| `created_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |
| `updated_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 更新时间 |

#### 3.1.2 `roles` (角色表)

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|---------|------|------|
| `id` | `SERIAL` | `PRIMARY KEY` | 角色ID |
| `name` | `VARCHAR(50)` | `UNIQUE NOT NULL` | 角色名称 |
| `description` | `TEXT` | | 角色描述 |
| `created_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |

#### 3.1.3 `user_roles` (用户角色关联表)

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|---------|------|------|
| `user_id` | `INTEGER` | `REFERENCES users(id) ON DELETE CASCADE` | 用户ID |
| `role_id` | `INTEGER` | `REFERENCES roles(id) ON DELETE CASCADE` | 角色ID |
| `PRIMARY KEY` | | `(user_id, role_id)` | 复合主键 |

#### 3.1.4 `attachments` (附件表)

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|---------|------|------|
| `id` | `SERIAL` | `PRIMARY KEY` | 附件ID |
| `name` | `VARCHAR(255)` | `NOT NULL` | 附件名称 |
| `path` | `VARCHAR(500)` | `NOT NULL` | 文件路径 |
| `content_type` | `VARCHAR(100)` | `NOT NULL` | 内容类型 |
| `file_size` | `BIGINT` | `NOT NULL` | 文件大小(字节) |
| `entity_type` | `VARCHAR(50)` | `NOT NULL` | 关联实体类型 |
| `entity_id` | `BIGINT` | `NOT NULL` | 关联实体ID |
| `uploaded_by` | `INTEGER` | `REFERENCES users(id)` | 上传人ID |
| `uploaded_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 上传时间 |

#### 3.1.5 `comments` (评论表)

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|---------|------|------|
| `id` | `SERIAL` | `PRIMARY KEY` | 评论ID |
| `content` | `TEXT` | `NOT NULL` | 评论内容 |
| `entity_type` | `VARCHAR(50)` | `NOT NULL` | 关联实体类型 |
| `entity_id` | `BIGINT` | `NOT NULL` | 关联实体ID |
| `created_by` | `INTEGER` | `REFERENCES users(id)` | 创建人ID |
| `created_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |
| `updated_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 更新时间 |

### 3.2 偏差管理模块表

#### 3.2.1 `deviations` (偏差表)

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|---------|------|------|
| `id` | `SERIAL` | `PRIMARY KEY` | 偏差ID |
| `code` | `VARCHAR(50)` | `UNIQUE NOT NULL` | 偏差编号 |
| `title` | `VARCHAR(255)` | `NOT NULL` | 偏差标题 |
| `description` | `TEXT` | `NOT NULL` | 偏差描述 |
| `type` | `VARCHAR(50)` | `NOT NULL` | 偏差类型 |
| `severity` | `VARCHAR(20)` | `NOT NULL` | 严重程度 |
| `status` | `VARCHAR(50)` | `NOT NULL` | 偏差状态 |
| `occurrence_date` | `TIMESTAMP` | `NOT NULL` | 发生日期 |
| `location` | `VARCHAR(255)` | | 发生地点 |
| `reporter_id` | `INTEGER` | `REFERENCES users(id)` | 报告人ID |
| `investigator_id` | `INTEGER` | `REFERENCES users(id)` | 调查人ID |
| `approver_id` | `INTEGER` | `REFERENCES users(id)` | 批准人ID |
| `root_cause` | `TEXT` | | 根本原因 |
| `conclusion` | `TEXT` | | 结论 |
| `created_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |
| `updated_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 更新时间 |
| `closed_at` | `TIMESTAMP` | | 关闭时间 |
| `related_batch_id` | `VARCHAR(50)` | | 关联批次ID |
| `related_product_id` | `VARCHAR(50)` | | 关联产品ID |

#### 3.2.2 `deviation_actions` (偏差措施表)

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|---------|------|------|
| `id` | `SERIAL` | `PRIMARY KEY` | 措施ID |
| `deviation_id` | `INTEGER` | `REFERENCES deviations(id) ON DELETE CASCADE` | 偏差ID |
| `description` | `TEXT` | `NOT NULL` | 措施描述 |
| `responsible_id` | `INTEGER` | `REFERENCES users(id)` | 负责人ID |
| `due_date` | `TIMESTAMP` | `NOT NULL` | 到期日期 |
| `completed_date` | `TIMESTAMP` | | 完成日期 |
| `status` | `VARCHAR(50)` | `NOT NULL` | 状态 |
| `effectiveness` | `VARCHAR(20)` | | 有效性评估 |
| `created_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |
| `updated_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 更新时间 |

### 3.3 CAPA管理模块表

#### 3.3.1 `capas` (纠正预防措施表)

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|---------|------|------|
| `id` | `SERIAL` | `PRIMARY KEY` | CAPA ID |
| `code` | `VARCHAR(50)` | `UNIQUE NOT NULL` | CAPA编号 |
| `title` | `VARCHAR(255)` | `NOT NULL` | CAPA标题 |
| `description` | `TEXT` | `NOT NULL` | CAPA描述 |
| `status` | `VARCHAR(50)` | `NOT NULL` | CAPA状态 |
| `owner_id` | `INTEGER` | `REFERENCES users(id)` | 负责人ID |
| `verifier_id` | `INTEGER` | `REFERENCES users(id)` | 验证人ID |
| `target_completion_date` | `TIMESTAMP` | `NOT NULL` | 目标完成日期 |
| `actual_completion_date` | `TIMESTAMP` | | 实际完成日期 |
| `effectiveness_conclusion` | `TEXT` | | 有效性结论 |
| `deviation_id` | `INTEGER` | `REFERENCES deviations(id)` | 关联偏差ID |
| `audit_finding_id` | `INTEGER` | `REFERENCES audit_findings(id)` | 关联审计发现ID |
| `complaint_id` | `INTEGER` | `REFERENCES complaints(id)` | 关联投诉ID |
| `created_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |
| `updated_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 更新时间 |

#### 3.3.2 `capa_actions` (CAPA措施表)

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|---------|------|------|
| `id` | `SERIAL` | `PRIMARY KEY` | 措施ID |
| `capa_id` | `INTEGER` | `REFERENCES capas(id) ON DELETE CASCADE` | CAPA ID |
| `type` | `VARCHAR(20)` | `NOT NULL` | 措施类型(CORRECTIVE/PREVENTIVE) |
| `description` | `TEXT` | `NOT NULL` | 措施描述 |
| `responsible_id` | `INTEGER` | `REFERENCES users(id)` | 负责人ID |
| `due_date` | `TIMESTAMP` | `NOT NULL` | 到期日期 |
| `completed_date` | `TIMESTAMP` | | 完成日期 |
| `status` | `VARCHAR(50)` | `NOT NULL` | 状态 |
| `created_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |
| `updated_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 更新时间 |

#### 3.3.3 `capa_verifications` (CAPA验证表)

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|---------|------|------|
| `id` | `SERIAL` | `PRIMARY KEY` | 验证ID |
| `capa_id` | `INTEGER` | `REFERENCES capas(id) ON DELETE CASCADE` | CAPA ID |
| `result` | `VARCHAR(20)` | `NOT NULL` | 验证结果(YES/NO/PARTIAL) |
| `comments` | `TEXT` | | 验证评论 |
| `verification_date` | `TIMESTAMP` | `NOT NULL` | 验证日期 |
| `verifier_id` | `INTEGER` | `REFERENCES users(id)` | 验证人ID |
| `created_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |
| `updated_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 更新时间 |

### 3.4 变更控制模块表

#### 3.4.1 `change_controls` (变更控制表)

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|---------|------|------|
| `id` | `SERIAL` | `PRIMARY KEY` | 变更ID |
| `code` | `VARCHAR(50)` | `UNIQUE NOT NULL` | 变更编号 |
| `title` | `VARCHAR(255)` | `NOT NULL` | 变更标题 |
| `description` | `TEXT` | `NOT NULL` | 变更描述 |
| `type` | `VARCHAR(50)` | `NOT NULL` | 变更类型 |
| `status` | `VARCHAR(50)` | `NOT NULL` | 变更状态 |
| `risk_level` | `VARCHAR(20)` | `NOT NULL` | 风险等级 |
| `initiator_id` | `INTEGER` | `REFERENCES users(id)` | 申请人ID |
| `reviewer_id` | `INTEGER` | `REFERENCES users(id)` | 审核人ID |
| `approver_id` | `INTEGER` | `REFERENCES users(id)` | 批准人ID |
| `implementation_date` | `TIMESTAMP` | | 实施日期 |
| `validation_required` | `BOOLEAN` | `DEFAULT FALSE` | 是否需要验证 |
| `validated` | `BOOLEAN` | `DEFAULT FALSE` | 是否已验证 |
| `created_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |
| `updated_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 更新时间 |
| `effective_date` | `TIMESTAMP` | | 生效日期 |

### 3.5 审计管理模块表

#### 3.5.1 `audits` (审计表)

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|---------|------|------|
| `id` | `SERIAL` | `PRIMARY KEY` | 审计ID |
| `code` | `VARCHAR(50)` | `UNIQUE NOT NULL` | 审计编号 |
| `title` | `VARCHAR(255)` | `NOT NULL` | 审计标题 |
| `type` | `VARCHAR(50)` | `NOT NULL` | 审计类型 |
| `scope` | `TEXT` | `NOT NULL` | 审计范围 |
| `standard` | `VARCHAR(100)` | `NOT NULL` | 审计标准 |
| `status` | `VARCHAR(50)` | `NOT NULL` | 审计状态 |
| `planned_start_date` | `TIMESTAMP` | `NOT NULL` | 计划开始日期 |
| `planned_end_date` | `TIMESTAMP` | `NOT NULL` | 计划结束日期 |
| `actual_start_date` | `TIMESTAMP` | | 实际开始日期 |
| `actual_end_date` | `TIMESTAMP` | | 实际结束日期 |
| `lead_auditor_id` | `INTEGER` | `REFERENCES users(id)` | 主审ID |
| `summary` | `TEXT` | | 审计摘要 |
| `conclusion` | `TEXT` | | 审计结论 |
| `created_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |
| `updated_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 更新时间 |

#### 3.5.2 `audit_findings` (审计发现表)

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|---------|------|------|
| `id` | `SERIAL` | `PRIMARY KEY` | 发现ID |
| `audit_id` | `INTEGER` | `REFERENCES audits(id) ON DELETE CASCADE` | 审计ID |
| `description` | `TEXT` | `NOT NULL` | 发现描述 |
| `severity` | `VARCHAR(20)` | `NOT NULL` | 严重程度 |
| `reference_clause` | `VARCHAR(100)` | | 参考条款 |
| `auditor_id` | `INTEGER` | `REFERENCES users(id)` | 发现人ID |
| `finding_date` | `TIMESTAMP` | `NOT NULL` | 发现日期 |
| `target_completion_date` | `TIMESTAMP` | | 目标完成日期 |
| `actual_completion_date` | `TIMESTAMP` | | 实际完成日期 |
| `status` | `VARCHAR(50)` | `NOT NULL` | 状态 |
| `created_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |
| `updated_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 更新时间 |

### 3.6 投诉管理模块表

#### 3.6.1 `complaints` (投诉表)

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|---------|------|------|
| `id` | `SERIAL` | `PRIMARY KEY` | 投诉ID |
| `code` | `VARCHAR(50)` | `UNIQUE NOT NULL` | 投诉编号 |
| `title` | `VARCHAR(255)` | `NOT NULL` | 投诉标题 |
| `description` | `TEXT` | `NOT NULL` | 投诉描述 |
| `source` | `VARCHAR(50)` | `NOT NULL` | 投诉来源 |
| `status` | `VARCHAR(50)` | `NOT NULL` | 投诉状态 |
| `priority` | `VARCHAR(20)` | `NOT NULL` | 优先级 |
| `customer_name` | `VARCHAR(255)` | `NOT NULL` | 客户名称 |
| `customer_contact` | `VARCHAR(255)` | | 客户联系方式 |
| `product_id` | `VARCHAR(50)` | | 产品ID |
| `batch_number` | `VARCHAR(50)` | | 批次号 |
| `received_date` | `TIMESTAMP` | `NOT NULL` | 接收日期 |
| `investigator_id` | `INTEGER` | `REFERENCES users(id)` | 调查人ID |
| `closer_id` | `INTEGER` | `REFERENCES users(id)` | 关闭人ID |
| `investigation_summary` | `TEXT` | | 调查摘要 |
| `root_cause` | `TEXT` | | 根本原因 |
| `resolution` | `TEXT` | | 解决方案 |
| `closed_date` | `TIMESTAMP` | | 关闭日期 |
| `created_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |
| `updated_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 更新时间 |

## 4. 数据完整性约束

### 4.1 主键约束

- 每个表必须有且仅有一个主键
- 主键值必须唯一且非空
- 推荐使用代理键(SERIAL)作为主键

### 4.2 外键约束

- 所有引用关系必须通过外键约束实现
- 外键引用的目标必须是被引用表的主键
- 外键约束应明确定义级联操作(ON DELETE CASCADE, ON UPDATE CASCADE等)

### 4.3 唯一约束

- 业务上需要唯一标识的字段必须定义唯一约束
- 例如：偏差编号、CAPA编号、变更编号等

### 4.4 检查约束

- 状态字段必须使用检查约束限制取值范围
- 日期字段关系必须通过检查约束确保合理性

```sql
-- 示例：检查约束
ALTER TABLE deviations
ADD CONSTRAINT chk_deviation_status 
CHECK (status IN ('NEW', 'UNDER_INVESTIGATION', 'IN_PROGRESS', 'COMPLETED', 'CLOSED'));

ALTER TABLE deviations
ADD CONSTRAINT chk_deviation_dates
CHECK (occurrence_date <= CURRENT_DATE);
```

### 4.5 默认值约束

- 状态字段应设置合理的默认值
- 创建时间和更新时间应使用数据库默认值

## 5. 索引设计

### 5.1 主键索引

- 所有主键字段自动创建主键索引

### 5.2 外键索引

- 所有外键字段应创建索引以提高查询性能

```sql
-- 示例：外键索引
CREATE INDEX idx_deviation_reporter ON deviations(reporter_id);
CREATE INDEX idx_deviation_investigator ON deviations(investigator_id);
CREATE INDEX idx_capa_deviation ON capas(deviation_id);
```

### 5.3 业务字段索引

- 常用查询字段应创建索引
- 状态字段、日期字段等应创建索引

```sql
-- 示例：业务字段索引
CREATE INDEX idx_deviation_code ON deviations(code);
CREATE INDEX idx_deviation_status ON deviations(status);
CREATE INDEX idx_deviation_occurrence_date ON deviations(occurrence_date);
CREATE INDEX idx_capa_status ON capas(status);
CREATE INDEX idx_audit_status ON audits(status);
```

### 5.4 复合索引

- 对于频繁组合查询的字段，应创建复合索引

```sql
-- 示例：复合索引
CREATE INDEX idx_deviation_type_severity ON deviations(type, severity);
CREATE INDEX idx_audit_type_status ON audits(type, status);
CREATE INDEX idx_complaint_product_batch ON complaints(product_id, batch_number);
```

## 6. 数据分区策略

对于大型表，可以考虑采用数据分区策略以提高查询性能和管理效率：

- 按时间范围分区：适用于偏差、投诉等时间相关数据
- 按类型分区：适用于变更控制等不同类型数据
- 按状态分区：适用于所有状态管理相关数据

```sql
-- 示例：按时间范围分区
CREATE TABLE deviations (
    -- 字段定义
) PARTITION BY RANGE (EXTRACT(YEAR FROM occurrence_date));

CREATE TABLE deviations_2023 PARTITION OF deviations
    FOR VALUES FROM (2023) TO (2024);

CREATE TABLE deviations_2024 PARTITION OF deviations
    FOR VALUES FROM (2024) TO (2025);
```

## 7. 数据访问层设计

### 7.1 ORM映射

系统采用Hibernate/JPA作为ORM框架，实体类与数据表的映射关系如下：

- 使用`@Entity`注解标识实体类
- 使用`@Table`注解指定数据表名
- 使用`@Id`和`@GeneratedValue`注解定义主键
- 使用`@ManyToOne`, `@OneToMany`, `@OneToOne`等注解定义实体关系

### 7.2 数据访问对象(DAO)

系统采用Repository模式设计数据访问层：

- 每个实体类对应一个Repository接口
- Repository接口继承JpaRepository接口
- 支持自定义查询方法和JPQL查询

## 8. 文档历史

| 版本 | 修改日期 | 修改人 | 修改内容 |
|------|----------|--------|----------|
| 1.0  | 2023-07-18 | QMS团队 | 初始版本 |
| 1.1  | 2023-07-28 | QMS团队 | 增加投诉管理模块表结构 |
| 1.2  | 2023-08-08 | QMS团队 | 更新索引设计和数据分区策略 |
