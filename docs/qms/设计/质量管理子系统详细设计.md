# 质量管理子系统详细设计文档

## 1. 文档概述

本文档详细描述GMP系统中质量管理子系统(QMS)的设计实现方案，包括系统架构、模块划分、类设计、数据库设计、API设计等详细设计内容。本文档是开发团队进行系统实现的主要依据。

## 2. 系统架构

### 2.1 总体架构

QMS子系统采用微服务架构设计，作为GMP系统的核心组件，与其他子系统通过RESTful API进行集成。系统架构图如下：

```
客户端层 ←→ API网关 ←→ QMS微服务 ←→ 数据库层
                               ↓
                         消息队列/缓存
```

### 2.2 技术栈

- **后端技术**：Java 11, Spring Boot 2.7.x, Spring Cloud 2021.x
- **数据库**：PostgreSQL 13+, MongoDB 4.x
- **缓存**：Redis 6.x
- **消息队列**：RabbitMQ 3.x
- **工作流引擎**：Camunda BPM 7.x
- **安全框架**：Spring Security, JWT
- **API文档**：Swagger/OpenAPI 3.0

## 3. 模块划分

### 3.1 核心模块

| 模块名称 | 主要职责 | 包路径 |
|---------|---------|--------|
| 偏差管理 | 偏差记录、调查、处理和关闭 | com.gmp.qms.deviation |
| CAPA管理 | 纠正预防措施的制定、实施和验证 | com.gmp.qms.capa |
| 变更控制 | 变更申请、评估、审批和实施 | com.gmp.qms.change |
| 审计管理 | 内部审计计划、执行和跟踪 | com.gmp.qms.audit |
| 投诉管理 | 客户投诉接收、调查和处理 | com.gmp.qms.complaint |

### 3.2 通用模块

| 模块名称 | 主要职责 | 包路径 |
|---------|---------|--------|
| 公共工具 | 通用工具类和辅助方法 | com.gmp.qms.common.utils |
| 配置管理 | 系统配置和参数管理 | com.gmp.qms.config |
| 异常处理 | 统一异常处理机制 | com.gmp.qms.exception |
| 安全控制 | 安全相关功能实现 | com.gmp.qms.security |
| 数据访问 | 数据库访问和事务管理 | com.gmp.qms.repository |
| 事件通知 | 系统事件和消息通知 | com.gmp.qms.notification |

## 4. 数据模型设计

### 4.1 核心实体关系

```
Deviation (偏差) ←→ CAPA (纠正预防措施)
ChangeControl (变更控制) ←→ Deviation (偏差)
Audit (审计) ←→ AuditFinding (审计发现) ←→ CAPA (纠正预防措施)
Complaint (投诉) ←→ Investigation (调查) ←→ Deviation (偏差)
```

### 4.2 关键实体类设计

#### 4.2.1 Deviation (偏差)

```java
@Entity
@Table(name = "deviations")
public class Deviation extends BaseEntity {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    private String code; // 偏差编号
    private String title; // 偏差标题
    private String description; // 偏差描述
    
    @Enumerated(EnumType.STRING)
    private DeviationType type; // 偏差类型
    
    @Enumerated(EnumType.STRING)
    private DeviationSeverity severity; // 偏差严重程度
    
    @Enumerated(EnumType.STRING)
    private DeviationStatus status; // 偏差状态
    
    private LocalDateTime occurrenceDate; // 发生日期
    private String location; // 发生地点
    
    @ManyToOne
    private User reporter; // 报告人
    
    @ManyToOne
    private User investigator; // 调查人
    
    @ManyToOne
    private User approver; // 批准人
    
    @OneToMany(mappedBy = "deviation", cascade = CascadeType.ALL)
    private List<DeviationAction> actions; // 偏差处理措施
    
    @OneToMany(mappedBy = "deviation", cascade = CascadeType.ALL)
    private List<DeviationAttachment> attachments; // 附件
    
    @OneToOne(mappedBy = "deviation", cascade = CascadeType.ALL)
    private CAPA relatedCAPA; // 关联的CAPA
    
    // getter and setter methods
}
```

#### 4.2.2 CAPA (纠正预防措施)

```java
@Entity
@Table(name = "capas")
public class CAPA extends BaseEntity {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    private String code; // CAPA编号
    private String title; // CAPA标题
    private String description; // CAPA描述
    
    @Enumerated(EnumType.STRING)
    private CAPAStatus status; // CAPA状态
    
    @ManyToOne
    private User owner; // CAPA负责人
    
    @ManyToOne
    private User verifier; // 验证人
    
    private LocalDateTime targetCompletionDate; // 目标完成日期
    private LocalDateTime actualCompletionDate; // 实际完成日期
    
    private String effectivenessConclusion; // 有效性结论
    
    @OneToOne
    private Deviation deviation; // 关联的偏差
    
    @OneToOne
    private AuditFinding auditFinding; // 关联的审计发现
    
    @OneToMany(mappedBy = "capa", cascade = CascadeType.ALL)
    private List<CAPAAction> actions; // 具体措施
    
    // getter and setter methods
}
```

## 5. 服务层设计

### 5.1 偏差管理服务

```java
@Service
@Transactional
public class DeviationServiceImpl implements DeviationService {
    
    private final DeviationRepository deviationRepository;
    private final NotificationService notificationService;
    
    @Autowired
    public DeviationServiceImpl(DeviationRepository deviationRepository, 
                              NotificationService notificationService) {
        this.deviationRepository = deviationRepository;
        this.notificationService = notificationService;
    }
    
    @Override
    public Deviation createDeviation(DeviationDTO deviationDTO) {
        // 实现偏差创建逻辑
        Deviation deviation = convertToEntity(deviationDTO);
        deviation.setCode(generateDeviationCode());
        deviation.setStatus(DeviationStatus.NEW);
        
        Deviation savedDeviation = deviationRepository.save(deviation);
        
        // 发送通知
        notificationService.sendDeviationCreatedNotification(savedDeviation);
        
        return savedDeviation;
    }
    
    @Override
    public Deviation updateDeviation(Long id, DeviationDTO deviationDTO) {
        // 实现偏差更新逻辑
    }
    
    @Override
    public void submitForInvestigation(Long id) {
        // 实现提交调查逻辑
    }
    
    @Override
    public void closeDeviation(Long id, String conclusion) {
        // 实现偏差关闭逻辑
    }
    
    // 其他方法实现
}
```

## 6. API设计

### 6.1 偏差管理API

| API路径 | 方法 | 功能描述 | 请求体 (JSON) | 成功响应 (200 OK) |
|---------|------|---------|--------------|-------------------|
| `/api/deviations` | GET | 获取偏差列表 | N/A | `[{"id": 1, "code": "DEV-2023-001", "title": "...", "status": "NEW"}]` |
| `/api/deviations` | POST | 创建新偏差 | `{"title": "...", "description": "...", "type": "SYSTEM", "severity": "MINOR"}` | `{"id": 1, "code": "DEV-2023-001", "title": "..."}` |
| `/api/deviations/{id}` | GET | 获取偏差详情 | N/A | `{"id": 1, "code": "DEV-2023-001", "title": "...", "description": "..."}` |
| `/api/deviations/{id}` | PUT | 更新偏差信息 | `{"title": "...", "description": "..."}` | `{"id": 1, "code": "DEV-2023-001", "title": "..."}` |
| `/api/deviations/{id}/submit` | POST | 提交偏差调查 | N/A | `{"id": 1, "status": "UNDER_INVESTIGATION"}` |
| `/api/deviations/{id}/close` | POST | 关闭偏差 | `{"conclusion": "..."}` | `{"id": 1, "status": "CLOSED"}` |

## 7. 工作流设计

### 7.1 偏差处理工作流

QMS子系统使用Camunda BPM实现业务流程自动化，偏差处理工作流定义如下：

1. **偏差报告**：用户创建偏差报告
2. **初步评估**：质量主管进行初步评估，确定严重程度
3. **调查**：指定调查人进行详细调查
4. **根本原因分析**：分析偏差根本原因
5. **措施制定**：制定纠正措施
6. **审批**：质量经理审批措施
7. **实施**：执行纠正措施
8. **验证**：验证措施有效性
9. **关闭**：偏差关闭

## 8. 接口集成

### 8.1 与认证子系统集成

QMS子系统通过JWT与认证子系统集成，实现用户认证和权限控制：

```java
@Configuration
@EnableWebSecurity
public class SecurityConfig extends WebSecurityConfigurerAdapter {
    
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http.oauth2ResourceServer().jwt();
        
        http.authorizeRequests()
            .antMatchers("/api/deviations/**").hasRole("QUALITY_MANAGER")
            .antMatchers("/api/capas/**").hasRole("QUALITY_MANAGER")
            .anyRequest().authenticated();
    }
}
```

### 8.2 与其他子系统集成

| 子系统 | 集成方式 | 主要功能 |
|--------|----------|----------|
| MES | REST API | 生产数据关联和质量问题追溯 |
| LIMS | REST API | 测试数据关联和质量指标分析 |
| EDMS | REST API | 质量文档管理和版本控制 |
| 文件服务 | REST API | 文件上传和下载 |
| 消息服务 | RabbitMQ | 系统通知和消息推送 |

## 9. 性能优化

### 9.1 缓存策略

使用Redis缓存常用数据，如：
- 用户权限信息
- 系统配置参数
- 常用查询结果

```java
@Configuration
@EnableCaching
public class CacheConfig extends CachingConfigurerSupport {
    
    @Bean
    public RedisCacheManager cacheManager(RedisConnectionFactory factory) {
        RedisCacheConfiguration config = RedisCacheConfiguration.defaultCacheConfig()
            .entryTtl(Duration.ofMinutes(10))
            .serializeKeysWith(RedisSerializationContext.SerializationPair.fromSerializer(new StringRedisSerializer()))
            .serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(new GenericJackson2JsonRedisSerializer()));
        
        return RedisCacheManager.builder(factory)
            .cacheDefaults(config)
            .build();
    }
}
```

### 9.2 数据库优化

- 为常用查询字段创建索引
- 使用分页查询减少数据传输
- 合理使用联合查询和延迟加载

## 10. 安全措施

### 10.1 数据安全

- 敏感数据加密存储
- 数据访问审计日志
- 定期数据备份

### 10.2 访问控制

- 基于角色的访问控制
- 操作权限精细化管理
- 会话超时和自动登出

## 11. 部署架构

QMS子系统采用Docker容器化部署，通过Kubernetes进行容器编排和管理。主要组件包括：

- QMS服务实例(多副本)
- PostgreSQL数据库
- Redis缓存
- RabbitMQ消息队列
- Camunda BPM工作流引擎

## 12. 监控与日志

使用Spring Boot Actuator和Prometheus实现系统监控，Grafana提供可视化监控面板。日志采用ELK(Elasticsearch, Logstash, Kibana)栈进行集中管理和分析。

## 13. 文档历史

| 版本 | 修改日期 | 修改人 | 修改内容 |
|------|----------|--------|----------|
| 1.0  | 2023-07-20 | QMS团队 | 初始版本 |
| 1.1  | 2023-08-05 | QMS团队 | 增加缓存策略和性能优化章节 |
