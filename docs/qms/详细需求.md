# QMS子系统（质量管理系统）详细需求分析

## 1. 偏差管理模块 (Deviation Management)

### 1.1 功能需求

#### 1.1.1 偏差创建
- **功能描述**：允许用户创建新的偏差报告
- **输入字段**：
  - 偏差编号 (自动生成: DEV-YYYY-MMDD-001)
  - 偏差标题 (必填, 最大长度: 200字符)
  - 偏差描述 (必填, 文本字段)
  - 发生日期时间 (必填, 日期时间选择器)
  - 发生地点/生产线 (下拉选择)
  - 报告人 (自动填充当前登录用户)
  - 严重程度 (必选: LOW/MEDIUM/HIGH/CRITICAL)
  - 影响范围 (多选: 产品质量/生产过程/设备运行/人员安全/环境影响)
  - 附件上传 (支持最多5个文件, 最大10MB)
- **业务规则**：
  - 偏差编号唯一且自动生成
  - 严重程度为CRITICAL时必须短信通知质量经理
  - 偏差创建后自动分配给质量工程师处理

#### 1.1.2 偏差评估
- **功能描述**：质量工程师评估偏差的影响和优先级
- **评估信息**：
  - 评估日期
  - 评估人员
  - 根因分析 (文本字段)
  - 潜在影响 (下拉/多选)
  - 所需措施 (文本字段)
  - 预计完成时间
- **状态管理**：
  - OPEN → IN_ANALYSIS → CLOSED
  - 紧急偏差(24小时内响应)

#### 1.1.3 偏差跟踪
- **状态管理**：
  - OPEN: 新建状态
  - IN_ANALYSIS: 评估中
  - ACTION_REQUIRED: 需要行动
  - IN_CORRECTION: 纠正中
  - CLOSED: 已关闭
- **时间管控**：
  - LOW: 7天内完成
  - MEDIUM: 3天内完成
  - HIGH: 24小时内完成
  - CRITICAL: 8小时内完成

### 1.2 数据模型

#### 1.2.1 偏差表 (deviations)
```sql
CREATE TABLE deviations (
    id BIGSERIAL PRIMARY KEY,
    deviation_number VARCHAR(50) UNIQUE NOT NULL, -- DEV-2024-0101-001
    title VARCHAR(200) NOT NULL,
    description TEXT NOT NULL,
    severity VARCHAR(20) CHECK (severity IN ('LOW', 'MEDIUM', 'HIGH', 'CRITICAL')),
    status VARCHAR(20) DEFAULT 'OPEN',
    reported_by VARCHAR(100) NOT NULL,
    reported_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    occurred_date TIMESTAMP NOT NULL,
    location VARCHAR(100),
    due_date TIMESTAMP,
    assigned_to VARCHAR(100), -- 分配负责人员
    root_cause TEXT, -- 根本原因
    corrective_action TEXT, -- 纠正措施
    preventive_action TEXT, -- 预防措施
    closed_date TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## 2. CAPA管理模块 (CAPA Management)

### 2.1 功能需求

#### 2.1.1 CAPA创建
- **可用来源**：
  - 来自偏差 (自动创建)
  - 来自审计发现
  - 来自投诉
  - 主动识别的改进机会

#### 2.1.2 CAPA流程
```
CAPA创建 → 根本原因分析 → 措施制定 → 措施执行 → 有效性验证 → CAPA关闭
```

#### 2.1.3 步骤详情

**a) 根本原因分析**
- 问题描述
- 不确定性情况分析
- 原因收集 (鱼骨图法)
- 根本原因确认

**b) 措施制定**
- 立即纠正措施 (临时解决方案)
- 系统性纠正措施 (永久解决方案)
- 预防措施 (防止问题再现)

**c) 执行跟踪**
- 负责人分配
- 完成期限设置
- 进度报告
- 延期申请流程

### 2.2 数据模型

#### 2.2.1 CAPA表 (capas)
```sql
CREATE TABLE capas (
    id BIGSERIAL PRIMARY KEY,
    capa_number VARCHAR(50) UNIQUE NOT NULL, -- CAPA-2024-0101-001
    source_type VARCHAR(20) NOT NULL, -- DEVIATION/AUDIT/COMPLAINT/PROACTIVE
    source_id BIGINT, -- 关联的源记录ID
    title VARCHAR(200) NOT NULL,
    description TEXT NOT NULL,
    priority VARCHAR(20) DEFAULT 'MEDIUM',
    status VARCHAR(20) DEFAULT 'OPEN',
    assigned_to VARCHAR(100),
    due_date TIMESTAMP,
    closed_date TIMESTAMP,
    effectiveness_check TEXT, -- 有效性验证
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 2.2.2 CAPA行动项表 (capa_actions)
```sql
CREATE TABLE capa_actions (
    id BIGSERIAL PRIMARY KEY,
    capa_id BIGINT REFERENCES capas(id),
    action_type VARCHAR(20) NOT NULL, -- CORRECTIVE/PREVENTIVE/IMMEDIATE
    description TEXT NOT NULL,
    assignee VARCHAR(100),
    due_date TIMESTAMP,
    status VARCHAR(20) DEFAULT 'OPEN',
    completed_date TIMESTAMP,
    verification_notes TEXT
);
```

## 3. 变更控制模块 (Change Control)

### 3.1 功能需求

#### 3.1.1 变更类型
- **工艺变更**：配方、生产工艺、工艺参数
- **设备变更**：设备更换、设备维护、设备报废
- **文件变更**：SOP、规范、批记录模板
- **供应商变更**：原材料供应商变更
- **系统变更**：软件系统、IT系统变更

#### 3.1.2 变更流程
```
变更申请 → 影响评估 → 评审审批 → 执行变更 → 验证效果 → 变更关闭
```

#### 3.1.3 审批流程
- **单级审批**：常规变更
- **多级审批**：重要变更(CRITICAL级别)
- **专家评审**：需要专业知识的变更

### 3.2 数据模型

#### 3.2.1 变更控制表 (change_controls)
```sql
CREATE TABLE change_controls (
    id BIGSERIAL PRIMARY KEY,
    change_number VARCHAR(50) UNIQUE NOT NULL,
    change_type VARCHAR(20) NOT NULL, -- PROCESS/EQUIPMENT/DOCUMENT/SUPPLIER/SYSTEM
    title VARCHAR(200) NOT NULL,
    description TEXT NOT NULL,
    reason TEXT NOT NULL,
    impact_assessment TEXT, -- 影响评估
    proposed_solution TEXT, -- 建议解决方案
    risk_level VARCHAR(20) DEFAULT 'LOW',
    priority VARCHAR(20) DEFAULT 'NORMAL',
    status VARCHAR(20) DEFAULT 'DRAFT',
    requester VARCHAR(100) NOT NULL, -- 变更申请人
    assigned_to VARCHAR(100), -- 负责人
    approval_required BOOLEAN DEFAULT TRUE,
    approved_by VARCHAR(100),
    approved_date TIMESTAMP,
    effective_date TIMESTAMP, -- 变更生效日期
    completed_date TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## 4. 审计管理模块 (Audit Management)

### 4.1 功能需求

#### 4.1.1 审计类型
- **内部审计**：企业自行组织的质量体系审计
- **外部审计**：监管机构、客户组织的审计
- **供应商审计**：对供应商质量体系的审计
- **专项审计**：针对特定主题的专项审查

#### 4.1.2 审计流程
```
审计计划 → 审计执行 → 发现记录 → 整改要求 → 整改验证 → 审计关闭
```

### 4.2 数据模型

#### 4.2.1 审计表 (audits)
```sql
CREATE TABLE audits (
    id BIGSERIAL PRIMARY KEY,
    audit_number VARCHAR(50) UNIQUE NOT NULL,
    audit_type VARCHAR(20) NOT NULL,
    title VARCHAR(200) NOT NULL,
    scope TEXT NOT NULL, -- 审计范围
    objective TEXT NOT NULL, -- 审计目标
    planned_start_date TIMESTAMP,
    planned_end_date TIMESTAMP,
    actual_start_date TIMESTAMP,
    actual_end_date TIMESTAMP,
    lead_auditor VARCHAR(100),
    audit_team TEXT, -- JSON数组格式存储团队成员
    status VARCHAR(20) DEFAULT 'PLANNED',
    findings TEXT, -- 审计发现
    conclusion TEXT, -- 审计结论
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## 5. REST API接口设计

### 5.1 偏差管理接口

#### 5.1.1 创建偏差
```
POST /api/qms/deviations
Content-Type: application/json

{
    "title": "生产过程中温度超标",
    "description": "提取工序温度超过设定值5℃",
    "severity": "MEDIUM",
    "occurredDate": "2024-01-01T10:30:00Z",
    "location": "提取车间A线",
    "dueDate": "2024-01-05T17:00:00Z"
}
```

#### 5.1.2 查询偏差列表
```
GET /api/qms/deviations?page=0&size=10&status=OPEN&severity=HIGH,MEDIUM
```

### 5.2 CAPA管理接口

#### 5.2.1 创建CAPA
```
POST /api/qms/capas
Content-Type: application/json

{
    "sourceType": "DEVIATION",
    "sourceId": 1,
    "title": "改进生产监控系统",
    "description": "温度监控系统需要升级以避免偏差发生",
    "priority": "HIGH",
    "dueDate": "2024-02-01T17:00:00Z"
}
```

### 5.3 数据验证规则

#### 5.3.1 服务端验证
- 必填字段校验
- 数据类型校验
- 数据长度限制
- 业务逻辑校验 (如日期逻辑, 状态流转)

#### 5.3.2 前端验证
- 表单实时验证
- 日期范围校验
- 文件上传大小限制
- 用户权限校验

## 6. 数据库设计要点

### 6.1 索引优化
- 主键索引 (自动)
- 状态字段索引 (`status`)
- 日期字段索引 (`created_at`, `due_date`)
- 联合索引 (`status, created_at`)

### 6.2 数据完整性
- 外键约束
- 枚举值约束
- 唯一约束 (`deviation_number`)
- 非空约束

### 6.3 数据迁移
- 使用Flyway管理数据库版本
- 支持数据初始化
- 版本回退支持

## 7. 安全与权限

### 7.1 功能权限
- **偏差创建**：所有用户
- **偏差评估**：质量工程师及以上
- **变更审批**：质量经理
- **审计执行**：授权审计员

### 7.2 数据权限
- 基于角色的数据访问控制
- 用户只能查看自己创建的记录 (除管理员外)
- 敏感信息加密存储

---

**文档信息：**
- 版本：v1.0
- 更新日期：2024年
- 编制人员：详细需求分析团队
- 状态：Draft
