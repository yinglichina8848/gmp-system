# MES子系统（生产执行系统）架构设计

## 1. 概述

MES子系统基于微服务架构设计，实现生产执行过程的电子化管控和追溯，通过物联网设备数据采集、智能生产调度和质量过程控制，实现精益生产管理。

## 2. 系统架构

### 2.1 分层架构设计

```
┌────────────────────────────────────────────────────┐
│            表现层 (Presentation Layer)             │
│   ┌─────────────────────────────────────────────┐   │
│   │      REST Controllers (Controller层)       │   │
│   │ - OrderController                           │   │
│   │ - BatchController                           │   │
│   │ - EquipmentController                       │   │
│   │ - MaterialController                        │   │
│   └─────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────┘
                                ▼
┌────────────────────────────────────────────────────┐
│           业务逻辑层 (Business Layer)               │
│   ┌─────────────────────────────────────────────┐   │
│   │       业务服务 (Services)                    │   │
│   │ - ProductionOrderService                     │   │
│   │ - ProductionBatchService                     │   │
│   │ - EquipmentService                           │   │
│   │ - MaterialTraceabilityService                │   │
│   │                                             │   │
│   │ - 生产调度引擎                               │   │
│   │ - 质量控制引擎                               │   │
│   │ - 追溯分析引擎                               │   │
│   └─────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────┘
                                ▼
┌────────────────────────────────────────────────────┐
│           数据访问层 (Data Access Layer)            │
│   ┌─────────────────────────────────────────────┐   │
│   │       数据仓库 (Repositories)               │   │
│   │ - ProductionOrderRepository                 │   │
│   │ - ProductionBatchRepository                 │   │
│   │ - EquipmentRepository                       │   │
│   │ - MaterialBatchRepository                   │   │
│   └─────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────┘
                                ▼
┌────────────────────────────────────────────────────┐
│           数据存储层 (Data Storage)                │
└────────────────────────────────────────────────────┘
```

### 2.2 微服务架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    MES微服务 (mes-service:8082)             │
│                                                             │
│  ┌─────────────┬─────────────┬─────────────┬─────────────┐   │
│  │生产订单管理 │  批次执行  │ 设备状态监 │ 物料追溯管 │   │
│  │ Order Mgmt  │  Batch Exec │  Equip Mon │  Material T │   │
│  │             │             │             │    Trace    │   │
│  └─────────────┴─────────────┴─────────────┴─────────────┘   │
│                                                             │
│  ┌─────────────┬─────────────┬─────────────┬─────────────┐   │
│  │ 数据采集器 │ 规则引擎    │  缓存管理  │ 消息队列    │   │
│  │  Collector  │   Engine    │   Cache    │    MQ       │   │
│  └─────────────┴─────────────┴─────────────┴─────────────┘   │
└─────────────────────────────────────────────────────────────┘
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                    数据存储与外部集成                       │
│                                                             │
│  PostgreSQL mes_db    Redis Cache     RabbitMQ         │
│  - production_orders                                 │
│  - production_batches                                │
│  - equipment                                          │
│  - material_batches                                │
│                                                             │
│  外部系统集成：ERP、WMS、QMS、SCADA                     │
└─────────────────────────────────────────────────────────────┘
```

## 3. 服务设计

### 3.1 微服务边界

MES微服务主要包含四个核心业务领域：

```
生产订单管理 (Production Order Management)
├── 订单创建与编辑 (@Post /api/mes/orders)
├── 订单审批流程 (@Patch /api/mes/orders/{id}/approve)
├── 订单查询与统计 (@Get /api/mes/orders)
├── 订单状态跟踪 (@Get /api/mes/orders/{id}/status)
└── 资源调度分配 (@Post /api/mes/orders/{id}/schedule)

批次执行管理 (Batch Execution Management)
├── 批次创建分割 (@Post /api/mes/batches)
├── 批次启动执行 (@Patch /api/mes/batches/{id}/start)
├── 质量参数记录 (@Post /api/mes/batches/{id}/parameters)
├── 批次完成确认 (@Patch /api/mes/batches/{id}/complete)
└── 异常处理记录 (@Post /api/mes/batches/{id}/exceptions)

设备状态监控 (Equipment Monitoring)
├── 设备状态查询 (@Get /api/mes/equipment)
├── 设备状态更新 (@Patch /api/mes/equipment/{id}/status)
├── 维护记录管理 (@Post /api/mes/equipment/{id}/maintenance)
├── 报警配置管理 (@Put /api/mes/equipment/{id}/alarms)
└── 设备利用率分析 (@Get /api/mes/equipment/{id}/analytics)

物料追溯管理 (Material Traceability)
├── 物料批次查询 (@Get /api/mes/material-batches)
├── 批次使用记录 (@Post /api/mes/material-batches/{id}/usage)
├── 追溯链查询 (@Get /api/mes/trace/{batchNumber})
├── 质量状态关联 (@Patch /api/mes/material-batches/{id}/quality)
└── 过期预警管理 (@Get /api/mes/material-batches/expiring)
```

### 3.2 服务接口设计

#### 3.2.1 生产订单控制器
```java
@RestController
@RequestMapping("/api/mes/orders")
@Tag(name = "Production Order Management", description = "生产订单管理API")
public class ProductionOrderController {

    @PostMapping
    @ResponseStatus(HttpStatus.CREATED)
    public ApiResponse<ProductionOrderDto> createOrder(@Valid @RequestBody CreateOrderRequest request) {
        // 创建生产订单
    }

    @GetMapping("/{id}")
    public ApiResponse<ProductionOrderDto> getOrder(@PathVariable Long id) {
        // 查询订单详情
    }

    @GetMapping
    public ApiResponse<Page<ProductionOrderDto>> getOrders(OrderSearchCriteria criteria,
                                                           Pageable pageable) {
        // 分页查询订单
    }
}
```

## 4. 数据架构设计

### 4.1 核心数据模型

#### 4.1.1 生产订单实体
```java
@Entity
@Table(name = "production_orders")
@Data
@Audited
public class ProductionOrder {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(unique = true, nullable = false)
    private String orderNumber;

    @Column(nullable = false)
    private Long productId;

    private String productName;
    private BigDecimal batchSize;

    @Column(nullable = false)
    private LocalDateTime plannedStartDate;

    @Column(nullable = false)
    private LocalDateTime plannedEndDate;

    @Enumerated(EnumType.STRING)
    private OrderStatus status = OrderStatus.DRAFT;

    @Enumerated(EnumType.STRING)
    private OrderPriority priority = OrderPriority.NORMAL;

    @Column(nullable = false)
    private String requester;

    private String approver;
    private LocalDateTime approvedAt;

    @OneToMany(mappedBy = "order", cascade = CascadeType.ALL, fetch = FetchType.LAZY)
    private List<ProductionBatch> batches = new ArrayList<>();

    // 审计字段
    @CreatedDate
    private LocalDateTime createdAt;

    @LastModifiedDate
    private LocalDateTime updatedAt;
}
```

#### 4.1.2 设备监控实体
```java
@Entity
@Table(name = "equipment")
@Data
public class Equipment {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(unique = true, nullable = false)
    private String equipmentCode;

    @Column(nullable = false)
    private String equipmentName;

    private String equipmentType;
    private String model;
    private String manufacturer;
    private String location;

    @Enumerated(EnumType.STRING)
    private EquipmentStatus status = EquipmentStatus.AVAILABLE;

    private LocalDateTime lastMaintenance;
    private LocalDateTime nextMaintenance;

    @OneToMany(mappedBy = "equipment", cascade = CascadeType.ALL)
    private List<EquipmentStatusRecord> statusRecords;
}
```

### 4.3 Repository层设计

```java
@Repository
public interface ProductionOrderRepository extends JpaRepository<ProductionOrder, Long>,
                                                JpaSpecificationExecutor<ProductionOrder> {

    List<ProductionOrder> findByStatus(OrderStatus status);

    List<ProductionOrder> findByRequester(String requester);

    List<ProductionOrder> findByPlannedStartDateBetween(LocalDateTime start, LocalDateTime end);

    @Query("SELECT o FROM ProductionOrder o WHERE " +
           "o.status IN :statuses AND o.plannedStartDate >= :startDate")
    Page<ProductionOrder> findActiveOrders(@Param("statuses") List<OrderStatus> statuses,
                                           @Param("startDate") LocalDateTime startDate,
                                           Pageable pageable);
}
```

## 5. 业务规则引擎

### 5.1 生产调度引擎

```java
@Service
public class ProductionSchedulingEngine {

    // 资源可用性检查
    public boolean checkResourceAvailability(ProductionOrder order) {
        // 检查设备可用时间
        // 检查物料库存
        // 检查人力资源
        return true;
    }

    // 智能批次分配算法
    public List<ProductionBatch> createBatches(ProductionOrder order) {
        // 根据订单大小拆分批次
        // 考虑设备产能限制
        // 优化生产序列
        return new ArrayList<>();
    }
}
```

## 6. 物联网数据采集设计

### 6.1 数据采集架构

```java
@Component
public class IoTDataCollector {

    // 设备连接管理器
    private final Map<String, DeviceConnection> deviceConnections = new ConcurrentHashMap<>();

    // 实时数据订阅
    public void subscribeToEquipment(String equipmentCode) {
        WebSocketSession session = createWebSocketSession(equipmentCode);
        session.subscribe("/topic/equipment/" + equipmentCode + "/data", this::handleDataMessage);
    }

    // 数据消息处理器
    private void handleDataMessage(Message message) {
        // 解析物联网数据
        // 存储到时序数据库
        // 检查阈值触发报警
    }
}
```

## 7. 缓存设计

### 7.1 Redis缓存策略

#### 7.1.1 热点数据缓存
```java
@Service
@CacheConfig(cacheNames = "mes")
public class CachingService {

    @Cacheable(value = "equipment", key = "#equipmentId")
    public Equipment getEquipmentById(Long equipmentId) {
        // 缓存设备基础信息
    }

    @Cacheable(value = "activeOrders", key = "'active'")
    public List<ProductionOrder> getActiveOrders() {
        // 缓存活跃生产订单，定期刷新
    }

    @CacheEvict(value = {"equipment", "activeOrders"}, key = "#equipmentId")
    public void updateEquipmentStatus(Long equipmentId, EquipmentStatus status) {
        // 更新设备状态时清除相关缓存
    }
}
```

## 8. 消息队列设计

### 8.1 事件驱动架构

```java
@Component
public class MesEventPublisher {

    @Autowired
    private RabbitTemplate rabbitTemplate;

    // 发布订单状态变更事件
    public void publishOrderStatusChangedEvent(ProductionOrder order) {
        OrderStatusChangedEvent event = new OrderStatusChangedEvent(order);
        rabbitTemplate.convertAndSend("mes.exchange", "order.status.changed", event);
    }

    // 发布设备报警事件
    public void publishEquipmentAlarmEvent(Equipment equipment, String alarmType) {
        EquipmentAlarmEvent event = new EquipmentAlarmEvent(equipment, alarmType);
        rabbitTemplate.convertAndSend("mes.exchange", "equipment.alarm", event);
    }
}
```

## 9. 安全性设计

### 9.1 角色权限配置

```java
@Configuration
public class SecurityConfig {

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .authorizeRequests()
                .antMatchers("/api/mes/orders").hasRole("PRODUCTION_PLANNER")
                .antMatchers("/api/mes/batches/**").hasRole("OPERATOR")
                .antMatchers("/api/mes/equipment/**").hasAnyRole("OPERATOR", "MAINTENANCE")
                .antMatchers("/api/mes/orders/*/approve").hasRole("PRODUCTION_MANAGER")
            .and()
            .oauth2ResourceServer()
                .jwt();
        return http.build();
    }
}
```

## 10. 监控与可观测性

### 10.1 应用监控指标

```yaml
management:
  metrics:
    export:
      prometheus:
        enabled: true
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus,auditevents

# 自定义指标
mes:
  orders:
    created:
      total: 1000
  batches:
    active: 50
    completed: 450
```

---

**文档信息：**
- 版本：v1.0
- 更新日期：2024年
- 编制人员：架构设计团队
- 状态：Draft
