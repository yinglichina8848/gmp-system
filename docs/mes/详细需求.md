# MES子系统（生产执行系统）详细需求分析

## 1. 生产订单管理模块 (Production Order Management)

### 1.1 功能需求

#### 1.1.1 订单创建与审批
- **订单创建**：
  - 产品名称、规格、批次大小
  - 计划开始时间、截止时间
  - 生产工序分配
  - 物料需求计算
- **订单审批**：多级审批流程，质量、主管、生产确认

#### 1.1.2 资源调度
- **产能评估**：设备可用时间计算
- **物料检查**：库存验证，采购提醒
- **人力分配**：操作员技能匹配

### 1.2 数据模型

#### 1.2.1 生产订单表 (production_orders)
```sql
CREATE TABLE production_orders (
    id BIGSERIAL PRIMARY KEY,
    order_number VARCHAR(50) UNIQUE NOT NULL,
    product_id BIGINT NOT NULL,
    batch_size DECIMAL(10,3),
    planned_start_date TIMESTAMP,
    planned_end_date TIMESTAMP,
    status VARCHAR(20) DEFAULT 'DRAFT',
    priority VARCHAR(20) DEFAULT 'NORMAL',
    requester VARCHAR(100),
    approver VARCHAR(100),
    approved_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 1.2.2 生产批次表 (production_batches)
```sql
CREATE TABLE production_batches (
    id BIGSERIAL PRIMARY KEY,
    batch_number VARCHAR(50) UNIQUE NOT NULL,
    order_id BIGINT REFERENCES production_orders(id),
    batch_size DECIMAL(10,3),
    produced_quantity DECIMAL(10,3),
    status VARCHAR(20) DEFAULT 'CREATED',
    equipment_id BIGINT,
    operator_id VARCHAR(100),
    started_at TIMESTAMP,
    completed_at TIMESTAMP,
    quality_status VARCHAR(20) DEFAULT 'PENDING'
);
```

## 2. 设备监控模块 (Equipment Monitoring)

### 2.1 功能需求

#### 2.1.1 实时监控
- **状态采集**：设备运行状态、参数采集
- **报警设置**：阈值配置，自动报警
- **故障录入**：人工故障报告

#### 2.1.2 维护管理
- **计划保养**：定期维护计划
- **故障维修**：维修工单跟踪
- **使用统计**：设备利用率分析

### 2.2 数据模型

#### 2.2.1 设备表 (equipment)
```sql
CREATE TABLE equipment (
    id BIGSERIAL PRIMARY KEY,
    equipment_code VARCHAR(50) UNIQUE NOT NULL,
    equipment_name VARCHAR(200) NOT NULL,
    equipment_type VARCHAR(50),
    model VARCHAR(100),
    manufacturer VARCHAR(100),
    location VARCHAR(200),
    status VARCHAR(20) DEFAULT 'AVAILABLE',
    last_maintenance TIMESTAMP,
    next_maintenance TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 2.2.2 设备状态记录表 (equipment_status)
```sql
CREATE TABLE equipment_status (
    id BIGSERIAL PRIMARY KEY,
    equipment_id BIGINT REFERENCES equipment(id),
    status VARCHAR(20) NOT NULL,
    operator VARCHAR(100),
    start_time TIMESTAMP,
    end_time TIMESTAMP,
    remarks TEXT,
    recorded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## 3. 物料追溯模块 (Material Traceability)

### 3.1 功能需求

#### 3.1.1 物料批次追溯
- **流入跟踪**：供应商批次记录
- **内部流转**：仓库→生产线批次关联
- **流出跟踪**：产品批次关联

#### 3.1.2 质量关联
- **来源检验**：入库检验结果关联
- **过程检验**：工序质量数据关联
- **最终检验**：成品检验数据关联

### 3.2 数据模型

#### 3.2.1 物料批次表 (material_batches)
```sql
CREATE TABLE material_batches (
    id BIGSERIAL PRIMARY KEY,
    material_id BIGINT NOT NULL,
    batch_number VARCHAR(50) UNIQUE NOT NULL,
    supplier_batch VARCHAR(50),
    received_date TIMESTAMP,
    expiry_date TIMESTAMP,
    quantity DECIMAL(10,3),
    unit VARCHAR(20),
    quality_status VARCHAR(20) DEFAULT 'PENDING',
    qa_inspection_result VARCHAR(20),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 3.2.2 批次使用记录表 (batch_usage)
```sql
CREATE TABLE batch_usage (
    id BIGSERIAL PRIMARY KEY,
    material_batch_id BIGINT REFERENCES material_batches(id),
    production_batch_id BIGINT REFERENCES production_batches(id),
    used_quantity DECIMAL(10,3),
    unit VARCHAR(20),
    used_by VARCHAR(100),
    used_at TIMESTAMP,
    stage VARCHAR(50), -- PRODUCTION/QUALITY_CONTROL/etc
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## 4. REST API接口设计

### 4.1 生产订单管理接口

#### 4.1.1 创建生产订单
```
POST /api/mes/orders
Content-Type: application/json

{
    "orderNumber": "ORD-2024-0101-001",
    "productId": 1,
    "batchSize": 1000.0,
    "plannedStartDate": "2024-01-02T00:00:00Z",
    "plannedEndDate": "2024-01-02T23:59:59Z",
    "priority": "HIGH"
}
```

#### 4.1.2 查询生产订单
```
GET /api/mes/orders?page=0&size=20&status=APPROVED,IN_PROGRESS
```

### 4.2 批次管理接口

#### 4.2.1 创建生产批次
```
POST /api/mes/batches
{
    "batchNumber": "BAT-2024-0101-001",
    "orderId": 1,
    "batchSize": 500.0,
    "equipmentId": 2,
    "operatorId": "operator001"
}
```

### 4.3 数据验证规则

#### 4.3.1 订单验证
- 订单号唯一性校验
- 批量范围合理性检查
- 时间逻辑验证（开始时间早于结束时间）
- 产品存在性和可用性验证

#### 4.3.2 物料验证
- 物料库存充足性检查
- 有效期验证
- 质量状态确认

## 5. 数据库设计要点

### 5.1 索引优化
- 状态字段索引：`status`、`priority`
- 时间字段索引：`planned_start_date`、`planned_end_date`
- 外键索引：`production_batch.order_id`、`batch_usage.material_batch_id`

### 5.2 数据完整性
- 外键约束：确保数据引用正确性
- 枚举约束：状态、优先级等字段使用枚举值
- 非空约束：关键业务字段必须填写

### 5.3 数据迁移
- 生产订单历史数据迁移
- 设备基础数据初始化
- 物料批次追溯数据重建

## 6. 安全与权限

### 6.1 功能权限
- **订单创建**：生产计划员及以上
- **订单审批**：生产主管及以上
- **设备操作**：授权操作员
- **质量记录**：质量检验员

### 6.2 数据权限
- 基于用户角色的数据访问控制
- 生产数据据操作员/班组隔离
- 质量数据可追溯但受控修改

---

**文档信息：**
- 版本：v1.0
- 更新日期：2024年
- 编制人员：详细需求分析团队
- 状态：Draft
